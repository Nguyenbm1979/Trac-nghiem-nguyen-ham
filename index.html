<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ki·ªÉm Tra Nguy√™n H√†m - ƒê·ªÅ 1</title>
    <script>
    window.MathJax = {
      tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
      svg: { fontCache: 'global' },
      options: { ignoreHtmlClass: 'tex2jax_ignore', processHtmlClass: 'tex2jax_process' }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; background-color: #f4f4f9; padding: 20px; max-width: 900px; margin: 0 auto; }
        .header-info { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .timer { font-size: 24px; font-weight: bold; color: #d9534f; }
        .student-form input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px; width: 200px; }
        .quiz-container { background: white; padding: 30px; margin-top: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .question-block { margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .question-title { font-weight: bold; color: #2c3e50; margin-bottom: 15px; font-size: 1.1em; }
        mjx-container { font-size: 115% !important; }
        .options label { display: block; margin-bottom: 10px; cursor: pointer; padding: 8px; border-radius: 5px; transition: background 0.2s; }
        .options label:hover { background-color: #f0f8ff; }
        .tf-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .tf-table th, .tf-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        .btn-submit { display: block; width: 100%; padding: 15px; background: #42b983; color: white; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; margin-top: 20px; font-weight: bold; }
        .btn-submit:disabled { background: #ccc; cursor: not-allowed; }
        .result-box { display: none; background: #e8f5e9; border: 2px solid #4caf50; padding: 20px; border-radius: 8px; margin-top: 20px; text-align: center; }
        .result-score { font-size: 32px; font-weight: bold; color: #2e7d32; margin: 10px 0; }
        .correct-ans { color: #2e7d32; font-weight: bold; background: #e8f5e9; padding: 5px; display: inline-block; margin-top: 5px; border: 1px solid #a5d6a7; border-radius: 4px;}
        .wrong-ans { color: #c62828; text-decoration: line-through; margin-right: 10px; opacity: 0.7;}
        .feedback { font-size: 0.95em; margin-top: 10px; color: #333; background: #fff3cd; padding: 10px; border-radius: 5px; display: none; border: 1px solid #ffeeba; }
        .show-feedback .feedback { display: block; }
    </style>
</head>
<body>

    <div class="header-info">
        <div>
            <h2>Ki·ªÉm tra: Nguy√™n H√†m (90 ph√∫t)</h2>
            <div class="student-form">
                <input type="text" id="hs-name" placeholder="H·ªç v√† t√™n h·ªçc sinh">
                <input type="text" id="hs-class" placeholder="L·ªõp (VD: 12A1)">
            </div>
        </div>
        <div class="timer" id="timer">90:00</div>
    </div>

    <div id="result-area" class="result-box">
        <h3>K·∫æT QU·∫¢ B√ÄI L√ÄM</h3>
        <p>H·ªçc sinh: <span id="res-name" style="font-weight:bold"></span> - L·ªõp: <span id="res-class" style="font-weight:bold"></span></p>
        <div class="result-score" id="score-display">0 / 0</div>
        <div id="submit-status" style="margin-top:10px; font-style:italic;"></div>
        <p>K√©o xu·ªëng d∆∞·ªõi ƒë·ªÉ xem ƒë√°p √°n chi ti·∫øt v√† l·ªùi gi·∫£i.</p>
    </div>

    <div class="quiz-container" id="quiz-body"><p style="text-align:center">ƒêang t·∫£i d·ªØ li·ªáu ƒë·ªÅ thi...</p></div>
    <button class="btn-submit" onclick="submitQuiz()" id="btn-submit">N·ªòP B√ÄI & XEM ƒêI·ªÇM</button>

<script>
    // ============================================================
    // üëá LINK GOOGLE SCRIPT C·ª¶A B·∫†N üëá
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw9AvPfuJ53SMG-AIdP9SBL6LThFM-r8DRphGwSqRutArucIK5jxf4BxzTHY2SIBJE/exec'; 
    // ============================================================

    // --- D·ªÆ LI·ªÜU C√ÇU H·ªéI (ƒê∆∞·ª£c chuy·ªÉn ƒë·ªïi t·ª´ file LaTeX ƒê·ªÅ 1) ---
    const questions = [
        // --- PH·∫¶N 1: TR·∫ÆC NGHI·ªÜM ---
        {
            type: 'mcq',
            q: 'C√¢u 1: H·ªç nguy√™n h√†m c·ªßa h√†m s·ªë $f(x)=x^3$ l√†',
            options: ['$4x^4+C$', '$3x^2+C$', '$x^4+C$', '$\\dfrac{1}{4}x^4+C$'],
            ans: 3,
            explain: 'Ta c√≥ $\\displaystyle\\int x^3\\mathrm{\\,d}x=\\dfrac{1}{4}x^4+C$.'
        },
        {
            type: 'mcq',
            q: 'C√¢u 2: T√¨m nguy√™n h√†m c·ªßa h√†m s·ªë $ f(x)=2\\sin x$.',
            options: ['$\\displaystyle\\int 2\\sin x\\mathrm{\\,d}x=-2\\cos x+C$', '$\\displaystyle\\int 2\\sin x\\mathrm{\\,d}x=2\\cos x+C$', '$\\displaystyle\\int 2\\sin x\\mathrm{\\,d}x=\\sin^2x+C$', '$\\displaystyle\\int 2\\sin x\\mathrm{\\,d}x=\\sin 2x+C$'],
            ans: 0,
            explain: 'Ta c√≥ $\\displaystyle\\int 2\\sin x\\mathrm{\\,d}x=2\\displaystyle\\int \\sin x \\mathrm{\\,d}x=-2\\cos x+C$.'
        },
        {
            type: 'mcq',
            q: 'C√¢u 3: H·ªç nguy√™n h√†m c·ªßa h√†m s·ªë $f(x)=\\mathrm{e}^x+x$ l√†',
            options: ['$\\mathrm{e}^x+1+C$', '$\\mathrm{e}^x+x^2+C$', '$\\mathrm{e}^x+\\dfrac{1}{2}{x^2}+C$', '$\\dfrac{1}{x+1}{\\mathrm{e}^x}+\\dfrac{1}{2}{x^2}+C$'],
            ans: 2,
            explain: 'Ta c√≥ $\\displaystyle\\int \\left(\\mathrm{e}^x+x\\right) \\mathrm{\\,d}x=\\displaystyle\\int \\mathrm{e}^x \\mathrm{\\,d}x+\\displaystyle\\int x \\mathrm{\\,d}x=\\mathrm{e}^x+\\dfrac{x^2}{2}+C$.'
        },
        {
            type: 'mcq',
            q: 'C√¢u 4: H·ªç nguy√™n h√†m c·ªßa h√†m s·ªë $y=x^2-3x+\\dfrac{1}{x}$ l√†',
            options: ['$\\dfrac{x^3}{3}-\\dfrac{3x^2}{2}-\\ln\\left|x\\right|+C$', '$\\dfrac{x^3}{3}-\\dfrac{3x^2}{2}+\\ln x+C$', '$\\dfrac{x^3}{3}-\\dfrac{3x^2}{2}+\\ln\\left|x\\right|+C$', '$\\dfrac{x^3}{3}-\\dfrac{3x^2}{2}+\\dfrac{1}{x^2}+C$'],
            ans: 2,
            explain: 'Ta c√≥ $\\displaystyle\\int \\left(x^2-3x+\\dfrac{1}{x}\\right) \\mathrm{\\,d}x=\\dfrac{x^3}{3}-\\dfrac{3x^2}{2}+\\ln\\left|x\\right|+C$.'
        },
        {
            type: 'mcq',
            q: 'C√¢u 5: T√¨m nguy√™n h√†m c·ªßa h√†m s·ªë $f(x)=\\dfrac{x^4+2}{x^2}$.',
            options: ['$\\dfrac{x^3}{3}-\\dfrac{1}{x}+C$', '$\\dfrac{x^3}{3}+\\dfrac{2}{x}+C$', '$\\dfrac{x^3}{3}+\\dfrac{1}{x}+C$', '$\\dfrac{x^3}{3}-\\dfrac{2}{x}+C$'],
            ans: 3,
            explain: 'Ta c√≥ $\\displaystyle\\int \\dfrac{x^4+2}{x^2} \\mathrm{\\,d}x=\\displaystyle\\int \\left(x^2+\\dfrac{2}{x^2}\\right) \\mathrm{\\,d}x=\\dfrac{x^3}{3}-\\dfrac{2}{x}+C$.'
        },
        {
            type: 'mcq',
            q: 'C√¢u 6: Cho h√†m s·ªë $ f(x)=1-\\dfrac{1}{\\cos^2 x}$. Kh·∫≥ng ƒë·ªãnh n√†o d∆∞·ªõi ƒë√¢y ƒë√∫ng?',
            options: ['$x+\\tan x+C$', '$x+\\cot x+C$', '$x-\\tan x+C$', '$x-\\cot x+C$'],
            ans: 2,
            explain: 'Ta c√≥ $\\displaystyle\\int f(x) \\mathrm{\\,d}x=\\displaystyle\\int \\left(1-\\dfrac{1}{\\cos^2x}\\right)\\mathrm{\\,d}x=x-\\tan x+C$.'
        },
        {
            type: 'mcq',
            q: 'C√¢u 7: H·ªç nguy√™n h√†m c·ªßa h√†m s·ªë $f(x)=\\cos x+6x$ l√†',
            options: ['$\\sin x+3x^2+C$', '$-\\sin x+3x^2+C$', '$\\sin x+6x^2+C$', '$-\\sin x+C$'],
            ans: 0,
            explain: 'Ta c√≥ $\\displaystyle\\int f(x)\\mathrm{\\,d}x=\\displaystyle\\int \\left(\\cos x+6x\\right)\\mathrm{\\,d}x=\\sin x+3x^2+C$.'
        },
        {
            type: 'mcq',
            q: 'C√¢u 8: $\\displaystyle\\int f(x)\\mathrm{\\,d}x=4x^3+x^2+C$ th√¨ h√†m s·ªë $f(x)$ b·∫±ng',
            options: ['$f(x)=x^4+\\dfrac{x^3}{3}+Cx$', '$f(x)=12x^2+2x+C$', '$f(x)=12x^2+2x$', '$f(x)=x^4+\\dfrac{x^3}{3}$'],
            ans: 2,
            explain: 'Ta c√≥ $ f(x)=F\'(x)=\\left(4x^3+x^2+C\\right)\'=12x^2+2x$.'
        },
        {
            type: 'mcq',
            q: 'C√¢u 9: H√†m s·ªë $F(x)=2x+3^x-1$ l√† nguy√™n h√†m c·ªßa h√†m s·ªë n√†o trong c√°c h√†m s·ªë sau',
            options: ['$f(x)=2+3^x\\ln 3$', '$f(x)=x^2+\\dfrac{3^x}{\\ln 3}-x+C$', '$f(x)=x^2+\\dfrac{3^x}{\\ln 3}-x$', '$f(x)=2+3^x\\ln 3+C$'],
            ans: 0,
            explain: 'Ta c√≥ $ f(x)=F\'(x)\\Rightarrow f(x)=\\left(2x+3^x-1\\right)\'=2+3^x\\ln 3$.'
        },
        {
            type: 'mcq',
            q: 'C√¢u 10: Cho $\\displaystyle\\int \\ln x \\mathrm{\\,d}x=F(x)+C$. Kh·∫≥ng ƒë·ªãnh n√†o d∆∞·ªõi ƒë√¢y ƒë√∫ng?',
            options: ['$F\'(x)=\\dfrac{1}{x}$', '$F\'(x)=\\dfrac{1}{x}+C$', '$F\'(x)=\\ln x$', '$F\'(x)=\\ln x+1$'],
            ans: 2,
            explain: 'Theo ƒë·ªãnh nghƒ©a nguy√™n h√†m: ƒê·∫°o h√†m c·ªßa nguy√™n h√†m ch√≠nh l√† h√†m s·ªë d∆∞·ªõi d·∫•u t√≠ch ph√¢n. $F\'(x) = \\ln x$.'
        },
        {
            type: 'mcq',
            q: 'C√¢u 11: Cho $F(x)$ l√† m·ªôt nguy√™n h√†m c·ªßa h√†m s·ªë $f(x)=\\mathrm{e}^x+2x$ th·ªèa m√£n $F(0)=\\dfrac{3}{2}$. T√¨m $F(x)$.',
            options: ['$F(x)=\\mathrm{e}^x+x^2+\\dfrac{1}{2}$', '$F(x)=\\mathrm{e}^x+x^2+\\dfrac{5}{2}$', '$F(x)=\\mathrm{e}^x+x^2+\\dfrac{3}{2}$', '$F(x)=2\\mathrm{e}^x+x^2-\\dfrac{1}{2}$'],
            ans: 0,
            explain: '$F(x)=\\mathrm{e}^x+x^2+C$. $F(0)=1+C=\\dfrac{3}{2} \\Rightarrow C=\\dfrac{1}{2}$.'
        },
        {
            type: 'mcq',
            q: 'C√¢u 12: M·ªôt vi√™n ƒë·∫°n ƒë∆∞·ª£c b·∫Øn th·∫≥ng ƒë·ª©ng l√™n tr√™n. $v(t)=160-9{,}8t$ (m/s). ƒê·ªô cao c·ªßa vi√™n ƒë·∫°n sau $t=10$ gi√¢y l√†',
            options: ['$620$ m', '$1\\,240$ m', '$555$ m', '$1\\,110$ m'],
            ans: 3,
            explain: '$S(t) = 160t - 4.9t^2$. $S(10) = 1600 - 490 = 1110$ m.'
        },

        // --- PH·∫¶N 2: ƒê√öNG SAI ---
        {
            type: 'tf',
            q: 'C√¢u 13: Cho h√†m s·ªë $y=h(x)$ c√≥ ƒë·∫°o h√†m $h\'(x)=3x^2$ v√† h√†m s·ªë $y=g(x)$ c√≥ ƒë·∫°o h√†m $g\'(x)=\\mathrm{e}^x$.',
            items: [
                {sub: 'H√†m s·ªë $y=h(x)=6x+C_1$, v·ªõi $C_1\\in \\mathbb{R}$', ans: 'F'},
                {sub: 'H√†m s·ªë $y=g(x)=\\mathrm{e}^x+C_2$, v·ªõi $C_2\\in \\mathbb{R}$', ans: 'T'},
                {sub: '$ I=\\displaystyle\\int \\left[xh\'(x)+2025\\right]\\mathrm{\\,d}x=\\dfrac{3}{4}{x^4}+2025x+C$', ans: 'T'},
                {sub: 'Cho $ f\'(x)=3x^2+\\mathrm{e}^x+m-1$. Cho $f(0)=2$; $ f(1)=2\\mathrm{e}$ th√¨ gi√° tr·ªã c·ªßa $m\\in (1;2)$', ans: 'T'}
            ],
            explain: 'a) Sai v√¨ nguy√™n h√†m c·ªßa $3x^2$ l√† $x^3$.'
        },
        {
            type: 'tf',
            q: 'C√¢u 14: Cho c√°c h√†m s·ªë $g(x)=\\sin x$ , $h(x)=\\cos x$.',
            items: [
                {sub: '$\\displaystyle\\int \\left[2g(x)-3h(x)\\right]\\mathrm{\\,d}x=3\\displaystyle\\int g(x)\\mathrm{\\,d}x-2\\displaystyle\\int h(x)\\mathrm{\\,d}x$', ans: 'F'},
                {sub: 'M·ªôt nguy√™n c·ªßa h√†m s·ªë $g(x)$ l√† $-\\cos x$', ans: 'T'},
                {sub: 'H·ªç nguy√™n c·ªßa h√†m s·ªë $h(x)+2\\sqrt{x}$ l√† $\\sin x+\\dfrac{3}{2}\\sqrt{x^3}+C$', ans: 'F'},
                {sub: 'H·ªç nguy√™n h√†m c·ªßa h√†m s·ªë $f(x)=g(x)\\cdot h^2(x)$ l√† $F(x)=-\\dfrac{1}{3}\\cos^3 x+C$', ans: 'T'}
            ],
            explain: 'a) Sai h·ªá s·ªë. c) Sai, ph·∫£i l√† $\\frac{4}{3}x\\sqrt{x}$.'
        },
        {
            type: 'tf',
            q: 'C√¢u 15: Cho c√°c h√†m s·ªë $g(x)=\\dfrac{1}{x^2}$, $h(x)=\\ln (x+3)$.',
            items: [
                {sub: 'Bi·∫øt $G(x)$ l√† m·ªôt nguy√™n h√†m c·ªßa $g(x)$ v√† $ G(1)=1$. Khi ƒë√≥ $ G(2)=-\\dfrac{1}{2}$', ans: 'F'},
                {sub: '$ J=\\displaystyle\\int \\left[h(x)+\\ln\\dfrac{1}{x+3}+2025\\right]\\mathrm{\\,d}x=2025x+C$', ans: 'T'},
                {sub: '$I=\\displaystyle\\int x\\cdot h\'(x)\\mathrm{\\,d}x=x-\\ln (x+3)+C$ v·ªõi $C\\in \\mathbb{R}$', ans: 'F'},
                {sub: 'Gi·∫£ s·ª≠ $F(x)$ l√† m·ªôt nguy√™n h√†m c·ªßa $f(x)=\\dfrac{x+3}{g(x)}$ v√† $F(1)=\\dfrac{1}{4}$. Khi ƒë√≥ $F(-1)=-\\dfrac{7}{4}$', ans: 'T'}
            ],
            explain: 'a) Sai, t√≠nh ra $G(2)=1.5$.'
        },
        {
            type: 'tf',
            q: 'C√¢u 16: Cho c√°c h√†m s·ªë $g(x)=\\mathrm{e}^{\\dfrac{x}{2}}$, $h(x)=2x^3+5x^2-2x+4$.',
            items: [
                {sub: '$\\displaystyle\\int \\left[2g(x)+3h(x)\\right]\\mathrm{\\,d}x=2\\displaystyle\\int g(x)\\mathrm{\\,d}x+3\\displaystyle\\int h(x)\\mathrm{\\,d}x$', ans: 'T'},
                {sub: 'M·ªôt nguy√™n c·ªßa h√†m s·ªë $3\\cdot g^2(x)$ l√† $3\\mathrm{e}^x$', ans: 'T'},
                {sub: 'H·ªç nguy√™n c·ªßa h√†m s·ªë $h(x)$ l√† $\\dfrac{1}{4}{x^3}+\\dfrac{5}{3}{x^3}-x^2+C$', ans: 'F'},
                {sub: 'Bi·∫øt $\\displaystyle\\int g^4(x)\\cdot h(x)\\mathrm{\\,d}x=(a{x^3}+b{x^2}+cx+d)\\mathrm{e}^{2x}+C$. Khi ƒë√≥ $ a+b+c+d=3$', ans: 'T'}
            ],
            explain: 'c) Sai v√¨ nguy√™n h√†m c·ªßa $2x^3$ l√† $\\frac{1}{2}x^4$.'
        },

        // --- PH·∫¶N 3: TR·∫¢ L·ªúI NG·∫ÆN ---
        {
            type: 'short',
            q: 'C√¢u 17: Cho $F(x)$ l√† m·ªôt nguy√™n h√†m c·ªßa h√†m $f(x)=\\dfrac{\\cos 2x}{\\sin x+\\cos x}$ th·ªèa m√£n $F(0)=1$. T√≠nh $F(\\pi)$.',
            ans: '-1',
            explain: '$F(x)=\\sin x + \\cos x$. $F(\\pi) = -1$.'
        },
        {
            type: 'short',
            q: 'C√¢u 18: $F(x)$ l√† m·ªôt nguy√™n h√†m c·ªßa h√†m s·ªë $f(x)=2^x$, th·ªèa m√£n $ F(0)=\\dfrac{1}{\\ln 2}$. Bi·ªÉu th·ª©c $ F(0)+F(1)+\\ldots+F(2024)=\\dfrac{a^b-c}{\\ln a}$. T√≠nh $ T=a+b-2c$.',
            ans: '2025',
            explain: 'T√≠nh ƒë∆∞·ª£c $a=2, b=2025, c=1$. $T = 2+2025-2 = 2025$.'
        },
        {
            type: 'short',
            q: 'C√¢u 19: $F(x)$ l√† nguy√™n h√†m c·ªßa $f(x)=\\dfrac{(3x-1)^2}{x^2}$, ƒë·ªì th·ªã $y=F(x)$ ƒëi qua $M(1;-2)$. T√≠nh $F\\left(\\mathrm{e}^2\\right)$ (l√†m tr√≤n ƒë·∫øn h√†ng ph·∫ßn ch·ª•c).',
            ans: '44,4', // Ch·∫•p nh·∫≠n c·∫£ 44.4 trong code x·ª≠ l√Ω
            explain: '$F(x)=9x-6\\ln|x|-1/x-10$. K·∫øt qu·∫£ x·∫•p x·ªâ 44,4.'
        },
        {
            type: 'short',
            q: 'C√¢u 20: √î t√¥ ch·∫°y $90$ km/h, ƒë·∫°p phanh ch·∫≠m d·∫ßn $v(t)=-\\dfrac{25}{4}t+25$ (m/s). Qu√£ng ƒë∆∞·ªùng t·ª´ l√∫c ph√°t hi·ªán ch∆∞·ªõng ng·∫°i v·∫≠t ƒë·∫øn khi d·ª´ng h·∫≥n l√† bao nhi√™u m√©t?',
            ans: '100',
            explain: 'Qu√£ng ƒë∆∞·ªùng ph·∫£n x·∫°: $25 \\times 2 = 50m$. Qu√£ng ƒë∆∞·ªùng phanh: $\\int_0^4 v(t)dt = 50m$. T·ªïng = 100m.'
        },
        {
            type: 'short',
            q: 'C√¢u 21: Vi khu·∫©n tƒÉng tr∆∞·ªüng $P\'(t)=k\\sqrt{t}$. Ban ƒë·∫ßu 500 con, sau 1 ng√†y 600 con. T√≠nh s·ªë l∆∞·ª£ng sau 9 ng√†y.',
            ans: '3200',
            explain: '$P(t)=150t\\sqrt{t} + 500$ (sau khi t√¨m k). $P(9) = 3200$.'
        },
        {
            type: 'short',
            q: 'C√¢u 22: C√¢y c√† chua cao 5cm. T·ªëc ƒë·ªô l·ªõn $ v(t)=-0{,}1t^3+t^2$. Chi·ªÅu cao khi c√¢y ph√°t tri·ªÉn nhanh nh·∫•t l√† bao nhi√™u? (l√†m tr√≤n ƒë·∫øn h√†ng ph·∫ßn ch·ª•c).',
            ans: '54,4',
            explain: '$v(t)$ max t·∫°i $t=20/3$. $h(20/3) \\approx 54,4$ cm.'
        }
    ];

    // --- LOGIC X·ª¨ L√ù ---
    const quizBody = document.getElementById('quiz-body');
    let timerDuration = 90 * 60; 

    function initQuiz() {
        try {
            let html = '';
            questions.forEach((q, index) => {
                html += `<div class="question-block" id="q-${index}">`;
                
                if(q.type === 'mcq') {
                    html += `<div class="question-title">${q.q}</div><div class="options">`;
                    q.options.forEach((opt, i) => html += `<label><input type="radio" name="q${index}" value="${i}"> ${opt}</label>`);
                    html += `</div>`;
                    html += `<div class="feedback"><b>ƒê√°p √°n ƒë√∫ng:</b> ${q.options[q.ans]}<br><i>${q.explain}</i></div>`;
                } 
                else if (q.type === 'tf') {
                    html += `<div class="question-title">${q.q}</div><table class="tf-table"><tr><th>M·ªánh ƒë·ªÅ</th><th>ƒê</th><th>S</th></tr>`;
                    q.items.forEach((item, subIndex) => html += `<tr><td>${item.sub}</td><td style="text-align:center"><input type="radio" name="q${index}_${subIndex}" value="T"></td><td style="text-align:center"><input type="radio" name="q${index}_${subIndex}" value="F"></td></tr>`);
                    html += `</table>`;
                    html += `<div class="feedback"><b>ƒê√°p √°n:</b> ${q.items.map(i => i.ans).join(', ')}<br><i>${q.explain}</i></div>`;
                } 
                else if (q.type === 'short') {
                    html += `<div class="question-title">${q.q}</div><input type="text" id="in-${index}" placeholder="Nh·∫≠p k·∫øt qu·∫£...">`;
                    html += `<div class="feedback"><b>ƒê√°p √°n ƒë√∫ng:</b> ${q.ans}<br><i>${q.explain}</i></div>`;
                }
                html += `</div>`;
            });
            quizBody.innerHTML = html;
            if(window.MathJax && MathJax.typesetPromise) MathJax.typesetPromise();
            startTimer();
        } catch (e) { console.error(e); }
    }

    function startTimer() {
        const display = document.getElementById('timer');
        const timerInterval = setInterval(() => {
            let m = parseInt(timerDuration / 60, 10);
            let s = parseInt(timerDuration % 60, 10);
            display.textContent = (m<10?"0"+m:m) + ":" + (s<10?"0"+s:s);
            if (--timerDuration < 0) { clearInterval(timerInterval); submitQuiz(); }
        }, 1000);
        window.quizTimer = timerInterval; 
    }

    function submitQuiz() {
        const name = document.getElementById('hs-name').value;
        const className = document.getElementById('hs-class').value;
        if(!name || !className) { alert("Vui l√≤ng nh·∫≠p H·ªç t√™n v√† L·ªõp!"); return; }

        clearInterval(window.quizTimer);
        const btn = document.getElementById('btn-submit');
        btn.disabled = true;
        btn.innerText = "ƒêANG CH·∫§M V√Ä G·ª¨I ƒêI·ªÇM...";

        let score = 0, total = 0;
        questions.forEach((q, index) => {
            const block = document.getElementById(`q-${index}`);
            block.classList.add('show-feedback');
            
            if(q.type === 'mcq') {
                total++;
                const sel = document.querySelector(`input[name="q${index}"]:checked`);
                if(sel && parseInt(sel.value) === q.ans) { 
                    score++; 
                    block.insertAdjacentHTML('beforeend', '<div class="correct-ans">ƒê√∫ng (+1ƒë)</div>'); 
                } else { 
                    block.insertAdjacentHTML('beforeend', '<div class="wrong-ans">Sai</div>'); 
                }
            } 
            else if(q.type === 'tf') {
                q.items.forEach((item, sub) => {
                    total+=0.25;
                    const sel = document.querySelector(`input[name="q${index}_${sub}"]:checked`);
                    if(sel && sel.value === item.ans) score+=0.25;
                });
            } 
            else if(q.type === 'short') {
                total++;
                let val = document.getElementById(`in-${index}`).value.trim();
                // X·ª≠ l√Ω d·∫•u ph·∫©y th√†nh d·∫•u ch·∫•m ƒë·ªÉ so s√°nh
                let valNormalized = val.replace(',', '.');
                let ansNormalized = q.ans.replace(',', '.');
                
                if(valNormalized === ansNormalized) { 
                    score++; 
                    block.insertAdjacentHTML('beforeend', '<div class="correct-ans">ƒê√∫ng (+1ƒë)</div>'); 
                } else { 
                    block.insertAdjacentHTML('beforeend', '<div class="wrong-ans">Sai</div>'); 
                }
            }
        });

        document.getElementById('result-area').style.display = 'block';
        document.getElementById('res-name').innerText = name;
        document.getElementById('res-class').innerText = className;
        document.getElementById('score-display').innerText = `${score} / ${total}`;
        const statusDiv = document.getElementById('submit-status');

        if(GOOGLE_SCRIPT_URL) {
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST', mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name, class: className, score: score + "/" + total })
            }).then(() => {
                btn.innerText = "ƒê√É G·ª¨I ƒêI·ªÇM TH√ÄNH C√îNG";
                statusDiv.innerText = "D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o h·ªá th·ªëng.";
                statusDiv.style.color = "green";
            }).catch(e => {
                btn.innerText = "L·ªñI G·ª¨I ƒêI·ªÇM";
                statusDiv.innerText = "Kh√¥ng g·ª≠i ƒë∆∞·ª£c ƒëi·ªÉm. H√£y ch·ª•p m√†n h√¨nh!";
                statusDiv.style.color = "red";
            });
        }
        
        btn.style.display = 'none';
        window.scrollTo(0,0);
        if(window.MathJax) MathJax.typesetPromise();
    }
    
    window.onload = initQuiz;
</script>
</body>
</html>
