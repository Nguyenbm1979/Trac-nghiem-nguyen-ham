<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√†i Ki·ªÉm Tra Nguy√™n H√†m 12</title>
    <script>
    window.MathJax = {
      tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
      svg: { fontCache: 'global' },
      options: { ignoreHtmlClass: 'tex2jax_ignore', processHtmlClass: 'tex2jax_process' }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; background-color: #f4f4f9; padding: 0; margin: 0; }
        
        /* M√ÄN H√åNH CH·ªú */
        .welcome-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999; display: flex; justify-content: center; align-items: center;
            overflow-y: auto; padding: 20px;
        }
        .welcome-card {
            background: white; width: 100%; max-width: 600px;
            padding: 40px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center;
        }
        .welcome-card h1 { color: #2c3e50; margin-bottom: 10px; }
        .input-group { margin: 25px 0; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #444; }
        .input-group input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        .btn-start {
            background: #42b983; color: white; border: none; padding: 15px 40px;
            font-size: 20px; border-radius: 30px; cursor: pointer; font-weight: bold;
            transition: transform 0.2s; width: 100%;
        }
        .btn-start:hover { transform: scale(1.02); background: #3aa876; }

        /* GIAO DI·ªÜN CH√çNH */
        #main-interface { display: none; padding: 20px; max-width: 900px; margin: 0 auto; }
        
        .header-info { background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; margin-bottom: 20px; }
        .timer { font-size: 24px; font-weight: bold; color: #d9534f; }
        .student-info-display { font-weight: bold; color: #2c3e50; }
        
        .quiz-container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .question-block { margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .question-title { font-weight: bold; color: #2c3e50; margin-bottom: 10px; font-size: 1.15em; }
        
        /* CSS CHO PH·∫¶N TI√äU ƒê·ªÄ (M√î PH·ªéNG LATEX FBOX COLOR) */
        .part-header {
            color: #00796b; /* M√†u xanh ng·ªçc ƒë·∫≠m (Blue+Green) */
            border: 2px solid #00796b; /* Vi·ªÅn h·ªôp */
            background-color: #e0f2f1; /* N·ªÅn nh·∫°t b√™n trong */
            padding: 10px 20px;
            margin: 40px 0 20px 0;
            display: inline-block; /* ƒê·ªÉ khung bao quanh ch·ªØ v·ª´a v·∫∑n */
            border-radius: 5px;
            font-family: 'Segoe UI', sans-serif;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 3px 3px 0px rgba(0,0,0,0.1); /* Hi·ªáu ·ª©ng n·ªïi nh·∫π */
            width: 100%; /* ƒê·∫ßy chi·ªÅu ngang n·∫øu mu·ªën, ho·∫∑c b·ªè ƒëi ƒë·ªÉ co theo ch·ªØ */
            box-sizing: border-box;
        }

        .question-image { text-align: center; margin: 15px 0; }
        .question-image img { max-width: 100%; max-height: 400px; border: 1px solid #ddd; border-radius: 5px; }

        mjx-container { font-size: 115% !important; }
        .options label { display: block; margin-bottom: 10px; cursor: pointer; padding: 8px; border-radius: 5px; transition: background 0.2s; }
        .options label:hover { background-color: #f0f8ff; }
        
        .tf-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .tf-table th, .tf-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        
        .btn-submit { display: block; width: 100%; padding: 15px; background: #3498db; color: white; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; margin-top: 20px; font-weight: bold; }
        .btn-submit:hover { background: #2980b9; }
        
        /* K·∫æT QU·∫¢ */
        .result-box { display: none; background: #e8f5e9; border: 2px solid #4caf50; padding: 20px; border-radius: 8px; margin-top: 20px; text-align: center; }
        .result-score { font-size: 32px; font-weight: bold; color: #2e7d32; margin: 10px 0; }
        .correct-ans { color: #2e7d32; font-weight: bold; background: #e8f5e9; padding: 5px; display: inline-block; margin-top: 5px; border: 1px solid #a5d6a7; border-radius: 4px;}
        .wrong-ans { color: #c62828; text-decoration: line-through; margin-right: 10px; opacity: 0.7;}
        .feedback { font-size: 0.95em; margin-top: 10px; color: #333; background: #fff3cd; padding: 10px; border-radius: 5px; display: none; border: 1px solid #ffeeba; }
        .show-feedback .feedback { display: block; }
    </style>
</head>
<body>

    <div class="welcome-overlay" id="welcome-screen">
        <div class="welcome-card">
            <h1>B√ÄI KI·ªÇM TRA NGUY√äN H√ÄM 12</h1>
            <p>Gi√°o vi√™n: <b>Th·∫ßy Nguy·ªÖn B√¨nh Nguy√™n</b></p>
            <p>Th·ªùi gian: <b style="color:#d9534f">90 ph√∫t</b> | S·ªë c√¢u: <b>22 c√¢u</b></p>
            <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
            <p><i>"Ch√∫c c√°c em b√¨nh tƒ©nh, t·ª± tin v√† l√†m b√†i ƒë·∫°t k·∫øt qu·∫£ cao nh·∫•t!"</i></p>

            <div class="input-group">
                <label>H·ªç v√† t√™n h·ªçc sinh (*)</label>
                <input type="text" id="input-name" placeholder="Nh·∫≠p h·ªç t√™n...">
            </div>
            <div class="input-group">
                <label>L·ªõp (*)</label>
                <input type="text" id="input-class" placeholder="V√≠ d·ª•: 12A1">
            </div>
            <button class="btn-start" onclick="startQuizNow()">B·∫ÆT ƒê·∫¶U L√ÄM B√ÄI</button>
        </div>
    </div>

    <div id="main-interface">
        <div class="header-info">
            <div class="student-info-display">
                <span id="display-name">HS</span> - <span id="display-class">L·ªõp</span>
            </div>
            <div class="timer" id="timer">90:00</div>
        </div>

        <div id="result-area" class="result-box">
            <h3>K·∫æT QU·∫¢ B√ÄI L√ÄM</h3>
            <div class="result-score" id="score-display">0 / 0</div>
            <div id="submit-status" style="margin-top:10px; font-style:italic;"></div>
            <p>K√©o xu·ªëng d∆∞·ªõi ƒë·ªÉ xem ƒë√°p √°n chi ti·∫øt.</p>
        </div>

        <div class="quiz-container" id="quiz-body"></div>

        <button class="btn-submit" onclick="checkBeforeSubmit()" id="btn-submit">N·ªòP B√ÄI</button>
    </div>

<script>
    // üëá LINK GOOGLE SCRIPT C·ª¶A B·∫†N (GI·ªÆ NGUY√äN) üëá
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw9AvPfuJ53SMG-AIdP9SBL6LThFM-r8DRphGwSqRutArucIK5jxf4BxzTHY2SIBJE/exec'; 

    // D·ªÆ LI·ªÜU C√ÇU H·ªéI
    const questions = [
        // --- PH·∫¶N 1 (12 C√ÇU) ---
        { type: 'mcq', q: 'C√¢u 1: H·ªç nguy√™n h√†m c·ªßa h√†m s·ªë $f(x)=x^3$ l√†', options: ['$4x^4+C$', '$3x^2+C$', '$x^4+C$', '$\\dfrac{1}{4}x^4+C$'], ans: 3, explain: 'Ta c√≥ $\\displaystyle\\int x^3\\mathrm{\\,d}x=\\dfrac{1}{4}x^4+C$.' },
        { type: 'mcq', q: 'C√¢u 2: T√¨m nguy√™n h√†m c·ªßa h√†m s·ªë $ f(x)=2\\sin x$.', options: ['$\\displaystyle\\int 2\\sin x\\mathrm{\\,d}x=-2\\cos x+C$', '$\\displaystyle\\int 2\\sin x\\mathrm{\\,d}x=2\\cos x+C$', '$\\displaystyle\\int 2\\sin x\\mathrm{\\,d}x=\\sin^2x+C$', '$\\displaystyle\\int 2\\sin x\\mathrm{\\,d}x=\\sin 2x+C$'], ans: 0, explain: 'Nguy√™n h√†m sin l√† -cos.' },
        { type: 'mcq', q: 'C√¢u 3: H·ªç nguy√™n h√†m c·ªßa h√†m s·ªë $f(x)=\\mathrm{e}^x+x$ l√†', options: ['$\\mathrm{e}^x+1+C$', '$\\mathrm{e}^x+x^2+C$', '$\\mathrm{e}^x+\\dfrac{1}{2}{x^2}+C$', '$\\dfrac{1}{x+1}{\\mathrm{e}^x}+\\dfrac{1}{2}{x^2}+C$'], ans: 2, explain: '$\\int (e^x+x)dx = e^x + x^2/2 + C$' },
        { type: 'mcq', q: 'C√¢u 4: H·ªç nguy√™n h√†m c·ªßa h√†m s·ªë $y=x^2-3x+\\dfrac{1}{x}$ l√†', options: ['$\\dfrac{x^3}{3}-\\dfrac{3x^2}{2}-\\ln\\left|x\\right|+C$', '$\\dfrac{x^3}{3}-\\dfrac{3x^2}{2}+\\ln x+C$', '$\\dfrac{x^3}{3}-\\dfrac{3x^2}{2}+\\ln\\left|x\\right|+C$', '$\\dfrac{x^3}{3}-\\dfrac{3x^2}{2}+\\dfrac{1}{x^2}+C$'], ans: 2, explain: 'Nguy√™n h√†m 1/x l√† ln|x|.' },
        { type: 'mcq', q: 'C√¢u 5: T√¨m nguy√™n h√†m c·ªßa h√†m s·ªë $f(x)=\\dfrac{x^4+2}{x^2}$.', options: ['$\\dfrac{x^3}{3}-\\dfrac{1}{x}+C$', '$\\dfrac{x^3}{3}+\\dfrac{2}{x}+C$', '$\\dfrac{x^3}{3}+\\dfrac{1}{x}+C$', '$\\dfrac{x^3}{3}-\\dfrac{2}{x}+C$'], ans: 3, explain: 'T√°ch th√†nh $x^2 + 2x^{-2}$.' },
        { type: 'mcq', q: 'C√¢u 6: Cho h√†m s·ªë $ f(x)=1-\\dfrac{1}{\\cos^2 x}$. H√†m s·ªë $f(x)$ c√≥ h·ªç nguy√™n h√†m l√† h√†m s·ªë n√†o sau ƒë√¢y?', options: ['$x+\\tan x+C$', '$x+\\cot x+C$', '$x-\\tan x+C$', '$x-\\cot x+C$'], ans: 2, explain: 'Nguy√™n h√†m $1/\\cos^2x$ l√† $\\tan x$.' },
        { type: 'mcq', q: 'C√¢u 7: H·ªç nguy√™n h√†m c·ªßa h√†m s·ªë $f(x)=\\cos x+6x$ l√†', options: ['$\\sin x+3x^2+C$', '$-\\sin x+3x^2+C$', '$\\sin x+6x^2+C$', '$-\\sin x+C$'], ans: 0, explain: '$\\int \\cos x = \\sin x$.' },
        { type: 'mcq', q: 'C√¢u 8: $\\displaystyle\\int f(x)\\mathrm{\\,d}x=4x^3+x^2+C$ th√¨ h√†m s·ªë $f(x)$ b·∫±ng', options: ['$f(x)=x^4+\\dfrac{x^3}{3}+Cx$', '$f(x)=12x^2+2x+C$', '$f(x)=12x^2+2x$', '$f(x)=x^4+\\dfrac{x^3}{3}$'], ans: 2, explain: 'ƒê·∫°o h√†m c·ªßa $4x^3+x^2$.' },
        { type: 'mcq', q: 'C√¢u 9: H√†m s·ªë $F(x)=2x+3^x-1$ l√† nguy√™n h√†m c·ªßa h√†m s·ªë n√†o?', options: ['$f(x)=2+3^x\\ln 3$', '$f(x)=x^2+\\dfrac{3^x}{\\ln 3}-x+C$', '$f(x)=x^2+\\dfrac{3^x}{\\ln 3}-x$', '$f(x)=2+3^x\\ln 3+C$'], ans: 0, explain: 'ƒê·∫°o h√†m $3^x$ l√† $3^x \\ln 3$.' },
        { type: 'mcq', q: 'C√¢u 10: Cho $\\displaystyle\\int \\ln x \\mathrm{\\,d}x=F(x)+C$. Kh·∫≥ng ƒë·ªãnh ƒë√∫ng?', options: ['$F\'(x)=\\dfrac{1}{x}$', '$F\'(x)=\\dfrac{1}{x}+C$', '$F\'(x)=\\ln x$', '$F\'(x)=\\ln x+1$'], ans: 2, explain: '$F\'(x)$ ch√≠nh l√† h√†m d∆∞·ªõi d·∫•u t√≠ch ph√¢n.' },
        { type: 'mcq', q: 'C√¢u 11: Cho $F(x)$ l√† m·ªôt nguy√™n h√†m c·ªßa $f(x)=\\mathrm{e}^x+2x$ th·ªèa m√£n $F(0)=\\dfrac{3}{2}$. T√¨m $F(x)$.', options: ['$F(x)=\\mathrm{e}^x+x^2+\\dfrac{1}{2}$', '$F(x)=\\mathrm{e}^x+x^2+\\dfrac{5}{2}$', '$F(x)=\\mathrm{e}^x+x^2+\\dfrac{3}{2}$', '$F(x)=2\\mathrm{e}^x+x^2-\\dfrac{1}{2}$'], ans: 0, explain: '$1 + C = 3/2 \\Rightarrow C = 1/2$.' },
        { type: 'mcq', q: 'C√¢u 12: M·ªôt vi√™n ƒë·∫°n ƒë∆∞·ª£c b·∫Øn l√™n $v(t)=160-9{,}8t$. ƒê·ªô cao sau $t=10$ gi√¢y l√†', options: ['$620$ m', '$1\\,240$ m', '$555$ m', '$1\\,110$ m'], ans: 3, explain: 'Thay $t=10$ v√†o nguy√™n h√†m.' },

        // --- PH·∫¶N 2 (4 C√ÇU ƒê√öNG SAI) ---
        { type: 'tf', q: 'C√¢u 13: Cho h√†m s·ªë $y=h(x)$ c√≥ ƒë·∫°o h√†m $h\'(x)=3x^2$ v√† h√†m s·ªë $y=g(x)$ c√≥ ƒë·∫°o h√†m $g\'(x)=\\mathrm{e}^x$.', items: [{sub: 'H√†m s·ªë $y=h(x)=6x+C_1$', ans: 'F'}, {sub: 'H√†m s·ªë $y=g(x)=\\mathrm{e}^x+C_2$', ans: 'T'}, {sub: '$ I=\\displaystyle\\int \\left[xh\'(x)+2025\\right]\\mathrm{\\,d}x=\\dfrac{3}{4}{x^4}+2025x+C$', ans: 'T'}, {sub: 'Cho $ f\'(x)=3x^2+\\mathrm{e}^x+m-1$. Cho $f(0)=2; f(1)=2\\mathrm{e}$ th√¨ $m\\in (1;2)$', ans: 'T'}], explain: 'Chi ti·∫øt trong file ƒë√°p √°n.' },
        { type: 'tf', q: 'C√¢u 14: Cho c√°c h√†m s·ªë $g(x)=\\sin x$ , $h(x)=\\cos x$.', items: [{sub: '$\\displaystyle\\int \\left[2g(x)-3h(x)\\right]\\mathrm{\\,d}x=3\\displaystyle\\int g(x)\\mathrm{\\,d}x-2\\displaystyle\\int h(x)\\mathrm{\\,d}x$', ans: 'F'}, {sub: 'M·ªôt nguy√™n c·ªßa h√†m s·ªë $g(x)$ l√† $-\\cos x$', ans: 'T'}, {sub: 'H·ªç nguy√™n c·ªßa $h(x)+2\\sqrt{x}$ l√† $\\sin x+\\dfrac{3}{2}\\sqrt{x^3}+C$', ans: 'F'}, {sub: 'H·ªç nguy√™n h√†m c·ªßa $f(x)=g(x)\\cdot h^2(x)$ l√† $F(x)=-\\dfrac{1}{3}\\cos^3 x+C$', ans: 'T'}], explain: 'Chi ti·∫øt trong file ƒë√°p √°n.' },
        { type: 'tf', q: 'C√¢u 15: Cho c√°c h√†m s·ªë $g(x)=\\dfrac{1}{x^2}$, $h(x)=\\ln (x+3)$.', items: [{sub: 'Bi·∫øt $G(x)$ l√† m·ªôt nguy√™n h√†m c·ªßa $g(x)$ v√† $ G(1)=1$. Khi ƒë√≥ $ G(2)=-\\dfrac{1}{2}$', ans: 'F'}, {sub: '$ J=\\displaystyle\\int \\left[h(x)+\\ln\\dfrac{1}{x+3}+2025\\right]\\mathrm{\\,d}x=2025x+C$', ans: 'T'}, {sub: '$I=\\displaystyle\\int x\\cdot h\'(x)\\mathrm{\\,d}x=x-\\ln (x+3)+C$', ans: 'F'}, {sub: 'Gi·∫£ s·ª≠ $F(1)=\\dfrac{1}{4}$ th√¨ $F(-1)=-\\dfrac{7}{4}$', ans: 'T'}], explain: 'Chi ti·∫øt trong file ƒë√°p √°n.' },
        { type: 'tf', q: 'C√¢u 16: Cho c√°c h√†m s·ªë $g(x)=\\mathrm{e}^{\\dfrac{x}{2}}$, $h(x)=2x^3+5x^2-2x+4$.', items: [{sub: '$\\displaystyle\\int \\left[2g(x)+3h(x)\\right]\\mathrm{\\,d}x=2\\displaystyle\\int g(x)\\mathrm{\\,d}x+3\\displaystyle\\int h(x)\\mathrm{\\,d}x$', ans: 'T'}, {sub: 'M·ªôt nguy√™n c·ªßa h√†m s·ªë $3\\cdot g^2(x)$ l√† $3\\mathrm{e}^x$', ans: 'T'}, {sub: 'H·ªç nguy√™n c·ªßa $h(x)$ l√† $\\dfrac{1}{4}{x^3}+\\dfrac{5}{3}{x^3}-x^2+C$', ans: 'F'}, {sub: 'Bi·∫øt $\\displaystyle\\int g^4(x)\\cdot h(x)\\mathrm{\\,d}x=(a{x^3}+b{x^2}+cx+d)\\mathrm{e}^{2x}+C$ th√¨ $ a+b+c+d=3$', ans: 'T'}], explain: 'Chi ti·∫øt trong file ƒë√°p √°n.' },

        // --- PH·∫¶N 3 (6 C√ÇU TR·∫¢ L·ªúI NG·∫ÆN) ---
        { type: 'short', q: 'C√¢u 17: Cho $F(x)$ l√† m·ªôt nguy√™n h√†m c·ªßa h√†m $f(x)=\\dfrac{\\cos 2x}{\\sin x+\\cos x}$ th·ªèa m√£n $F(0)=1$. T√≠nh $F(\\pi)$.', ans: '-1', explain: '-1' },
        { type: 'short', q: 'C√¢u 18: $F(x)$ l√† m·ªôt nguy√™n h√†m c·ªßa h√†m s·ªë $f(x)=2^x$, th·ªèa m√£n $ F(0)=\\dfrac{1}{\\ln 2}$. T√≠nh $ T=a+b-2c$.', ans: '2025', explain: '2025' },
        { type: 'short', q: 'C√¢u 19: $F(x)$ l√† nguy√™n h√†m c·ªßa $f(x)=\\dfrac{(3x-1)^2}{x^2}$, ƒë·ªì th·ªã $y=F(x)$ ƒëi qua $M(1;-2)$. T√≠nh $F\\left(\\mathrm{e}^2\\right)$.', ans: '44,4', explain: '44,4' },
        { type: 'short', q: 'C√¢u 20: √î t√¥ ch·∫°y $90$ km/h, ƒë·∫°p phanh ch·∫≠m d·∫ßn. Qu√£ng ƒë∆∞·ªùng t·ª´ l√∫c ph√°t hi·ªán ch∆∞·ªõng ng·∫°i v·∫≠t ƒë·∫øn khi d·ª´ng h·∫≥n l√† bao nhi√™u m√©t?', ans: '100', explain: '100' },
        { type: 'short', q: 'C√¢u 21: Vi khu·∫©n tƒÉng tr∆∞·ªüng $P\'(t)=k\\sqrt{t}$. Ban ƒë·∫ßu 500 con, sau 1 ng√†y 600 con. T√≠nh s·ªë l∆∞·ª£ng sau 9 ng√†y.', ans: '3200', explain: '3200' },
        { type: 'short', q: 'C√¢u 22: C√¢y c√† chua cao 5cm. T·ªëc ƒë·ªô l·ªõn $ v(t)=-0{,}1t^3+t^2$. Chi·ªÅu cao max l√† bao nhi√™u?', ans: '54,4', explain: '54,4' }
    ];

    // LOGIC CH∆Ø∆†NG TR√åNH
    const quizBody = document.getElementById('quiz-body');
    let timerDuration = 90 * 60; 
    let studentName = '', studentClass = '', timerInterval = null;

    function initQuiz() {
        let html = '';
        questions.forEach((q, index) => {
            // --- T·∫†O TI√äU ƒê·ªÄ PH·∫¶N (THEO Y√äU C·∫¶U TRANG TR√ç M·ªöI) ---
            if (index === 0) {
                html += `<div class="part-header">PH·∫¶N 1. Tr·∫Øc nghi·ªám 4 ph∆∞∆°ng √°n l·ª±a ch·ªçn</div>`;
            } else if (index === 12) { // B·∫Øt ƒë·∫ßu c√¢u 13
                html += `<div class="part-header">PH·∫¶N 2. Tr·∫Øc nghi·ªám ch·ªçn ƒë√∫ng sai</div>`;
            } else if (index === 16) { // B·∫Øt ƒë·∫ßu c√¢u 17
                html += `<div class="part-header">PH·∫¶N 3. Tr·∫Øc nghi·ªám tr·∫£ l·ªùi ng·∫Øn</div>`;
            }
            // -----------------------------------------------------

            html += `<div class="question-block" id="q-${index}">`;
            html += `<div class="question-title">${q.q}</div>`;
            if(q.img) html += `<div class="question-image"><img src="${q.img}" alt="H√¨nh c√¢u ${index+1}"></div>`;

            if(q.type === 'mcq') {
                html += `<div class="options">`;
                q.options.forEach((opt, i) => html += `<label><input type="radio" name="q${index}" value="${i}"> ${opt}</label>`);
                html += `</div><div class="feedback"><b>ƒê√°p √°n ƒë√∫ng:</b> ${q.options[q.ans]}<br><i>${q.explain}</i></div>`;
            } else if (q.type === 'tf') {
                html += `<table class="tf-table"><tr><th>M·ªánh ƒë·ªÅ</th><th>ƒê</th><th>S</th></tr>`;
                q.items.forEach((item, subIndex) => html += `<tr><td>${item.sub}</td><td style="text-align:center"><input type="radio" name="q${index}_${subIndex}" value="T"></td><td style="text-align:center"><input type="radio" name="q${index}_${subIndex}" value="F"></td></tr>`);
                html += `</table><div class="feedback"><b>ƒê√°p √°n:</b> ${q.items.map(i => i.ans).join(', ')}<br><i>${q.explain}</i></div>`;
            } else if (q.type === 'short') {
                html += `<input type="text" id="in-${index}" placeholder="Nh·∫≠p k·∫øt qu·∫£..."><div class="feedback"><b>ƒê√°p √°n ƒë√∫ng:</b> ${q.ans}<br><i>${q.explain}</i></div>`;
            }
            html += `</div>`;
        });
        quizBody.innerHTML = html;
        if(window.MathJax && MathJax.typesetPromise) MathJax.typesetPromise();
    }

    function startQuizNow() {
        const nameInput = document.getElementById('input-name').value.trim();
        const classInput = document.getElementById('input-class').value.trim();
        if(!nameInput || !classInput) { alert('Em vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß H·ªç t√™n v√† L·ªõp!'); return; }
        
        studentName = nameInput; studentClass = classInput;
        document.getElementById('display-name').textContent = studentName;
        document.getElementById('display-class').textContent = studentClass;
        document.getElementById('welcome-screen').style.display = 'none';
        document.getElementById('main-interface').style.display = 'block';
        
        const display = document.getElementById('timer');
        timerInterval = setInterval(() => {
            let m = parseInt(timerDuration / 60, 10);
            let s = parseInt(timerDuration % 60, 10);
            display.textContent = (m<10?"0"+m:m) + ":" + (s<10?"0"+s:s);
            if (--timerDuration < 0) { clearInterval(timerInterval); submitQuiz(); }
        }, 1000);
    }

    function checkBeforeSubmit() {
        let unanswered = [];
        questions.forEach((q, index) => {
            let done = false;
            if (q.type === 'mcq') { if (document.querySelector(`input[name="q${index}"]:checked`)) done = true; } 
            else if (q.type === 'tf') { 
                let c = 0; q.items.forEach((it, sub) => { if(document.querySelector(`input[name="q${index}_${sub}"]:checked`)) c++; });
                if(c === q.items.length) done = true;
            } 
            else if (q.type === 'short') { if (document.getElementById(`in-${index}`).value.trim().length > 0) done = true; }
            if (!done) unanswered.push(index + 1);
        });

        if (unanswered.length > 0) {
            if (confirm("Em ch∆∞a ho√†n th√†nh c√°c c√¢u: " + unanswered.join(", ") + ".\n\nEm c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i lu√¥n kh√¥ng?")) submitQuiz();
        } else {
            if (confirm("Em ƒë√£ l√†m xong h·∫øt. Em c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i kh√¥ng?")) submitQuiz();
        }
    }

    function submitQuiz() {
        clearInterval(timerInterval);
        const btn = document.getElementById('btn-submit');
        btn.disabled = true; btn.innerText = "ƒêANG CH·∫§M V√Ä G·ª¨I ƒêI·ªÇM...";

        let score = 0, total = 0;
        questions.forEach((q, index) => {
            const block = document.getElementById(`q-${index}`);
            block.classList.add('show-feedback');
            if(q.type === 'mcq') {
                total++; const sel = document.querySelector(`input[name="q${index}"]:checked`);
                if(sel && parseInt(sel.value) === q.ans) { score++; block.insertAdjacentHTML('beforeend', '<div class="correct-ans">ƒê√∫ng (+1ƒë)</div>'); }
                else block.insertAdjacentHTML('beforeend', '<div class="wrong-ans">Sai</div>');
            } else if(q.type === 'tf') {
                q.items.forEach((item, sub) => {
                    total+=0.25; const sel = document.querySelector(`input[name="q${index}_${sub}"]:checked`);
                    if(sel && sel.value === item.ans) score+=0.25;
                });
            } else if(q.type === 'short') {
                total++; const val = document.getElementById(`in-${index}`).value.trim().replace(',', '.');
                if(val === q.ans.replace(',', '.')) { score++; block.insertAdjacentHTML('beforeend', '<div class="correct-ans">ƒê√∫ng (+1ƒë)</div>'); }
                else block.insertAdjacentHTML('beforeend', '<div class="wrong-ans">Sai</div>');
            }
        });

        document.getElementById('result-area').style.display = 'block';
        document.getElementById('score-display').innerText = `${score} / ${total}`;
        const statusDiv = document.getElementById('submit-status');

        if(GOOGLE_SCRIPT_URL) {
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: studentName, class: studentClass, score: score + "/" + total })
            }).then(() => {
                btn.innerText = "ƒê√É G·ª¨I ƒêI·ªÇM TH√ÄNH C√îNG";
                statusDiv.innerText = "D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o h·ªá th·ªëng."; statusDiv.style.color = "green";
            }).catch(e => { btn.innerText = "L·ªñI G·ª¨I ƒêI·ªÇM"; statusDiv.innerText = "L·ªói. Ch·ª•p m√†n h√¨nh g·ª≠i th·∫ßy!"; statusDiv.style.color = "red"; });
        }
        btn.style.display = 'none'; window.scrollTo(0,0);
        if(window.MathJax) MathJax.typesetPromise();
    }
    
    window.onload = initQuiz;
</script>
</body>
</html>
