<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Tool v8.0 (Security Edition)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }, svg: { fontCache: 'global' } };</script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #eceff1; padding: 20px; color: #37474f; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h1 { color: #00695c; text-align: center; border-bottom: 3px solid #004d40; padding-bottom: 10px; margin-bottom: 20px; }

        /* C·∫§U H√åNH */
        .config-box { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #90caf9; }
        .row { display: flex; gap: 15px; margin-bottom: 10px; } .col { flex: 1; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        label { font-weight: 600; font-size: 0.9em; display: block; margin-bottom: 3px; }

        /* EDITOR */
        .paste-area textarea { width: 100%; height: 100px; padding: 10px; border: 2px dashed #009688; border-radius: 6px; font-family: monospace; color: #00695c; }
        .q-item { border: 1px solid #cfd8dc; margin-bottom: 20px; border-radius: 8px; overflow: hidden; background: #fff; }
        .q-toolbar { background: #f5f5f5; padding: 8px 15px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; }
        .q-body { display: flex; border-bottom: 1px solid #eee; }
        .q-editor { flex: 1; padding: 15px; border-right: 1px solid #eee; background: #fafafa; }
        .q-preview { flex: 1; padding: 15px; background: #fff; }
        .q-editor textarea { width: 100%; height: 80px; padding: 8px; border: 1px solid #ccc; font-family: monospace; }
        
        /* HI·ªÇN TH·ªä */
        .tf-table { width: 100%; margin-top: 10px; border-collapse: collapse; font-size: 0.9em; }
        .tf-table td { padding: 6px; border-bottom: 1px solid #eee; }
        .badge-true { background: #c8e6c9; color: #2e7d32; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .badge-false { background: #ffcdd2; color: #c62828; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        
        /* ·∫¢NH */
        .img-control { margin-top: 10px; padding: 8px; background: #e8f5e9; border: 1px dashed #4caf50; border-radius: 4px; display: flex; align-items: center; gap: 10px; }
        .preview-img { max-width: 100%; height: auto; display: block; margin: 10px auto; border: 1px solid #ddd; }

        /* BUTTONS */
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; }
        .btn-green { background: #2e7d32; } .btn-blue { background: #1565c0; } .btn-red { background: #c62828; }
        
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 999; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; }
        #log-text { margin-top: 15px; font-family: monospace; color: #80cbc4; white-space: pre-wrap; max-height: 200px; overflow-y: auto; text-align: left; width: 80%; background: #263238; padding: 15px; border-radius: 8px; }
    </style>
</head>
<body>

<div id="loading-overlay"><div style="font-size: 50px;">üöÄ</div><h2 id="loading-title">ƒêANG X·ª¨ L√ù...</h2><div id="log-text"></div></div>

<div class="container">
    <h1>ADMIN TOOL v8.0 (B·∫¢O M·∫¨T & KI·ªÇM DUY·ªÜT)</h1>

    <div class="config-box">
        <div class="row">
            <div class="col"><label>Username</label><input type="text" id="gh-user"></div>
            <div class="col"><label>Repository</label><input type="text" id="gh-repo"></div>
            <div class="col"><label>Token</label><input type="password" id="gh-token"></div>
        </div>
        <div class="row"><div class="col"><button class="btn btn-blue" onclick="saveConfig()">üíæ L∆∞u C·∫•u H√¨nh</button></div></div>
    </div>

    <div class="config-box" style="background:#fff3e0; border-color:#ffe0b2">
        <div class="row">
            <div class="col"><label>M√¥n</label><select id="exam-subject"><option value="Toan">To√°n</option><option value="Su">L·ªãch S·ª≠</option><option value="Ly">V·∫≠t L√Ω</option><option value="Hoa">H√≥a H·ªçc</option><option value="Sinh">Sinh</option><option value="Dia">ƒê·ªãa</option><option value="Anh">Anh</option><option value="GDCD">GDCD</option></select></div>
            <div class="col"><label>Kh·ªëi</label><select id="exam-grade"><option value="12">12</option><option value="11">11</option><option value="10">10</option><option value="12OT">√în Thi</option></select></div>
            <div class="col"><label>Th·ªùi gian (ph√∫t)</label><input type="number" id="exam-time" value="45"></div>
        </div>
        <div class="row">
            <div class="col"><label>M√£ ƒê·ªÅ (ID)</label><input type="text" id="exam-id" placeholder="de-toan-hk1"></div>
            <div class="col" style="flex:2"><label>Ti√™u ƒê·ªÅ</label><input type="text" id="exam-title" placeholder="Ki·ªÉm tra..."></div>
            <div class="col"><label>M·∫≠t kh·∫©u (T√πy ch·ªçn)</label><input type="text" id="exam-pass" oninput="hashPass()"></div>
            <input type="hidden" id="exam-pass-hash">
        </div>
        <div class="row" style="margin-top:10px; background:#fff; padding:10px; border-radius:4px">
            <div class="col" style="display:flex; align-items:center; gap:10px">
                <input type="checkbox" id="secure-mode" style="width:20px; height:20px" checked>
                <label for="secure-mode" style="color:#c62828; cursor:pointer">üîí M√É H√ìA ƒê√ÅP √ÅN KHI XU·∫§T B·∫¢N (Ch·ªëng soi code)</label>
            </div>
        </div>
    </div>

    <div class="paste-area">
        <label>üì• D√°n code JSON t·ª´ Gemini:</label>
        <textarea id="json-input" placeholder='[ { "type": "tf", ... } ]'></textarea>
        <button class="btn btn-green" style="width:100%; margin-top:10px" onclick="parseData()">‚ö° B∆Ø·ªöC 1: PH√ÇN T√çCH & KI·ªÇM TRA</button>
    </div>

    <div id="editor-area" style="display:none; margin-top:20px">
        <h3 style="color:#2e7d32; border-bottom:2px solid #eee">üîç B∆Ø·ªöC 2: KI·ªÇM TRA & CH√àN ·∫¢NH</h3>
        <div id="questions-list"></div>
        <div style="text-align:right; margin-top:30px">
            <button class="btn btn-red" style="font-size:1.2em; padding:15px 30px" onclick="publishExam()">üöÄ B∆Ø·ªöC 3: XU·∫§T B·∫¢N ƒê·ªÄ THI</button>
        </div>
    </div>
</div>

<script>
    let questions = [];

    window.onload = () => { ['gh-user','gh-repo','gh-token'].forEach(id => { if(localStorage.getItem(id)) document.getElementById(id).value = localStorage.getItem(id); }); };
    function saveConfig() { ['gh-user','gh-repo','gh-token'].forEach(id => localStorage.setItem(id, document.getElementById(id).value.trim())); alert("ƒê√£ l∆∞u!"); }
    function hashPass() { let p=document.getElementById('exam-pass').value.trim(); document.getElementById('exam-pass-hash').value = p?CryptoJS.MD5(p).toString():""; }

    function parseData() {
        let text = document.getElementById('json-input').value.trim();
        if(!text) return alert("Vui l√≤ng d√°n code!");
        let start = text.indexOf('['), end = text.lastIndexOf(']');
        if(start !== -1 && end > start) text = text.substring(start, end + 1);
        try {
            let data = new Function("return " + text)();
            questions = Array.isArray(data) ? data : (data.questions || []);
            questions.forEach(q => { q.id = Date.now()+Math.random(); q.localImage=null; q.localPreview=null; });
            document.getElementById('editor-area').style.display = 'block';
            renderEditor();
        } catch(e) { alert("L·ªói JSON: " + e.message); }
    }

    function renderEditor() {
        const container = document.getElementById('questions-list');
        container.innerHTML = "";
        questions.forEach((q, idx) => {
            let div = document.createElement('div'); div.className = 'q-item';
            div.innerHTML = `
                <div class="q-toolbar"><span><b>C√¢u ${idx+1}</b> (${q.type})</span> <button class="btn btn-red" style="padding:2px 8px" onclick="removeQ(${idx})">X√≥a</button></div>
                <div class="q-body">
                    <div class="q-editor">
                        <textarea oninput="updatePreview(${idx}, this.value)">${q.q}</textarea>
                        <div class="img-control">
                            <label class="btn btn-blue" style="cursor:pointer; margin:0">üì∑ Ch·ªçn ·∫¢nh <input type="file" style="display:none" accept="image/*" onchange="selectImage(this, ${idx})"></label>
                            <span id="file-name-${idx}" style="font-size:0.8em; margin-left:10px"></span>
                        </div>
                    </div>
                    <div class="q-preview" id="preview-box-${idx}"></div>
                </div>`;
            container.appendChild(div);
            updatePreview(idx, q.q);
        });
    }

    function selectImage(input, idx) {
        const file = input.files[0]; if(!file) return;
        questions[idx].localImage = file; questions[idx].localPreview = URL.createObjectURL(file);
        document.getElementById(`file-name-${idx}`).innerText = "üìÇ " + file.name;
        updatePreview(idx, questions[idx].q);
    }

    function updatePreview(idx, newContent) {
        let q = questions[idx]; q.q = newContent;
        const box = document.getElementById(`preview-box-${idx}`);
        let html = newContent;
        let imgSrc = q.localPreview || q.img;
        if(imgSrc) html = html.includes('[IMG]') ? html.replace('[IMG]', `<img src="${imgSrc}" class="preview-img">`) : html + `<br><img src="${imgSrc}" class="preview-img">`;
        
        html = `<div>${html}</div>`;
        if(q.type === 'mcq' && q.options) html += `<div style="margin-top:10px; color:#555">` + q.options.map((o,i)=> `<b>${String.fromCharCode(65+i)}.</b> ${o}`).join('<br>') + `</div>`;
        else if(q.type === 'tf' && q.items) {
            html += `<table class="tf-table">` + q.items.map((it,i)=> 
                `<tr><td><b>${i+1})</b></td><td>${it.sub}</td><td>${it.ans==='T'?'<span class="badge-true">ƒê√öNG</span>':'<span class="badge-false">SAI</span>'}</td></tr>`
            ).join('') + `</table>`;
        } else if(q.type === 'short') html += `<div style="margin-top:10px; color:#1565c0"><b>ƒêS:</b> ${q.ans}</div>`;
        
        box.innerHTML = html;
        if(window.MathJax) MathJax.typesetPromise([box]);
    }

    function removeQ(idx) { if(confirm("X√≥a?")) { questions.splice(idx, 1); renderEditor(); } }

    // --- UPLOAD V·ªöI M√É H√ìA ---
    async function publishExam() {
        const user = document.getElementById('gh-user').value.trim();
        const repo = document.getElementById('gh-repo').value.trim();
        const token = document.getElementById('gh-token').value.trim();
        const examId = document.getElementById('exam-id').value.trim();
        const secureMode = document.getElementById('secure-mode').checked; // KI·ªÇM TRA CH·∫æ ƒê·ªò B·∫¢O M·∫¨T

        if(!user || !repo || !token || !examId) return alert("Thi·∫øu th√¥ng tin!");
        if(!confirm(secureMode ? "ƒêang b·∫≠t ch·∫ø ƒë·ªô M√É H√ìA ƒê√ÅP √ÅN. Th·∫ßy c√≥ ch·∫Øc ch·∫Øn xu·∫•t b·∫£n?" : "Xu·∫•t b·∫£n kh√¥ng m√£ h√≥a?")) return;

        const overlay = document.getElementById('loading-overlay');
        const logBox = document.getElementById('log-text');
        overlay.style.display = 'flex'; logBox.innerHTML = "‚è≥ ƒêang kh·ªüi t·∫°o...";
        function log(msg) { logBox.innerHTML += "\n" + msg; logBox.scrollTop = logBox.scrollHeight; }

        try {
            // 1. Upload ·∫¢nh
            for (let i = 0; i < questions.length; i++) {
                if (questions[i].localImage) {
                    log(`‚û§ Upload ·∫£nh c√¢u ${i+1}...`);
                    const ext = questions[i].localImage.name.split('.').pop();
                    const fileName = `${examId}-q${i+1}-${Date.now()}.${ext}`;
                    const base64 = await toBase64(questions[i].localImage);
                    await uploadToGitHub(user, repo, token, `images/${fileName}`, base64, true);
                    questions[i].img = `images/${fileName}`;
                    questions[i].q = questions[i].q.replace('[IMG]', '');
                }
            }

            // 2. M√É H√ìA ƒê√ÅP √ÅN (QUAN TR·ªåNG)
            let finalQuestions = JSON.parse(JSON.stringify(questions)); // Clone ƒë·ªÉ kh√¥ng ·∫£nh h∆∞·ªüng b·∫£n ƒëang s·ª≠a
            if (secureMode) {
                log("‚û§ ƒêang m√£ h√≥a ƒë√°p √°n (MD5)...");
                finalQuestions.forEach(q => {
                    if(q.type === 'mcq') q.ans = CryptoJS.MD5(String(q.ans)).toString(); // M√£ h√≥a s·ªë 0,1,2,3
                    else if(q.type === 'tf') {
                        q.items.forEach(it => it.ans = CryptoJS.MD5(it.ans).toString()); // M√£ h√≥a "T"/"F"
                    }
                    else if(q.type === 'short') q.ans = CryptoJS.MD5(String(q.ans).trim().toLowerCase()).toString(); // M√£ h√≥a text
                });
            }

            // 3. Upload Data
            log(`‚û§ T·∫°o file d·ªØ li·ªáu...`);
            const examData = {
                title: document.getElementById('exam-title').value,
                subject: document.getElementById('exam-subject').value,
                grade: document.getElementById('exam-grade').value,
                time: parseInt(document.getElementById('exam-time').value),
                password: document.getElementById('exam-pass-hash').value,
                encrypted: secureMode, // C·ªù b√°o hi·ªáu ƒë·ªÅ ƒë√£ m√£ h√≥a
                scores: { mcq: 0.25, tf: 1.0, short: 0.5 },
                questions: finalQuestions
            };
            const jsContent = `window.EXAM_DATA = ${JSON.stringify(examData, null, 4)};`;
            await uploadToGitHub(user, repo, token, `data/${examId}.js`, btoa(unescape(encodeURIComponent(jsContent))), false);

            // 4. Update List
            log(`‚û§ C·∫≠p nh·∫≠t danh s√°ch...`);
            await updateListFile(user, repo, token, examId, examData);

            log(`üéâ TH√ÄNH C√îNG!`);
            alert("ƒê√£ xu·∫•t b·∫£n th√†nh c√¥ng!");
            setTimeout(() => { overlay.style.display = 'none'; }, 2000);
        } catch (err) { log(`‚ùå L·ªñI: ${err.message}`); alert("L·ªói upload!"); }
    }

    function toBase64(f) { return new Promise((r,j)=>{const d=new FileReader();d.readAsDataURL(f);d.onload=()=>r(d.result.split(',')[1]);d.onerror=e=>j(e);}); }
    async function uploadToGitHub(u,r,t,p,c,i) { 
        let s=null; try{let k=await fetch(`https://api.github.com/repos/${u}/${r}/contents/${p}`,{headers:{Authorization:`token ${t}`}});if(k.ok)s=(await k.json()).sha;}catch(e){}
        let rs=await fetch(`https://api.github.com/repos/${u}/${r}/contents/${p}`,{method:'PUT',headers:{Authorization:`token ${t}`,'Content-Type':'application/json'},body:JSON.stringify({message:i?"Img":"Data",content:c,sha:s})});
        if(!rs.ok) throw new Error("L·ªói GitHub API"); 
    }
    async function updateListFile(u,r,t,id,d) {
        let url=`https://api.github.com/repos/${u}/${r}/contents/data/list.js`, l=[], s=null;
        try{let k=await fetch(url,{headers:{Authorization:`token ${t}`}});if(k.ok){let j=await k.json();s=j.sha;l=new Function("return "+decodeURIComponent(escape(atob(j.content))).replace(/window\.EXAM_LIST\s*=\s*/,'').replace(/;$/,''))();}}catch(e){}
        l=l.filter(x=>x.id!==id); l.unshift({id:id, title:d.title, subject:d.subject, grade:d.grade, time:d.time});
        await uploadToGitHub(u,r,t,`data/list.js`,btoa(unescape(encodeURIComponent(`window.EXAM_LIST = ${JSON.stringify(l,null,4)};`))), false);
    }
</script>
</body>
</html>
