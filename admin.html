<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Tool v7.0 (Quy Tr√¨nh Ki·ªÉm Duy·ªát)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }, svg: { fontCache: 'global' } };</script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #e0ece4; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h1 { color: #004d40; text-align: center; border-bottom: 3px solid #004d40; padding-bottom: 10px; margin-bottom: 20px; }

        /* C·∫§U H√åNH & TH√îNG TIN */
        .config-box { background: #e0f2f1; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #b2dfdb; }
        .row { display: flex; gap: 15px; margin-bottom: 10px; } .col { flex: 1; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        label { font-weight: 600; font-size: 0.9em; display: block; margin-bottom: 3px; }

        /* INPUT CODE */
        .paste-area textarea { width: 100%; height: 100px; padding: 10px; border: 2px dashed #009688; border-radius: 6px; font-family: monospace; color: #00695c; }
        
        /* DANH S√ÅCH C√ÇU H·ªéI (QUAN TR·ªåNG) */
        .q-item { border: 1px solid #ddd; margin-bottom: 20px; border-radius: 8px; overflow: hidden; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .q-toolbar { background: #f5f5f5; padding: 8px 15px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .q-badge { background: #00796b; color: white; padding: 3px 8px; border-radius: 3px; font-size: 12px; font-weight: bold; }
        
        /* CHIA ƒê√îI M√ÄN H√åNH: EDITOR & PREVIEW */
        .q-body { display: flex; border-bottom: 1px solid #eee; }
        .q-editor { flex: 1; padding: 15px; border-right: 1px solid #eee; background: #fafafa; }
        .q-editor textarea { width: 100%; height: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; }
        .q-preview { flex: 1; padding: 15px; background: #fff; position: relative; }
        
        /* PH·∫¶N CH√àN ·∫¢NH */
        .img-control { margin-top: 10px; padding: 8px; background: #e8f5e9; border: 1px dashed #4caf50; border-radius: 4px; display: flex; align-items: center; gap: 10px; }
        .preview-img { max-width: 100%; height: auto; display: block; margin: 10px auto; border: 1px solid #ddd; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        /* N√öT B·∫§M */
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-green { background: #2e7d32; } .btn-blue { background: #1565c0; } .btn-red { background: #c62828; } .btn-gray { background: #607d8b; }
        
        /* LOG & LOADING */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; }
        #log-text { margin-top: 10px; font-family: monospace; color: #80cbc4; white-space: pre-wrap; max-height: 200px; overflow-y: auto; text-align: left; width: 80%; }
        
        /* Highlight placeholder [IMG] */
        .highlight-marker { background: #ffeb3b; padding: 2px 5px; border-radius: 3px; font-weight: bold; color: #d84315; font-size: 0.8em; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div style="font-size: 50px;">üöÄ</div>
    <h2 id="loading-title">ƒêANG XU·∫§T B·∫¢N...</h2>
    <div id="log-text"></div>
</div>

<div class="container">
    <h1>H·ªÜ TH·ªêNG KI·ªÇM DUY·ªÜT & XU·∫§T B·∫¢N ƒê·ªÄ THI (v7.0)</h1>

    <div class="config-box">
        <div class="row">
            <div class="col"><label>GitHub Username</label><input type="text" id="gh-user"></div>
            <div class="col"><label>Repository</label><input type="text" id="gh-repo"></div>
            <div class="col"><label>Token (ghp_...)</label><input type="password" id="gh-token"></div>
        </div>
        <div class="row">
            <div class="col"><button class="btn btn-gray" onclick="saveConfig()">üíæ L∆∞u C·∫•u H√¨nh</button></div>
        </div>
    </div>

    <div class="config-box" style="background: #fff3e0; border-color: #ffe0b2;">
        <div class="row">
            <div class="col"><label>M√¥n</label><select id="exam-subject"><option value="Toan">To√°n</option><option value="Su">L·ªãch S·ª≠</option><option value="Ly">V·∫≠t L√Ω</option><option value="Hoa">H√≥a H·ªçc</option><option value="Sinh">Sinh</option><option value="Dia">ƒê·ªãa</option><option value="Anh">Anh</option><option value="GDCD">GDCD</option></select></div>
            <div class="col"><label>Kh·ªëi</label><select id="exam-grade"><option value="12">12</option><option value="11">11</option><option value="10">10</option><option value="12OT">√în Thi</option></select></div>
            <div class="col"><label>Th·ªùi gian (ph√∫t)</label><input type="number" id="exam-time" value="45"></div>
        </div>
        <div class="row">
            <div class="col"><label>M√£ ƒê·ªÅ (ID)</label><input type="text" id="exam-id" placeholder="de-toan-hk1"></div>
            <div class="col" style="flex:2"><label>Ti√™u ƒê·ªÅ Hi·ªÉn Th·ªã</label><input type="text" id="exam-title" placeholder="Ki·ªÉm tra..."></div>
            <div class="col"><label>M·∫≠t kh·∫©u (T√πy ch·ªçn)</label><input type="text" id="exam-pass" oninput="hashPass()"></div>
            <input type="hidden" id="exam-pass-hash">
        </div>
    </div>

    <div style="margin-bottom: 20px;">
        <label>üì• D√°n code c√¢u h·ªèi t·ª´ Gemini v√†o ƒë√¢y:</label>
        <div class="paste-area">
            <textarea id="json-input" placeholder='[ { "type": "mcq", "q": "N·ªôi dung...", "options": [...] } ]'></textarea>
        </div>
        <button class="btn btn-blue" style="width:100%; margin-top:10px; padding:12px" onclick="parseData()">‚ö° B∆Ø·ªöC 1: PH√ÇN T√çCH & KI·ªÇM TRA</button>
    </div>

    <div id="editor-area" style="display:none">
        <h3 style="color:#2e7d32; border-bottom:2px solid #eee; padding-bottom:10px">üîç B∆Ø·ªöC 2: KI·ªÇM TRA & CH√àN ·∫¢NH</h3>
        <p style="font-size:0.9em; color:#666"><i>M·∫πo: G√µ <b>[IMG]</b> v√†o √¥ n·ªôi dung b√™n tr√°i ƒë·ªÉ ch·ªçn v·ªã tr√≠ hi·ªÉn th·ªã ·∫£nh b√™n ph·∫£i. N·∫øu kh√¥ng g√µ, ·∫£nh s·∫Ω t·ª± hi·ªán ·ªü cu·ªëi c√¢u.</i></p>
        
        <div id="questions-list"></div>

        <div style="text-align:right; margin-top:30px; padding-top:20px; border-top:1px solid #ccc">
            <button class="btn btn-green" style="font-size:1.2em; padding:15px 30px" onclick="publishExam()">üöÄ B∆Ø·ªöC 3: XU·∫§T B·∫¢N ƒê·ªÄ THI</button>
        </div>
    </div>

</div>

<script>
    let questions = [];

    // --- 1. CONFIG ---
    window.onload = () => {
        ['gh-user','gh-repo','gh-token'].forEach(id => {
            if(localStorage.getItem(id)) document.getElementById(id).value = localStorage.getItem(id);
        });
    };
    function saveConfig() {
        ['gh-user','gh-repo','gh-token'].forEach(id => {
            localStorage.setItem(id, document.getElementById(id).value.trim());
        });
        alert("ƒê√£ l∆∞u c·∫•u h√¨nh!");
    }
    function hashPass() {
        let p = document.getElementById('exam-pass').value.trim();
        document.getElementById('exam-pass-hash').value = p ? CryptoJS.MD5(p).toString() : "";
    }

    // --- 2. PARSE DATA ---
    function parseData() {
        let text = document.getElementById('json-input').value.trim();
        if(!text) return alert("Vui l√≤ng d√°n code v√†o!");

        // L·ªçc r√°c th√¥ng minh
        let start = text.indexOf('[');
        let end = text.lastIndexOf(']');
        if(start === -1 || end === -1) { 
            // Th·ª≠ t√¨m object ƒë∆°n l·∫ª
            start = text.indexOf('{'); end = text.lastIndexOf('}'); 
        }
        if(start !== -1 && end > start) text = text.substring(start, end + 1);

        try {
            let data = new Function("return " + text)();
            questions = Array.isArray(data) ? data : (data.questions || []);
            if(!questions.length) throw new Error("Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi");
            
            // G√°n ID v√† chu·∫©n b·ªã
            questions.forEach(q => {
                q.id = Date.now() + Math.random();
                q.localImage = null; // Ch·ª©a file ·∫£nh ch∆∞a upload
                q.localPreview = null; // Blob URL ƒë·ªÉ xem tr∆∞·ªõc
            });

            document.getElementById('editor-area').style.display = 'block';
            renderEditor();
            document.getElementById('editor-area').scrollIntoView({behavior: "smooth"});

        } catch(e) { alert("L·ªói c√∫ ph√°p: " + e.message); }
    }

    // --- 3. RENDER EDITOR (GIAO DI·ªÜN KI·ªÇM TRA) ---
    function renderEditor() {
        const container = document.getElementById('questions-list');
        container.innerHTML = "";

        questions.forEach((q, idx) => {
            let typeLabel = q.type=='mcq'?'Tr·∫Øc Nghi·ªám':(q.type=='tf'?'ƒê√∫ng/Sai':'ƒêi·ªÅn Khuy·∫øt');
            
            let div = document.createElement('div');
            div.className = 'q-item';
            div.innerHTML = `
                <div class="q-toolbar">
                    <span class="q-badge">${typeLabel}</span>
                    <b>C√¢u ${idx+1}</b>
                    <button class="btn btn-red" style="font-size:10px; padding:2px 5px" onclick="removeQ(${idx})">X√≥a</button>
                </div>
                <div class="q-body">
                    <div class="q-editor">
                        <label>N·ªôi dung c√¢u h·ªèi (G√µ [IMG] ƒë·ªÉ ƒë·∫∑t v·ªã tr√≠ ·∫£nh):</label>
                        <textarea oninput="updatePreview(${idx}, this.value)">${q.q}</textarea>
                        
                        <div class="img-control">
                            <label class="btn btn-blue" style="cursor:pointer; margin:0">
                                üì∑ Ch·ªçn ·∫¢nh Minh H·ªça
                                <input type="file" style="display:none" accept="image/*" onchange="selectImage(this, ${idx})">
                            </label>
                            <span id="file-name-${idx}" style="font-size:0.8em; color:#666; margin-left:10px">Ch∆∞a ch·ªçn ·∫£nh</span>
                        </div>
                    </div>

                    <div class="q-preview" id="preview-box-${idx}">
                        </div>
                </div>
            `;
            container.appendChild(div);
            updatePreview(idx, q.q); // Render l·∫ßn ƒë·∫ßu
        });
    }

    // --- 4. LOGIC X·ª¨ L√ù ·∫¢NH & PREVIEW ---
    function selectImage(input, idx) {
        const file = input.files[0];
        if(!file) return;

        // L∆∞u file v√†o b·ªô nh·ªõ t·∫°m (ch∆∞a upload)
        questions[idx].localImage = file;
        questions[idx].localPreview = URL.createObjectURL(file);
        
        document.getElementById(`file-name-${idx}`).innerText = "üìÇ " + file.name;
        document.getElementById(`file-name-${idx}`).style.color = "green";
        document.getElementById(`file-name-${idx}`).style.fontWeight = "bold";

        // C·∫≠p nh·∫≠t l·∫°i khung xem tr∆∞·ªõc
        updatePreview(idx, questions[idx].q);
    }

    function updatePreview(idx, newContent) {
        questions[idx].q = newContent; // C·∫≠p nh·∫≠t d·ªØ li·ªáu g·ªëc
        const box = document.getElementById(`preview-box-${idx}`);
        
        // X·ª≠ l√Ω hi·ªÉn th·ªã ·∫£nh
        let htmlContent = newContent;
        let imgTag = "";
        
        // N·∫øu ƒë√£ ch·ªçn ·∫£nh (local) ho·∫∑c ƒë√£ c√≥ ·∫£nh c≈© (online)
        let imgSrc = questions[idx].localPreview || questions[idx].img;
        
        if (imgSrc) {
            imgTag = `<img src="${imgSrc}" class="preview-img">`;
            
            // N·∫øu trong text c√≥ [IMG], thay th·∫ø n√≥
            if (htmlContent.includes('[IMG]')) {
                htmlContent = htmlContent.replace('[IMG]', imgTag);
            } else {
                // N·∫øu kh√¥ng c√≥, ch√®n xu·ªëng cu·ªëi
                htmlContent += `<br>${imgTag}`;
            }
        } else {
            // Nh·∫Øc ng∆∞·ªùi d√πng v·ªã tr√≠ [IMG] n·∫øu ch∆∞a c√≥ ·∫£nh
            htmlContent = htmlContent.replace('[IMG]', '<span class="highlight-marker">[V·ªä TR√ç ·∫¢NH]</span>');
        }

        // Render MathJax
        box.innerHTML = `<div>${htmlContent}</div>`;
        
        // Hi·ªÉn th·ªã ƒë√°p √°n (S∆° l∆∞·ª£c ƒë·ªÉ ki·ªÉm tra)
        if(questions[idx].options) {
            box.innerHTML += `<div style="margin-top:10px; font-size:0.9em; color:#555">
                ${questions[idx].options.map((o,i)=> `(${String.fromCharCode(65+i)}) ${o}`).join('<br>')}
            </div>`;
        }

        if(window.MathJax) MathJax.typesetPromise([box]);
    }

    function removeQ(idx) {
        if(confirm("X√≥a c√¢u n√†y?")) {
            questions.splice(idx, 1);
            renderEditor();
        }
    }

    // --- 5. QUY TR√åNH XU·∫§T B·∫¢N (UPLOAD BATCH) ---
    async function publishExam() {
        const user = document.getElementById('gh-user').value.trim();
        const repo = document.getElementById('gh-repo').value.trim();
        const token = document.getElementById('gh-token').value.trim();
        const examId = document.getElementById('exam-id').value.trim();

        if(!user || !repo || !token || !examId) return alert("Thi·∫øu th√¥ng tin c·∫•u h√¨nh ho·∫∑c M√£ ƒë·ªÅ!");
        if(!confirm("Th·∫ßy c√≥ ch·∫Øc ch·∫Øn mu·ªën xu·∫•t b·∫£n ƒë·ªÅ thi n√†y?")) return;

        // B·∫ÆT ƒê·∫¶U QUY TR√åNH
        const overlay = document.getElementById('loading-overlay');
        const logBox = document.getElementById('log-text');
        overlay.style.display = 'flex';
        logBox.innerHTML = "‚è≥ ƒêang kh·ªüi t·∫°o...";

        function log(msg) { logBox.innerHTML += "\n" + msg; logBox.scrollTop = logBox.scrollHeight; }

        try {
            saveConfig(); // L∆∞u c·∫•u h√¨nh l·∫ßn cu·ªëi

            // B∆Ø·ªöC 1: UPLOAD T·∫§T C·∫¢ ·∫¢NH (N·∫æU C√ì)
            let uploadCount = 0;
            for (let i = 0; i < questions.length; i++) {
                let q = questions[i];
                if (q.localImage) {
                    log(`‚û§ ƒêang upload ·∫£nh c√¢u ${i+1}...`);
                    
                    // T·∫°o t√™n file duy nh·∫•t
                    const ext = q.localImage.name.split('.').pop();
                    const fileName = `${examId}-q${i+1}-${Date.now()}.${ext}`;
                    const path = `images/${fileName}`;
                    
                    // Convert sang Base64
                    const base64 = await toBase64(q.localImage);
                    
                    // Upload GitHub
                    await uploadToGitHub(user, repo, token, path, base64, true);
                    
                    // C·∫≠p nh·∫≠t link ·∫£nh v√†o d·ªØ li·ªáu c√¢u h·ªèi
                    // L∆∞u √Ω: Thay th·∫ø placeholder [IMG] b·∫±ng link ·∫£nh r·ªóng ƒë·ªÉ hi·ªÉn th·ªã, 
                    // ho·∫∑c ch·ªâ l∆∞u ƒë∆∞·ªùng d·∫´n ·∫£nh v√†o thu·ªôc t√≠nh .img
                    // ·ªû ƒë√¢y ta l∆∞u path v√†o q.img, v√† X√ìA [IMG] trong n·ªôi dung text ƒë·ªÉ tr√°nh l·ªói hi·ªÉn th·ªã 2 l·∫ßn
                    q.img = `images/${fileName}`;
                    q.q = q.q.replace('[IMG]', ''); // X√≥a placeholder v√¨ code thi.html s·∫Ω t·ª± ch√®n ·∫£nh d·ª±a tr√™n q.img
                    
                    // D·ªçn d·∫πp d·ªØ li·ªáu t·∫°m
                    delete q.localImage;
                    delete q.localPreview;
                    uploadCount++;
                }
            }
            if(uploadCount > 0) log(`‚úÖ ƒê√£ upload th√†nh c√¥ng ${uploadCount} ·∫£nh.`);

            // B∆Ø·ªöC 2: T·∫†O FILE DATA ƒê·ªÄ THI
            log(`‚û§ ƒêang t·∫°o file d·ªØ li·ªáu ƒë·ªÅ thi: ${examId}.js ...`);
            const examData = {
                title: document.getElementById('exam-title').value,
                subject: document.getElementById('exam-subject').value,
                grade: document.getElementById('exam-grade').value,
                time: parseInt(document.getElementById('exam-time').value),
                password: document.getElementById('exam-pass-hash').value,
                scores: { mcq: 0.25, tf: 1.0, short: 0.5 },
                questions: questions
            };
            const contentJS = `window.EXAM_DATA = ${JSON.stringify(examData, null, 4)};`;
            await uploadToGitHub(user, repo, token, `data/${examId}.js`, btoa(unescape(encodeURIComponent(contentJS))), false);

            // B∆Ø·ªöC 3: C·∫¨P NH·∫¨T MENU DANH S√ÅCH
            log(`‚û§ ƒêang c·∫≠p nh·∫≠t danh s√°ch ƒë·ªÅ thi...`);
            await updateListFile(user, repo, token, examId, examData);

            log(`üéâüéâüéâ XU·∫§T B·∫¢N TH√ÄNH C√îNG!`);
            alert("ƒê√£ xu·∫•t b·∫£n ƒë·ªÅ thi th√†nh c√¥ng!");
            setTimeout(() => { overlay.style.display = 'none'; }, 2000);

        } catch (err) {
            log(`‚ùå L·ªñI NGHI√äM TR·ªåNG: ${err.message}`);
            alert("C√≥ l·ªói x·∫£y ra. Vui l√≤ng xem log.");
            // Kh√¥ng t·∫Øt overlay ngay ƒë·ªÉ th·∫ßy ƒë·ªçc l·ªói
        }
    }

    // --- HELPER FUNCTIONS ---
    function toBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });
    }

    async function uploadToGitHub(user, repo, token, path, contentBase64, isImage) {
        const url = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;
        
        // Ki·ªÉm tra file t·ªìn t·∫°i ƒë·ªÉ l·∫•y SHA (ghi ƒë√®)
        let sha = null;
        try {
            let check = await fetch(url, { headers: {Authorization: `token ${token}`} });
            if(check.ok) {
                let json = await check.json();
                sha = json.sha;
            }
        } catch(e) {}

        let body = {
            message: isImage ? "Upload image" : "Upload exam data",
            content: contentBase64
        };
        if(sha) body.sha = sha;

        let res = await fetch(url, {
            method: 'PUT',
            headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        if(!res.ok) throw new Error(`L·ªói upload ${path}: ${res.status}`);
    }

    async function updateListFile(user, repo, token, id, data) {
        const url = `https://api.github.com/repos/${user}/${repo}/contents/data/list.js`;
        let list = [];
        let sha = null;

        // L·∫•y list c≈©
        let getRes = await fetch(url, { headers: {Authorization: `token ${token}`} });
        if(getRes.ok) {
            let json = await getRes.json();
            sha = json.sha;
            let content = decodeURIComponent(escape(atob(json.content)));
            let jsonStr = content.replace(/window\.EXAM_LIST\s*=\s*/, '').trim();
            if(jsonStr.endsWith(';')) jsonStr = jsonStr.slice(0, -1);
            try { list = new Function("return " + jsonStr)(); } catch(e){}
        }

        // Th√™m ƒë·ªÅ m·ªõi l√™n ƒë·∫ßu
        list = list.filter(x => x.id !== id);
        list.unshift({ 
            id: id, 
            title: data.title, 
            subject: data.subject, 
            grade: data.grade, 
            time: data.time 
        });

        // Upload l·∫°i
        let newContent = `window.EXAM_LIST = ${JSON.stringify(list, null, 4)};`;
        await uploadToGitHub(user, repo, token, `data/list.js`, btoa(unescape(encodeURIComponent(newContent))), false);
    }
</script>

</body>
</html>
