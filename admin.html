<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công Cụ Soạn Đề (v4.3 - Chuẩn Hóa Môn/Khối)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
    window.MathJax = {
        tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
        svg: { fontCache: 'global' }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; color: #333; }
        .container { max-width: 950px; margin: 0 auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        h1 { color: #00695c; text-align: center; margin-bottom: 20px; text-transform: uppercase; border-bottom: 3px solid #00695c; padding-bottom: 10px; display: inline-block; }
        .center-wrap { text-align: center; }

        .section-title { background: #e0f2f1; padding: 10px 15px; border-left: 5px solid #00796b; margin-top: 30px; margin-bottom: 15px; font-weight: bold; font-size: 1.1em; color: #004d40; }

        .row { display: flex; gap: 15px; margin-bottom: 15px; }
        .col { flex: 1; }
        
        label { font-weight: bold; display: block; margin-bottom: 5px; font-size: 0.9em; color: #455a64; }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        input:focus, textarea:focus, select:focus { border-color: #009688; outline: none; }
        textarea { height: 70px; font-family: 'Courier New', monospace; }

        .toolbar { position: sticky; top: 0; background: rgba(255,255,255,0.95); padding: 15px 0; border-bottom: 2px solid #eee; z-index: 100; display: flex; gap: 10px; flex-wrap: wrap; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        button { padding: 10px 20px; cursor: pointer; font-weight: bold; color: white; border: none; border-radius: 5px; font-size: 14px; transition: 0.2s; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-mcq { background: #1976d2; }
        .btn-tf { background: #f57c00; }
        .btn-short { background: #7b1fa2; }
        .btn-save { background: #2e7d32; margin-left: auto; box-shadow: 0 4px 6px rgba(46, 125, 50, 0.3); }
        .btn-del { background: #d32f2f; padding: 5px 12px; font-size: 12px; margin-left: 10px; }

        .q-box { border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; background: #fff; border-radius: 8px; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .q-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .q-tag { padding: 4px 8px; border-radius: 4px; font-size: 12px; color: white; font-weight: bold; margin-right: 8px; }
        
        .preview-math { color: #1565c0; font-weight: 500; margin: 5px 0 15px 0; padding: 10px; background: #f5f5f5; border-radius: 4px; border-left: 3px solid #1565c0; font-size: 0.9em; }
        .preview-img { display: none; max-width: 200px; max-height: 200px; margin-top: 10px; border: 1px solid #ccc; border-radius: 4px; padding: 2px; }

        .opt-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        input[type="radio"] { width: 18px; height: 18px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div class="center-wrap">
        <h1>CÔNG CỤ SOẠN ĐỀ THI</h1>
    </div>

    <div class="section-title">1. Thông Tin Chung & Phân Loại</div>
    <div class="row">
        <div class="col">
            <label>Môn Học</label>
            <select id="exam-subject">
                <option value="Toan">Toán Học</option>
                <option value="Ly">Vật Lý</option>
                <option value="Hoa">Hóa Học</option>
                <option value="Sinh">Sinh Học</option>
                <option value="Su">Lịch Sử</option>
                <option value="Dia">Địa Lý</option>
                <option value="GDCD">GDCD</option>
                <option value="Anh">Tiếng Anh</option>
                <option value="Van">Ngữ Văn</option>
                <option value="Khac">Khác</option>
            </select>
        </div>
        <div class="col">
            <label>Khối Lớp</label>
            <select id="exam-grade">
                <option value="12">Lớp 12</option>
                <option value="11">Lớp 11</option>
                <option value="10">Lớp 10</option>
                <option value="12OT">Ôn Thi THPT</option>
                <option value="HSG">Học Sinh Giỏi</option>
            </select>
        </div>
        <div class="col">
            <label>Thời gian (phút)</label>
            <input type="number" id="exam-time" value="45">
        </div>
    </div>

    <div class="row">
        <div class="col">
            <label>Mã Đề (Tên file, ví dụ: de-toan-01)</label>
            <input type="text" id="exam-id" placeholder="de-01">
        </div>
        <div class="col" style="flex:2">
            <label>Tiêu Đề Đề Thi (Hiển thị to)</label>
            <input type="text" id="exam-title" placeholder="Ví dụ: Kiểm tra 1 tiết Đại số - Chương 1">
        </div>
    </div>
    
    <div class="row">
        <div class="col">
            <label>Mô tả chi tiết</label>
            <input type="text" id="exam-desc" placeholder="Nội dung kiến thức, phạm vi ôn tập...">
        </div>
    </div>

    <div class="row" style="background:#fff3e0; padding:15px; border-radius:6px; align-items: flex-end;">
        <div class="col">
            <label>Tạo Mật Khẩu (Nếu cần)</label>
            <input type="text" id="raw-pass" placeholder="Nhập mật khẩu..." oninput="createPass()">
        </div>
        <div class="col">
            <label>Mã Hóa MD5</label>
            <input type="text" id="hashed-pass" readonly style="background:#eee; color:#666">
        </div>
    </div>

    <div class="section-title">2. Cấu Hình Điểm Số</div>
    <div class="row">
        <div class="col"><label>Trắc nghiệm (1 câu)</label><input type="number" id="score-mcq" value="0.25"></div>
        <div class="col"><label>Đúng/Sai (Max)</label><input type="number" id="score-tf" value="1.0"></div>
        <div class="col"><label>Trả lời ngắn (1 câu)</label><input type="number" id="score-short" value="0.5"></div>
    </div>

    <div class="section-title">3. Soạn Câu Hỏi (Tự động hiện công thức & Ảnh)</div>
    
    <div class="toolbar">
        <button class="btn-mcq" onclick="addQ('mcq')">+ Trắc Nghiệm</button>
        <button class="btn-tf" onclick="addQ('tf')">+ Đúng/Sai</button>
        <button class="btn-short" onclick="addQ('short')">+ Trả Lời Ngắn</button>
        <button class="btn-save" onclick="exportFile()">⬇️ TẢI FILE ĐỀ</button>
    </div>

    <div id="q-container">
        <div style="text-align:center; color:#999; margin-top:30px; font-style:italic">Chưa có câu hỏi nào.</div>
    </div>
</div>

<script>
    window.onload = function() { if(typeof CryptoJS === 'undefined') alert("⚠️ Kiểm tra kết nối mạng để dùng tính năng mã hóa mật khẩu."); }

    let questions = [];

    function createPass() {
        let p = document.getElementById('raw-pass').value.trim();
        if(p) document.getElementById('hashed-pass').value = CryptoJS.MD5(p).toString();
        else document.getElementById('hashed-pass').value = "";
    }

    function addQ(type) {
        if(questions.length === 0) document.getElementById('q-container').innerHTML = "";
        let id = Date.now();
        questions.push({ id: id, type: type });
        render();
        setTimeout(() => {
            document.getElementById('q-'+id).scrollIntoView({behavior: "smooth"});
            if(window.MathJax) MathJax.typesetPromise();
        }, 100);
    }

    function removeQ(id) {
        if(confirm("Xóa câu này?")) {
            questions = questions.filter(q => q.id !== id);
            render();
            if(questions.length === 0) document.getElementById('q-container').innerHTML = `<div style="text-align:center; color:#999; margin-top:30px; font-style:italic">Chưa có câu hỏi nào.</div>`;
        }
    }

    function previewMath(elm) {
        let previewDiv = elm.parentElement.querySelector('.preview-math');
        if(previewDiv) {
            previewDiv.innerHTML = elm.value ? elm.value : '(Xem trước công thức)';
            if(window.MathJax) MathJax.typesetPromise([previewDiv]);
        }
    }

    function previewImg(elm) {
        let url = elm.value.trim();
        let imgTag = elm.parentElement.querySelector('.preview-img');
        if(url) { imgTag.src = url; imgTag.style.display = 'block'; } 
        else { imgTag.style.display = 'none'; }
    }

    function render() {
        let html = '';
        questions.forEach((q, idx) => {
            let color = q.type=='mcq'?'#1976d2':(q.type=='tf'?'#f57c00':'#7b1fa2');
            let name = q.type=='mcq'?'Trắc Nghiệm':(q.type=='tf'?'Đúng/Sai':'Trả Lời Ngắn');
            
            html += `<div class="q-box" id="q-${q.id}">
                <div class="q-header">
                    <div><span class="q-tag" style="background:${color}">${name}</span> <strong>Câu ${idx+1}</strong></div>
                    <button class="btn-del" onclick="removeQ(${q.id})">Xóa</button>
                </div>
                
                <div class="form-group">
                    <label>Nội dung câu hỏi:</label>
                    <textarea id="content-${q.id}" oninput="previewMath(this)" placeholder="Nhập đề bài (Hỗ trợ LaTeX $...$)..."></textarea>
                    <div class="preview-math">(Xem trước đề bài)</div>
                    
                    <label style="margin-top:10px; color:#0277bd"><i class="fas fa-image"></i> Link Ảnh Câu Hỏi (Nếu có):</label>
                    <input type="text" id="img-q-${q.id}" oninput="previewImg(this)" placeholder="https://...">
                    <img class="preview-img" src="">
                </div>`;

            if(q.type === 'mcq') {
                html += `<div style="background:#e3f2fd; padding:15px; border-radius:6px; margin-bottom:15px">
                    <label>Chọn đáp án ĐÚNG:</label>`;
                ['A','B','C','D'].forEach((lbl, i) => {
                    html += `<div class="opt-row">
                        <input type="radio" name="ans-${q.id}" value="${i}">
                        <strong style="min-width:20px">${lbl}.</strong>
                        <div style="flex:1"><input type="text" id="opt-${q.id}-${i}" oninput="previewMath(this)" placeholder="Đáp án ${lbl}...">
                        <div class="preview-math" style="margin:2px 0 0 0; font-size:0.8em; padding:3px">(Xem trước)</div></div>
                    </div>`;
                });
                html += `</div>`;
            } else if(q.type === 'tf') {
                html += `<div style="background:#fff3e0; padding:15px; border-radius:6px; margin-bottom:15px">
                    <table width="100%"><tr><th>Mệnh đề</th><th width="50">Đ</th><th width="50">S</th></tr>`;
                [0,1,2,3].forEach(i => {
                    html += `<tr>
                        <td><input type="text" id="tf-sub-${q.id}-${i}" oninput="previewMath(this)" placeholder="Mệnh đề ${i+1}...">
                        <div class="preview-math" style="margin:2px 0 0 0; font-size:0.9em; padding:3px">(Xem trước)</div></td>
                        <td align="center"><input type="radio" name="tf-${q.id}-${i}" value="T"></td>
                        <td align="center"><input type="radio" name="tf-${q.id}-${i}" value="F" checked></td>
                    </tr>`;
                });
                html += `</table></div>`;
            } else {
                html += `<div style="background:#f3e5f5; padding:15px; border-radius:6px; margin-bottom:15px">
                    <label>Đáp án đúng:</label><input type="text" id="short-${q.id}" placeholder="Ví dụ: 2025">
                </div>`;
            }

            html += `<div class="form-group">
                <label>Lời giải chi tiết:</label>
                <textarea id="explain-${q.id}" oninput="previewMath(this)" style="height:50px" placeholder="Giải thích..."></textarea>
                <div class="preview-math">(Xem trước lời giải)</div>
                <label style="margin-top:10px; color:#2e7d32"><i class="fas fa-image"></i> Link Ảnh Lời Giải (Nếu có):</label>
                <input type="text" id="img-explain-${q.id}" oninput="previewImg(this)" placeholder="https://...">
                <img class="preview-img" src="">
            </div></div>`;
        });
        document.getElementById('q-container').innerHTML = html;
    }

    function exportFile() {
        let examId = document.getElementById('exam-id').value.trim() || 'de-moi';
        if(examId.endsWith('.js')) examId = examId.replace('.js','');

        let data = {
            title: document.getElementById('exam-title').value || "Bài Thi",
            description: document.getElementById('exam-desc').value || "",
            subject: document.getElementById('exam-subject').value,
            grade: document.getElementById('exam-grade').value,
            time: parseInt(document.getElementById('exam-time').value) || 45,
            password: document.getElementById('hashed-pass').value,
            scores: {
                mcq: parseFloat(document.getElementById('score-mcq').value) || 0.25,
                tf: parseFloat(document.getElementById('score-tf').value) || 1.0,
                short: parseFloat(document.getElementById('score-short').value) || 0.5
            },
            questions: []
        };

        questions.forEach(q => {
            let imgQ = document.getElementById(`img-q-${q.id}`).value.trim();
            let imgExplain = document.getElementById(`img-explain-${q.id}`).value.trim();
            let explainText = document.getElementById(`explain-${q.id}`).value;

            if(imgExplain) { explainText += `<br><div style="text-align:center; margin-top:10px"><img src="${imgExplain}" style="max-width:100%; border-radius:5px; border:1px solid #ddd"></div>`; }

            let qObj = { type: q.type, q: document.getElementById(`content-${q.id}`).value, explain: explainText };
            if(imgQ) qObj.img = imgQ;

            if(q.type === 'mcq') {
                qObj.options = [];
                for(let i=0; i<4; i++) qObj.options.push(document.getElementById(`opt-${q.id}-${i}`).value);
                let checked = document.querySelector(`input[name="ans-${q.id}"]:checked`);
                qObj.ans = checked ? parseInt(checked.value) : 0;
            } 
            else if(q.type === 'tf') {
                qObj.items = [];
                for(let i=0; i<4; i++) {
                    let sub = document.getElementById(`tf-sub-${q.id}-${i}`).value;
                    let ans = document.querySelector(`input[name="tf-${q.id}-${i}"]:checked`).value;
                    qObj.items.push({sub: sub, ans: ans});
                }
            } 
            else { qObj.ans = document.getElementById(`short-${q.id}`).value; }
            data.questions.push(qObj);
        });

        let content = `window.EXAM_DATA = ${JSON.stringify(data, null, 4)};`;
        let blob = new Blob([content], { type: "text/javascript;charset=utf-8" });
        let url = URL.createObjectURL(blob);
        let a = document.createElement("a");
        a.href = url;
        a.download = `${examId}.js`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
</script>

</body>
</html>
