<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Tool v5.0 (Auto Sync GitHub)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }, svg: { fontCache: 'global' } };</script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #eef2f5; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h1 { color: #00796b; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        
        /* C·∫§U H√åNH GITHUB */
        .github-config { background: #e3f2fd; border: 2px solid #2196f3; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .github-config h3 { margin-top: 0; color: #1565c0; }
        .github-config input { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #90caf9; border-radius: 4px; }
        
        .paste-area textarea { width: 100%; height: 100px; border: 1px solid #c8e6c9; padding: 10px; font-family: monospace; color: #2e7d32; }
        .section-title { font-weight: bold; color: #555; margin: 20px 0 10px 0; border-left: 4px solid #009688; padding-left: 10px; text-transform: uppercase; }
        .row { display: flex; gap: 15px; margin-bottom: 10px; } .col { flex: 1; }
        label { font-weight: 600; display: block; margin-bottom: 5px; font-size: 0.9em; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        
        .toolbar { position: sticky; top: 0; background: rgba(255,255,255,0.95); padding: 15px 0; border-bottom: 1px solid #ddd; z-index: 100; display: flex; gap: 10px; }
        button { padding: 10px 20px; cursor: pointer; font-weight: bold; color: white; border: none; border-radius: 6px; transition: 0.2s; }
        button:hover { transform: translateY(-2px); }
        .btn-green { background: #2e7d32; } .btn-blue { background: #1976d2; } .btn-red { background: #c62828; } .btn-orange { background: #f57c00; }
        
        .q-box { border: 1px solid #eee; padding: 15px; margin-bottom: 15px; background: #fff; border-radius: 8px; }
        .preview-math { background: #f8f9fa; padding: 5px; border-left: 3px solid #1976d2; margin-top: 5px; color: #1565c0; font-size: 0.9em; }
        
        /* LOG UPLOAD */
        #upload-log { display: none; margin-top: 20px; padding: 15px; background: #263238; color: #80cbc4; font-family: monospace; border-radius: 8px; white-space: pre-wrap; }
    </style>
</head>
<body>
<div class="container">
    <h1>ADMIN TOOL v5.0 (T·ª∞ ƒê·ªòNG H√ìA)</h1>

    <div class="github-config">
        <h3>üîë C·∫§U H√åNH K·∫æT N·ªêI (Nh·∫≠p 1 l·∫ßn l√† nh·ªõ)</h3>
        <div class="row">
            <div class="col"><label>GitHub Username</label><input type="text" id="gh-user" placeholder="V√≠ d·ª•: Nguyenbm1979"></div>
            <div class="col"><label>T√™n Repository</label><input type="text" id="gh-repo" placeholder="V√≠ d·ª•: Trac-nghiem-nguyen-ham"></div>
        </div>
        <label>GitHub Token (B·∫Øt ƒë·∫ßu b·∫±ng ghp_...)</label>
        <input type="password" id="gh-token" placeholder="D√°n m√£ Token v√†o ƒë√¢y">
    </div>

    <div class="section-title">1. D√°n D·ªØ Li·ªáu T·ª´ Gemini</div>
    <div class="paste-area">
        <textarea id="json-input" placeholder='D√°n m·∫£ng c√¢u h·ªèi JSON v√†o ƒë√¢y...'></textarea>
        <button class="btn-green" style="margin-top:10px" onclick="importFromText()">‚ö° N·∫†P D·ªÆ LI·ªÜU</button>
    </div>

    <div class="section-title">2. Th√¥ng Tin ƒê·ªÅ Thi</div>
    <div class="row">
        <div class="col"><label>M√¥n</label><select id="exam-subject"><option value="Toan">To√°n</option><option value="Su">L·ªãch S·ª≠</option><option value="Ly">V·∫≠t L√Ω</option><option value="Hoa">H√≥a H·ªçc</option><option value="Sinh">Sinh</option><option value="Dia">ƒê·ªãa</option><option value="GDCD">GDCD</option><option value="Anh">Anh</option></select></div>
        <div class="col"><label>Kh·ªëi</label><select id="exam-grade"><option value="12">12</option><option value="11">11</option><option value="10">10</option><option value="12OT">√în THPT</option></select></div>
        <div class="col"><label>Th·ªùi gian</label><input type="number" id="exam-time" value="45"></div>
    </div>
    <div class="row">
        <div class="col"><label>M√£ ƒê·ªÅ (ID)</label><input type="text" id="exam-id" placeholder="de-su-01"></div>
        <div class="col" style="flex:2"><label>Ti√™u ƒê·ªÅ</label><input type="text" id="exam-title" placeholder="Ki·ªÉm tra..."></div>
    </div>

    <div class="section-title">3. Ki·ªÉm Tra C√¢u H·ªèi</div>
    <div class="toolbar">
        <button class="btn-blue" onclick="addQ('mcq')">+ Tr·∫Øc Nghi·ªám</button>
        <button class="btn-orange" onclick="addQ('tf')">+ ƒê√∫ng/Sai</button>
        <button class="btn-red" style="margin-left:auto; background:#d32f2f" onclick="uploadSystem()">üöÄ ƒêƒÇNG ƒê·ªÄ L√äN H·ªÜ TH·ªêNG</button>
    </div>
    
    <div id="upload-log"></div>
    <div id="q-container" style="margin-top:20px"><div style="text-align:center; color:#999">Ch∆∞a c√≥ d·ªØ li·ªáu.</div></div>
</div>

<script>
    // --- L∆ØU C·∫§U H√åNH ---
    window.onload = function() {
        if(localStorage.getItem('gh-user')) document.getElementById('gh-user').value = localStorage.getItem('gh-user');
        if(localStorage.getItem('gh-repo')) document.getElementById('gh-repo').value = localStorage.getItem('gh-repo');
        if(localStorage.getItem('gh-token')) document.getElementById('gh-token').value = localStorage.getItem('gh-token');
    }

    function saveConfig() {
        localStorage.setItem('gh-user', document.getElementById('gh-user').value.trim());
        localStorage.setItem('gh-repo', document.getElementById('gh-repo').value.trim());
        localStorage.setItem('gh-token', document.getElementById('gh-token').value.trim());
    }

    // --- X·ª¨ L√ù D·ªÆ LI·ªÜU ---
    let questions = [];
    function importFromText() {
        try {
            let text = document.getElementById('json-input').value.trim();
            if(text.includes('=')) text = text.substring(text.indexOf('=')+1);
            if(text.endsWith(';')) text = text.slice(0,-1);
            questions = JSON.parse(text);
            questions.forEach(q => q.id = Date.now() + Math.random());
            render();
            alert(`‚úÖ ƒê√£ n·∫°p ${questions.length} c√¢u h·ªèi!`);
        } catch(e) { alert("L·ªói JSON: " + e.message); }
    }

    function render() {
        let html = '';
        questions.forEach((q, idx) => {
            let txt = q.type=='mcq'?'Tr·∫Øc Nghi·ªám':(q.type=='tf'?'ƒê√∫ng/Sai':'Tr·∫£ L·ªùi Ng·∫Øn');
            html += `<div class="q-box"><b>C√¢u ${idx+1} [${txt}]</b>: ${q.q.substring(0,80)}...</div>`;
        });
        document.getElementById('q-container').innerHTML = html;
    }

    // --- üöÄ H√ÄM UPLOAD L√äN GITHUB (TR√ÅI TIM C·ª¶A H·ªÜ TH·ªêNG) ---
    async function uploadSystem() {
        saveConfig();
        const user = document.getElementById('gh-user').value.trim();
        const repo = document.getElementById('gh-repo').value.trim();
        const token = document.getElementById('gh-token').value.trim();
        const examId = document.getElementById('exam-id').value.trim();
        
        if(!user || !repo || !token || !examId) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin GitHub v√† M√£ ƒë·ªÅ!");

        const log = document.getElementById('upload-log');
        log.style.display = 'block';
        log.innerHTML = "‚è≥ ƒêang k·∫øt n·ªëi GitHub...\n";

        // 1. CHU·∫®N B·ªä D·ªÆ LI·ªÜU ƒê·ªÄ THI
        const examData = {
            title: document.getElementById('exam-title').value,
            subject: document.getElementById('exam-subject').value,
            grade: document.getElementById('exam-grade').value,
            time: parseInt(document.getElementById('exam-time').value),
            scores: { mcq: 0.25, tf: 1.0, short: 0.5 },
            password: "",
            questions: questions
        };
        const fileContent = `window.EXAM_DATA = ${JSON.stringify(examData, null, 4)};`;
        const contentBase64 = btoa(unescape(encodeURIComponent(fileContent))); // M√£ h√≥a UTF-8 chu·∫©n

        try {
            // 2. UPLOAD FILE ƒê·ªÄ THI (PUT)
            log.innerHTML += `‚û§ ƒêang t·∫°o file: data/${examId}.js ... `;
            let urlFile = `https://api.github.com/repos/${user}/${repo}/contents/data/${examId}.js`;
            
            // Ki·ªÉm tra file c√≥ t·ªìn t·∫°i kh√¥ng ƒë·ªÉ l·∫•y SHA (n·∫øu ghi ƒë√®)
            let checkFile = await fetch(urlFile, { headers: {Authorization: `token ${token}`} });
            let shaFile = null;
            if(checkFile.ok) {
                let json = await checkFile.json();
                shaFile = json.sha;
            }

            let resFile = await fetch(urlFile, {
                method: 'PUT',
                headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: `Upload exam ${examId} via AdminTool`,
                    content: contentBase64,
                    sha: shaFile // N·∫øu file c≈© c√≥ th√¨ ghi ƒë√®
                })
            });

            if(!resFile.ok) throw new Error("L·ªói upload file ƒë·ªÅ: " + resFile.statusText);
            log.innerHTML += "‚úÖ OK!\n";

            // 3. C·∫¨P NH·∫¨T DANH S√ÅCH (list.js)
            log.innerHTML += `‚û§ ƒêang c·∫≠p nh·∫≠t menu (list.js) ... `;
            let urlList = `https://api.github.com/repos/${user}/${repo}/contents/data/list.js`;
            
            let resListGet = await fetch(urlList, { headers: {Authorization: `token ${token}`} });
            if(!resListGet.ok) throw new Error("Kh√¥ng t√¨m th·∫•y file data/list.js tr√™n GitHub!");
            
            let jsonList = await resListGet.json();
            let contentList = decodeURIComponent(escape(atob(jsonList.content))); // Gi·∫£i m√£
            
            // X·ª≠ l√Ω n·ªôi dung list.js
            // T√¨m m·∫£ng c≈©, c·∫Øt b·ªè ph·∫ßn th·ª´a
            let jsonStr = contentList.replace(/window\.EXAM_LIST\s*=\s*/, '').trim();
            if(jsonStr.endsWith(';')) jsonStr = jsonStr.slice(0, -1);
            
            let currentList = [];
            try { currentList = JSON.parse(jsonStr); } catch(e) { console.log('List r·ªóng ho·∫∑c l·ªói'); }

            // X√≥a ƒë·ªÅ c≈© n·∫øu tr√πng ID, th√™m ƒë·ªÅ m·ªõi l√™n ƒë·∫ßu
            currentList = currentList.filter(x => x.id !== examId);
            currentList.unshift({
                id: examId,
                title: examData.title,
                subject: examData.subject,
                grade: examData.grade,
                time: examData.time
            });

            let newListContent = `window.EXAM_LIST = ${JSON.stringify(currentList, null, 4)};`;
            let newListBase64 = btoa(unescape(encodeURIComponent(newListContent)));

            let resListPut = await fetch(urlList, {
                method: 'PUT',
                headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: `Update list for ${examId}`,
                    content: newListBase64,
                    sha: jsonList.sha
                })
            });

            if(!resListPut.ok) throw new Error("L·ªói c·∫≠p nh·∫≠t list.js");
            log.innerHTML += "‚úÖ OK!\n";
            log.innerHTML += "\nüéâüéâüéâ TH√ÄNH C√îNG! ƒê·ªÄ ƒê√É L√äN H·ªÜ TH·ªêNG.\nTh·∫ßy h√£y ƒë·ª£i 1-2 ph√∫t r·ªìi F5 trang ch·ªß.";

        } catch (err) {
            log.innerHTML += `\n‚ùå TH·∫§T B·∫†I: ${err.message}`;
            console.error(err);
        }
    }
</script>
</body>
</html>
