<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Tool v26.0 (Optimized)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }, svg: { fontCache: 'global' } };</script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* CSS GI·ªÆ NGUY√äN NH∆Ø C≈®, CH·ªà T·ªêI ∆ØU GIAO DI·ªÜN M·ªòT CH√öT */
        body{font-family:'Segoe UI',sans-serif;background:#eceff1;padding:20px;color:#37474f;margin:0}
        .btn{padding:8px 15px;border:none;border-radius:4px;cursor:pointer;font-weight:bold;color:white;font-size:0.9em;display:inline-flex;align-items:center;gap:5px;transition:0.2s}
        .btn:hover{transform:translateY(-2px);box-shadow:0 2px 5px rgba(0,0,0,0.2)}
        .btn-green{background:#2e7d32}.btn-blue{background:#1565c0}.btn-red{background:#c62828}.btn-gray{background:#607d8b}.btn-orange{background:#ef6c00}
        .config-box{background:#e3f2fd;padding:15px;border-radius:8px;margin-bottom:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
        .row{display:flex;gap:15px;margin-bottom:10px}.col{flex:1}
        label{font-weight:600;display:block;margin-bottom:3px;font-size:0.9em;color:#546e7a}
        input,select,textarea{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box}
        .tab-bar{display:flex;gap:10px;margin-bottom:20px;border-bottom:2px solid #eee;padding-bottom:10px;overflow-x:auto}
        .tab-btn{padding:10px 20px;background:#f5f5f5;border:none;border-radius:6px;cursor:pointer;color:#666;font-weight:bold;white-space:nowrap}
        .tab-btn.active{background:#00796b;color:white;box-shadow:0 2px 5px rgba(0,121,107,0.3)}
        .section{display:none}.section.active{display:block;animation:fadeIn 0.3s}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        
        .split-view { display:flex; gap:20px; align-items: flex-start; margin-top: 20px; }
        .editor-col { 
            flex: 1; /* Chi·∫øm 50% */
            min-width: 0;
        }
        
        .preview-col { 
            flex: 1; /* Chi·∫øm 50% */
            position: sticky; top: 20px; 
            max-height: 90vh; overflow-y: auto;
            background: white; border-radius: 8px; border: 1px solid #ddd; padding: 15px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: none; /* M·∫∑c ƒë·ªãnh ·∫©n, s·∫Ω hi·ªán khi c√≥ c√¢u h·ªèi */
        }
        
        /* ·∫®n th√πng r√°c Score-box c≈© v√¨ ƒë√£ ƒë∆∞a l√™n tr√™n */
        .score-box { display: none !important; }
        
        .q-item {background:white; padding:15px; border:1px solid #ccc; border-radius:8px; margin-bottom:15px; border-left:5px solid #009688; position:relative;}
        .q-item-header {display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px}
        .smart-textarea {min-height:60px; font-family:inherit; font-size:1em}
        .upload-wrapper {display:flex; gap:5px; margin: 5px 0;}
        .file-upload-btn {background:#e0e0e0; color:#333; padding:5px 10px; border-radius:4px; cursor:pointer; display:inline-block; font-size:0.9em; border:1px solid #ccc;}
        
        .score-box {background:#fff3e0; padding:15px; border:1px solid #ffe0b2; border-radius:8px; margin-bottom:20px; text-align:center; color:#e65100; box-shadow: 0 2px 5px rgba(0,0,0,0.05);}
        .score-total {font-size:2em; font-weight:bold; color:#d32f2f; display:block;}
        .point-input {width:70px !important; text-align:center; color:#d32f2f; font-weight:bold; border:1px solid #ffab91;}

        .preview-header {text-align: center; color: #1a237e; border-bottom: 2px solid #eee; margin-bottom: 15px; padding-bottom: 10px;}
        .p-q-block {background:#fff; margin-bottom:15px; padding-bottom:15px; border-bottom:1px dashed #ccc;}
        .p-label {color:#1a237e; font-weight:bold; font-size:1.1em;}
        .p-content {font-weight:500; margin-bottom:10px;}
        .p-opt {background:#fafafa; border:1px solid #eee; padding:8px; margin-bottom:5px; border-radius:4px;}
        .p-img {max-width:100%; border-radius:8px; margin:10px 0; border:1px solid #eee; display:block;}
        .p-sol {background:#e8f5e9; color:#2e7d32; padding:10px; border-radius:4px; font-size:0.9em; margin-top:10px; border:1px dashed #a5d6a7;}
        
        .file-item{display:flex;justify-content:space-between;padding:10px;background:#fafafa;border:1px solid #ddd;border-radius:6px;margin-bottom:5px;align-items:center;transition:0.2s}
        .file-item:hover{background:#e0f2f1;border-color:#b2dfdb}
        .fm-breadcrumb {padding:10px; background:#eee; margin-bottom:15px; border-radius:4px; font-weight:bold; display:flex; align-items:center;}
        .fm-item {display:flex; align-items:center; padding:10px; border-bottom:1px solid #eee; cursor:pointer;}
        .fm-item:hover {background:#f0f0f0;}
        .fm-icon {width:30px; text-align:center; margin-right:10px; font-size:1.2em;}
        .fm-name {flex:1; font-weight:500;} .fm-folder {color:#fbc02d;} .fm-file {color:#546e7a;}
        .img-card {border:1px solid #ddd; padding:5px; background:white; border-radius:4px; text-align:center; width: 150px; position: relative;}
        .img-card img {width: 100%; height: 100px; object-fit: cover; border-radius: 4px;}
        .img-card small {display:block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-top:5px;}
        .img-del-btn {background:#d32f2f; color:white; border:none; width:100%; padding:5px; cursor:pointer; margin-top:5px; border-radius:2px;}
        
        #loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;display:none;flex-direction:column;justify-content:center;align-items:center;color:white}
        .modal{display:none;position:fixed;z-index:10000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);align-items:center;justify-content:center}
        .modal-content{background-color:white;padding:20px;border-radius:10px;text-align:center;box-shadow:0 10px 25px rgba(0,0,0,0.2)}
        #qrcode{margin:20px auto;display:flex;justify-content:center}
        #login-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:#263238;z-index:9999;display:flex;justify-content:center;align-items:center}
        .login-box{background:white;padding:40px;border-radius:10px;width:350px;text-align:center;box-shadow:0 10px 25px rgba(0,0,0,0.3)}
        #main-app{display:none;max-width:1400px;margin:0 auto;background:white;padding:25px;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,0.05)} 
        /* --- CSS M·ªöI CHO PH·∫¶N SO·∫†N TH·∫¢O MCQ --- */
    .mcq-row {
        display: flex;
        align-items: flex-start; /* CƒÉn l·ªÅ tr√™n */
        margin-bottom: 10px;
        gap: 10px;
    }
    .mcq-left-col {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 50px; /* C·ªë ƒë·ªãnh chi·ªÅu r·ªông c·ªôt n√∫t ch·ªçn */
        padding-top: 5px;
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 4px;
        height: 100%;
        min-height: 50px;
    }
    .mcq-label {
        font-weight: bold;
        font-size: 1.2em;
        margin-top: 2px;
        color: #1565c0;
    }
    .mcq-input-area {
        flex: 1; /* Chi·∫øm h·∫øt ph·∫ßn c√≤n l·∫°i */
    }
    .mcq-input-area textarea {
        width: 100%;
        min-height: 50px; /* √î nh·∫≠p cao h∆°n, r·ªông h∆°n */
        font-family: inherit;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        resize: vertical; /* Cho ph√©p k√©o gi√£n */
    }
    input[type="radio"].big-radio {
        transform: scale(1.5); /* N√∫t ch·ªçn to h∆°n */
        margin-bottom: 5px;
        cursor: pointer;
    }

    /* --- CSS M·ªöI CHO PH·∫¶N PREVIEW --- */
    .p-opt-row {
        display: flex;
        gap: 10px;
        margin-bottom: 8px;
        align-items: flex-start;
        background: #fafafa;
        border: 1px solid #eee;
        padding: 8px;
        border-radius: 4px;
    }
    .p-opt-label {
        font-weight: bold;
        color: #0d47a1;
        min-width: 25px; /* C·ªë ƒë·ªãnh ƒë·ªô r·ªông ch·ªØ A. B. */
    }
    .p-opt-content {
        flex: 1;
        word-break: break-word;
    }
    .p-opt-row.correct-ans {
        background: #e3f2fd;
        border-color: #2196f3;
    }
    </style>
</head>
<body>

<div id="loading-overlay"><div style="font-size:50px">üöÄ</div><h2 id="loading-title">ƒêANG X·ª¨ L√ù...</h2></div>

<div id="qr-modal" class="modal">
    <div class="modal-content">
        <h3 style="color:#3f51b5">M√É QR ƒê·ªÄ THI</h3>
        <p id="qr-link-text" style="font-size:0.8em;color:#666"></p>
        <div id="qrcode"></div>
        <button class="btn btn-red" onclick="document.getElementById('qr-modal').style.display='none'">ƒê√≥ng</button>
    </div>
</div>

<div id="login-screen">
    <div class="login-box">
        <h2 style="color:#00695c">ADMIN LOGIN</h2>
        <input type="password" id="admin-pass-input" placeholder="Nh·∫≠p m·∫≠t kh·∫©u qu·∫£n tr·ªã..." onkeyup="if(event.key==='Enter')checkAdmin()">
        <p id="login-msg" style="color:red;display:none;margin-top:5px">Sai m·∫≠t kh·∫©u!</p>
        <button class="btn btn-green" onclick="checkAdmin()" style="margin-top:10px;width:100%">ƒêƒÇNG NH·∫¨P</button>
    </div>
</div>

<div id="main-app">
    <h1>QU·∫¢N TR·ªä v25.0 (OPTIMIZED)</h1>
    
    <div class="config-box">
        <div class="row">
            <div class="col"><label>User GitHub</label><input type="text" id="gh-user"></div>
            <div class="col"><label>Repo Name</label><input type="text" id="gh-repo"></div>
            <div class="col"><label>Token (Classic)</label><input type="password" id="gh-token"></div>
        </div>
        <div class="row" style="margin-top:10px">
            <div class="col"><label>Ng√¢n h√†ng</label><input type="text" id="bank-id" placeholder="MB"></div>
            <div class="col"><label>S·ªë T√†i Kho·∫£n</label><input type="text" id="bank-acc"></div>
            <div class="col"><label>Link Google Sheet (Script)</label><input type="text" id="gs-url" placeholder="https://script.google.com/macros/s/AKfycbyvrYa-XEHWk_Pcn2_9x4ZOLpdqfi_1KFPn1Y6I6QeaHihDVBNwu2lLfE43D1z96f9_zQ/exec"></div>
            <div class="col"><button class="btn btn-gray" style="margin-top:22px;width:100%" onclick="saveConfig()">üíæ L∆∞u C·∫•u H√¨nh</button></div>
        </div>
    </div>

    <div class="tab-bar">
        <button id="tab-data" class="tab-btn active" onclick="switchTab('data')">üìÇ QU·∫¢N L√ù ƒê·ªÄ</button>
        <button id="tab-files" class="tab-btn" onclick="switchTab('files')">üóÇÔ∏è QU·∫¢N L√ù FILE</button>
        <button id="tab-create" class="tab-btn" onclick="switchTab('create')">üìù SO·∫†N ƒê·ªÄ</button>
        <button id="tab-images" class="tab-btn" onclick="switchTab('images')">üì∑ KHO ·∫¢NH</button>
    </div>

    <div id="sec-data" class="section active">
        <div style="display:flex;justify-content:space-between;margin-bottom:20px"><h3>DANH S√ÅCH ƒê·ªÄ THI</h3><button class="btn btn-green" onclick="loadDataFiles()">üîÑ T·∫£i L·∫°i</button></div>
        <div id="data-list" class="file-list"></div>
    </div>

    <div id="sec-files" class="section">
        <div class="fm-breadcrumb">
            <button class="btn btn-gray" style="margin-right:10px" onclick="loadFileManager('')"><i class="fas fa-home"></i> G·ªëc</button>
            <span id="fm-current-path">/</span>
        </div>
        <div id="fm-list" style="background:white;border:1px solid #ddd;border-radius:6px"></div>
    </div>
<div id="sec-create" class="section">
        <div class="config-box" style="background:#fff3e0;border-color:#ffe0b2; margin-bottom: 10px;">
            <div class="row">
                <div class="col"><label>M√£ ƒê·ªÅ (ID) <span style="color:red">*</span></label><input type="text" id="exam-id" placeholder="vd: de-toan-giua-ky-1" style="font-weight:bold;color:#c62828"></div>
                <div class="col" style="flex:2"><label>Ti√™u ƒê·ªÅ <span style="color:red">*</span></label><input type="text" id="exam-title"></div>
            </div>
            <div class="row">
                <div class="col"><label>M√¥n H·ªçc</label><select id="exam-subject"><option value="Toan">To√°n</option><option value="Ly">V·∫≠t L√Ω</option><option value="Hoa">H√≥a H·ªçc</option><option value="Sinh">Sinh H·ªçc</option><option value="Anh">Ti·∫øng Anh</option><option value="Van">Ng·ªØ VƒÉn</option><option value="Su">L·ªãch S·ª≠</option><option value="Dia">ƒê·ªãa L√Ω</option><option value="GDCD">GDCD</option></select></div>
                <div class="col"><label>Kh·ªëi L·ªõp</label><select id="exam-grade"><option value="12">Kh·ªëi 12</option><option value="11">Kh·ªëi 11</option><option value="10">Kh·ªëi 10</option><option value="9">Kh·ªëi 9</option></select></div>
                <div class="col">
    <div style="display:flex; gap:10px">
        <div style="flex:1">
            <label>Th·ªùi gian (ph√∫t)</label>
            <input type="number" id="exam-time" value="45">
        </div>
        <div style="flex:1">
            <label>L·∫•y SL c√¢u (0=T·∫•t c·∫£)</label>
            <input type="number" id="exam-take" placeholder="VD: 20" style="font-weight:bold;color:#d32f2f">
        </div>
    </div>
</div>
            </div>
            <div class="row">
                <div class="col"><label>Gi√° (VNƒê)</label><input type="number" id="exam-price" placeholder="0"></div>
                <div class="col"><label>M·∫≠t kh·∫©u ƒê·ªÅ</label><input type="text" id="exam-pass" oninput="hashPass()"><input type="hidden" id="exam-pass-hash"></div>
                <div class="col" style="flex:2"><label>C·∫•u h√¨nh thi</label>
                    <div style="margin-top:5px;display:flex;gap:15px;flex-wrap:wrap">
                        <span><input type="checkbox" id="secure-mode"> M√£ h√≥a</span>
                        <span style="color:#e65100;font-weight:bold"><input type="checkbox" id="exam-shuffle" checked> üîÄ ƒê·∫£o c√¢u</span>
                        <span style="color:#2e7d32;font-weight:bold"><input type="checkbox" id="view-detail" checked> üëÅÔ∏è Xem gi·∫£i</span>
                        <span style="color:#c2185b;font-weight:bold"><input type="checkbox" id="exam-music"> üéµ Nh·∫°c n·ªÅn</span>
                        <span style="color:#00796b;font-weight:bold"><input type="checkbox" id="allow-print" checked> üñ®Ô∏è Cho ph√©p in</span>
                    </div>
                </div>
            </div>
            <div class="row" style="border:1px dashed #ef6c00;padding:10px;border-radius:5px;background:#fff8e1">
                <div class="col"><label>üïí M·ªü ƒë·ªÅ l√∫c:</label><input type="datetime-local" id="exam-start"></div>
                <div class="col"><label>‚õî ƒê√≥ng ƒë·ªÅ l√∫c:</label><input type="datetime-local" id="exam-end"></div>
                <div class="col"><label>L√†m t·ªëi thi·ªÉu (%)</label><input type="number" id="min-time-percent" placeholder="VD: 50"></div>
            </div>
        </div>
        <div style="background:white; border:1px solid #cfd8dc; padding:10px 15px; border-radius:6px; margin-bottom:10px; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; box-shadow:0 1px 3px rgba(0,0,0,0.05)">
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; flex:1">
                <b style="color:#2e7d32; font-size:1.1em"><i class="fas fa-calculator"></i> CHIA ƒêI·ªÇM:</b>
                
                <div style="display:flex; align-items:center; background:#f1f8e9; padding:2px 5px; border-radius:4px; border:1px solid #c5e1a5">
                    <span style="font-size:0.8em; font-weight:bold; color:#33691e; margin-right:3px">TN:</span>
                    <input type="number" id="total-mcq" placeholder="7" style="width:40px; border:none; background:transparent; font-weight:bold; color:#2e7d32; text-align:center; outline:none">
                </div>
                <div style="display:flex; align-items:center; background:#e3f2fd; padding:2px 5px; border-radius:4px; border:1px solid #90caf9">
                    <span style="font-size:0.8em; font-weight:bold; color:#0d47a1; margin-right:3px">ƒê/S:</span>
                    <input type="number" id="total-tf" placeholder="1" style="width:40px; border:none; background:transparent; font-weight:bold; color:#1565c0; text-align:center; outline:none">
                </div>
                <div style="display:flex; align-items:center; background:#fff3e0; padding:2px 5px; border-radius:4px; border:1px solid #ffcc80">
                    <span style="font-size:0.8em; font-weight:bold; color:#e65100; margin-right:3px">ƒêi·ªÅn:</span>
                    <input type="number" id="total-short" placeholder="1" style="width:40px; border:none; background:transparent; font-weight:bold; color:#ef6c00; text-align:center; outline:none">
                </div>
                <div style="display:flex; align-items:center; background:#eceff1; padding:2px 5px; border-radius:4px; border:1px solid #b0bec5">
                    <span style="font-size:0.8em; font-weight:bold; color:#455a64; margin-right:3px">Gh√©p:</span>
                    <input type="number" id="total-match" placeholder="1" style="width:40px; border:none; background:transparent; font-weight:bold; color:#546e7a; text-align:center; outline:none">
                </div>
                <button class="btn btn-blue" onclick="autoDistributePoints()" style="padding:4px 10px; font-size:0.8em; height:28px">‚ö° CHIA</button>
            </div>
            <div style="border-left:2px solid #eee; padding-left:15px; margin-left:15px; text-align:right">
                <span style="font-size:0.85em; color:#666; display:block">T·ªîNG ƒêI·ªÇM / C√ÇU</span>
                <span style="font-size:1.4em; font-weight:bold; color:#d32f2f">
                    <span id="total-score-display">0.00</span> 
                    <small style="color:#999; font-size:0.6em">/ <span id="total-qs">0</span></small>
                </span>
            </div>
        </div>
        <div style="margin-bottom:15px; border:1px dashed #ccc; padding:10px; border-radius:6px; background:#fafafa">
            <div style="display:flex; justify-content:space-between; cursor:pointer" onclick="let b=document.getElementById('json-import-box'); b.style.display=b.style.display==='none'?'block':'none'">
                <b style="color:#546e7a"><i class="fas fa-file-code"></i> N·∫°p d·ªØ li·ªáu JSON (Click ƒë·ªÉ m·ªü)</b>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div id="json-import-box" style="display:none; margin-top:10px">
                <textarea id="json-input" style="width:100%;height:80px;font-family:monospace;font-size:0.9em;margin-bottom:5px" placeholder='D√°n m√£ JSON v√†o ƒë√¢y...'></textarea>
                <button class="btn btn-gray" onclick="parseDataSafe()">üì• N·∫°p Ngay</button>
            </div>
        </div>
        <div style="margin-bottom:15px;display:flex;gap:10px;flex-wrap:wrap;border-bottom:2px solid #eee;padding-bottom:15px">
            <button class="btn btn-blue" onclick="addQ('mcq')">‚ûï Tr·∫Øc Nghi·ªám</button>
            <button class="btn btn-green" onclick="addQ('tf')">‚ûï ƒê√∫ng/Sai</button>
            <button class="btn btn-orange" onclick="addQ('short')">‚ûï ƒêi·ªÅn Khuy·∫øt</button>
            <button class="btn btn-gray" onclick="addQ('match')">‚ûï Gh√©p C·ªôt</button>
            <div style="flex:1"></div>
            <button class="btn btn-red" onclick="publishExam()">üöÄ XU·∫§T B·∫¢N NGAY</button>
        </div>
        <div class="split-view">
            <div class="editor-col" id="editor-area">
                <div id="questions-list"></div>
                <p style="text-align:center;color:#666;margin-top:20px" id="empty-msg">Ch∆∞a c√≥ c√¢u h·ªèi n√†o. H√£y b·∫•m n√∫t th√™m b√™n tr√™n!</p>
            </div>
            
            <div class="preview-col" id="preview-area">
                <div class="preview-header"><h3>XEM TR∆Ø·ªöC (PREVIEW)</h3></div>
                <div id="preview-content"></div>
            </div>
        </div>
    </div>
    <div id="sec-images" class="section">
        <div style="margin-bottom:15px; display:flex; justify-content:space-between">
            <h3>KHO ·∫¢NH TR√äN GITHUB</h3>
            <button class="btn btn-green" onclick="loadImagesFromGitHub()">üîÑ T·∫£i L·∫°i ·∫¢nh</button>
        </div>
        <div id="image-gallery" style="display:flex;flex-wrap:wrap;gap:10px"></div>
    </div>
</div>

<script>
   const ADMIN_HASH = "55ab43ebd8eb2635766c3944cb192e72"; // M·∫≠t kh·∫©u: binhminh
    let EXAM_QUESTIONS = [];

    // --- H·ªÜ TH·ªêNG: ƒêƒÇNG NH·∫¨P (ƒê√£ th√™m trim() s·ª≠a l·ªói nh·∫≠p) ---
    function checkAdmin(){
        // Ki·ªÉm tra th∆∞ vi·ªán m√£ h√≥a ƒë√£ t·∫£i ch∆∞a
        if(typeof CryptoJS === 'undefined') {
            alert("L·ªói: M·∫•t m·∫°ng ho·∫∑c ch∆∞a t·∫£i ƒë∆∞·ª£c th∆∞ vi·ªán m√£ h√≥a!");
            return;
        }
        
        // L·∫•y m·∫≠t kh·∫©u v√† c·∫Øt b·ªè kho·∫£ng tr·∫Øng th·ª´a (quan tr·ªçng)
        let pass = document.getElementById('admin-pass-input').value.trim();
        
        if(CryptoJS.MD5(pass).toString() === ADMIN_HASH){
            document.getElementById('login-screen').style.display='none';
            document.getElementById('main-app').style.display='block';
            sessionStorage.setItem('admin_ok','1');
        } else {
            alert("Sai m·∫≠t kh·∫©u! (L∆∞u √Ω: Th·∫ßy nh·∫≠p l√† '" + pass + "')");
            document.getElementById('login-msg').style.display='block';
        }
    }
    if(sessionStorage.getItem('admin_ok')) checkAdmin();

    function switchTab(t){
        document.querySelectorAll('.section').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
        document.getElementById('sec-'+t).classList.add('active');
        const btn = document.getElementById('tab-'+t); if(btn) btn.classList.add('active');
        if(t === 'files') loadFileManager('');
        if(t === 'images') loadImagesFromGitHub();
    }
    
    // --- C·∫§U H√åNH ---
    const IDS = ['gh-user','gh-repo','gh-token','bank-id','bank-acc', 'gs-url'];
    window.onload=()=>{ IDS.forEach(id=>{if(localStorage.getItem(id))document.getElementById(id).value=localStorage.getItem(id)}); }
    function saveConfig(){ IDS.forEach(id=>localStorage.setItem(id,document.getElementById(id).value.trim())); alert("ƒê√£ l∆∞u!"); }
    function hashPass(){let p=document.getElementById('exam-pass').value.trim();document.getElementById('exam-pass-hash').value=p?CryptoJS.MD5(p).toString():"";}

    // --- LOGIC C√ÇU H·ªéI ---
    function addQ(type) {
        let def = {point:0.2, type:type, img:'', explain:'L·ªùi gi·∫£i... [IMG]', solImg:''};
        if(type==='mcq') { def.q='C√¢u h·ªèi... [IMG]'; def.options=['A','B','C','D']; def.ans=0; }
        else if(type==='tf') { def.point=1.0; def.q='ƒê√∫ng hay sai?'; def.items=[{sub:'√ù 1', ans:'T'},{sub:'√ù 2', ans:'F'},{sub:'√ù 3', ans:'T'},{sub:'√ù 4', ans:'F'}]; }
        else if(type==='short') { def.point=0.5; def.q='ƒêi·ªÅn ƒë√°p √°n:'; def.ans=''; }
        else if(type==='match') { def.point=1.0; def.q='Gh√©p c·∫∑p:'; def.items=['Tr√°i 1','Tr√°i 2']; def.options=['Ph·∫£i A','Ph·∫£i B']; def.ans=['A','B']; }
        
        EXAM_QUESTIONS.push(def); renderEditor();
    }

    async function handleImageUpload(input, index, field) {
        const file = input.files[0]; if(!file) return;
        const u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value,t=document.getElementById('gh-token').value;
        if(!t) return alert("Ch∆∞a c√≥ Token GitHub!");
        
        input.parentElement.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Upload...`;
        try {
            const ext = file.name.split('.').pop();
            const fileName = `img_${Date.now()}_${Math.floor(Math.random()*1000)}.${ext}`;
            const path = `images/${fileName}`;
            const base64 = await new Promise(r => { let fr=new FileReader(); fr.onload=()=>r(fr.result.split(',')[1]); fr.readAsDataURL(file); });
            const res = await fetch(`https://api.github.com/repos/${u}/${r}/contents/${path}`, {
                method: 'PUT', headers: { Authorization: `token ${t}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: `Upload ${fileName}`, content: base64 })
            });
            if(!res.ok) throw new Error("L·ªói Upload GitHub");
            const data = await res.json();
            const rawUrl = data.content.download_url;
            if(field === 'q') EXAM_QUESTIONS[index].img = rawUrl; else EXAM_QUESTIONS[index].solImg = rawUrl;
            renderEditor(); 
        } catch(e) { alert("Upload th·∫•t b·∫°i: " + e.message); renderEditor(); }
    }

   function renderEditor(){
        let c=document.getElementById('questions-list'); c.innerHTML="";
        if(EXAM_QUESTIONS.length > 0) { document.getElementById('empty-msg').style.display='none'; document.getElementById('preview-area').style.display='block'; }
        
        let totalScore = 0;
        EXAM_QUESTIONS.forEach((q,i)=>{
            totalScore += parseFloat(q.point || 0);
            const mkInput = (val, fn) => `<input value="${val}" onchange="${fn}" style="flex:1">`;
            let ansUI = "";
            
            if(q.type === 'mcq') {
                ansUI = q.options.map((opt, idx) => `
                    <div class="mcq-row">
                        <div class="mcq-left-col" title="Ch·ªçn ƒë√°p √°n ƒë√∫ng">
                            <input type="radio" name="r${i}" class="big-radio" ${q.ans==idx?'checked':''} onchange="EXAM_QUESTIONS[${i}].ans=${idx};renderPreview()">
                            <span class="mcq-label">${['A','B','C','D'][idx]}</span>
                        </div>
                        <div class="mcq-input-area">
                            <textarea placeholder="Nh·∫≠p n·ªôi dung ph∆∞∆°ng √°n ${['A','B','C','D'][idx]}..." 
                                oninput="EXAM_QUESTIONS[${i}].options[${idx}]=this.value;renderPreview()">${opt}</textarea>
                        </div>
                    </div>`).join('');
            }
            else if (q.type === 'tf') ansUI = q.items.map((it,idx)=>`<div style="display:flex;gap:5px;margin-bottom:3px"><b style="width:30px">√ù ${idx+1}</b>${mkInput(it.sub, `EXAM_QUESTIONS[${i}].items[${idx}].sub=this.value;renderPreview()`)}<select onchange="EXAM_QUESTIONS[${i}].items[${idx}].ans=this.value;renderPreview()"><option value="T" ${it.ans=='T'?'selected':''}>ƒê√öNG</option><option value="F" ${it.ans=='F'?'selected':''}>SAI</option></select></div>`).join('');
            else if (q.type === 'short') ansUI = `<b>ƒê√°p √°n:</b> ${mkInput(q.ans, `EXAM_QUESTIONS[${i}].ans=this.value;renderPreview()`)}`;
            else if (q.type === 'match') ansUI = q.items.map((it,idx)=>`<div style="display:flex;gap:5px;margin-bottom:3px">${mkInput(it, `EXAM_QUESTIONS[${i}].items[${idx}]=this.value;renderPreview()`)} - ${mkInput(q.options[idx], `EXAM_QUESTIONS[${i}].options[${idx}]=this.value;renderPreview()`)} - ƒê.√Ån: <input style="width:40px" value="${q.ans[idx]}" onchange="EXAM_QUESTIONS[${i}].ans[${idx}]=this.value;renderPreview()"></div>`).join('');
            
            c.insertAdjacentHTML('beforeend',`<div class="q-item">
                <div class="q-item-header">
                    <span style="font-weight:bold;color:#00796b">C√¢u ${i+1} (${q.type.toUpperCase()})</span>
                    <div style="display:flex;align-items:center">
                        <b style="color:#e65100;margin-right:5px">ƒêi·ªÉm:</b> 
                        <input type="number" class="point-input" step="0.05" value="${q.point||0}" onchange="EXAM_QUESTIONS[${i}].point=this.value; renderEditor()">
                       
                        <label style="margin-left:10px; display:flex; align-items:center; cursor:pointer; background:${q.mustTake?'#e8eaf6':'#f5f5f5'}; padding:3px 8px; border-radius:4px; border:1px solid ${q.mustTake?'#3f51b5':'#ccc'}">
                        <input type="checkbox" ${q.mustTake?'checked':''} onchange="EXAM_QUESTIONS[${i}].mustTake=this.checked; renderEditor()" style="transform:scale(1.2); margin-right:5px">
                        <span style="font-size:0.85em; font-weight:bold; color:${q.mustTake?'#3f51b5':'#777'}">${q.mustTake ? 'üìå ƒê√£ Ghim' : 'Ghim c√¢u n√†y'}</span>
                        </label>
                        <button class="btn btn-red" style="padding:2px 8px;font-size:0.8em;margin-left:10px" onclick="EXAM_QUESTIONS.splice(${i},1);renderEditor()">X√≥a</button>
                    </div>
                </div>
                <div style="margin-bottom:5px"><b>N·ªôi dung c√¢u h·ªèi:</b></div>
                <textarea class="smart-textarea" oninput="EXAM_QUESTIONS[${i}].q=this.value; renderPreview()">${q.q}</textarea>
                <div class="upload-wrapper" style="background:#f1f8e9; padding:5px; border-radius:4px">
                    <i class="fas fa-image" style="color:#2e7d32"></i>
                    <input type="text" value="${q.img||''}" onchange="EXAM_QUESTIONS[${i}].img=this.value; renderPreview()" style="flex:1" placeholder="Link ·∫£nh... [IMG]">
                    <label class="file-upload-btn"><i class="fas fa-upload"></i> <input type="file" style="display:none" accept="image/*" onchange="handleImageUpload(this, ${i}, 'q')"></label>
                </div>
                <div style="margin:15px 0;">${ansUI}</div>
                <div style="margin-bottom:5px"><b>L·ªùi gi·∫£i chi ti·∫øt:</b></div>
                <textarea class="smart-textarea" placeholder="L·ªùi gi·∫£i..." oninput="EXAM_QUESTIONS[${i}].explain=this.value; renderPreview()" style="height:50px;border-color:#a5d6a7">${q.explain||''}</textarea>
                <div class="upload-wrapper" style="background:#fffde7; padding:5px; border-radius:4px; margin-top:5px">
                    <i class="fas fa-lightbulb" style="color:#fbc02d"></i>
                    <input type="text" value="${q.solImg||''}" onchange="EXAM_QUESTIONS[${i}].solImg=this.value; renderPreview()" style="flex:1" placeholder="Link ·∫£nh l·ªùi gi·∫£i... [IMG]">
                    <label class="file-upload-btn"><i class="fas fa-upload"></i> <input type="file" style="display:none" accept="image/*" onchange="handleImageUpload(this, ${i}, 'sol')"></label>
                </div>
            </div>`);
        });
        document.getElementById('total-score-display').innerText = totalScore.toFixed(2);
        document.getElementById('total-qs').innerText = EXAM_QUESTIONS.length;
        renderPreview();
    }

    function renderPreview() {
        let h = '';
        const procImg = (txt, img) => {
            if(!img) return txt;
            return txt.includes('[IMG]') ? txt.replace('[IMG]', `<img src="${img}" class="p-img">`) : txt + `<br><img src="${img}" class="p-img">`;
        };
        EXAM_QUESTIONS.forEach((q, i) => {
            let pt = q.point ? `<span style="float:right;color:red;font-weight:bold">[${q.point}ƒë]</span>` : '';
            let body = '';
            if(q.type === 'mcq') {
                body = q.options.map((opt, idx) => `
                    <div class="p-opt-row ${q.ans==idx ? 'correct-ans' : ''}">
                        <div class="p-opt-label">${['A','B','C','D'][idx]}.</div>
                        <div class="p-opt-content">${opt}</div>
                    </div>`).join('');
            }
            else if (q.type === 'tf') body = `<table width="100%"><tr><th>√ù</th><th>N·ªôi dung</th><th>ƒê/S</th></tr>` + q.items.map((it, idx) => `<tr><td>${idx+1}</td><td>${it.sub}</td><td><b>${it.ans=='T'?'ƒê':'S'}</b></td></tr>`).join('') + `</table>`;
            else if (q.type === 'short') body = `<div class="p-opt"><b>Tr·∫£ l·ªùi:</b> ${q.ans}</div>`;
            else if (q.type === 'match') body = q.items.map((it, idx) => `<div class="p-opt">${idx+1}. ${it} --> ${q.ans[idx]} (${q.options[idx]})</div>`).join('');
            
            h += `<div class="p-q-block"><div class="p-label">C√¢u ${i+1}: ${pt}</div>
                <div class="p-content">${procImg(q.q, q.img)}</div>
                <div>${body}</div>
                <div class="p-sol"><b>L·ªùi gi·∫£i:</b><br>${procImg(q.explain, q.solImg)}</div>
            </div>`;
        });
        document.getElementById('preview-content').innerHTML = h;
        if(window.MathJax) MathJax.typesetPromise();
    }
    
    function parseDataSafe() {
        try {
            let data = JSON.parse(document.getElementById('json-input').value.trim());
            EXAM_QUESTIONS = Array.isArray(data) ? data : (data.questions || []);
            renderEditor(); alert("‚úÖ ƒê√£ n·∫°p " + EXAM_QUESTIONS.length + " c√¢u h·ªèi!");
        } catch(e) { alert("‚ùå L·ªói JSON: " + e.message); }
    }

    async function deleteFileGeneric(path, name, isFileManager) {
        if(!confirm(`‚ö†Ô∏è X√ìA Vƒ®NH VI·ªÑN: ${name}?`)) return;
        const u=document.getElementById('gh-user').value, r=document.getElementById('gh-repo').value, t=document.getElementById('gh-token').value;
        const ov=document.getElementById('loading-overlay'); ov.style.display='flex';
        try {
            const res = await fetch(`https://api.github.com/repos/${u}/${r}/contents/${path}`, {headers: {Authorization: `token ${t}`}});
            const data = await res.json();
            await fetch(`https://api.github.com/repos/${u}/${r}/contents/${path}`, {
                method: 'DELETE', headers: { Authorization: `token ${t}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: `Delete ${name}`, sha: data.sha })
            });
            alert("ƒê√£ x√≥a!"); 
            if(isFileManager) loadFileManager(currentPath); else if (path.startsWith('images/')) loadImagesFromGitHub(); else loadDataFiles();
        } catch(e) { alert("L·ªói: " + e.message); } finally { ov.style.display='none'; }
    }

    async function loadDataFiles(){
        const u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value,t=document.getElementById('gh-token').value;
        if(!u)return alert("Thi·∫øu Config!");
        try{
            const res=await fetch(`https://api.github.com/repos/${u}/${r}/contents/data`,{headers:{Authorization:`token ${t}`}});
            const f=await res.json();
            let h='';
            f.forEach(x=>{
                if(x.name.endsWith('.js')&&x.name!=='list.js') {
                    h+=`<div class="file-item"><span style="font-weight:500">${x.name}</span><div><button class="btn btn-qr" onclick="showExamQR('${x.name}')">QR</button><button class="btn btn-edit" onclick="loadExamToEdit('${x.path}','${x.name}')">S·ª≠a</button><button class="btn btn-red" onclick="deleteFileGeneric('${x.path}','${x.name}', false)">X√≥a</button></div></div>`;
                }
            });
            document.getElementById('data-list').innerHTML=h;
        }catch(e){alert(e.message);}
    }

    async function loadExamToEdit(path, name) {
        const u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value,t=document.getElementById('gh-token').value;
        const ov=document.getElementById('loading-overlay'); ov.style.display='flex';
        try{
            const res=await fetch(`https://api.github.com/repos/${u}/${r}/contents/${path}`,{headers:{Authorization:`token ${t}`}});
            const json=await res.json(), content=decodeURIComponent(escape(atob(json.content.replace(/\s/g, ''))));
            let dataStr = content.substring(content.indexOf('{'), content.lastIndexOf('}')+1);
            let data=JSON.parse(dataStr);
            document.getElementById('exam-id').value=name.replace('.js','');
            ['title','time','take','price','subject','grade','start','end','minTime'].forEach(k => {
                 if(data[k] !== undefined) {
                    let elId = (k==='minTime') ? 'min-time-percent' : 'exam-'+k;
                    let el = document.getElementById(elId);
                    if(el) el.value = data[k].toString().replace('K','');
                }
            });
            document.getElementById('exam-pass-hash').value=data.password||"";
            document.getElementById('secure-mode').checked=data.encrypted;
            document.getElementById('exam-shuffle').checked = (data.shuffle !== false);
            document.getElementById('view-detail').checked = (data.viewDetail !== false);
            document.getElementById('exam-music').checked = (data.music === true);
            document.getElementById('allow-print').checked = (data.allowPrint === true);
            EXAM_QUESTIONS = (data.questions||[]).map(q => {
                if(q.explain && q.explain.includes('<img')) {
                    let match = q.explain.match(/src="([^"]+)"/);
                    if(match) q.solImg = match[1];
                    q.explain = q.explain.replace(/<br><img.*?>/g, '').trim(); 
                }
                if(q.q && q.q.includes('<img')) {
                    let match = q.q.match(/src="([^"]+)"/);
                    if(match) q.img = match[1];
                    q.q = q.q.replace(/<br><img.*?>/g, '').trim(); 
                }
                return q;
            });
            renderEditor(); ov.style.display='none'; switchTab('create');
        }catch(e){ alert("L·ªói t·∫£i ƒë·ªÅ: "+e.message); ov.style.display='none'; }
    }

    async function publishExam(){
        const u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value,t=document.getElementById('gh-token').value,id=document.getElementById('exam-id').value;
        if(!u||!r||!t||!id)return alert("Thi·∫øu ID ho·∫∑c C·∫•u h√¨nh!");
        
        let sTime = document.getElementById('exam-start').value;
        let eTime = document.getElementById('exam-end').value;
        if(sTime && eTime && new Date(sTime) >= new Date(eTime)){
            alert("‚õî L·ªñI: Th·ªùi gian ƒê√≥ng ƒë·ªÅ ph·∫£i SAU th·ªùi gian M·ªü ƒë·ªÅ!");
            return;
        }

        const ov=document.getElementById('loading-overlay'); ov.style.display='flex';
        try{
            let fQ=JSON.parse(JSON.stringify(EXAM_QUESTIONS));
            let sec=document.getElementById('secure-mode').checked;
            
            fQ.forEach(q=>{
                if(q.solImg) {
                    q.explain = (q.explain || "") + (q.explain.includes('[IMG]') ? "" : `<br><img src="${q.solImg}" style="max-width:100%;margin-top:10px;border-radius:5px">`);
                    if(q.explain.includes('[IMG]')) q.explain = q.explain.replace('[IMG]', `<img src="${q.solImg}" style="max-width:100%;margin-top:10px;border-radius:5px">`);
                    delete q.solImg; 
                }
                if(q.img) {
                    q.q = q.q + (q.q.includes('[IMG]') ? "" : `<br><img src="${q.img}" style="max-width:100%;margin:10px 0;border-radius:5px">`);
                    if(q.q.includes('[IMG]')) q.q = q.q.replace('[IMG]', `<img src="${q.img}" style="max-width:100%;margin:10px 0;border-radius:5px">`);
                    delete q.img;
                }
                if(sec){
                    const h = (v) => CryptoJS.MD5(String(v).trim()).toString();
                    if(q.type==='mcq') q.ans=h(q.ans);
                    else if(q.type==='tf') q.items.forEach(x=>x.ans=h(x.ans));
                    else if(q.type==='short') q.ans=h(String(q.ans).toLowerCase().replace(',','.'));
                    else if(q.type==='match') q.ans=q.ans.map(v=>h(v));
                }
            });

            let dt={
                title: document.getElementById('exam-title').value,
                subject: document.getElementById('exam-subject').value, 
                grade: document.getElementById('exam-grade').value,
                time: parseInt(document.getElementById('exam-time').value),
                take: parseInt(document.getElementById('exam-take').value) || 0, // <--- TH√äM D√íNG N√ÄY
                password: document.getElementById('exam-pass-hash').value,
                encrypted: sec,
                shuffle: document.getElementById('exam-shuffle').checked,
                viewDetail: document.getElementById('view-detail').checked,
                music: document.getElementById('exam-music').checked,
                allowPrint: document.getElementById('allow-print').checked,
                minTime: parseInt(document.getElementById('min-time-percent').value) || 0,
                start: sTime,
                end: eTime,
                price: parseInt(document.getElementById('exam-price').value) || 0, 
                bank: {id: document.getElementById('bank-id').value, acc: document.getElementById('bank-acc').value},
                scores: {mcq:0.25, tf:1.0, short:0.5, match:1.0},
                questions: fQ
            };

            let c=btoa(unescape(encodeURIComponent(`window.EXAM_DATA = ${JSON.stringify(dt,null,4)};`)));
            await upF(u,r,t,`data/${id}.js`,c,false);
            await updateList(u,r,t,id,dt);

            // --- ƒêO·∫†N G·ª¨I GOOGLE SHEET (ƒê√£ s·ª≠a l·ªói) ---
            let gsUrl = document.getElementById('gs-url').value.trim();
            let rawPass = document.getElementById('exam-pass').value.trim();
            if (gsUrl && rawPass) {
                let fd = new FormData();
                fd.append("action", "savePass");
                fd.append("id", id);
                fd.append("title", dt.title);
                fd.append("pass", rawPass);
                fetch(gsUrl, { method: "POST", body: fd, mode: "no-cors" }).catch(e=>console.log(e));
            }
            // ----------------------------------------

            alert("‚úÖ Xu·∫•t b·∫£n th√†nh c√¥ng!"); 
            loadDataFiles();

        } catch(e){
            alert("‚ùå L·ªói: " + e.message);
        } finally {
            ov.style.display='none';
        }
    }

    async function upF(u,r,t,p,c,isF){let s=null;try{let k=await fetch(`https://api.github.com/repos/${u}/${r}/contents/${p}`,{headers:{Authorization:`token ${t}`}});if(k.ok)s=(await k.json()).sha;}catch(e){}let b={message:"Up",content:isF?await toB64(c):c};if(s)b.sha=s;let rs=await fetch(`https://api.github.com/repos/${u}/${r}/contents/${p}`,{method:'PUT',headers:{Authorization:`token ${t}`,'Content-Type':'application/json'},body:JSON.stringify(b)});if(!rs.ok){let j=await rs.json();throw new Error(j.message);}}
    function toB64(f){return new Promise(r=>{let fr=new FileReader();fr.onload=()=>r(fr.result.split(',')[1]);fr.readAsDataURL(f);});}
    
    async function updateList(u,r,t,id,d){
        let url=`https://api.github.com/repos/${u}/${r}/contents/data/list.js`;
        let l=[],s=null;
        try{
            let k=await fetch(url,{headers:{Authorization:`token ${t}`}});
            if(k.ok){
                let j=await k.json(); s=j.sha;
                let content = decodeURIComponent(escape(atob(j.content.replace(/\s/g, ''))));
                let jsonStr = content.substring(content.indexOf('['), content.lastIndexOf(']')+1);
                if(jsonStr) l = JSON.parse(jsonStr);
            }
        }catch(e){}
        
        if(!Array.isArray(l)) l = [];
        l=l.filter(x=>x.id!==id);
        l.unshift({
            id: id, title: d.title, subject: d.subject, grade: d.grade, time: d.time,
            allowPrint: d.allowPrint, 
            start: d.start, end: d.end
        });
        let c=btoa(unescape(encodeURIComponent(`window.EXAM_LIST = ${JSON.stringify(l,null,4)};`)));
        await upF(u,r,t,`data/list.js`,c,false);
    }
    
    function showExamQR(n){let u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value;let url=`https://${u}.github.io/${r}/thi.html?id=${n.replace('.js','')}`;document.getElementById('qr-modal').style.display='flex';document.getElementById('qr-link-text').innerText=url;document.getElementById('qrcode').innerHTML="";new QRCode(document.getElementById("qrcode"),{text:url,width:200,height:200});}
    
    async function loadFileManager(path) {
        currentPath = path;
        document.getElementById('fm-current-path').innerText = path || " (G·ªëc)";
        const u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value,t=document.getElementById('gh-token').value;
        try {
            const res = await fetch(`https://api.github.com/repos/${u}/${r}/contents/${path}`, {headers: {Authorization: `token ${t}`}});
            if(!res.ok) throw new Error("L·ªói t·∫£i th∆∞ m·ª•c!");
            const items = await res.json();
            items.sort((a, b) => (a.type === b.type ? 0 : a.type === 'dir' ? -1 : 1));
            let html = '';
            if(path !== "") { 
                let parent = path.split('/').slice(0,-1).join('/');
                html += `<div class="fm-item" onclick="loadFileManager('${parent}')"><div class="fm-icon fm-folder"><i class="fas fa-level-up-alt"></i></div><div class="fm-name">.. (Quay l·∫°i)</div></div>`;
            }
            items.forEach(item => {
                let icon = item.type === 'dir' ? '<i class="fas fa-folder"></i>' : '<i class="fas fa-file-alt"></i>';
                let cls = item.type === 'dir' ? 'fm-folder' : 'fm-file';
                let action = item.type === 'dir' ? `onclick="loadFileManager('${item.path}')"` : '';
                let delBtn = `<button class="btn btn-red" style="padding:2px 8px" onclick="event.stopPropagation();deleteFileGeneric('${item.path}', '${item.name}', true)">X√≥a</button>`;
                html += `<div class="fm-item" ${action}><div class="fm-icon ${cls}">${icon}</div><div class="fm-name">${item.name}</div><div>${delBtn}</div></div>`;
            });
            document.getElementById('fm-list').innerHTML = html;
        } catch(e) {}
    }
    
    async function loadImagesFromGitHub(){
        const u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value,t=document.getElementById('gh-token').value;
        if(!u)return;
        try{
            const res=await fetch(`https://api.github.com/repos/${u}/${r}/contents/images`,{headers:{Authorization:`token ${t}`}});
            const f=await res.json();
            let h='';
            f.forEach(x=>{
                if(x.name.match(/\.(png|jpg|jpeg|gif)$/i)) {
                    h+=`<div class="img-card"><img src="${x.download_url}" onclick="window.open('${x.download_url}')"><small>${x.name}</small><button class="img-del-btn" onclick="deleteFileGeneric('${x.path}', '${x.name}', false)">X√≥a ·∫¢nh</button></div>`;
                }
            });
            document.getElementById('image-gallery').innerHTML=h;
        }catch(e){}
    }
    // --- H√ÄM T·ª∞ ƒê·ªòNG CHIA ƒêI·ªÇM (M·ªöI) ---
    function autoDistributePoints() {
        // 1. L·∫•y t·ªïng ƒëi·ªÉm ng∆∞·ªùi d√πng nh·∫≠p (n·∫øu kh√¥ng nh·∫≠p th√¨ coi nh∆∞ 0)
        let tMCQ = parseFloat(document.getElementById('total-mcq').value) || 0;
        let tTF = parseFloat(document.getElementById('total-tf').value) || 0;
        let tShort = parseFloat(document.getElementById('total-short').value) || 0;
        let tMatch = parseFloat(document.getElementById('total-match').value) || 0;

        // 2. ƒê·∫øm s·ªë l∆∞·ª£ng c√¢u h·ªèi m·ªói lo·∫°i hi·ªán c√≥
        let cMCQ = EXAM_QUESTIONS.filter(q => q.type === 'mcq').length;
        let cTF = EXAM_QUESTIONS.filter(q => q.type === 'tf').length;
        let cShort = EXAM_QUESTIONS.filter(q => q.type === 'short').length;
        let cMatch = EXAM_QUESTIONS.filter(q => q.type === 'match').length;

        // 3. T√≠nh to√°n v√† chia ƒëi·ªÉm (Ch·ªâ chia n·∫øu c√≥ nh·∫≠p t·ªïng ƒëi·ªÉm v√† c√≥ c√¢u h·ªèi)
        let count = 0;

        if (tMCQ > 0 && cMCQ > 0) {
            let p = tMCQ / cMCQ;
            EXAM_QUESTIONS.forEach(q => { if(q.type === 'mcq') q.point = parseFloat(p.toFixed(3)); }); 
            count++;
        }
        
        if (tTF > 0 && cTF > 0) {
            let p = tTF / cTF;
            EXAM_QUESTIONS.forEach(q => { if(q.type === 'tf') q.point = parseFloat(p.toFixed(3)); });
            count++;
        }

        if (tShort > 0 && cShort > 0) {
            let p = tShort / cShort;
            EXAM_QUESTIONS.forEach(q => { if(q.type === 'short') q.point = parseFloat(p.toFixed(3)); });
            count++;
        }

        if (tMatch > 0 && cMatch > 0) {
            let p = tMatch / cMatch;
            EXAM_QUESTIONS.forEach(q => { if(q.type === 'match') q.point = parseFloat(p.toFixed(3)); });
            count++;
        }

        // 4. C·∫≠p nh·∫≠t giao di·ªán
        if(count > 0) {
            renderEditor();
            alert("‚úÖ ƒê√£ chia ƒë·ªÅu ƒëi·ªÉm th√†nh c√¥ng!");
        } else {
            alert("‚ö†Ô∏è Th·∫ßy ch∆∞a nh·∫≠p t·ªïng ƒëi·ªÉm ho·∫∑c ch∆∞a c√≥ c√¢u h·ªèi n√†o ƒë·ªÉ chia!");
        }
    }
</script>
</body>
</html>
