<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Tool v25.0 (Full Control)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }, svg: { fontCache: 'global' } };</script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body{font-family:'Segoe UI',sans-serif;background:#eceff1;padding:20px;color:#37474f;margin:0}
        .btn{padding:8px 15px;border:none;border-radius:4px;cursor:pointer;font-weight:bold;color:white;font-size:0.9em;display:inline-flex;align-items:center;gap:5px}
        .btn-green{background:#2e7d32}.btn-blue{background:#1565c0}.btn-red{background:#c62828}.btn-gray{background:#607d8b}.btn-orange{background:#ef6c00}
        .config-box{background:#e3f2fd;padding:15px;border-radius:8px;margin-bottom:20px}
        .row{display:flex;gap:15px;margin-bottom:10px}.col{flex:1}
        label{font-weight:600;display:block;margin-bottom:3px}
        input,select,textarea{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box}
        .tab-bar{display:flex;gap:10px;margin-bottom:20px;border-bottom:2px solid #eee;padding-bottom:10px;overflow-x:auto}
        .tab-btn{padding:10px 20px;background:#f5f5f5;border:none;border-radius:6px;cursor:pointer;color:#666;font-weight:bold;white-space:nowrap}
        .tab-btn.active{background:#00796b;color:white}
        .section{display:none}.section.active{display:block}
        
        .split-view {display:flex; gap:20px; align-items: flex-start;}
        .editor-col {flex: 1.2; min-width: 0;}
        .preview-col {flex: 0.8; position: sticky; top: 20px; max-height: 90vh; overflow-y: auto; background: white; border-radius: 8px; border: 1px solid #ddd; padding: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display:none;}
        
        .q-item {background:white; padding:15px; border:1px solid #ccc; border-radius:8px; margin-bottom:15px; border-left:5px solid #009688; position:relative;}
        .q-item-header {display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px}
        .smart-textarea {min-height:60px; font-family:inherit; font-size:1em}
        .upload-wrapper {display:flex; gap:5px; margin: 5px 0;}
        .file-upload-btn {background:#e0e0e0; color:#333; padding:5px 10px; border-radius:4px; cursor:pointer; display:inline-block; font-size:0.9em; border:1px solid #ccc;}
        
        .score-box {background:#fff3e0; padding:15px; border:1px solid #ffe0b2; border-radius:8px; margin-bottom:20px; text-align:center; color:#e65100; box-shadow: 0 2px 5px rgba(0,0,0,0.05);}
        .score-total {font-size:2em; font-weight:bold; color:#d32f2f; display:block;}
        .point-input {width:70px !important; text-align:center; color:#d32f2f; font-weight:bold; border:1px solid #ffab91;}

        .preview-header {text-align: center; color: #1a237e; border-bottom: 2px solid #eee; margin-bottom: 15px; padding-bottom: 10px;}
        .p-q-block {background:#fff; margin-bottom:15px; padding-bottom:15px; border-bottom:1px dashed #ccc;}
        .p-label {color:#1a237e; font-weight:bold; font-size:1.1em;}
        .p-content {font-weight:500; margin-bottom:10px;}
        .p-opt {background:#fafafa; border:1px solid #eee; padding:8px; margin-bottom:5px; border-radius:4px;}
        .p-img {max-width:100%; border-radius:8px; margin:10px 0; border:1px solid #eee; display:block;}
        .p-sol {background:#e8f5e9; color:#2e7d32; padding:10px; border-radius:4px; font-size:0.9em; margin-top:10px; border:1px dashed #a5d6a7;}
        
        .file-item{display:flex;justify-content:space-between;padding:10px;background:#fafafa;border:1px solid #ddd;border-radius:6px;margin-bottom:5px;align-items:center}
        .fm-breadcrumb {padding:10px; background:#eee; margin-bottom:15px; border-radius:4px; font-weight:bold; display:flex; align-items:center;}
        .fm-item {display:flex; align-items:center; padding:10px; border-bottom:1px solid #eee; cursor:pointer;}
        .fm-item:hover {background:#f0f0f0;}
        .fm-icon {width:30px; text-align:center; margin-right:10px; font-size:1.2em;}
        .fm-name {flex:1; font-weight:500;} .fm-folder {color:#fbc02d;} .fm-file {color:#546e7a;}
        .img-card {border:1px solid #ddd; padding:5px; background:white; border-radius:4px; text-align:center; width: 150px; position: relative;}
        .img-card img {width: 100%; height: 100px; object-fit: cover; border-radius: 4px;}
        .img-card small {display:block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-top:5px;}
        .img-del-btn {background:#d32f2f; color:white; border:none; width:100%; padding:5px; cursor:pointer; margin-top:5px; border-radius:2px;}
        
        #loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;display:none;flex-direction:column;justify-content:center;align-items:center;color:white}
        .modal{display:none;position:fixed;z-index:10000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);align-items:center;justify-content:center}
        .modal-content{background-color:white;padding:20px;border-radius:10px;text-align:center}
        #qrcode{margin:20px auto;display:flex;justify-content:center}
        #login-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:#263238;z-index:9999;display:flex;justify-content:center;align-items:center}
        .login-box{background:white;padding:40px;border-radius:10px;width:350px;text-align:center}
        #main-app{display:none;max-width:1400px;margin:0 auto;background:white;padding:25px;border-radius:10px} 
    </style>
</head>
<body>

<div id="loading-overlay"><div style="font-size:50px">üöÄ</div><h2 id="loading-title">ƒêANG X·ª¨ L√ù...</h2></div>

<div id="qr-modal" class="modal">
    <div class="modal-content">
        <h3 style="color:#3f51b5">M√É QR ƒê·ªÄ THI</h3>
        <p id="qr-link-text" style="font-size:0.8em;color:#666"></p>
        <div id="qrcode"></div>
        <button class="btn btn-red" onclick="document.getElementById('qr-modal').style.display='none'">ƒê√≥ng</button>
    </div>
</div>

<div id="login-screen">
    <div class="login-box">
        <h2 style="color:#00695c">ADMIN LOGIN</h2>
        <input type="password" id="admin-pass-input" onkeyup="if(event.key==='Enter')checkAdmin()">
        <button class="btn btn-green" onclick="checkAdmin()" style="margin-top:10px;width:100%">ƒêƒÇNG NH·∫¨P</button>
    </div>
</div>

<div id="main-app">
    <h1>QU·∫¢N TR·ªä v25.0 (FULL CONTROL)</h1>
    
    <div class="config-box">
        <div class="row">
            <div class="col"><label>User GitHub</label><input type="text" id="gh-user"></div>
            <div class="col"><label>Repo Name</label><input type="text" id="gh-repo"></div>
            <div class="col"><label>Token (Classic)</label><input type="password" id="gh-token"></div>
        </div>
        <div class="row" style="margin-top:10px">
            <div class="col"><label>Ng√¢n h√†ng</label><input type="text" id="bank-id" placeholder="MB"></div>
            <div class="col"><label>S·ªë T√†i Kho·∫£n</label><input type="text" id="bank-acc"></div>
            <div class="col"><button class="btn btn-gray" style="margin-top:22px;width:100%" onclick="saveConfig()">üíæ L∆∞u C·∫•u H√¨nh</button></div>
        </div>
    </div>

    <div class="tab-bar">
        <button id="tab-data" class="tab-btn active" onclick="switchTab('data')">üìÇ QU·∫¢N L√ù ƒê·ªÄ</button>
        <button id="tab-files" class="tab-btn" onclick="switchTab('files')">üóÇÔ∏è QU·∫¢N L√ù FILE</button>
        <button id="tab-create" class="tab-btn" onclick="switchTab('create')">üìù SO·∫†N ƒê·ªÄ</button>
        <button id="tab-images" class="tab-btn" onclick="switchTab('images')">üì∑ KHO ·∫¢NH</button>
    </div>

    <div id="sec-data" class="section active">
        <div style="display:flex;justify-content:space-between;margin-bottom:20px"><h3>DANH S√ÅCH ƒê·ªÄ THI</h3><button class="btn btn-green" onclick="loadDataFiles()">üîÑ T·∫£i L·∫°i</button></div>
        <div id="data-list" class="file-list"></div>
    </div>

    <div id="sec-files" class="section">
        <div class="fm-breadcrumb">
            <button class="btn btn-gray" style="margin-right:10px" onclick="loadFileManager('')"><i class="fas fa-home"></i> G·ªëc</button>
            <span id="fm-current-path">/</span>
        </div>
        <div id="fm-list" style="background:white;border:1px solid #ddd;border-radius:6px"></div>
    </div>

    <div id="sec-create" class="section">
        <div class="config-box" style="background:#fff3e0;border-color:#ffe0b2">
            <div class="row">
                <div class="col"><label>M√£ ƒê·ªÅ (ID)</label><input type="text" id="exam-id" placeholder="vd: de-toan-giua-ky-1" style="font-weight:bold;color:#c62828"></div>
                <div class="col" style="flex:2"><label>Ti√™u ƒê·ªÅ</label><input type="text" id="exam-title"></div>
            </div>
            
            <div class="row">
                <div class="col"><label>M√¥n H·ªçc</label><select id="exam-subject"><option value="Toan">To√°n</option><option value="Ly">V·∫≠t L√Ω</option><option value="Hoa">H√≥a H·ªçc</option><option value="Sinh">Sinh H·ªçc</option><option value="Anh">Ti·∫øng Anh</option><option value="Van">Ng·ªØ VƒÉn</option><option value="Su">L·ªãch S·ª≠</option><option value="Dia">ƒê·ªãa L√Ω</option><option value="GDCD">GDCD</option></select></div>
                <div class="col"><label>Kh·ªëi L·ªõp</label><select id="exam-grade"><option value="12">Kh·ªëi 12</option><option value="11">Kh·ªëi 11</option><option value="10">Kh·ªëi 10</option><option value="9">Kh·ªëi 9</option></select></div>
                <div class="col"><label>Th·ªùi gian (ph√∫t)</label><input type="number" id="exam-time" value="45"></div>
            </div>

            <div class="row">
                <div class="col"><label>Gi√° (VNƒê)</label><input type="number" id="exam-price" placeholder="0"></div>
                <div class="col"><label>M·∫≠t kh·∫©u</label><input type="text" id="exam-pass" oninput="hashPass()"><input type="hidden" id="exam-pass-hash"></div>
                <div class="col" style="flex:2"><label>C·∫•u h√¨nh thi</label>
                    <div style="margin-top:5px;display:flex;gap:15px;flex-wrap:wrap">
                        <span><input type="checkbox" id="secure-mode"> M√£ h√≥a</span>
                        <span style="color:#e65100;font-weight:bold"><input type="checkbox" id="exam-shuffle" checked> üîÄ ƒê·∫£o c√¢u</span>
                        <span style="color:#2e7d32;font-weight:bold"><input type="checkbox" id="view-detail" checked> üëÅÔ∏è Xem gi·∫£i</span>
                        <span style="color:#c2185b;font-weight:bold"><input type="checkbox" id="exam-music"> üéµ Nh·∫°c n·ªÅn</span>
                        <span style="color:#00796b;font-weight:bold"><input type="checkbox" id="allow-print" checked> üñ®Ô∏è Cho ph√©p in</span>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col"><label>M·ªü l√∫c</label><input type="datetime-local" id="exam-start"></div>
                <div class="col"><label>ƒê√≥ng l√∫c</label><input type="datetime-local" id="exam-end"></div>
                <div class="col"><label>L√†m t·ªëi thi·ªÉu (%)</label><input type="number" id="min-time-percent" placeholder="VD: 50"></div>
            </div>
        </div>

        <div style="margin-bottom:15px;display:flex;gap:10px">
            <button class="btn btn-blue" onclick="addQ('mcq')">‚ûï Tr·∫Øc Nghi·ªám</button>
            <button class="btn btn-green" onclick="addQ('tf')">‚ûï ƒê√∫ng/Sai</button>
            <button class="btn btn-orange" onclick="addQ('short')">‚ûï ƒêi·ªÅn Khuy·∫øt</button>
            <button class="btn btn-gray" onclick="addQ('match')">‚ûï Gh√©p C·ªôt</button>
            <button class="btn btn-red" style="margin-left:auto" onclick="publishExam()">üöÄ XU·∫§T B·∫¢N</button>
        </div>

        <div class="split-view">
            <div class="editor-col" id="editor-area">
                <div id="questions-list"></div>
                <p style="text-align:center;color:#666" id="empty-msg">Ch∆∞a c√≥ c√¢u h·ªèi.</p>
            </div>
            <div class="preview-col" id="preview-area">
                <div class="score-box">
                    <span style="font-size:0.9em;color:#666">T·ªîNG ƒêI·ªÇM TO√ÄN ƒê·ªÄ</span>
                    <span id="total-score-display" class="score-total">0.00</span>
                    <div style="font-size:0.8em;margin-top:5px">T·ªïng s·ªë c√¢u: <span id="total-qs" style="font-weight:bold">0</span></div>
                </div>
                <div class="preview-header"><h3>XEM TR∆Ø·ªöC (PREVIEW)</h3></div>
                <div id="preview-content"></div>
            </div>
        </div>
        
        <div style="margin-top:20px;border-top:1px dashed #ccc;padding-top:10px">
            <small style="cursor:pointer;color:#999" onclick="document.getElementById('json-import-box').style.display='block'">‚ñº N·∫°p d·ªØ li·ªáu JSON</small>
            <div id="json-import-box" style="display:none">
                <textarea id="json-input" style="width:100%;height:100px;font-family:monospace;font-size:0.9em" placeholder='D√°n m√£ JSON v√†o ƒë√¢y...'></textarea>
                <button class="btn btn-gray" onclick="parseDataSafe()">üì• N·∫°p D·ªØ Li·ªáu</button>
            </div>
        </div>
    </div>

    <div id="sec-images" class="section">
        <div style="margin-bottom:15px; display:flex; justify-content:space-between">
            <h3>KHO ·∫¢NH TR√äN GITHUB</h3>
            <button class="btn btn-green" onclick="loadImagesFromGitHub()">üîÑ T·∫£i L·∫°i ·∫¢nh</button>
        </div>
        <div id="image-gallery" style="display:flex;flex-wrap:wrap;gap:10px"></div>
    </div>
</div>

<script>
    const ADMIN_HASH = "55ab43ebd8eb2635766c3944cb192e72"; 
    let EXAM_QUESTIONS = [];

    function checkAdmin(){if(CryptoJS.MD5(document.getElementById('admin-pass-input').value).toString()===ADMIN_HASH){document.getElementById('login-screen').style.display='none';document.getElementById('main-app').style.display='block';sessionStorage.setItem('admin_ok','1');}else document.getElementById('login-msg').style.display='block';}
    if(sessionStorage.getItem('admin_ok')) checkAdmin();

    function switchTab(t){
        document.querySelectorAll('.section').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
        document.getElementById('sec-'+t).classList.add('active');
        const btn = document.getElementById('tab-'+t); if(btn) btn.classList.add('active');
        if(t === 'files') loadFileManager('');
        if(t === 'images') loadImagesFromGitHub();
    }
    
    window.onload=()=>{ ['gh-user','gh-repo','gh-token','bank-id','bank-acc'].forEach(id=>{if(localStorage.getItem(id))document.getElementById(id).value=localStorage.getItem(id)}); }
    function saveConfig(){ ['gh-user','gh-repo','gh-token','bank-id','bank-acc'].forEach(id=>localStorage.setItem(id,document.getElementById(id).value.trim())); alert("ƒê√£ l∆∞u!"); }
    function hashPass(){let p=document.getElementById('exam-pass').value.trim();document.getElementById('exam-pass-hash').value=p?CryptoJS.MD5(p).toString():"";}

    // --- LOGIC C√ÇU H·ªéI ---
    function addQ(type) {
        let defPoint = 0.2; 
        if(type==='tf') defPoint = 1.0;
        if(type==='short') defPoint = 0.5;
        if(type==='match') defPoint = 1.0;

        if(type === 'mcq') EXAM_QUESTIONS.push({type:'mcq', q:'C√¢u h·ªèi... [IMG]', point:defPoint, img:'', options:['A','B','C','D'], ans:0, explain:'L·ªùi gi·∫£i... [IMG]', solImg:''});
        if(type === 'tf') EXAM_QUESTIONS.push({type:'tf', q:'ƒê√∫ng hay sai?', point:defPoint, img:'', items:[{sub:'√ù 1', ans:'T'},{sub:'√ù 2', ans:'F'},{sub:'√ù 3', ans:'T'},{sub:'√ù 4', ans:'F'}], explain:'', solImg:''});
        if(type === 'short') EXAM_QUESTIONS.push({type:'short', q:'ƒêi·ªÅn ƒë√°p √°n:', point:defPoint, img:'', ans:'', explain:'', solImg:''});
        if(type === 'match') EXAM_QUESTIONS.push({type:'match', q:'Gh√©p c·∫∑p:', point:defPoint, img:'', items:['Tr√°i 1','Tr√°i 2','Tr√°i 3','Tr√°i 4'], options:['Ph·∫£i A','Ph·∫£i B','Ph·∫£i C','Ph·∫£i D'], ans:['A','B','C','D'], explain:'', solImg:''});
        renderEditor();
    }

    async function handleImageUpload(input, index, field) {
        const file = input.files[0];
        if(!file) return;
        const u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value,t=document.getElementById('gh-token').value;
        if(!t) return alert("Ch∆∞a c√≥ Token GitHub!");
        const ext = file.name.split('.').pop();
        const fileName = `img_${Date.now()}_${Math.floor(Math.random()*1000)}.${ext}`;
        const path = `images/${fileName}`;
        input.parentElement.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Upload...`;
        try {
            const base64 = await new Promise(r => { let fr=new FileReader(); fr.onload=()=>r(fr.result.split(',')[1]); fr.readAsDataURL(file); });
            const res = await fetch(`https://api.github.com/repos/${u}/${r}/contents/${path}`, {
                method: 'PUT', headers: { Authorization: `token ${t}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: `Upload ${fileName}`, content: base64 })
            });
            if(!res.ok) throw new Error("L·ªói Upload");
            const data = await res.json();
            const rawUrl = data.content.download_url; 
            if(field === 'q') EXAM_QUESTIONS[index].img = rawUrl; else EXAM_QUESTIONS[index].solImg = rawUrl;
            renderEditor(); 
        } catch(e) { alert("Upload th·∫•t b·∫°i: " + e.message); renderEditor(); }
    }

    function renderEditor(){
        let c=document.getElementById('questions-list'); c.innerHTML="";
        if(EXAM_QUESTIONS.length > 0) { document.getElementById('empty-msg').style.display='none'; document.getElementById('preview-area').style.display='block'; }
        
        let totalScore = 0;

        EXAM_QUESTIONS.forEach((q,i)=>{
            totalScore += parseFloat(q.point || 0);

            let scoreInput = `<div style="display:flex;align-items:center;margin-right:10px;color:#e65100">
                <b>ƒêi·ªÉm:</b> 
                <input type="number" class="point-input" step="0.05" value="${q.point||0}" onchange="EXAM_QUESTIONS[${i}].point=this.value; renderEditor()">
            </div>`;

            let imgQ = `<div class="upload-wrapper" style="background:#f1f8e9; padding:5px; border-radius:4px">
                <i class="fas fa-image" style="color:#2e7d32"></i> <b>·∫¢nh ƒê·ªÅ:</b>
                <input type="text" value="${q.img||''}" onchange="EXAM_QUESTIONS[${i}].img=this.value; renderPreview()" style="flex:1" placeholder="Link ·∫£nh... [IMG]">
                <label class="file-upload-btn"><i class="fas fa-upload"></i> <input type="file" style="display:none" accept="image/*" onchange="handleImageUpload(this, ${i}, 'q')"></label>
                ${q.img ? `<img src="${q.img}" style="height:30px">` : ''}
            </div>`;
            let imgSol = `<div class="upload-wrapper" style="background:#fffde7; padding:5px; border-radius:4px; margin-top:5px">
                <i class="fas fa-lightbulb" style="color:#fbc02d"></i> <b>·∫¢nh L·ªùi Gi·∫£i:</b>
                <input type="text" value="${q.solImg||''}" onchange="EXAM_QUESTIONS[${i}].solImg=this.value; renderPreview()" style="flex:1" placeholder="Link ·∫£nh... [IMG]">
                <label class="file-upload-btn"><i class="fas fa-upload"></i> <input type="file" style="display:none" accept="image/*" onchange="handleImageUpload(this, ${i}, 'sol')"></label>
                ${q.solImg ? `<img src="${q.solImg}" style="height:30px">` : ''}
            </div>`;

            let ansUI = "";
            if(q.type === 'mcq') ansUI = q.options.map((opt,idx)=>`<div style="display:flex;margin-bottom:3px;align-items:center"><input type="radio" name="r${i}" ${q.ans==idx?'checked':''} onchange="EXAM_QUESTIONS[${i}].ans=${idx};renderPreview()"><b style="width:20px;text-align:center">${['A','B','C','D'][idx]}</b><input style="flex:1" value="${opt}" onchange="EXAM_QUESTIONS[${i}].options[${idx}]=this.value;renderPreview()"></div>`).join('');
            else if (q.type === 'tf') ansUI = q.items.map((it,idx)=>`<div style="display:flex;gap:5px;margin-bottom:3px"><b style="width:30px">√ù ${idx+1}</b><input style="flex:1" value="${it.sub}" onchange="EXAM_QUESTIONS[${i}].items[${idx}].sub=this.value;renderPreview()"><select onchange="EXAM_QUESTIONS[${i}].items[${idx}].ans=this.value;renderPreview()"><option value="T" ${it.ans=='T'?'selected':''}>ƒê√öNG</option><option value="F" ${it.ans=='F'?'selected':''}>SAI</option></select></div>`).join('');
            else if (q.type === 'short') ansUI = `<b>ƒê√°p √°n:</b> <input type="text" value="${q.ans}" onchange="EXAM_QUESTIONS[${i}].ans=this.value;renderPreview()">`;
            else if (q.type === 'match') ansUI = q.items.map((it,idx)=>`<div style="display:flex;gap:5px;margin-bottom:3px"><input style="flex:1" value="${it}" onchange="EXAM_QUESTIONS[${i}].items[${idx}]=this.value;renderPreview()"> - <input style="flex:1" value="${q.options[idx]}" placeholder="Ph·∫£i" onchange="EXAM_QUESTIONS[${i}].options[${idx}]=this.value;renderPreview()"> - ƒê√°p √°n: <input style="width:40px" value="${q.ans[idx]}" onchange="EXAM_QUESTIONS[${i}].ans[${idx}]=this.value;renderPreview()"></div>`).join('');

            c.insertAdjacentHTML('beforeend',`<div class="q-item">
                <div class="q-item-header">
                    <span style="font-weight:bold;color:#00796b">C√¢u ${i+1} (${q.type.toUpperCase()})</span>
                    <div style="display:flex;align-items:center">
                        ${scoreInput}
                        <button class="btn btn-red" style="padding:2px 8px;font-size:0.8em" onclick="EXAM_QUESTIONS.splice(${i},1);renderEditor()">X√≥a</button>
                    </div>
                </div>
                <textarea class="smart-textarea" oninput="EXAM_QUESTIONS[${i}].q=this.value; renderPreview()">${q.q}</textarea>
                ${imgQ}
                <div style="margin:10px 0;background:#f9f9f9;padding:10px;border-radius:4px">${ansUI}</div>
                <textarea class="smart-textarea" placeholder="L·ªùi gi·∫£i..." oninput="EXAM_QUESTIONS[${i}].explain=this.value; renderPreview()" style="height:50px;border-color:#a5d6a7">${q.explain||''}</textarea>
                ${imgSol}
            </div>`);
        });
        
        document.getElementById('total-score-display').innerText = totalScore.toFixed(2);
        document.getElementById('total-qs').innerText = EXAM_QUESTIONS.length;
        renderPreview();
    }

    function renderPreview() {
        let h = '';
        EXAM_QUESTIONS.forEach((q, i) => {
            let imgHtml = q.img ? `<img src="${q.img}" class="p-img">` : '';
            let solImgHtml = q.solImg ? `<img src="${q.solImg}" class="p-img">` : '';
            let pt = q.point ? `<span style="float:right;color:red;font-weight:bold">[${q.point}ƒë]</span>` : '';
            
            let contentHtml = q.q;
            if(q.img) {
                if(contentHtml.includes('[IMG]')) contentHtml = contentHtml.replace('[IMG]', `<img src="${q.img}" class="p-img">`);
                else contentHtml += `<br><img src="${q.img}" class="p-img">`;
            }
            let explainHtml = q.explain;
            if(q.solImg) {
                if(explainHtml.includes('[IMG]')) explainHtml = explainHtml.replace('[IMG]', `<img src="${q.solImg}" class="p-img">`);
                else explainHtml += `<br><img src="${q.solImg}" class="p-img">`;
            }

            let body = '';
            if(q.type === 'mcq') body = q.options.map((opt, idx) => `<div class="p-opt ${q.ans==idx?'selected':''}"><b>${['A','B','C','D'][idx]}.</b> ${opt}</div>`).join('');
            else if (q.type === 'tf') body = `<table width="100%"><tr><th>√ù</th><th>N·ªôi dung</th><th>ƒê/S</th></tr>` + q.items.map((it, idx) => `<tr><td>${idx+1}</td><td>${it.sub}</td><td><b>${it.ans=='T'?'ƒê':'S'}</b></td></tr>`).join('') + `</table>`;
            else if (q.type === 'short') body = `<div class="p-opt"><b>Tr·∫£ l·ªùi:</b> ${q.ans}</div>`;
            else if (q.type === 'match') body = q.items.map((it, idx) => `<div class="p-opt">${idx+1}. ${it} --> ${q.ans[idx]} (${q.options[idx]})</div>`).join('');
            h += `<div class="p-q-block"><div class="p-label">C√¢u ${i+1}: ${pt}</div><div class="p-content">${contentHtml}</div><div>${body}</div><div class="p-sol"><b>L·ªùi gi·∫£i:</b><br>${explainHtml}</div></div>`;
        });
        document.getElementById('preview-content').innerHTML = h;
        if(window.MathJax) MathJax.typesetPromise();
    }

    function parseDataSafe() {
        try {
            let raw = document.getElementById('json-input').value.trim();
            if(!raw) return alert("Ch∆∞a nh·∫≠p JSON!");
            let data = JSON.parse(raw);
            if(Array.isArray(data)) EXAM_QUESTIONS = data;
            else if (data.questions && Array.isArray(data.questions)) EXAM_QUESTIONS = data.questions;
            else throw new Error("C·∫•u tr√∫c JSON kh√¥ng h·ª£p l·ªá");
            renderEditor();
            alert("‚úÖ ƒê√£ n·∫°p " + EXAM_QUESTIONS.length + " c√¢u h·ªèi!");
        } catch(e) { alert("‚ùå L·ªói JSON: " + e.message); }
    }

    async function deleteFileGeneric(path, name, isFileManager) {
        if(!confirm(`‚ö†Ô∏è X√ìA Vƒ®NH VI·ªÑN: ${name}?`)) return;
        const u=document.getElementById('gh-user').value, r=document.getElementById('gh-repo').value, t=document.getElementById('gh-token').value;
        const ov=document.getElementById('loading-overlay'); ov.style.display='flex';
        try {
            const res = await fetch(`https://api.github.com/repos/${u}/${r}/contents/${path}`, {headers: {Authorization: `token ${t}`}});
            const data = await res.json();
            await fetch(`https://api.github.com/repos/${u}/${r}/contents/${path}`, {
                method: 'DELETE', headers: { Authorization: `token ${t}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: `Delete ${name}`, sha: data.sha })
            });
            alert("ƒê√£ x√≥a!"); 
            if(isFileManager) loadFileManager(currentPath); 
            else if (path.startsWith('images/')) loadImagesFromGitHub();
            else loadDataFiles();
        } catch(e) { alert("L·ªói: " + e.message); } finally { ov.style.display='none'; }
    }

    async function loadDataFiles(){
        const u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value,t=document.getElementById('gh-token').value;
        if(!u)return alert("Thi·∫øu Config!");
        try{
            const res=await fetch(`https://api.github.com/repos/${u}/${r}/contents/data`,{headers:{Authorization:`token ${t}`}});
            const f=await res.json();
            let h='';
            f.forEach(x=>{
                if(x.name.endsWith('.js')&&x.name!=='list.js') {
                    h+=`<div class="file-item"><span style="font-weight:500">${x.name}</span><div><button class="btn btn-qr" onclick="showExamQR('${x.name}')">QR</button><button class="btn btn-edit" onclick="loadExamToEdit('${x.path}','${x.name}')">S·ª≠a</button><button class="btn btn-red" onclick="deleteFileGeneric('${x.path}','${x.name}', false)">X√≥a</button></div></div>`;
                }
            });
            document.getElementById('data-list').innerHTML=h;
        }catch(e){alert(e.message);}
    }

    async function loadExamToEdit(path, name) {
        const u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value,t=document.getElementById('gh-token').value;
        const ov=document.getElementById('loading-overlay'); ov.style.display='flex';
        try{
            const res=await fetch(`https://api.github.com/repos/${u}/${r}/contents/${path}`,{headers:{Authorization:`token ${t}`}});
            const json=await res.json(), content=decodeURIComponent(escape(atob(json.content)));
            let dataStr = content.substring(content.indexOf('{'), content.lastIndexOf('}')+1);
            let data=JSON.parse(dataStr);
            document.getElementById('exam-id').value=name.replace('.js','');
            document.getElementById('exam-title').value=data.title||"";
            document.getElementById('exam-time').value=data.time||45;
            document.getElementById('exam-price').value=data.price||0;
            document.getElementById('exam-pass-hash').value=data.password||"";
            document.getElementById('secure-mode').checked=data.encrypted;
            if(data.shuffle !== undefined) document.getElementById('exam-shuffle').checked = data.shuffle;
            if(data.viewDetail !== undefined) document.getElementById('view-detail').checked = data.viewDetail;
            if(data.minTime) document.getElementById('min-time-percent').value = data.minTime;
            // --- CODE M·ªöI ---
            if(data.music !== undefined) document.getElementById('exam-music').checked = data.music;
            if(data.allowPrint !== undefined) document.getElementById('allow-print').checked = data.allowPrint;
            
            if(data.start)document.getElementById('exam-start').value=data.start;
            if(data.end)document.getElementById('exam-end').value=data.end;
            if(data.subject) document.getElementById('exam-subject').value = data.subject;
            if(data.grade) document.getElementById('exam-grade').value = data.grade.replace('K','');
            
            data.questions.forEach(q => {
                if(q.explain && q.explain.includes('<img')) {
                    let match = q.explain.match(/src="([^"]+)"/);
                    if(match) q.solImg = match[1];
                    q.explain = q.explain.replace(/<br><img.*?>/g, '').trim(); 
                }
            });

            EXAM_QUESTIONS=data.questions||[]; renderEditor(); 
            ov.style.display='none'; switchTab('create');
        }catch(e){ alert("L·ªói t·∫£i ƒë·ªÅ: "+e.message); ov.style.display='none'; }
    }

    async function publishExam(){
        const u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value,t=document.getElementById('gh-token').value,id=document.getElementById('exam-id').value;
        if(!u||!r||!t||!id)return alert("Thi·∫øu info!");
        const bankInfo = {id: document.getElementById('bank-id').value, acc: document.getElementById('bank-acc').value};
        const price = parseInt(document.getElementById('exam-price').value) || 0;
        const ov=document.getElementById('loading-overlay');ov.style.display='flex';
        try{
            let fQ=JSON.parse(JSON.stringify(EXAM_QUESTIONS));
            let sec=document.getElementById('secure-mode').checked;
            let shuffle = document.getElementById('exam-shuffle').checked;
            let viewDetail = document.getElementById('view-detail').checked;
            let minTime = parseInt(document.getElementById('min-time-percent').value) || 0;

            fQ.forEach(q=>{
                if(q.solImg) {
                    if(q.explain.includes('[IMG]')) q.explain = q.explain.replace('[IMG]', `<img src="${q.solImg}" style="max-width:100%;margin-top:10px;border-radius:5px">`);
                    else q.explain = (q.explain || "") + `<br><img src="${q.solImg}" style="max-width:100%;margin-top:10px;border-radius:5px">`;
                    delete q.solImg; 
                }
                if(q.img) {
                    if(q.q.includes('[IMG]')) q.q = q.q.replace('[IMG]', `<img src="${q.img}" style="max-width:100%;margin:10px 0;border-radius:5px">`);
                    else q.q = q.q + `<br><img src="${q.img}" style="max-width:100%;margin:10px 0;border-radius:5px">`;
                    delete q.img;
                }

                if(sec){
                    if(q.type==='mcq') q.ans=CryptoJS.MD5(String(q.ans)).toString();
                    else if(q.type==='tf') q.items.forEach(x=>x.ans=CryptoJS.MD5(String(x.ans).trim()).toString());
                    else if(q.type==='short') q.ans=CryptoJS.MD5(String(q.ans).trim().toLowerCase().replace(',','.')).toString();
                    else if(q.type==='match') q.ans=q.ans.map(v=>CryptoJS.MD5(String(v).trim()).toString());
                }
            });
            let dt={
                title: document.getElementById('exam-title').value,
                subject: document.getElementById('exam-subject').value, 
                grade: document.getElementById('exam-grade').value,
                time: parseInt(document.getElementById('exam-time').value),
                password: document.getElementById('exam-pass-hash').value,
                encrypted: sec,
                
                // C√°c bi·∫øn ƒë√£ khai b√°o b√™n tr√™n (shuffle, viewDetail, minTime)
                shuffle: shuffle,
                viewDetail: viewDetail,
                minTime: minTime,

                // --- CODE B·ªî SUNG M·ªöI (NH·∫†C & IN) ---
                music: document.getElementById('exam-music').checked,
                allowPrint: document.getElementById('allow-print').checked,
                // -------------------------------------

                start: document.getElementById('exam-start').value,
                end: document.getElementById('exam-end').value,
                price: price, 
                bank: bankInfo,
                scores: {mcq:0.25, tf:1.0, short:0.5, match:1.0},
                questions: fQ
            };
            let c=btoa(unescape(encodeURIComponent(`window.EXAM_DATA = ${JSON.stringify(dt,null,4)};`)));
            await upF(u,r,t,`data/${id}.js`,c,false);
            await updateList(u,r,t,id,dt);
            alert("Th√†nh c√¥ng! ƒê·ªÅ ƒë√£ ƒë∆∞·ª£c xu·∫•t b·∫£n."); ov.style.display='none'; loadDataFiles();
        }catch(e){alert(e.message); ov.style.display='none';}
    }

    async function upF(u,r,t,p,c,isF){let s=null;try{let k=await fetch(`https://api.github.com/repos/${u}/${r}/contents/${p}`,{headers:{Authorization:`token ${t}`}});if(k.ok)s=(await k.json()).sha;}catch(e){}let b={message:"Up",content:isF?await toB64(c):c};if(s)b.sha=s;let rs=await fetch(`https://api.github.com/repos/${u}/${r}/contents/${p}`,{method:'PUT',headers:{Authorization:`token ${t}`,'Content-Type':'application/json'},body:JSON.stringify(b)});if(!rs.ok){let j=await rs.json();throw new Error(j.message);}}
    function toB64(f){return new Promise(r=>{let fr=new FileReader();fr.onload=()=>r(fr.result.split(',')[1]);fr.readAsDataURL(f);});}
    
    async function updateList(u,r,t,id,d){
        let url=`https://api.github.com/repos/${u}/${r}/contents/data/list.js`;
        let l=[],s=null;
        try{
            let k=await fetch(url,{headers:{Authorization:`token ${t}`}});
            if(k.ok){
                let j=await k.json();
                s=j.sha;
                let content = decodeURIComponent(escape(atob(j.content)));
                let jsonStr = content.substring(content.indexOf('['), content.lastIndexOf(']')+1);
                if(jsonStr) l = JSON.parse(jsonStr);
            }
        }catch(e){ console.log("List ch∆∞a c√≥ ho·∫∑c l·ªói, t·∫°o m·ªõi."); }
        
        if(!Array.isArray(l)) l = [];
        l=l.filter(x=>x.id!==id);
        
        // --- [ƒêO·∫†N C·∫¶N S·ª¨A L√Ä ·ªû ƒê√ÇY] ---
        // Th√™m allowPrint: d.allowPrint v√†o object n√†y
        l.unshift({
            id: id,
            title: d.title,
            subject: d.subject,
            grade: d.grade,
            time: d.time,
            allowPrint: d.allowPrint // <--- QUAN TR·ªåNG: D√≤ng n√†y gi√∫p trang ch·ªß bi·∫øt c√≥ ƒë∆∞·ª£c in hay kh√¥ng
        });
        // -------------------------------

        let c=btoa(unescape(encodeURIComponent(`window.EXAM_LIST = ${JSON.stringify(l,null,4)};`)));
        await upF(u,r,t,`data/list.js`,c,false);
    }
    
    function showExamQR(n){let u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value;let url=`https://${u}.github.io/${r}/thi.html?id=${n.replace('.js','')}`;document.getElementById('qr-modal').style.display='flex';document.getElementById('qr-link-text').innerText=url;document.getElementById('qrcode').innerHTML="";new QRCode(document.getElementById("qrcode"),{text:url,width:200,height:200});}
    
    async function loadFileManager(path) {
        currentPath = path;
        document.getElementById('fm-current-path').innerText = path || " (G·ªëc)";
        const u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value,t=document.getElementById('gh-token').value;
        try {
            const res = await fetch(`https://api.github.com/repos/${u}/${r}/contents/${path}`, {headers: {Authorization: `token ${t}`}});
            if(!res.ok) throw new Error("L·ªói t·∫£i th∆∞ m·ª•c!");
            const items = await res.json();
            items.sort((a, b) => (a.type === b.type ? 0 : a.type === 'dir' ? -1 : 1));
            let html = '';
            if(path !== "") { 
                let parent = path.split('/').slice(0,-1).join('/');
                html += `<div class="fm-item" onclick="loadFileManager('${parent}')"><div class="fm-icon fm-folder"><i class="fas fa-level-up-alt"></i></div><div class="fm-name">.. (Quay l·∫°i)</div></div>`;
            }
            items.forEach(item => {
                let icon = item.type === 'dir' ? '<i class="fas fa-folder"></i>' : '<i class="fas fa-file-alt"></i>';
                let cls = item.type === 'dir' ? 'fm-folder' : 'fm-file';
                let action = item.type === 'dir' ? `onclick="loadFileManager('${item.path}')"` : '';
                let delBtn = `<button class="btn btn-red" style="padding:2px 8px" onclick="event.stopPropagation();deleteFileGeneric('${item.path}', '${item.name}', true)">X√≥a</button>`;
                html += `<div class="fm-item" ${action}><div class="fm-icon ${cls}">${icon}</div><div class="fm-name">${item.name}</div><div>${delBtn}</div></div>`;
            });
            document.getElementById('fm-list').innerHTML = html;
        } catch(e) {}
    }
    
    async function loadImagesFromGitHub(){
        const u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value,t=document.getElementById('gh-token').value;
        if(!u)return;
        try{
            const res=await fetch(`https://api.github.com/repos/${u}/${r}/contents/images`,{headers:{Authorization:`token ${t}`}});
            const f=await res.json();
            let h='';
            f.forEach(x=>{
                if(x.name.match(/\.(png|jpg)$/i)) {
                    h+=`<div class="img-card">
                            <img src="${x.download_url}" onclick="window.open('${x.download_url}')">
                            <small>${x.name}</small>
                            <button class="img-del-btn" onclick="deleteFileGeneric('${x.path}', '${x.name}', false)">X√≥a ·∫¢nh</button>
                        </div>`;
                }
            });
            document.getElementById('image-gallery').innerHTML=h;
        }catch(e){}
    }
</script>
</body>
</html>
