<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Tool v4.5 (Quick Paste)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }, svg: { fontCache: 'global' } };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #eef2f5; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        h1 { color: #00796b; text-align: center; margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }

        /* KHUNG NH·∫¨P NHANH T·ª™ GEMINI */
        .paste-area { 
            background: #e8f5e9; border: 2px dashed #4caf50; padding: 20px; border-radius: 8px; margin-bottom: 30px; 
        }
        .paste-area textarea { 
            width: 100%; height: 120px; border: 1px solid #c8e6c9; border-radius: 4px; padding: 10px; font-family: monospace; font-size: 13px; color: #2e7d32;
        }
        .paste-area h3 { margin-top: 0; color: #2e7d32; display: flex; align-items: center; gap: 10px; }
        
        /* C√ÅC PH·∫¶N KH√ÅC */
        .section-title { font-weight: bold; color: #555; margin-top: 20px; margin-bottom: 10px; text-transform: uppercase; font-size: 0.9em; border-left: 4px solid #009688; padding-left: 10px; }
        .row { display: flex; gap: 20px; margin-bottom: 15px; }
        .col { flex: 1; }
        
        label { font-weight: 600; display: block; margin-bottom: 5px; font-size: 0.9em; color: #444; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        input:focus, select:focus { border-color: #009688; outline: none; box-shadow: 0 0 0 3px rgba(0,150,136,0.1); }

        .toolbar { position: sticky; top: 0; background: rgba(255,255,255,0.95); padding: 15px 0; border-bottom: 1px solid #ddd; z-index: 100; display: flex; gap: 10px; backdrop-filter: blur(5px); }
        button { padding: 10px 20px; cursor: pointer; font-weight: bold; color: white; border: none; border-radius: 6px; transition: 0.2s; }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn-green { background: #2e7d32; } 
        .btn-blue { background: #1976d2; }
        .btn-orange { background: #f57c00; } 
        .btn-purple { background: #7b1fa2; }
        .btn-red { background: #c62828; font-size: 12px; padding: 5px 10px; }

        /* QUESTION BOX */
        .q-box { border: 1px solid #eee; padding: 20px; margin-bottom: 15px; background: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); position: relative; }
        .q-tag { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; color: white; font-weight: bold; text-transform: uppercase; margin-right: 10px;}
        
        .preview-math { background: #f8f9fa; padding: 10px; border-radius: 4px; border-left: 3px solid #1976d2; margin-top: 5px; color: #1565c0; font-size: 0.95em; min-height: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h1>C√îNG C·ª§ T·∫†O ƒê·ªÄ THI (FORM GEMINI)</h1>

    <div class="paste-area">
        <h3>üöÄ D√ÅN D·ªÆ LI·ªÜU T·ª™ GEMINI V√ÄO ƒê√ÇY</h3>
        <p style="font-size:0.9em; margin-bottom:10px; color:#555">Copy ƒëo·∫°n m√£ JSON m√† Gemini t·∫°o ra t·ª´ file ex_test c·ªßa th·∫ßy, d√°n v√†o √¥ d∆∞·ªõi r·ªìi b·∫•m n√∫t N·∫°p.</p>
        <textarea id="json-input" placeholder='[
    { "type": "mcq", "q": "C√¢u 1...", "options": [...] },
    { "type": "mcq", "q": "C√¢u 2...", "options": [...] }
]'></textarea>
        <div style="margin-top:10px; text-align:right">
            <button class="btn-green" onclick="importFromText()">‚ö° N·∫†P C√ÇU H·ªéI NGAY</button>
        </div>
    </div>

    <div class="section-title">1. Th√¥ng Tin ƒê·ªÅ Thi</div>
    <div class="row">
        <div class="col">
            <label>M√¥n H·ªçc</label>
            <select id="exam-subject">
                <option value="Toan">To√°n H·ªçc</option>
                <option value="Ly">V·∫≠t L√Ω</option>
                <option value="Hoa">H√≥a H·ªçc</option>
                <option value="Sinh">Sinh H·ªçc</option>
                <option value="Su">L·ªãch S·ª≠</option>
                <option value="Dia">ƒê·ªãa L√Ω</option>
                <option value="Anh">Ti·∫øng Anh</option>
                <option value="GDCD">GDCD</option>
            </select>
        </div>
        <div class="col">
            <label>Kh·ªëi L·ªõp</label>
            <select id="exam-grade">
                <option value="12">L·ªõp 12</option>
                <option value="11">L·ªõp 11</option>
                <option value="10">L·ªõp 10</option>
                <option value="12OT">√în Thi THPT</option>
            </select>
        </div>
        <div class="col">
            <label>Th·ªùi gian (ph√∫t)</label>
            <input type="number" id="exam-time" value="90">
        </div>
    </div>

    <div class="row">
        <div class="col"><label>M√£ ƒê·ªÅ (T√™n file)</label><input type="text" id="exam-id" placeholder="de-toan-01"></div>
        <div class="col" style="flex:2"><label>Ti√™u ƒê·ªÅ (Hi·ªÉn th·ªã)</label><input type="text" id="exam-title" placeholder="Ki·ªÉm tra Nguy√™n H√†m..."></div>
    </div>
    
    <div class="section-title">2. C·∫•u H√¨nh Thang ƒêi·ªÉm</div>
    <div class="row">
        <div class="col"><label>Tr·∫Øc nghi·ªám (1 c√¢u)</label><input type="number" id="score-mcq" value="0.25"></div>
        <div class="col"><label>ƒê√∫ng/Sai (Max)</label><input type="number" id="score-tf" value="1.0"></div>
        <div class="col"><label>Tr·∫£ l·ªùi ng·∫Øn (1 c√¢u)</label><input type="number" id="score-short" value="0.5"></div>
    </div>
    
    <div class="row" style="background:#fff8e1; padding:10px; border-radius:6px; align-items:center">
        <div class="col"><label>M·∫≠t Kh·∫©u (T√πy ch·ªçn)</label><input type="text" id="raw-pass" oninput="createPass()" placeholder="Nh·∫≠p pass..."></div>
        <div class="col"><label>M√£ H√≥a MD5</label><input type="text" id="hashed-pass" readonly style="background:#eee"></div>
    </div>

    <div class="section-title">3. Danh S√°ch C√¢u H·ªèi (Review & S·ª≠a)</div>
    <div class="toolbar">
        <button class="btn-blue" onclick="addQ('mcq')">+ Tr·∫Øc Nghi·ªám</button>
        <button class="btn-orange" onclick="addQ('tf')">+ ƒê√∫ng/Sai</button>
        <button class="btn-purple" onclick="addQ('short')">+ Tr·∫£ L·ªùi Ng·∫Øn</button>
        <button class="btn-green" style="margin-left:auto" onclick="exportFile()">üíæ XU·∫§T FILE ƒê·ªÄ (.JS)</button>
    </div>

    <div id="q-container" style="margin-top:20px">
        <div style="text-align:center; color:#999; padding:20px">Ch∆∞a c√≥ c√¢u h·ªèi. H√£y d√°n code t·ª´ Gemini v√†o √¥ tr√™n c√πng!</div>
    </div>
</div>

<script>
    let questions = [];

    // --- H√ÄM QUAN TR·ªåNG: NH·∫¨P T·ª™ TEXT ---
    function importFromText() {
        let text = document.getElementById('json-input').value.trim();
        if (!text) return alert("Vui l√≤ng d√°n n·ªôi dung v√†o √¥ tr·ªëng tr∆∞·ªõc!");

        try {
            // L·ªçc b·ªè c√°c ph·∫ßn th·ª´a n·∫øu th·∫ßy l·ª° copy c·∫£ d√≤ng 'window.EXAM_DATA ='
            if(text.includes('=')) {
                text = text.substring(text.indexOf('=') + 1);
            }
            if(text.trim().endsWith(';')) {
                text = text.trim().slice(0, -1);
            }

            // Parse th·ª≠
            let parsed = JSON.parse(text);
            let newQuestions = [];

            // Tr∆∞·ªùng h·ª£p 1: D√°n c·∫£ c·ª•c object l·ªõn (c√≥ title, questions...)
            if (parsed.questions && Array.isArray(parsed.questions)) {
                newQuestions = parsed.questions;
                // C√≥ th·ªÉ t·ª± ƒëi·ªÅn ti√™u ƒë·ªÅ n·∫øu mu·ªën, nh∆∞ng th·∫ßy b·∫£o ch·ªâ c·∫ßn ƒëi·ªÅn m√¥n/kh·ªëi n√™n ta gi·ªØ nguy√™n
                if(parsed.title) document.getElementById('exam-title').value = parsed.title;
            } 
            // Tr∆∞·ªùng h·ª£p 2: Ch·ªâ d√°n m·∫£ng c√¢u h·ªèi [ ... ]
            else if (Array.isArray(parsed)) {
                newQuestions = parsed;
            } else {
                throw new Error("Kh√¥ng t√¨m th·∫•y danh s√°ch c√¢u h·ªèi h·ª£p l·ªá!");
            }

            // G√°n ID cho c√°c c√¢u h·ªèi v√† ƒë∆∞a v√†o list
            questions = newQuestions.map(q => {
                q.id = Date.now() + Math.random();
                return q;
            });

            render();
            alert(`‚úÖ ƒê√£ n·∫°p th√†nh c√¥ng ${questions.length} c√¢u h·ªèi! Th·∫ßy h√£y ki·ªÉm tra l·∫°i b√™n d∆∞·ªõi.`);

        } catch (e) {
            alert("‚ùå L·ªói c·∫•u tr√∫c JSON! Th·∫ßy h√£y b·∫£o Gemini: 'Ch·ªâ xu·∫•t ra m·∫£ng JSON ch·ª©a c√°c c√¢u h·ªèi th√¥i'.\nL·ªói c·ª• th·ªÉ: " + e.message);
        }
    }

    function createPass() {
        let p = document.getElementById('raw-pass').value.trim();
        if(window.CryptoJS && p) document.getElementById('hashed-pass').value = CryptoJS.MD5(p).toString();
        else document.getElementById('hashed-pass').value = "";
    }

    function addQ(type) {
        if(questions.length===0) document.getElementById('q-container').innerHTML = "";
        let id = Date.now();
        questions.push({id:id, type:type});
        render();
        setTimeout(()=> document.getElementById('q-'+id).scrollIntoView({behavior:"smooth"}), 100);
    }

    function removeQ(id) {
        if(confirm("X√≥a c√¢u n√†y?")) {
            questions = questions.filter(q=>q.id!==id);
            render();
        }
    }

    // H√†m Preview MathJax
    function updateMath(elm) {
        let div = elm.parentElement.querySelector('.preview-math');
        if(div) {
            div.innerHTML = elm.value ? elm.value : '(Preview)';
            if(window.MathJax) MathJax.typesetPromise([div]);
        }
    }

    function render() {
        if(questions.length===0) {
            document.getElementById('q-container').innerHTML = `<div style="text-align:center; color:#999; padding:20px">Danh s√°ch tr·ªëng.</div>`;
            return;
        }

        let html = '';
        questions.forEach((q, idx) => {
            let color = q.type=='mcq'?'#1976d2':(q.type=='tf'?'#f57c00':'#7b1fa2');
            let txt = q.type=='mcq'?'TR·∫ÆC NGHI·ªÜM':(q.type=='tf'?'ƒê√öNG/SAI':'TR·∫¢ L·ªúI NG·∫ÆN');
            
            html += `<div class="q-box" id="q-${q.id}">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px">
                    <div><span class="q-tag" style="background:${color}">${txt}</span> <b>C√¢u ${idx+1}</b></div>
                    <button class="btn-red" onclick="removeQ(${q.id})">X√≥a</button>
                </div>
                
                <label>N·ªôi dung c√¢u h·ªèi:</label>
                <textarea oninput="updateMath(this)" id="content-${q.id}" style="width:100%; height:60px">${q.q || ''}</textarea>
                <div class="preview-math">...</div>
                
                <label style="margin-top:10px; color:#0d47a1">Link ·∫¢nh (n·∫øu c√≥):</label>
                <input type="text" id="img-${q.id}" value="${q.img || ''}" placeholder="http://...">`;

            // RENDER OPTIONS
            if(q.type === 'mcq') {
                html += `<div style="margin-top:10px; background:#e3f2fd; padding:10px; border-radius:4px">`;
                let opts = q.options || ["","","",""];
                ['A','B','C','D'].forEach((lbl, i) => {
                    let checked = (q.ans == i) ? 'checked' : '';
                    html += `<div style="display:flex; gap:10px; margin-bottom:5px; align-items:center">
                        <input type="radio" name="ans-${q.id}" value="${i}" ${checked}> <b>${lbl}.</b>
                        <input type="text" id="opt-${q.id}-${i}" value="${opts[i]||''}" oninput="updateMath(this)">
                    </div>`; 
                });
                html += `</div>`;
            } else if(q.type === 'tf') {
                html += `<div style="margin-top:10px; background:#fff3e0; padding:10px; border-radius:4px">
                    <table width="100%"><tr><th>√ù</th><th>ƒê</th><th>S</th></tr>`;
                let items = q.items || [{sub:'',ans:'F'},{sub:'',ans:'F'},{sub:'',ans:'F'},{sub:'',ans:'F'}];
                items.forEach((it, i) => {
                    let cT = (it.ans==='T')?'checked':'';
                    let cF = (it.ans!=='T')?'checked':'';
                    html += `<tr>
                        <td><input type="text" id="tf-sub-${q.id}-${i}" value="${it.sub}" oninput="updateMath(this)"></td>
                        <td align="center"><input type="radio" name="tf-${q.id}-${i}" value="T" ${cT}></td>
                        <td align="center"><input type="radio" name="tf-${q.id}-${i}" value="F" ${cF}></td>
                    </tr>`;
                });
                html += `</table></div>`;
            } else {
                html += `<div style="margin-top:10px; background:#f3e5f5; padding:10px; border-radius:4px">
                    <label>ƒê√°p √°n ƒë√∫ng:</label>
                    <input type="text" id="short-${q.id}" value="${q.ans||''}">
                </div>`;
            }

            html += `<label style="margin-top:10px">L·ªùi gi·∫£i chi ti·∫øt:</label>
                     <textarea oninput="updateMath(this)" id="explain-${q.id}" style="width:100%; height:50px">${q.explain||''}</textarea>
            </div>`;
        });
        document.getElementById('q-container').innerHTML = html;
        // Trigger MathJax render l·∫ßn ƒë·∫ßu
        setTimeout(() => { if(window.MathJax) MathJax.typesetPromise(); }, 500);
    }

    function exportFile() {
        let examId = document.getElementById('exam-id').value.trim() || 'de-moi';
        if(examId.endsWith('.js')) examId = examId.replace('.js','');

        let data = {
            title: document.getElementById('exam-title').value || "ƒê·ªÅ Thi M·ªõi",
            subject: document.getElementById('exam-subject').value,
            grade: document.getElementById('exam-grade').value,
            time: parseInt(document.getElementById('exam-time').value) || 90,
            password: document.getElementById('hashed-pass').value,
            scores: {
                mcq: parseFloat(document.getElementById('score-mcq').value),
                tf: parseFloat(document.getElementById('score-tf').value),
                short: parseFloat(document.getElementById('score-short').value)
            },
            questions: []
        };

        questions.forEach(q => {
            let qObj = { 
                type: q.type, 
                q: document.getElementById(`content-${q.id}`).value, 
                explain: document.getElementById(`explain-${q.id}`).value 
            };
            let img = document.getElementById(`img-${q.id}`).value.trim();
            if(img) qObj.img = img;

            if(q.type==='mcq') {
                qObj.options = [];
                for(let i=0;i<4;i++) qObj.options.push(document.getElementById(`opt-${q.id}-${i}`).value);
                let sel = document.querySelector(`input[name="ans-${q.id}"]:checked`);
                qObj.ans = sel ? parseInt(sel.value) : 0;
            } else if(q.type==='tf') {
                qObj.items = [];
                for(let i=0;i<4;i++) {
                    let sub = document.getElementById(`tf-sub-${q.id}-${i}`).value;
                    let ans = document.querySelector(`input[name="tf-${q.id}-${i}"]:checked`).value;
                    qObj.items.push({sub:sub, ans:ans});
                }
            } else {
                qObj.ans = document.getElementById(`short-${q.id}`).value;
            }
            data.questions.push(qObj);
        });

        let content = `window.EXAM_DATA = ${JSON.stringify(data, null, 4)};`;
        let blob = new Blob([content], { type: "text/javascript;charset=utf-8" });
        let a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `${examId}.js`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
</script>

</body>
</html>
