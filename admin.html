<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Tool v11.0 (Image Manager)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }, svg: { fontCache: 'global' } };</script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        /* CSS C∆† B·∫¢N */
        body { font-family: 'Segoe UI', sans-serif; background: #eceff1; padding: 20px; color: #37474f; margin: 0; }
        
        /* LOGIN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #263238; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 10px; width: 350px; text-align: center; }
        .login-box input { width: 100%; padding: 12px; margin: 20px 0; border: 1px solid #ccc; border-radius: 4px; }
        .login-btn { width: 100%; padding: 12px; background: #00695c; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }

        /* MAIN APP */
        #main-app { display: none; max-width: 1200px; margin: 0 auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h1 { color: #00695c; text-align: center; border-bottom: 3px solid #004d40; padding-bottom: 10px; }

        /* TABS */
        .tab-bar { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .tab-btn { padding: 10px 20px; background: #f5f5f5; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: #666; transition: 0.2s; }
        .tab-btn.active { background: #00796b; color: white; }
        .section { display: none; } .section.active { display: block; }

        /* CONFIG */
        .config-box { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #90caf9; }
        .row { display: flex; gap: 15px; margin-bottom: 10px; } .col { flex: 1; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        label { font-weight: 600; font-size: 0.9em; display: block; margin-bottom: 3px; }

        /* EDITOR & IMAGE LIST */
        .q-item { border: 1px solid #cfd8dc; margin-bottom: 30px; border-radius: 8px; overflow: hidden; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .q-toolbar { background: #f5f5f5; padding: 10px 15px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .q-body { display: flex; border-bottom: 1px solid #eee; }
        .column { flex: 1; padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        .col-left { border-right: 1px solid #eee; background: #fafafa; }
        .col-right { background: #fff; }
        
        /* IMAGE MANAGER STYLES */
        .img-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
        .img-card { border: 1px solid #ddd; border-radius: 6px; padding: 10px; text-align: center; background: #fff; position: relative; transition: 0.2s; }
        .img-card:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .img-thumb { width: 100%; height: 100px; object-fit: contain; margin-bottom: 5px; border: 1px solid #eee; }
        .img-name { font-size: 0.8em; color: #555; word-break: break-all; height: 35px; overflow: hidden; }
        .btn-del-img { background: #c62828; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8em; margin-top: 5px; width: 100%; }

        /* SMART TEXTAREA */
        .mini-toolbar { display: flex; gap: 5px; margin-bottom: 5px; }
        .tool-btn { padding: 5px 10px; border: 1px solid #ccc; background: white; cursor: pointer; border-radius: 3px; font-weight: bold; min-width: 30px; }
        .smart-textarea { width: 100%; height: 100px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; resize: vertical; box-sizing: border-box; }
        .smart-textarea:focus { border-color: #009688; outline: none; }
        
        .preview-box { padding: 10px; border: 1px dashed #ccc; border-radius: 4px; min-height: 50px; background: white; }
        .preview-img { max-width: 100%; height: auto; display: block; margin: 10px auto; border: 1px solid #ddd; }
        .img-status { font-size: 0.85em; margin-top: 5px; display: flex; align-items: center; gap: 5px; }
        .img-badge { background: #e0f2f1; color: #00695c; padding: 2px 6px; border-radius: 3px; font-size: 0.8em; }

        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; }
        .btn-green { background: #2e7d32; } .btn-blue { background: #1565c0; } .btn-red { background: #c62828; } .btn-gray { background: #607d8b; }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 99999; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; }
        #log-text { margin-top: 15px; font-family: monospace; color: #80cbc4; white-space: pre-wrap; max-height: 300px; overflow-y: auto; text-align: left; width: 80%; background: #263238; padding: 15px; border-radius: 8px; }
    </style>
</head>
<body>

<div id="loading-overlay"><div style="font-size: 50px;">üöÄ</div><h2 id="loading-title">ƒêANG X·ª¨ L√ù...</h2><div id="log-text"></div></div>

<div id="login-screen">
    <div class="login-box">
        <h2 style="color:#00695c">ADMIN LOGIN</h2>
        <input type="password" id="admin-pass-input" placeholder="M·∫≠t kh·∫©u (123456)" onkeyup="if(event.key==='Enter') checkAdmin()">
        <button class="login-btn" onclick="checkAdmin()">ƒêƒÇNG NH·∫¨P</button>
        <p id="login-msg" style="color:red; margin-top:10px; display:none">Sai m·∫≠t kh·∫©u!</p>
    </div>
</div>

<div id="main-app">
    <h1>H·ªÜ TH·ªêNG QU·∫¢N TR·ªä ƒê·ªÄ THI (v11.0)</h1>

    <div class="config-box">
        <div class="row">
            <div class="col"><label>Username</label><input type="text" id="gh-user"></div>
            <div class="col"><label>Repository</label><input type="text" id="gh-repo"></div>
            <div class="col"><label>Token</label><input type="password" id="gh-token"></div>
        </div>
        <div class="row"><div class="col"><button class="btn btn-gray" onclick="saveConfig()">üíæ L∆∞u C·∫•u H√¨nh</button></div></div>
    </div>

    <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('create')">üìù SO·∫†N ƒê·ªÄ THI</button>
        <button class="tab-btn" onclick="switchTab('images')">üìÅ KHO ·∫¢NH (QU·∫¢N L√ù & X√ìA)</button>
    </div>

    <div id="sec-create" class="section active">
        <div class="config-box" style="background:#fff3e0; border-color:#ffe0b2">
            <div class="row">
                <div class="col"><label>M√¥n</label><select id="exam-subject"><option value="Toan">To√°n</option><option value="Su">L·ªãch S·ª≠</option><option value="Ly">V·∫≠t L√Ω</option><option value="Hoa">H√≥a H·ªçc</option><option value="Sinh">Sinh</option><option value="Dia">ƒê·ªãa</option><option value="Anh">Anh</option><option value="GDCD">GDCD</option></select></div>
                <div class="col"><label>Kh·ªëi</label><select id="exam-grade"><option value="12">12</option><option value="11">11</option><option value="10">10</option><option value="12OT">√în Thi</option></select></div>
                <div class="col"><label>Th·ªùi gian (ph√∫t)</label><input type="number" id="exam-time" value="45"></div>
            </div>
            <div class="row">
                <div class="col"><label>M√£ ƒê·ªÅ (ID)</label><input type="text" id="exam-id" placeholder="de-toan-hk1"></div>
                <div class="col" style="flex:2"><label>Ti√™u ƒê·ªÅ</label><input type="text" id="exam-title" placeholder="Ki·ªÉm tra..."></div>
                <div class="col"><label>Pass ƒê·ªÅ Thi</label><input type="text" id="exam-pass" oninput="hashPass()"></div>
                <input type="hidden" id="exam-pass-hash">
            </div>
            <div class="row" style="margin-top:10px; background:#fff; padding:10px; border-radius:4px">
                <div class="col" style="display:flex; align-items:center; gap:10px">
                    <input type="checkbox" id="secure-mode" style="width:20px; height:20px" checked>
                    <label for="secure-mode" style="color:#c62828; cursor:pointer; font-weight:bold">üîí M√É H√ìA ƒê√ÅP √ÅN</label>
                </div>
            </div>
        </div>

        <div style="margin-bottom:30px">
            <label>üì• 1. D√°n code JSON t·ª´ Gemini:</label>
            <textarea id="json-input" class="smart-textarea" style="height:80px; border:2px dashed #009688" placeholder='[ { "type": "mcq", ... } ]'></textarea>
            <button class="btn btn-blue" style="width:100%; margin-top:10px" onclick="parseData()">‚ö° PH√ÇN T√çCH & SO·∫†N TH·∫¢O</button>
        </div>

        <div id="editor-area" style="display:none">
            <h3 style="color:#2e7d32; border-bottom:2px solid #eee; padding-bottom:10px">üìù 2. SO·∫†N TH·∫¢O & KI·ªÇM TRA</h3>
            <div id="questions-list"></div>
            <div style="text-align:right; margin-top:30px; padding-top:20px; border-top:1px solid #ccc">
                <button class="btn btn-red" style="font-size:1.2em; padding:15px 40px" onclick="publishExam()">üöÄ 3. XU·∫§T B·∫¢N ƒê·ªÄ THI</button>
            </div>
        </div>
    </div>

    <div id="sec-images" class="section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
            <h3>DANH S√ÅCH ·∫¢NH TR√äN GITHUB (Th∆∞ m·ª•c /images)</h3>
            <button class="btn btn-green" onclick="loadImagesFromGitHub()">üîÑ T·∫£i danh s√°ch ·∫£nh</button>
        </div>
        <p id="img-loading" style="display:none; color:#00695c; font-style:italic">ƒêang k·∫øt n·ªëi GitHub ƒë·ªÉ l·∫•y danh s√°ch...</p>
        <div id="image-gallery" class="img-grid">
            <div style="grid-column: 1/-1; text-align:center; color:#999; padding:20px">B·∫•m n√∫t "T·∫£i danh s√°ch ·∫£nh" ƒë·ªÉ xem.</div>
        </div>
    </div>
</div>

<script>
    // --- 0. AUTH ---
    const ADMIN_HASH = "e10adc3949ba59abbe56e057f20f883e"; // 123456
    function checkAdmin() {
        if(CryptoJS.MD5(document.getElementById('admin-pass-input').value).toString() === ADMIN_HASH) {
            document.getElementById('login-screen').style.display='none';
            document.getElementById('main-app').style.display='block';
            sessionStorage.setItem('admin_ok','1');
        } else document.getElementById('login-msg').style.display='block';
    }
    if(sessionStorage.getItem('admin_ok')) checkAdmin();

    // --- 1. CORE ---
    function switchTab(t) {
        document.querySelectorAll('.section').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
        document.getElementById('sec-'+t).classList.add('active');
        event.target.classList.add('active');
    }
    let questions = [];
    window.onload = () => { ['gh-user','gh-repo','gh-token'].forEach(id => { if(localStorage.getItem(id)) document.getElementById(id).value = localStorage.getItem(id); }); };
    function saveConfig() { ['gh-user','gh-repo','gh-token'].forEach(id => localStorage.setItem(id, document.getElementById(id).value.trim())); alert("ƒê√£ l∆∞u!"); }
    function hashPass() { let p=document.getElementById('exam-pass').value.trim(); document.getElementById('exam-pass-hash').value = p?CryptoJS.MD5(p).toString():""; }

    // --- 2. IMAGE MANAGER (NEW FEATURE) ---
    async function loadImagesFromGitHub() {
        const u = document.getElementById('gh-user').value.trim();
        const r = document.getElementById('gh-repo').value.trim();
        const t = document.getElementById('gh-token').value.trim();
        if(!u||!r||!t) return alert("Vui l√≤ng nh·∫≠p c·∫•u h√¨nh GitHub tr∆∞·ªõc!");

        document.getElementById('img-loading').style.display = 'block';
        document.getElementById('image-gallery').innerHTML = '';

        try {
            const res = await fetch(`https://api.github.com/repos/${u}/${r}/contents/images`, {
                headers: { Authorization: `token ${t}` }
            });
            if(!res.ok) throw new Error("Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch ·∫£nh (Ki·ªÉm tra Token)");
            
            const files = await res.json();
            document.getElementById('img-loading').style.display = 'none';

            let html = '';
            files.forEach(f => {
                // Ch·ªâ hi·ªán file ·∫£nh
                if(f.name.match(/\.(png|jpg|jpeg|gif)$/i)) {
                    html += `
                    <div class="img-card" id="card-${f.sha}">
                        <a href="${f.download_url}" target="_blank">
                            <img src="${f.download_url}" class="img-thumb" loading="lazy">
                        </a>
                        <div class="img-name" title="${f.name}">${f.name}</div>
                        <button class="btn-del-img" onclick="deleteImage('${f.path}', '${f.sha}', '${f.name}')">üóëÔ∏è X√≥a ·∫£nh</button>
                    </div>`;
                }
            });
            
            if(html === '') html = '<div style="grid-column: 1/-1; text-align:center">Th∆∞ m·ª•c images tr·ªëng.</div>';
            document.getElementById('image-gallery').innerHTML = html;

        } catch (err) {
            document.getElementById('img-loading').innerHTML = `<span style="color:red">L·ªói: ${err.message}</span>`;
        }
    }

    async function deleteImage(path, sha, name) {
        if(!confirm(`B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a ·∫£nh: ${name}?`)) return;
        
        const u = document.getElementById('gh-user').value.trim();
        const r = document.getElementById('gh-repo').value.trim();
        const t = document.getElementById('gh-token').value.trim();

        try {
            const res = await fetch(`https://api.github.com/repos/${u}/${r}/contents/${path}`, {
                method: 'DELETE',
                headers: { Authorization: `token ${t}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: `Delete ${name}`, sha: sha })
            });
            
            if(res.ok) {
                // X√≥a th·∫ª tr√™n giao di·ªán
                document.getElementById(`card-${sha}`).remove();
            } else {
                alert("L·ªói khi x√≥a ·∫£nh!");
            }
        } catch(e) { alert("L·ªói k·∫øt n·ªëi: " + e.message); }
    }

    // --- 3. PARSER & EDITOR (GI·ªÆ NGUY√äN T·ª™ V10) ---
    function parseData() {
        let text = document.getElementById('json-input').value.trim();
        if(!text) return alert("Vui l√≤ng d√°n code!");
        let start = text.indexOf('['), end = text.lastIndexOf(']');
        if(start === -1 || end === -1) { start = text.indexOf('{'); end = text.lastIndexOf('}'); }
        if(start !== -1 && end > start) text = text.substring(start, end + 1);
        try {
            let data = new Function("return " + text)();
            questions = Array.isArray(data) ? data : (data.questions || []);
            questions.forEach(q => { 
                q.id = Date.now() + Math.random(); 
                q.imgQ = {file:null, url:null}; q.imgE = {file:null, url:null}; 
            });
            document.getElementById('editor-area').style.display = 'block';
            renderEditor();
        } catch(e) { alert("L·ªói code: " + e.message); }
    }

    function renderEditor() {
        const container = document.getElementById('questions-list');
        container.innerHTML = "";
        questions.forEach((q, idx) => {
            let typeLabel = q.type=='mcq'?'TR·∫ÆC NGHI·ªÜM':(q.type=='tf'?'ƒê√öNG/SAI':'ƒêI·ªÄN KHUY·∫æT');
            let html = `
            <div class="q-item">
                <div class="q-toolbar">
                    <span style="font-weight:bold; color:#00695c">C√ÇU ${idx+1} [${typeLabel}]</span>
                    <button class="btn btn-red" style="padding:5px 10px; font-size:12px" onclick="removeQ(${idx})">X√≥a</button>
                </div>
                <div class="q-body">
                    <div class="column col-left">
                        <div>
                            <label>N·ªôi dung c√¢u h·ªèi:</label>
                            ${renderToolbar(idx, 'q')}
                            <textarea id="txt-q-${idx}" class="smart-textarea" 
                                oninput="updatePreview(${idx})"
                                ondrop="handleDrop(event, ${idx}, 'q')" 
                                ondragover="event.preventDefault(); this.classList.add('drag-over')"
                                ondragleave="this.classList.remove('drag-over')"
                                placeholder="Nh·∫≠p c√¢u h·ªèi...">${q.q}</textarea>
                            <div class="img-status" id="status-q-${idx}"></div>
                        </div>
                        <div style="margin-top:10px; border-top:1px dashed #ccc; padding-top:10px">
                            <label>L·ªùi gi·∫£i chi ti·∫øt:</label>
                            ${renderToolbar(idx, 'e')}
                            <textarea id="txt-e-${idx}" class="smart-textarea" 
                                oninput="updatePreview(${idx})"
                                ondrop="handleDrop(event, ${idx}, 'e')" 
                                ondragover="event.preventDefault(); this.classList.add('drag-over')"
                                ondragleave="this.classList.remove('drag-over')"
                                placeholder="Nh·∫≠p l·ªùi gi·∫£i...">${q.explain || ''}</textarea>
                            <div class="img-status" id="status-e-${idx}"></div>
                        </div>
                    </div>
                    <div class="column col-right">
                        <div class="preview-label">Xem tr∆∞·ªõc C√¢u h·ªèi:</div>
                        <div class="preview-box" id="preview-q-${idx}"></div>
                        <div class="preview-label" style="margin-top:20px">Xem tr∆∞·ªõc L·ªùi gi·∫£i:</div>
                        <div class="preview-box" id="preview-e-${idx}" style="background:#e8f5e9"></div>
                    </div>
                </div>
            </div>`;
            container.insertAdjacentHTML('beforeend', html);
            updatePreview(idx);
        });
    }

    function renderToolbar(idx, field) {
        return `<div class="mini-toolbar">
            <button class="tool-btn" onclick="insertTag(${idx}, '${field}', '**', '**')" title="In ƒë·∫≠m">B</button>
            <button class="tool-btn" onclick="insertTag(${idx}, '${field}', '*', '*')" title="In nghi√™ng">I</button>
            <button class="tool-btn" onclick="insertTag(${idx}, '${field}', '$', '$')" title="C√¥ng th·ª©c To√°n">‚àë</button>
            <label class="tool-btn" title="Ch√®n ·∫£nh" style="cursor:pointer">üì∑ <input type="file" style="display:none" accept="image/*" onchange="handleFileSelect(this, ${idx}, '${field}')"></label>
        </div>`;
    }

    function insertTag(idx, field, sTag, eTag) {
        let el = document.getElementById(`txt-${field}-${idx}`);
        let s = el.selectionStart, e = el.selectionEnd;
        el.value = el.value.substring(0,s) + sTag + el.value.substring(s,e) + eTag + el.value.substring(e);
        updatePreview(idx);
    }
    function handleDrop(e, idx, field) { e.preventDefault(); e.target.classList.remove('drag-over'); if(e.dataTransfer.files[0]) processImage(e.dataTransfer.files[0], idx, field); }
    function handleFileSelect(input, idx, field) { if(input.files[0]) processImage(input.files[0], idx, field); }
    function processImage(file, idx, field) {
        let q = questions[idx]; let key = field === 'q' ? 'imgQ' : 'imgE'; if(!q[key]) q[key] = {};
        q[key].file = file; q[key].url = URL.createObjectURL(file);
        let el = document.getElementById(`txt-${field}-${idx}`);
        if(!el.value.includes('[IMG]')) el.value += "\n[IMG]";
        document.getElementById(`status-${field}-${idx}`).innerHTML = `<span class="img-badge">üñºÔ∏è ${file.name}</span>`;
        updatePreview(idx);
    }
    function updatePreview(idx) {
        let q = questions[idx];
        q.q = document.getElementById(`txt-q-${idx}`).value; q.explain = document.getElementById(`txt-e-${idx}`).value;
        let urlQ = (q.imgQ && q.imgQ.url) ? q.imgQ.url : q.img;
        let urlE = (q.imgE && q.imgE.url) ? q.imgE.url : null;
        let htmlQ = renderText(q.q, urlQ);
        if(q.type==='mcq') htmlQ += `<div style="margin-top:10px; color:#555">` + q.options.map((o,i)=>`<b>${String.fromCharCode(65+i)}.</b> ${o}`).join('<br>') + `</div>`;
        else if(q.type==='tf') htmlQ += `<table style="width:100%; border-collapse:collapse; margin-top:5px">` + q.items.map((it,i)=>`<tr><td style="border-bottom:1px solid #eee; padding:5px"><b>${i+1})</b> ${it.sub}</td><td style="font-weight:bold; color:${it.ans==='T'?'green':'red'}">${it.ans}</td></tr>`).join('') + `</table>`;
        else if(q.type==='short') htmlQ += `<div style="color:#1565c0; font-weight:bold; margin-top:5px">ƒêS: ${q.ans}</div>`;
        document.getElementById(`preview-q-${idx}`).innerHTML = htmlQ;
        document.getElementById(`preview-e-${idx}`).innerHTML = renderText(q.explain, urlE);
        if(window.MathJax) MathJax.typesetPromise([document.getElementById(`preview-q-${idx}`), document.getElementById(`preview-e-${idx}`)]);
    }
    function renderText(txt, imgUrl) {
        if(!txt) return "";
        let h = txt.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\*(.*?)\*/g, '<i>$1</i>').replace(/\n/g, '<br>');
        if(imgUrl) { let tag = `<img src="${imgUrl}" class="preview-img">`; h = h.includes('[IMG]') ? h.replace('[IMG]', tag) : h + `<br>${tag}`; }
        return h.replace('[IMG]', '');
    }
    function removeQ(idx) { if(confirm("X√≥a?")) { questions.splice(idx, 1); renderEditor(); } }

    // --- 4. UPLOAD ---
    async function publishExam() {
        const u = document.getElementById('gh-user').value.trim();
        const r = document.getElementById('gh-repo').value.trim();
        const t = document.getElementById('gh-token').value.trim();
        const eid = document.getElementById('exam-id').value.trim();
        const secure = document.getElementById('secure-mode').checked;

        if(!u || !r || !t || !eid) return alert("Thi·∫øu th√¥ng tin!");
        if(!confirm("Xu·∫•t b·∫£n?")) return;

        const overlay = document.getElementById('loading-overlay');
        const logBox = document.getElementById('log-text');
        overlay.style.display = 'flex'; logBox.innerHTML = "‚è≥ ƒêang kh·ªüi t·∫°o...";
        function log(msg) { logBox.innerHTML += "\n" + msg; logBox.scrollTop = logBox.scrollHeight; }

        try {
            saveConfig();
            for (let i = 0; i < questions.length; i++) {
                let q = questions[i];
                if (q.imgQ && q.imgQ.file) {
                    log(`‚û§ Upload ·∫£nh c√¢u ${i+1}...`);
                    q.img = await uploadFile(u,r,t, `images/${eid}-q${i+1}-q-${Date.now()}.png`, q.imgQ.file, true);
                    q.q = q.q.replace('[IMG]', '');
                }
                if (q.imgE && q.imgE.file) {
                    log(`‚û§ Upload ·∫£nh l·ªùi gi·∫£i ${i+1}...`);
                    let url = await uploadFile(u,r,t, `images/${eid}-q${i+1}-e-${Date.now()}.png`, q.imgE.file, true);
                    let tag = `<div style="text-align:center"><img src="${url}" style="max-width:100%; border-radius:8px; margin:10px 0;"></div>`;
                    q.explain = q.explain.includes('[IMG]') ? q.explain.replace('[IMG]', tag) : q.explain + tag;
                }
                if(q.imgQ) delete q.imgQ; if(q.imgE) delete q.imgE;
            }

            let finalQ = JSON.parse(JSON.stringify(questions));
            if (secure) {
                log("‚û§ M√£ h√≥a ƒë√°p √°n...");
                finalQ.forEach(q => {
                    if(q.type==='mcq') q.ans=CryptoJS.MD5(String(q.ans)).toString();
                    else if(q.type==='tf') q.items.forEach(it=>it.ans=CryptoJS.MD5(it.ans).toString());
                    else if(q.type==='short') q.ans=CryptoJS.MD5(String(q.ans).trim().toLowerCase()).toString();
                });
            }

            log(`‚û§ T·∫°o file d·ªØ li·ªáu...`);
            const examData = {
                title: document.getElementById('exam-title').value,
                subject: document.getElementById('exam-subject').value,
                grade: document.getElementById('exam-grade').value,
                time: parseInt(document.getElementById('exam-time').value),
                password: document.getElementById('exam-pass-hash').value,
                encrypted: secure,
                scores: { mcq: 0.25, tf: 1.0, short: 0.5 },
                questions: finalQ
            };
            
            let c = btoa(unescape(encodeURIComponent(`window.EXAM_DATA = ${JSON.stringify(examData, null, 4)};`)));
            await uploadFile(u,r,t, `data/${eid}.js`, c, false);
            
            log(`‚û§ C·∫≠p nh·∫≠t danh s√°ch...`);
            await updateList(u,r,t, eid, examData);

            log(`üéâ TH√ÄNH C√îNG!`);
            alert("ƒê√£ xu·∫•t b·∫£n xong!");
            setTimeout(() => { overlay.style.display = 'none'; }, 2000);

        } catch (err) { 
            log(`‚ùå L·ªñI: ${err.message}`); 
            alert("C√≥ l·ªói! Xem chi ti·∫øt trong khung ƒëen.");
            setTimeout(() => { document.getElementById('loading-overlay').style.display='none'; }, 5000);
        }
    }

    async function uploadFile(u, r, t, path, content, isFileObj) {
        let sha = null;
        try { let check = await fetch(`https://api.github.com/repos/${u}/${r}/contents/${path}`, {headers:{Authorization:`token ${t}`}}); if(check.ok) sha = (await check.json()).sha; } catch(e){}

        let bodyData;
        if(isFileObj) {
            let b64 = await new Promise(resolve => { let fr = new FileReader(); fr.onload = () => resolve(fr.result.split(',')[1]); fr.readAsDataURL(content); });
            bodyData = { message: "Up Img", content: b64 };
        } else {
            bodyData = { message: "Up Data", content: content };
        }
        if(sha) bodyData.sha = sha;

        let res = await fetch(`https://api.github.com/repos/${u}/${r}/contents/${path}`, {
            method: 'PUT', headers: { Authorization: `token ${t}`, 'Content-Type': 'application/json' }, body: JSON.stringify(bodyData)
        });
        if(!res.ok) { let err = await res.json(); throw new Error(`GitHub (${res.status}): ${err.message}`); }
        return `https://raw.githubusercontent.com/${u}/${r}/main/${path}`;
    }

    async function updateList(u,r,t,id,d) {
        let url=`https://api.github.com/repos/${u}/${r}/contents/data/list.js`, l=[], s=null;
        try{let k=await fetch(url,{headers:{Authorization:`token ${t}`}});if(k.ok){let j=await k.json();s=j.sha;l=new Function("return "+decodeURIComponent(escape(atob(j.content))).replace(/window\.EXAM_LIST\s*=\s*/,'').replace(/;$/,''))();}}catch(e){}
        l=l.filter(x=>x.id!==id); l.unshift({id:id, title:d.title, subject:d.subject, grade:d.grade, time:d.time});
        let c = btoa(unescape(encodeURIComponent(`window.EXAM_LIST = ${JSON.stringify(l,null,4)};`)));
        await uploadFile(u,r,t, `data/list.js`, c, false);
    }
</script>
</body>
</html>
