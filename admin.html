<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Tool v20.2 (Full Manual)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* CSS CHU·∫®N */
        body{font-family:'Segoe UI',sans-serif;background:#eceff1;padding:20px;color:#37474f;margin:0}
        .btn{padding:8px 15px;border:none;border-radius:4px;cursor:pointer;font-weight:bold;color:white;font-size:0.9em;display:inline-flex;align-items:center;gap:5px}
        .btn-green{background:#2e7d32}.btn-blue{background:#1565c0}.btn-red{background:#c62828}.btn-gray{background:#607d8b}.btn-orange{background:#ef6c00}
        .btn:hover{opacity:0.9}
        
        .config-box{background:#e3f2fd;padding:15px;border-radius:8px;margin-bottom:20px}
        .row{display:flex;gap:15px;margin-bottom:10px}.col{flex:1}
        label{font-weight:600;display:block;margin-bottom:3px}
        input,select,textarea{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box}
        
        /* TABS */
        .tab-bar{display:flex;gap:10px;margin-bottom:20px;border-bottom:2px solid #eee;padding-bottom:10px;overflow-x:auto}
        .tab-btn{padding:10px 20px;background:#f5f5f5;border:none;border-radius:6px;cursor:pointer;color:#666;font-weight:bold;white-space:nowrap}
        .tab-btn.active{background:#00796b;color:white}
        .section{display:none}.section.active{display:block}

        /* MANUAL TOOLBAR */
        .manual-toolbar {background:white; padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid #ddd; display:flex; gap:10px; flex-wrap:wrap;}
        
        /* C√ÇU H·ªéI EDITOR */
        .q-item {background:white; padding:20px; border:1px solid #ccc; border-radius:8px; margin-bottom:20px; border-left:5px solid #009688; position:relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05);}
        .q-item-header {display:flex; justify-content:space-between; margin-bottom:15px; font-weight:bold; color:#00796b; border-bottom: 1px solid #eee; padding-bottom: 10px;}
        .smart-textarea {min-height:70px; font-family:inherit; font-size: 1.05em;}
        .img-input-group {display:flex; align-items:center; gap:10px; background:#f1f8e9; padding:8px; border-radius:4px; margin: 10px 0;}
        .sol-area {background:#e8f5e9; padding:15px; border-radius:8px; margin-top:15px; border:1px dashed #4caf50;}
        
        /* OPTION INPUTS */
        .opt-row {display:flex; align-items:center; margin-bottom:8px; gap:10px;}
        .opt-label {font-weight:bold; width: 25px;}
        .opt-radio {width: 20px; height: 20px; cursor: pointer;}
        
        /* LOGIN & MODAL */
        #login-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:#263238;z-index:9999;display:flex;justify-content:center;align-items:center}
        .login-box{background:white;padding:40px;border-radius:10px;width:350px;text-align:center}
        #main-app{display:none;max-width:1200px;margin:0 auto;background:white;padding:25px;border-radius:10px}
        #loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;display:none;flex-direction:column;justify-content:center;align-items:center;color:white}
        
        /* FILE MANAGER */
        .file-item{display:flex;justify-content:space-between;padding:10px;background:#fafafa;border:1px solid #ddd;border-radius:6px;margin-bottom:5px;align-items:center}
        .fm-breadcrumb {padding:10px; background:#eee; margin-bottom:15px; border-radius:4px; font-weight:bold; display:flex; align-items:center;}
        .fm-item {display:flex; align-items:center; padding:10px; border-bottom:1px solid #eee; cursor:pointer;}
        .fm-item:hover {background:#f0f0f0;}
        .fm-icon {width:30px; text-align:center; margin-right:10px; font-size:1.2em;}
        .fm-name {flex:1; font-weight:500;} .fm-folder {color:#fbc02d;} .fm-file {color:#546e7a;}
        
        /* QR MODAL */
        .modal{display:none;position:fixed;z-index:10000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);align-items:center;justify-content:center}
        .modal-content{background-color:white;padding:20px;border-radius:10px;text-align:center}
        #qrcode{margin:20px auto;display:flex;justify-content:center}
    </style>
</head>
<body>

<div id="loading-overlay"><div style="font-size:50px">üöÄ</div><h2 id="loading-title">ƒêANG X·ª¨ L√ù...</h2></div>

<div id="qr-modal" class="modal">
    <div class="modal-content">
        <h3 style="color:#3f51b5">M√É QR ƒê·ªÄ THI</h3>
        <p id="qr-link-text" style="font-size:0.8em;color:#666"></p>
        <div id="qrcode"></div>
        <button class="btn btn-red" onclick="document.getElementById('qr-modal').style.display='none'">ƒê√≥ng</button>
    </div>
</div>

<div id="login-screen">
    <div class="login-box">
        <h2 style="color:#00695c">ADMIN LOGIN</h2>
        <input type="password" id="admin-pass-input" onkeyup="if(event.key==='Enter')checkAdmin()">
        <button class="btn btn-green" onclick="checkAdmin()" style="margin-top:10px;width:100%">ƒêƒÇNG NH·∫¨P</button>
        <p id="login-msg" style="color:red;display:none;margin-top:10px">Sai m·∫≠t kh·∫©u!</p>
    </div>
</div>

<div id="main-app">
    <h1>QU·∫¢N TR·ªä v20.2 (FULL TH·ª¶ C√îNG)</h1>
    
    <div class="config-box">
        <div class="row">
            <div class="col"><label>User GitHub</label><input type="text" id="gh-user"></div>
            <div class="col"><label>Repo Name</label><input type="text" id="gh-repo"></div>
            <div class="col"><label>Token (Classic)</label><input type="password" id="gh-token"></div>
        </div>
        <div class="row" style="margin-top:10px">
            <div class="col"><label>Ng√¢n h√†ng</label><input type="text" id="bank-id" placeholder="MB"></div>
            <div class="col"><label>S·ªë T√†i Kho·∫£n</label><input type="text" id="bank-acc"></div>
            <div class="col"><button class="btn btn-gray" style="margin-top:22px;width:100%" onclick="saveConfig()">üíæ L∆∞u C·∫•u H√¨nh</button></div>
        </div>
    </div>

    <div class="tab-bar">
        <button id="tab-data" class="tab-btn active" onclick="switchTab('data')">üìÇ QU·∫¢N L√ù ƒê·ªÄ</button>
        <button id="tab-files" class="tab-btn" onclick="switchTab('files')">üóÇÔ∏è QU·∫¢N L√ù FILE</button>
        <button id="tab-create" class="tab-btn" onclick="switchTab('create')">üìù SO·∫†N ƒê·ªÄ</button>
        <button id="tab-images" class="tab-btn" onclick="switchTab('images')">üì∑ KHO ·∫¢NH</button>
    </div>

    <div id="sec-data" class="section active">
        <div style="display:flex;justify-content:space-between;margin-bottom:20px"><h3>DANH S√ÅCH ƒê·ªÄ THI</h3><button class="btn btn-green" onclick="loadDataFiles()">üîÑ T·∫£i L·∫°i</button></div>
        <div id="data-list" class="file-list"></div>
    </div>

    <div id="sec-files" class="section">
        <div class="fm-breadcrumb">
            <button class="btn btn-gray" style="margin-right:10px" onclick="loadFileManager('')"><i class="fas fa-home"></i> G·ªëc</button>
            <span id="fm-current-path">/</span>
        </div>
        <div id="fm-list" style="background:white;border:1px solid #ddd;border-radius:6px"></div>
    </div>

    <div id="sec-create" class="section">
        <div class="config-box" style="background:#fff3e0;border-color:#ffe0b2">
            <div class="row">
                <div class="col"><label>M√£ ƒê·ªÅ (ID)</label><input type="text" id="exam-id" placeholder="vd: de-toan-giua-ky-1" style="font-weight:bold;color:#c62828"></div>
                <div class="col" style="flex:2"><label>Ti√™u ƒê·ªÅ</label><input type="text" id="exam-title" placeholder="VD: ƒê·ªÅ thi th·ª≠ To√°n 12..."></div>
            </div>
            <div class="row">
                <div class="col"><label>Th·ªùi gian (ph√∫t)</label><input type="number" id="exam-time" value="45"></div>
                <div class="col"><label>Gi√° b√°n (VNƒê)</label><input type="number" id="exam-price" placeholder="0"></div>
                <div class="col"><label>M·∫≠t kh·∫©u</label><input type="text" id="exam-pass" oninput="hashPass()"><input type="hidden" id="exam-pass-hash"></div>
            </div>
            <div class="row" style="margin-top:10px">
                <div class="col"><label>M·ªü l√∫c</label><input type="datetime-local" id="exam-start"></div>
                <div class="col"><label>ƒê√≥ng l√∫c</label><input type="datetime-local" id="exam-end"></div>
                <div class="col" style="display:flex;align-items:center"><input type="checkbox" id="secure-mode" style="width:auto;margin-right:5px"> <label for="secure-mode">M√£ h√≥a ƒë√°p √°n</label></div>
            </div>
        </div>

        <div class="manual-toolbar">
            <button class="btn btn-blue" onclick="addQ('mcq')"><i class="fas fa-plus-circle"></i> Tr·∫Øc Nghi·ªám (4)</button>
            <button class="btn btn-green" onclick="addQ('tf')"><i class="fas fa-check-square"></i> ƒê√∫ng/Sai</button>
            <button class="btn btn-orange" onclick="addQ('short')"><i class="fas fa-pen-alt"></i> ƒêi·ªÅn S·ªë/Ch·ªØ</button>
            <button class="btn btn-gray" onclick="addQ('match')"><i class="fas fa-random"></i> Gh√©p C·ªôt</button>
        </div>

        <div id="editor-area">
            <div id="questions-list"></div>
            <p style="text-align:center;color:#666;font-style:italic;margin:20px" id="empty-msg">B·∫•m n√∫t ph√≠a tr√™n ƒë·ªÉ th√™m c√¢u h·ªèi.</p>
        </div>

        <button class="btn btn-red" style="width:100%;margin-top:20px;padding:15px;font-size:1.2em" onclick="publishExam()">üöÄ XU·∫§T B·∫¢N ƒê·ªÄ THI</button>
        
        <div style="margin-top:20px;border-top:1px dashed #ccc;padding-top:10px">
            <small style="cursor:pointer;color:#999" onclick="document.getElementById('json-import-box').style.display='block'">‚ñº D√°n JSON c≈© (N·∫øu c·∫ßn s·ª≠a)</small>
            <div id="json-import-box" style="display:none">
                <textarea id="json-input" style="width:100%;height:60px;margin-top:5px" placeholder="D√°n JSON v√†o ƒë√¢y..."></textarea>
                <button class="btn btn-gray" onclick="parseData()">N·∫°p JSON</button>
            </div>
        </div>
    </div>

    <div id="sec-images" class="section"><button class="btn btn-green" onclick="loadImagesFromGitHub()">T·∫£i ·∫£nh</button><div id="image-gallery" style="display:flex;flex-wrap:wrap;gap:10px;margin-top:15px"></div></div>
</div>

<script>
    const ADMIN_HASH = "55ab43ebd8eb2635766c3944cb192e72"; 
    function checkAdmin(){if(CryptoJS.MD5(document.getElementById('admin-pass-input').value).toString()===ADMIN_HASH){document.getElementById('login-screen').style.display='none';document.getElementById('main-app').style.display='block';sessionStorage.setItem('admin_ok','1');}else document.getElementById('login-msg').style.display='block';}
    if(sessionStorage.getItem('admin_ok')) checkAdmin();

    function switchTab(t){
        document.querySelectorAll('.section').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
        document.getElementById('sec-'+t).classList.add('active');
        const btn = document.getElementById('tab-'+t); if(btn) btn.classList.add('active');
        if(t === 'files') loadFileManager('');
    }
    
    window.onload=()=>{ ['gh-user','gh-repo','gh-token','bank-id','bank-acc'].forEach(id=>{if(localStorage.getItem(id))document.getElementById(id).value=localStorage.getItem(id)}); }
    function saveConfig(){ ['gh-user','gh-repo','gh-token','bank-id','bank-acc'].forEach(id=>localStorage.setItem(id,document.getElementById(id).value.trim())); alert("ƒê√£ l∆∞u!"); }
    function hashPass(){let p=document.getElementById('exam-pass').value.trim();document.getElementById('exam-pass-hash').value=p?CryptoJS.MD5(p).toString():"";}

    // ==========================================
    // LOGIC SO·∫†N TH·∫¢O (C√ì ·∫¢NH L·ªúI GI·∫¢I v20.2)
    // ==========================================
    let questions = [];

    function addQ(type) {
        if(type === 'mcq') questions.push({type:'mcq', q:'C√¢u h·ªèi m·ªõi...', img:'', options:['L·ª±a ch·ªçn A','L·ª±a ch·ªçn B','L·ª±a ch·ªçn C','L·ª±a ch·ªçn D'], ans:0, explain:'', solImg:''});
        if(type === 'tf') questions.push({type:'tf', q:'Nh·∫≠n ƒë·ªãnh sau ƒë√¢y ƒë√∫ng hay sai?', img:'', items:[{sub:'√ù 1', ans:'T'},{sub:'√ù 2', ans:'F'},{sub:'√ù 3', ans:'T'},{sub:'√ù 4', ans:'F'}], explain:'', solImg:''});
        if(type === 'short') questions.push({type:'short', q:'ƒêi·ªÅn ƒë√°p √°n ƒë√∫ng:', img:'', ans:'', explain:'', solImg:''});
        if(type === 'match') questions.push({type:'match', q:'Gh√©p c√°c c·∫∑p t∆∞∆°ng ·ª©ng:', img:'', items:['V·∫ø tr√°i 1','V·∫ø tr√°i 2','V·∫ø tr√°i 3','V·∫ø tr√°i 4'], options:['V·∫ø ph·∫£i A','V·∫ø ph·∫£i B','V·∫ø ph·∫£i C','V·∫ø ph·∫£i D'], ans:['A','B','C','D'], explain:'', solImg:''});
        renderEditor();
    }

    function renderEditor(){
        let c=document.getElementById('questions-list'); c.innerHTML="";
        if(questions.length > 0) document.getElementById('empty-msg').style.display='none';
        
        questions.forEach((q,i)=>{
            // UI ·∫¢NH C√ÇU H·ªéI
            let imgQ = `<div class="img-input-group">
                <i class="fas fa-image" style="color:#2e7d32"></i> <b>·∫¢nh ƒê·ªÅ:</b>
                <input type="text" placeholder="Link ·∫£nh c√¢u h·ªèi..." value="${q.img||''}" onchange="questions[${i}].img=this.value" style="flex:1">
                ${q.img ? `<img src="${q.img}" style="height:40px;border:1px solid #ccc">` : ''}
            </div>`;

            // UI ·∫¢NH L·ªúI GI·∫¢I
            let imgSol = `<div class="img-input-group" style="background:#fffde7">
                <i class="fas fa-lightbulb" style="color:#fbc02d"></i> <b>·∫¢nh L·ªùi Gi·∫£i:</b>
                <input type="text" placeholder="Link ·∫£nh l·ªùi gi·∫£i..." value="${q.solImg||''}" onchange="questions[${i}].solImg=this.value" style="flex:1">
                ${q.solImg ? `<img src="${q.solImg}" style="height:40px;border:1px solid #ccc">` : ''}
            </div>`;

            // UI N·ªòI DUNG ƒê√ÅP √ÅN (HI·ªÜN R√ï R√ÄNG)
            let ansUI = "";
            if(q.type === 'mcq') {
                ansUI = `<div style="margin:10px 0;background:#f5f5f5;padding:15px;border-radius:4px;border:1px solid #e0e0e0">
                    ${q.options.map((opt,idx)=>`
                        <div class="opt-row">
                            <input type="radio" name="radio_q${i}" class="opt-radio" ${q.ans==idx?'checked':''} onchange="questions[${i}].ans=${idx}">
                            <span class="opt-label">${['A','B','C','D'][idx]}.</span>
                            <input style="flex:1" value="${opt}" onchange="questions[${i}].options[${idx}]=this.value">
                        </div>
                    `).join('')}
                </div>`;
            } 
            else if (q.type === 'tf') {
                ansUI = `<div style="margin:10px 0;background:#e3f2fd;padding:15px;border-radius:4px">
                    ${q.items.map((it,idx)=>`
                        <div class="opt-row">
                            <span class="opt-label">√ù ${idx+1}:</span>
                            <input style="flex:1" value="${it.sub}" onchange="questions[${i}].items[${idx}].sub=this.value">
                            <select onchange="questions[${i}].items[${idx}].ans=this.value" style="width:90px;font-weight:bold;color:${it.ans=='T'?'#2e7d32':'#c62828'}">
                                <option value="T" ${it.ans=='T'?'selected':''}>ƒê√öNG</option>
                                <option value="F" ${it.ans=='F'?'selected':''}>SAI</option>
                            </select>
                        </div>
                    `).join('')}
                </div>`;
            }
            else if (q.type === 'short') {
                ansUI = `<div style="margin:10px 0;padding:10px;border:1px dashed #ffa000;border-radius:4px;background:#fff8e1">
                    <b>ƒê√°p √°n ƒë√∫ng (S·ªë/Ch·ªØ):</b> <input type="text" value="${q.ans}" onchange="questions[${i}].ans=this.value" placeholder="VD: 16.98" style="font-weight:bold;color:#c62828;width:200px;margin-left:10px">
                </div>`;
            }
            else if (q.type === 'match') {
                 ansUI = `<div style="margin:10px 0;background:#f3e5f5;padding:10px">
                    <div style="margin-bottom:10px"><b>C·ªôt Ph·∫£i (A,B,C,D):</b><br>${q.options.map((opt,oidx)=>`<input placeholder="${String.fromCharCode(65+oidx)}" value="${opt}" onchange="questions[${i}].options[${oidx}]=this.value" style="margin-bottom:2px">`).join('')}</div>
                    <div><b>C·ªôt Tr√°i & Gh√©p:</b><br>${q.items.map((it,idx)=>`<div style="display:flex;gap:5px;margin-bottom:3px"><input value="${it}" onchange="questions[${i}].items[${idx}]=this.value"><input value="${q.ans[idx]}" onchange="questions[${i}].ans[${idx}]=this.value" style="width:50px;text-align:center;font-weight:bold" placeholder="A"></div>`).join('')}</div>
                 </div>`;
            }

            c.insertAdjacentHTML('beforeend',`<div class="q-item">
                <div class="q-item-header"><span>C√ÇU ${i+1} (${q.type.toUpperCase()})</span><button class="btn btn-red" style="padding:2px 8px;font-size:0.8em" onclick="questions.splice(${i},1);renderEditor()">X√≥a</button></div>
                <textarea class="smart-textarea" onchange="questions[${i}].q=this.value" placeholder="Nh·∫≠p n·ªôi dung c√¢u h·ªèi...">${q.q}</textarea>
                ${imgQ}
                ${ansUI}
                <div class="sol-area">
                    <label style="color:#2e7d32;font-weight:bold"><i class="fas fa-book-open"></i> L·ªùi Gi·∫£i Chi Ti·∫øt:</label>
                    <textarea class="smart-textarea" placeholder="Nh·∫≠p l·ªùi gi·∫£i..." onchange="questions[${i}].explain=this.value" style="border:none;background:transparent;width:100%;min-height:50px">${q.explain||''}</textarea>
                    ${imgSol}
                </div>
            </div>`);
        });
    }

    // ==========================================
    // QU·∫¢N L√ù FILE
    // ==========================================
    let currentPath = "";
    async function loadFileManager(path) {
        currentPath = path;
        document.getElementById('fm-current-path').innerText = path || " (G·ªëc)";
        const u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value,t=document.getElementById('gh-token').value;
        try {
            const res = await fetch(`https://api.github.com/repos/${u}/${r}/contents/${path}`, {headers: {Authorization: `token ${t}`}});
            if(!res.ok) throw new Error("L·ªói t·∫£i th∆∞ m·ª•c!");
            const items = await res.json();
            items.sort((a, b) => (a.type === b.type ? 0 : a.type === 'dir' ? -1 : 1));
            let html = '';
            if(path !== "") { 
                let parent = path.split('/').slice(0,-1).join('/');
                html += `<div class="fm-item" onclick="loadFileManager('${parent}')"><div class="fm-icon fm-folder"><i class="fas fa-level-up-alt"></i></div><div class="fm-name">.. (Quay l·∫°i)</div></div>`;
            }
            items.forEach(item => {
                let icon = item.type === 'dir' ? '<i class="fas fa-folder"></i>' : '<i class="fas fa-file-alt"></i>';
                let cls = item.type === 'dir' ? 'fm-folder' : 'fm-file';
                let action = item.type === 'dir' ? `onclick="loadFileManager('${item.path}')"` : '';
                let delBtn = `<button class="btn btn-red" style="padding:2px 8px" onclick="event.stopPropagation();deleteFileGeneric('${item.path}', '${item.name}', true)">X√≥a</button>`;
                html += `<div class="fm-item" ${action}><div class="fm-icon ${cls}">${icon}</div><div class="fm-name">${item.name}</div><div>${delBtn}</div></div>`;
            });
            document.getElementById('fm-list').innerHTML = html;
        } catch(e) {}
    }

    async function deleteFileGeneric(path, name, isFileManager) {
        if(!confirm(`‚ö†Ô∏è X√ìA Vƒ®NH VI·ªÑN: ${name}?`)) return;
        const u=document.getElementById('gh-user').value, r=document.getElementById('gh-repo').value, t=document.getElementById('gh-token').value;
        const ov=document.getElementById('loading-overlay'); ov.style.display='flex';
        try {
            const res = await fetch(`https://api.github.com/repos/${u}/${r}/contents/${path}`, {headers: {Authorization: `token ${t}`}});
            const data = await res.json();
            await fetch(`https://api.github.com/repos/${u}/${r}/contents/${path}`, {
                method: 'DELETE', headers: { Authorization: `token ${t}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: `Delete ${name}`, sha: data.sha })
            });
            alert("ƒê√£ x√≥a!"); 
            if(isFileManager) loadFileManager(currentPath); else loadDataFiles();
        } catch(e) { alert("L·ªói: " + e.message); } finally { ov.style.display='none'; }
    }

    // ==========================================
    // C√ÅC H√ÄM X·ª¨ L√ù (PUBLISH, IMPORT)
    // ==========================================
    function parseData(){ try { let t = document.getElementById('json-input').value; let d = new Function("return " + t)(); questions = Array.isArray(d) ? d : (d.questions || []); renderEditor(); } catch(e) { alert("L·ªói JSON!"); } }

    async function loadDataFiles(){
        const u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value,t=document.getElementById('gh-token').value;
        if(!u)return alert("Thi·∫øu Config!");
        try{
            const res=await fetch(`https://api.github.com/repos/${u}/${r}/contents/data`,{headers:{Authorization:`token ${t}`}});
            const f=await res.json();
            let h='';
            f.forEach(x=>{
                if(x.name.endsWith('.js')&&x.name!=='list.js') {
                    h+=`<div class="file-item"><span style="font-weight:500">${x.name}</span><div><button class="btn btn-qr" onclick="showExamQR('${x.name}')">QR</button><button class="btn btn-edit" onclick="loadExamToEdit('${x.path}','${x.name}')">S·ª≠a</button><button class="btn btn-red" onclick="deleteFileGeneric('${x.path}','${x.name}', false)">X√≥a</button></div></div>`;
                }
            });
            document.getElementById('data-list').innerHTML=h;
        }catch(e){alert(e.message);}
    }

    async function loadExamToEdit(path, name) {
        const u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value,t=document.getElementById('gh-token').value;
        const ov=document.getElementById('loading-overlay'); ov.style.display='flex';
        try{
            const res=await fetch(`https://api.github.com/repos/${u}/${r}/contents/${path}`,{headers:{Authorization:`token ${t}`}});
            const json=await res.json(), content=decodeURIComponent(escape(atob(json.content)));
            let dataStr = content.substring(content.indexOf('{'), content.lastIndexOf('}')+1);
            let data=JSON.parse(dataStr);
            document.getElementById('exam-id').value=name.replace('.js','');
            document.getElementById('exam-title').value=data.title||"";
            document.getElementById('exam-time').value=data.time||45;
            document.getElementById('exam-price').value=data.price||0;
            document.getElementById('exam-pass-hash').value=data.password||"";
            document.getElementById('secure-mode').checked=data.encrypted;
            if(data.start)document.getElementById('exam-start').value=data.start;
            if(data.end)document.getElementById('exam-end').value=data.end;
            
            // X·ª¨ L√ù L·∫§Y L·∫†I ·∫¢NH L·ªúI GI·∫¢I T·ª™ HTML N·∫æU C√ì
            data.questions.forEach(q => {
                if(q.explain && q.explain.includes('<img')) {
                    // Tr√≠ch xu·∫•t link ·∫£nh t·ª´ th·∫ª img trong explain n·∫øu c√≥ (d√†nh cho ƒë·ªÅ c≈©)
                    let match = q.explain.match(/src="([^"]+)"/);
                    if(match) q.solImg = match[1];
                }
            });

            questions=data.questions||[]; renderEditor(); 
            ov.style.display='none'; switchTab('create');
        }catch(e){ alert("L·ªói t·∫£i ƒë·ªÅ: "+e.message); ov.style.display='none'; }
    }

    async function publishExam(){
        const u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value,t=document.getElementById('gh-token').value,id=document.getElementById('exam-id').value;
        if(!u||!r||!t||!id)return alert("Thi·∫øu info!");
        const bankInfo = {id: document.getElementById('bank-id').value, acc: document.getElementById('bank-acc').value};
        const price = parseInt(document.getElementById('exam-price').value) || 0;
        const ov=document.getElementById('loading-overlay');ov.style.display='flex';
        try{
            let fQ=JSON.parse(JSON.stringify(questions));
            let sec=document.getElementById('secure-mode').checked;
            
            // G·ªòP ·∫¢NH L·ªúI GI·∫¢I V√ÄO EXPLAIN V√Ä M√É H√ìA
            fQ.forEach(q=>{
                if(q.solImg) {
                    q.explain = (q.explain || "") + `<br><img src="${q.solImg}" style="max-width:100%;margin-top:10px;border-radius:5px">`;
                    delete q.solImg; // X√≥a tr∆∞·ªùng th·ª´a tr∆∞·ªõc khi l∆∞u
                }

                if(sec){
                    if(q.type==='mcq') q.ans=CryptoJS.MD5(String(q.ans)).toString();
                    else if(q.type==='tf') q.items.forEach(x=>x.ans=CryptoJS.MD5(String(x.ans).trim()).toString());
                    else if(q.type==='short') q.ans=CryptoJS.MD5(String(q.ans).trim().toLowerCase().replace(',','.')).toString();
                    else if(q.type==='match') q.ans=q.ans.map(v=>CryptoJS.MD5(String(v).trim()).toString());
                }
            });

            let dt={ title:document.getElementById('exam-title').value, time:parseInt(document.getElementById('exam-time').value), password:document.getElementById('exam-pass-hash').value, encrypted:sec, start:document.getElementById('exam-start').value, end:document.getElementById('exam-end').value, price: price, bank: bankInfo, scores:{mcq:0.25,tf:1.0,short:0.5,match:1.0}, questions:fQ };
            let c=btoa(unescape(encodeURIComponent(`window.EXAM_DATA = ${JSON.stringify(dt,null,4)};`)));
            await upF(u,r,t,`data/${id}.js`,c,false);
            await updateList(u,r,t,id,dt);
            alert("Th√†nh c√¥ng! ƒê·ªÅ ƒë√£ ƒë∆∞·ª£c xu·∫•t b·∫£n."); ov.style.display='none'; loadDataFiles();
        }catch(e){alert(e.message); ov.style.display='none';}
    }

    async function upF(u,r,t,p,c,isF){let s=null;try{let k=await fetch(`https://api.github.com/repos/${u}/${r}/contents/${p}`,{headers:{Authorization:`token ${t}`}});if(k.ok)s=(await k.json()).sha;}catch(e){}let b={message:"Up",content:isF?await toB64(c):c};if(s)b.sha=s;let rs=await fetch(`https://api.github.com/repos/${u}/${r}/contents/${p}`,{method:'PUT',headers:{Authorization:`token ${t}`,'Content-Type':'application/json'},body:JSON.stringify(b)});if(!rs.ok){let j=await rs.json();throw new Error(j.message);}}
    function toB64(f){return new Promise(r=>{let fr=new FileReader();fr.onload=()=>r(fr.result.split(',')[1]);fr.readAsDataURL(f);});}
    async function updateList(u,r,t,id,d){let url=`https://api.github.com/repos/${u}/${r}/contents/data/list.js`,l=[],s=null;try{let k=await fetch(url,{headers:{Authorization:`token ${t}`}});if(k.ok){let j=await k.json();s=j.sha;l=new Function("return "+decodeURIComponent(escape(atob(j.content))).replace(/window\.EXAM_LIST\s*=\s*/,'').replace(/;$/,''))();}}catch(e){}l=l.filter(x=>x.id!==id);l.unshift({id:id,title:d.title,subject:d.subject,grade:d.grade,time:d.time});let c=btoa(unescape(encodeURIComponent(`window.EXAM_LIST = ${JSON.stringify(l,null,4)};`)));await upF(u,r,t,`data/list.js`,c,false);}
    
    function showExamQR(n){let u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value;let url=`https://${u}.github.io/${r}/thi.html?id=${n.replace('.js','')}`;document.getElementById('qr-modal').style.display='flex';document.getElementById('qr-link-text').innerText=url;document.getElementById('qrcode').innerHTML="";new QRCode(document.getElementById("qrcode"),{text:url,width:200,height:200});}
    async function loadImagesFromGitHub(){const u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value,t=document.getElementById('gh-token').value;if(!u)return;try{const res=await fetch(`https://api.github.com/repos/${u}/${r}/contents/images`,{headers:{Authorization:`token ${t}`}});const f=await res.json();let h='';f.forEach(x=>{if(x.name.match(/\.(png|jpg)$/i))h+=`<div style="border:1px solid #ddd;padding:5px"><img src="${x.download_url}" style="height:100px"><br><small>${x.name}</small></div>`});document.getElementById('image-gallery').innerHTML=h;}catch(e){}}
</script>
</body>
</html>
