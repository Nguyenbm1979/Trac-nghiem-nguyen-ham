<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Tool v13.1 (Final Fix)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }, svg: { fontCache: 'global' } };</script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        /* GIAO DI·ªÜN CHU·∫®N */
        body{font-family:'Segoe UI',sans-serif;background:#eceff1;padding:20px;color:#37474f;margin:0}
        
        /* LOGIN */
        #login-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:#263238;z-index:9999;display:flex;flex-direction:column;justify-content:center;align-items:center}
        .login-box{background:white;padding:40px;border-radius:10px;width:350px;text-align:center;box-shadow: 0 10px 25px rgba(0,0,0,0.5);}
        .login-box input{width:100%;padding:12px;margin:20px 0;border:1px solid #ccc;border-radius:4px}
        .login-btn{width:100%;padding:12px;background:#00695c;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold;transition:0.3s}
        .login-btn:hover{background:#004d40}

        /* MAIN APP */
        #main-app{display:none;max-width:1200px;margin:0 auto;background:white;padding:25px;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,0.1)}
        h1{color:#00695c;text-align:center;border-bottom:3px solid #004d40;padding-bottom:10px}
        
        /* TABS */
        .tab-bar{display:flex;gap:10px;margin-bottom:20px;border-bottom:2px solid #eee;padding-bottom:10px}
        .tab-btn{padding:10px 20px;background:#f5f5f5;border:none;border-radius:6px;cursor:pointer;font-weight:bold;color:#666;transition:0.2s}
        .tab-btn.active{background:#00796b;color:white}
        .section{display:none}.section.active{display:block}
        
        /* CONFIG & INPUTS */
        .config-box{background:#e3f2fd;padding:15px;border-radius:8px;margin-bottom:20px;border:1px solid #90caf9}
        .row{display:flex;gap:15px;margin-bottom:10px}.col{flex:1}
        input,select{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box}
        label{font-weight:600;font-size:0.9em;display:block;margin-bottom:3px}
        
        /* EDITOR ITEMS */
        .q-item{border:1px solid #cfd8dc;margin-bottom:30px;border-radius:8px;overflow:hidden;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,0.05)}
        .q-toolbar{background:#f5f5f5;padding:10px 15px;border-bottom:1px solid #ddd;display:flex;justify-content:space-between;align-items:center}
        .q-body{display:flex;border-bottom:1px solid #eee}
        .column{flex:1;padding:15px;display:flex;flex-direction:column;gap:15px}
        .col-left{border-right:1px solid #eee;background:#fafafa}.col-right{background:#fff}
        
        /* TOOLS */
        .mini-toolbar{display:flex;gap:5px;margin-bottom:5px}
        .tool-btn{padding:5px 10px;border:1px solid #ccc;background:white;cursor:pointer;border-radius:3px;font-weight:bold;min-width:30px}
        .smart-textarea{width:100%;height:100px;padding:10px;border:1px solid #ccc;border-radius:4px;font-family:monospace;resize:vertical;box-sizing:border-box}
        .smart-textarea:focus{border-color:#009688;outline:none}
        
        /* PREVIEW */
        .preview-box{padding:10px;border:1px dashed #ccc;border-radius:4px;min-height:50px;background:white}
        .preview-img{max-width:100%;height:auto;display:block;margin:10px auto;border:1px solid #ddd}
        .img-status{font-size:0.85em;margin-top:5px;display:flex;align-items:center;gap:5px}
        .img-badge{background:#e0f2f1;color:#00695c;padding:2px 6px;border-radius:3px;font-size:0.8em}
        
        /* BUTTONS */
        .btn{padding:10px 20px;border:none;border-radius:4px;cursor:pointer;font-weight:bold;color:white}
        .btn-green{background:#2e7d32}.btn-blue{background:#1565c0}.btn-red{background:#c62828}.btn-gray{background:#607d8b}
        .btn-edit{background:#ff9800;color:white;border:none;padding:5px 15px;border-radius:4px;cursor:pointer;margin-right:10px;font-weight:bold}

        /* LOADING & LOGS */
        #loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:99999;display:none;flex-direction:column;justify-content:center;align-items:center;color:white}
        #log-text{margin-top:15px;font-family:monospace;color:#80cbc4;white-space:pre-wrap;max-height:300px;overflow-y:auto;text-align:left;width:80%;background:#263238;padding:15px;border-radius:8px}
        
        /* LISTS */
        .img-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:15px;margin-top:15px}
        .img-card{border:1px solid #ddd;border-radius:6px;padding:10px;text-align:center;background:#fff}
        .img-thumb{width:100%;height:100px;object-fit:contain;margin-bottom:5px;border:1px solid #eee}
        .img-name{font-size:0.8em;color:#555;word-break:break-all;height:35px;overflow:hidden}
        .btn-del-img{background:#c62828;color:white;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:0.8em;margin-top:5px;width:100%}
        
        .file-list{display:flex;flex-direction:column;gap:10px}
        .file-item{display:flex;justify-content:space-between;align-items:center;padding:15px;background:#fafafa;border:1px solid #ddd;border-radius:6px}
    </style>
</head>
<body>

<div id="loading-overlay"><div style="font-size: 50px;">üöÄ</div><h2 id="loading-title">ƒêANG X·ª¨ L√ù...</h2><div id="log-text"></div></div>

<div id="login-screen">
    <div class="login-box">
        <h2 style="color:#00695c">ADMIN LOGIN</h2>
        <input type="password" id="admin-pass-input" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" onkeyup="if(event.key==='Enter')checkAdmin()">
        <button class="login-btn" onclick="checkAdmin()">ƒêƒÇNG NH·∫¨P</button>
        <p id="login-msg" style="color:red;margin-top:10px;display:none">Sai m·∫≠t kh·∫©u!</p>
    </div>
</div>

<div id="main-app">
    <h1>H·ªÜ TH·ªêNG QU·∫¢N TR·ªä v13.1</h1>
    
    <div class="config-box">
        <div class="row">
            <div class="col"><label>Username</label><input type="text" id="gh-user"></div>
            <div class="col"><label>Repository</label><input type="text" id="gh-repo"></div>
            <div class="col"><label>Token</label><input type="password" id="gh-token"></div>
        </div>
        <div class="row"><div class="col"><button class="btn btn-gray" onclick="saveConfig()">üíæ L∆∞u C·∫•u H√¨nh</button></div></div>
    </div>

    <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('create')">üìù SO·∫†N ƒê·ªÄ</button>
        <button class="tab-btn" onclick="switchTab('images')">üì∑ KHO ·∫¢NH</button>
        <button class="tab-btn" onclick="switchTab('data')">üìÇ QU·∫¢N L√ù ƒê·ªÄ</button>
    </div>

    <div id="sec-create" class="section active">
        <div class="config-box" style="background:#fff3e0;border-color:#ffe0b2">
            <div class="row">
                <div class="col"><label>M√¥n</label><select id="exam-subject"><option value="Toan">To√°n</option><option value="Su">L·ªãch S·ª≠</option><option value="Ly">V·∫≠t L√Ω</option><option value="Hoa">H√≥a</option><option value="Sinh">Sinh</option><option value="Dia">ƒê·ªãa</option><option value="Anh">Anh</option><option value="GDCD">GDCD</option></select></div>
                <div class="col"><label>Kh·ªëi</label><select id="exam-grade"><option value="12">12</option><option value="11">11</option><option value="10">10</option><option value="12OT">√în Thi</option></select></div>
                <div class="col"><label>Th·ªùi gian (ph√∫t)</label><input type="number" id="exam-time" value="45"></div>
            </div>
            <div class="row">
                <div class="col"><label>M√£ ƒê·ªÅ (ID)</label><input type="text" id="exam-id" placeholder="de-toan-hk1" style="font-weight:bold;color:#c62828"></div>
                <div class="col" style="flex:2"><label>Ti√™u ƒê·ªÅ</label><input type="text" id="exam-title" placeholder="Ki·ªÉm tra..."></div>
                <div class="col"><label>M·∫≠t kh·∫©u ƒê·ªÅ</label><input type="text" id="exam-pass" oninput="hashPass()"><input type="hidden" id="exam-pass-hash"></div>
            </div>
            <div class="row" style="background:#fff; padding:10px; border-radius:4px; margin-top:10px">
                <div class="col"><label>‚è∞ M·ªü ƒë·ªÅ l√∫c</label><input type="datetime-local" id="exam-start"></div>
                <div class="col"><label>üö´ ƒê√≥ng ƒë·ªÅ l√∫c</label><input type="datetime-local" id="exam-end"></div>
            </div>
            <div class="row" style="margin-top:10px; background:#fff; padding:10px; border-radius:4px">
                <div class="col"><input type="checkbox" id="secure-mode" style="width:20px;height:20px" checked><label for="secure-mode" style="display:inline;color:#c62828;font-weight:bold;margin-left:5px">üîí M√É H√ìA ƒê√ÅP √ÅN (Khuy√™n d√πng)</label></div>
            </div>
        </div>

        <div style="margin-bottom:30px">
            <label>üì• Nh·∫≠p JSON t·ª´ Gemini ho·∫∑c B·∫•m "S·ª≠a" ·ªü tab Qu·∫£n l√Ω:</label>
            <textarea id="json-input" class="smart-textarea" style="height:80px;border:2px dashed #009688" placeholder='[{"type":"mcq",...}]'></textarea>
            <button class="btn btn-blue" style="width:100%;margin-top:10px" onclick="parseData()">‚ö° PH√ÇN T√çCH & SO·∫†N TH·∫¢O</button>
        </div>

        <div id="editor-area" style="display:none">
            <h3 style="color:#2e7d32;border-bottom:2px solid #eee;padding-bottom:10px">üìù KHUNG CH·ªàNH S·ª¨A</h3>
            <div id="questions-list"></div>
            <div style="text-align:right;margin-top:30px;padding-top:20px;border-top:1px solid #ccc">
                <button class="btn btn-red" style="font-size:1.2em;padding:15px 40px" onclick="publishExam()">üöÄ XU·∫§T B·∫¢N / C·∫¨P NH·∫¨T</button>
            </div>
        </div>
    </div>

    <div id="sec-images" class="section">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><h3>KHO ·∫¢NH TR√äN GITHUB</h3><button class="btn btn-green" onclick="loadImagesFromGitHub()">üîÑ T·∫£i ·∫£nh</button></div>
        <p id="img-loading" style="display:none;color:#009688">ƒêang t·∫£i...</p>
        <div id="image-gallery" class="img-grid"></div>
    </div>
    
    <div id="sec-data" class="section">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><h3>DANH S√ÅCH ƒê·ªÄ THI</h3><button class="btn btn-green" onclick="loadDataFiles()">üîÑ T·∫£i danh s√°ch</button></div>
        <div id="data-list" class="file-list"></div>
    </div>
</div>

<script>
    // --- AUTHENTICATION ---
    // M·∫≠t kh·∫©u: Nguyen@#197@9
    const ADMIN_HASH = "55ab43ebd8eb2635766c3944cb192e72"; 

    function checkAdmin(){
        if(CryptoJS.MD5(document.getElementById('admin-pass-input').value).toString()===ADMIN_HASH){
            document.getElementById('login-screen').style.display='none';
            document.getElementById('main-app').style.display='block';
            sessionStorage.setItem('admin_ok','1');
        } else {
            document.getElementById('login-msg').style.display='block';
        }
    }
    if(sessionStorage.getItem('admin_ok')) checkAdmin();

    // --- CORE FUNCTIONS ---
    function switchTab(t){
        document.querySelectorAll('.section').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
        document.getElementById('sec-'+t).classList.add('active');
        event.target.classList.add('active');
    }

    let questions=[];
    window.onload=()=>{
        ['gh-user','gh-repo','gh-token'].forEach(id=>{
            if(localStorage.getItem(id)) document.getElementById(id).value=localStorage.getItem(id)
        });
    }

    function saveConfig(){
        ['gh-user','gh-repo','gh-token'].forEach(id=>localStorage.setItem(id,document.getElementById(id).value.trim()));
        alert("ƒê√£ l∆∞u c·∫•u h√¨nh!");
    }

    function hashPass(){
        let p=document.getElementById('exam-pass').value.trim();
        document.getElementById('exam-pass-hash').value=p?CryptoJS.MD5(p).toString():"";
    }

    // --- H√ÄM LOAD FILE TH√îNG MINH (PHI√äN B·∫¢N M·ªöI NH·∫§T) ---
    async function loadExamToEdit(path, name) {
        const u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value,t=document.getElementById('gh-token').value;
        const ov=document.getElementById('loading-overlay'); 
        ov.style.display='flex'; 
        document.getElementById('log-text').innerText=`‚è≥ ƒêang t·∫£i v√† gi·∫£i m√£: ${name}...`;

        try {
            const res = await fetch(`https://api.github.com/repos/${u}/${r}/contents/${path}`, {headers:{Authorization:`token ${t}`}});
            if(!res.ok) throw new Error("Kh√¥ng t·∫£i ƒë∆∞·ª£c file (Token l·ªói ho·∫∑c file kh√¥ng t·ªìn t·∫°i)");
            const json = await res.json();
            const content = decodeURIComponent(escape(atob(json.content)));
            
            // 1. C·∫Øt l·∫•y JSON chu·∫©n (Fix l·ªói k√Ω t·ª± th·ª´a)
            const firstBrace = content.indexOf('{');
            const lastBrace = content.lastIndexOf('}');
            if(firstBrace === -1) throw new Error("File h·ªèng (Kh√¥ng t√¨m th·∫•y JSON)");
            let jsonStr = content.substring(firstBrace, lastBrace + 1);
            
            let data = JSON.parse(jsonStr);

            // 2. GI·∫¢I M√É NG∆Ø·ª¢C (ƒê·ªÇ S·ª¨A)
            if(data.encrypted) {
                const HASH_MAP = {
                    "cfcd208495d565ef66e7dff9f98764da": 0,   // A
                    "c4ca4238a0b923820dcc509a6f75849b": 1,   // B
                    "c81e728d9d4c2f636f067f89cc14862c": 2,   // C
                    "eccbc87e4b5ce2fe28308fd9f2a7baf3": 3,   // D
                    "b9ece18c950afbfa6b0fdbfa4ff731d3": "T", // ƒê√∫ng
                    "800618943025315f869e4e1f09471012": "F"  // Sai
                };

                (data.questions || []).forEach(q => {
                    if(q.type === 'mcq' && HASH_MAP[q.ans] !== undefined) q.ans = HASH_MAP[q.ans];
                    else if(q.type === 'tf') q.items.forEach(it => { if(HASH_MAP[it.ans]) it.ans = HASH_MAP[it.ans]; });
                    else if(q.type === 'short') q.ans = ""; // X√≥a tr·∫Øng short answer v√¨ ko d·ªãch ng∆∞·ª£c ƒë∆∞·ª£c
                });
                console.log("ƒê√£ gi·∫£i m√£ d·ªØ li·ªáu.");
            }

            // 3. ƒê·ªï d·ªØ li·ªáu v√†o Form
            document.getElementById('exam-id').value = name.replace('.js','');
            document.getElementById('exam-title').value = data.title || "";
            document.getElementById('exam-subject').value = data.subject || "Toan";
            document.getElementById('exam-grade').value = data.grade || "12";
            document.getElementById('exam-time').value = data.time || 45;
            document.getElementById('exam-pass-hash').value = data.password || "";
            document.getElementById('secure-mode').checked = data.encrypted;
            if(data.start) document.getElementById('exam-start').value = data.start;
            if(data.end) document.getElementById('exam-end').value = data.end;

            // 4. ƒê·ªï c√¢u h·ªèi v√†o Editor
            questions = data.questions || [];
            questions.forEach(q => { if(!q.imgQ) q.imgQ={}; if(!q.imgE) q.imgE={}; }); 
            renderEditor();

            // 5. Chuy·ªÉn giao di·ªán
            ov.style.display='none';
            switchTab('create'); 
            window.scrollTo({ top: 0, behavior: 'smooth' });

            if(data.encrypted && questions.some(q=>q.type==='short')) {
                alert("L∆ØU √ù: C√¢u 'Tr·∫£ l·ªùi ng·∫Øn' ƒë√£ b·ªã m√£ h√≥a. Th·∫ßy c·∫ßn nh·∫≠p l·∫°i ƒë√°p √°n m·ªõi cho c√°c c√¢u ƒë√≥.");
            }

        } catch(e) { 
            ov.style.display='none'; 
            alert("‚ùå L·ªói: " + e.message); 
        }
    }

    // --- EDITOR LOGIC ---
    function parseData(){
        let t=document.getElementById('json-input').value.trim();
        if(!t)return alert("Tr·ªëng!");
        let s=t.indexOf('['),e=t.lastIndexOf(']');
        if(s!==-1&&e>s)t=t.substring(s,e+1);
        try{
            let d=new Function("return "+t)();
            questions=Array.isArray(d)?d:(d.questions||[]);
            questions.forEach(q=>{q.id=Date.now()+Math.random();q.imgQ={};q.imgE={}});
            document.getElementById('editor-area').style.display='block';
            renderEditor();
        }catch(z){alert("L·ªói: "+z.message);}
    }
    
    function renderEditor(){
        let c=document.getElementById('questions-list');c.innerHTML="";
        questions.forEach((q,i)=>{
            let ansUI = "";
            if(q.type === 'mcq') {
                ansUI = `<div style="margin-top:5px; background:#e0f7fa; padding:5px; border-radius:4px">
                    <label>ƒê√°p √°n ƒë√∫ng:</label> 
                    <select id="ans-sel-${i}" onchange="updateAns(${i}, this.value)">
                        <option value="0" ${q.ans==0?'selected':''}>A</option>
                        <option value="1" ${q.ans==1?'selected':''}>B</option>
                        <option value="2" ${q.ans==2?'selected':''}>C</option>
                        <option value="3" ${q.ans==3?'selected':''}>D</option>
                    </select>
                </div>`;
            } else if (q.type === 'short') {
                ansUI = `<div style="margin-top:5px"><label>ƒê√°p √°n ƒë√∫ng:</label> <input type="text" value="${q.ans||''}" onchange="questions[${i}].ans = this.value" style="width:200px"></div>`;
            }

            c.insertAdjacentHTML('beforeend',`<div class="q-item"><div class="q-toolbar"><span style="font-weight:bold;color:#00695c">C√ÇU ${i+1}</span><button class="btn btn-red" style="padding:5px" onclick="removeQ(${i})">X√≥a</button></div><div class="q-body"><div class="column col-left"><div><label>C√¢u h·ªèi:</label>${tb(i,'q')}<textarea id="tq${i}" class="smart-textarea" oninput="upd(${i})" ondrop="drop(event,${i},'q')" ondragover="event.preventDefault()">${q.q}</textarea><div id="sq${i}" class="img-status"></div>${ansUI}</div><div style="margin-top:10px;border-top:1px dashed #ccc;padding-top:10px"><label>L·ªùi gi·∫£i:</label>${tb(i,'e')}<textarea id="te${i}" class="smart-textarea" oninput="upd(${i})" ondrop="drop(event,${i},'e')" ondragover="event.preventDefault()">${q.explain||''}</textarea><div id="se${i}" class="img-status"></div></div></div><div class="column col-right"><div class="preview-label">Xem tr∆∞·ªõc:</div><div class="preview-box" id="pq${i}"></div><div class="preview-label" style="margin-top:20px">L·ªùi gi·∫£i:</div><div class="preview-box" id="pe${i}" style="background:#e8f5e9"></div></div></div></div>`);upd(i);
        });
        document.getElementById('editor-area').style.display='block';
    }

    function updateAns(idx, val) { questions[idx].ans = parseInt(val); }

    function tb(i,f){return `<div class="mini-toolbar"><button class="tool-btn" onclick="tag(${i},'${f}','**','**')">B</button><button class="tool-btn" onclick="tag(${i},'${f}','$','$')">‚àë</button><label class="tool-btn">üì∑<input type="file" style="display:none" accept="image/*" onchange="fileSel(this,${i},'${f}')"></label></div>`;}
    function tag(i,f,s,e){let el=document.getElementById(`t${f}${i}`),v=el.value,st=el.selectionStart,en=el.selectionEnd;el.value=v.substring(0,st)+s+v.substring(st,en)+e+v.substring(en);upd(i);}
    function drop(e,i,f){e.preventDefault();if(e.dataTransfer.files[0])procImg(e.dataTransfer.files[0],i,f);}
    function fileSel(inp,i,f){if(inp.files[0])procImg(inp.files[0],i,f);}
    function procImg(fl,i,f){let q=questions[i],k=f==='q'?'imgQ':'imgE';q[k].f=fl;q[k].u=URL.createObjectURL(fl);let el=document.getElementById(`t${f}${i}`);if(!el.value.includes('[IMG]'))el.value+="\n[IMG]";document.getElementById(`s${f}${i}`).innerHTML=`<span class="img-badge">üñºÔ∏è ${fl.name}</span>`;upd(i);}
    function upd(i){let q=questions[i];q.q=document.getElementById(`tq${i}`).value;q.explain=document.getElementById(`te${i}`).value;let uQ=(q.imgQ&&q.imgQ.u)?q.imgQ.u:q.img,uE=(q.imgE&&q.imgE.u)?q.imgE.u:null;let hQ=rt(q.q,uQ);if(q.type==='mcq')hQ+=`<div style="margin-top:10px;color:#555">`+q.options.map((o,x)=>`<b>${String.fromCharCode(65+x)}.</b> ${o}`).join('<br>')+`</div>`;else if(q.type==='tf')hQ+=`<table style="width:100%;margin-top:5px">`+q.items.map((t,x)=>`<tr><td><b>${x+1})</b> ${t.sub}</td><td>${t.ans}</td></tr>`).join('')+`</table>`;else hQ+=`<div style="color:blue;font-weight:bold;margin-top:5px">ƒêS: ${q.ans}</div>`;document.getElementById(`pq${i}`).innerHTML=hQ;document.getElementById(`pe${i}`).innerHTML=rt(q.explain,uE);if(window.MathJax)MathJax.typesetPromise([document.getElementById(`pq${i}`),document.getElementById(`pe${i}`)]);}
    function rt(t,u){if(!t)return"";let h=t.replace(/\*\*(.*?)\*\*/g,'<b>$1</b>').replace(/\n/g,'<br>');if(u){let g=`<img src="${u}" class="preview-img">`;h=h.includes('[IMG]')?h.replace('[IMG]',g):h+`<br>${g}`;}return h.replace('[IMG]','');}
    function removeQ(i){if(confirm("X√≥a?")){questions.splice(i,1);renderEditor();}}

    // --- UPLOAD SYSTEM ---
    async function publishExam(){
        const u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value,t=document.getElementById('gh-token').value,id=document.getElementById('exam-id').value;
        if(!u||!r||!t||!id)return alert("Thi·∫øu info!"); if(!confirm("Xu·∫•t b·∫£n/C·∫≠p nh·∫≠t?"))return;
        const ov=document.getElementById('loading-overlay'),lb=document.getElementById('log-text');ov.style.display='flex';lb.innerHTML="‚è≥ ƒêang x·ª≠ l√Ω...";
        function log(m){lb.innerHTML+="\n"+m;lb.scrollTop=lb.scrollHeight;}
        try{
            saveConfig();
            for(let i=0;i<questions.length;i++){
                let q=questions[i];
                if(q.imgQ&&q.imgQ.f){log(`Up ·∫£nh ${i+1}...`);q.img=await upF(u,r,t,`images/${id}-q${i+1}-q-${Date.now()}.png`,q.imgQ.f,true);q.q=q.q.replace('[IMG]','');}
                if(q.imgE&&q.imgE.f){let l=await upF(u,r,t,`images/${id}-q${i+1}-e-${Date.now()}.png`,q.imgE.f,true);let g=`<div style="text-align:center"><img src="${l}" style="max-width:100%;border-radius:8px;margin:10px 0"></div>`;q.explain=q.explain.includes('[IMG]')?q.explain.replace('[IMG]',g):q.explain+g;}
                if(q.imgQ)delete q.imgQ;if(q.imgE)delete q.imgE;
            }
            let fQ=JSON.parse(JSON.stringify(questions));
            let sec=document.getElementById('secure-mode').checked;
            if(sec){log("M√£ h√≥a...");fQ.forEach(q=>{if(q.type==='mcq')q.ans=CryptoJS.MD5(String(q.ans)).toString();else if(q.type==='tf')q.items.forEach(x=>x.ans=CryptoJS.MD5(x.ans).toString());else q.ans=CryptoJS.MD5(String(q.ans).trim().toLowerCase()).toString();});}
            
            log("T·∫°o data...");
            let dt={
                title:document.getElementById('exam-title').value,
                subject:document.getElementById('exam-subject').value,
                grade:document.getElementById('exam-grade').value,
                time:parseInt(document.getElementById('exam-time').value),
                password:document.getElementById('exam-pass-hash').value,
                encrypted:sec,
                start: document.getElementById('exam-start').value,
                end: document.getElementById('exam-end').value,
                scores:{mcq:0.25,tf:1.0,short:0.5},
                questions:fQ
            };
            let c=btoa(unescape(encodeURIComponent(`window.EXAM_DATA = ${JSON.stringify(dt,null,4)};`)));
            await upF(u,r,t,`data/${id}.js`,c,false);
            log("Update list...");
            await updateList(u,r,t,id,dt);
            log("DONE!"); alert("ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng!"); setTimeout(()=>{ov.style.display='none'},2000);
        }catch(e){log("L·ªñI: "+e.message);setTimeout(()=>{ov.style.display='none'},5000);}
    }
    async function upF(u,r,t,p,c,isF){let s=null;try{let k=await fetch(`https://api.github.com/repos/${u}/${r}/contents/${p}`,{headers:{Authorization:`token ${t}`}});if(k.ok)s=(await k.json()).sha;}catch(e){}let b={message:"Up",content:isF?await toB64(c):c};if(s)b.sha=s;let rs=await fetch(`https://api.github.com/repos/${u}/${r}/contents/${p}`,{method:'PUT',headers:{Authorization:`token ${t}`,'Content-Type':'application/json'},body:JSON.stringify(b)});if(!rs.ok){let j=await rs.json();throw new Error(j.message);}return `https://raw.githubusercontent.com/${u}/${r}/main/${p}`;}
    function toB64(f){return new Promise(r=>{let fr=new FileReader();fr.onload=()=>r(fr.result.split(',')[1]);fr.readAsDataURL(f);});}
    async function updateList(u,r,t,id,d){let url=`https://api.github.com/repos/${u}/${r}/contents/data/list.js`,l=[],s=null;try{let k=await fetch(url,{headers:{Authorization:`token ${t}`}});if(k.ok){let j=await k.json();s=j.sha;l=new Function("return "+decodeURIComponent(escape(atob(j.content))).replace(/window\.EXAM_LIST\s*=\s*/,'').replace(/;$/,''))();}}catch(e){}l=l.filter(x=>x.id!==id);l.unshift({id:id,title:d.title,subject:d.subject,grade:d.grade,time:d.time});let c=btoa(unescape(encodeURIComponent(`window.EXAM_LIST = ${JSON.stringify(l,null,4)};`)));await upF(u,r,t,`data/list.js`,c,false);}
    
    // --- LOAD LIST & FILES ---
    async function loadDataFiles(){const u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value,t=document.getElementById('gh-token').value;if(!u||!r||!t)return alert("Thi·∫øu info!");document.getElementById('data-list').innerHTML='Loading...';try{const res=await fetch(`https://api.github.com/repos/${u}/${r}/contents/data`,{headers:{Authorization:`token ${t}`}});const f=await res.json();let h='';f.forEach(x=>{if(x.name.endsWith('.js')&&x.name!=='list.js')h+=`<div class="file-item"><span>üìÑ ${x.name}</span><div><button class="btn-edit" onclick="loadExamToEdit('${x.path}','${x.name}')">‚úèÔ∏è S·ª≠a</button><button class="btn btn-red" onclick="deleteDataFile('${x.path}','${x.sha}','${x.name}')">üóëÔ∏è</button></div></div>`});document.getElementById('data-list').innerHTML=h||'Tr·ªëng';}catch(e){alert(e.message);}}
    async function deleteDataFile(p,s,n){if(!confirm(`X√≥a ${n}?`))return;const u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value,t=document.getElementById('gh-token').value;await fetch(`https://api.github.com/repos/${u}/${r}/contents/${p}`,{method:'DELETE',headers:{Authorization:`token ${t}`,'Content-Type':'application/json'},body:JSON.stringify({message:`Del ${n}`,sha:s})});let id=n.replace('.js','');await removeFromList(u,r,t,id);alert("Xong!");loadDataFiles();}
    async function loadImagesFromGitHub(){const u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value,t=document.getElementById('gh-token').value;if(!u||!r||!t)return alert("Thi·∫øu info!");document.getElementById('img-loading').style.display='block';document.getElementById('image-gallery').innerHTML='';try{const res=await fetch(`https://api.github.com/repos/${u}/${r}/contents/images`,{headers:{Authorization:`token ${t}`}});const f=await res.json();document.getElementById('img-loading').style.display='none';let h='';f.forEach(x=>{if(x.name.match(/\.(png|jpg|jpeg|gif)$/i))h+=`<div class="img-card" id="c-${x.sha}"><a href="${x.download_url}" target="_blank"><img src="${x.download_url}" class="img-thumb"></a><div class="img-name">${x.name}</div><button class="btn-del-img" onclick="delImg('${x.path}','${x.sha}')">X√≥a</button></div>`});document.getElementById('image-gallery').innerHTML=h||'Tr·ªëng';}catch(e){alert(e.message);}}
    async function delImg(p,s){if(!confirm("X√≥a?"))return;const u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value,t=document.getElementById('gh-token').value;await fetch(`https://api.github.com/repos/${u}/${r}/contents/${p}`,{method:'DELETE',headers:{Authorization:`token ${t}`,'Content-Type':'application/json'},body:JSON.stringify({message:"Del img",sha:s})});document.getElementById(`c-${s}`).remove();}
</script>
</body>
</html>
