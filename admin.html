<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Tool v19.0 (File Manager)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* CSS CHU·∫®N */
        body{font-family:'Segoe UI',sans-serif;background:#eceff1;padding:20px;color:#37474f;margin:0}
        .btn{padding:8px 15px;border:none;border-radius:4px;cursor:pointer;font-weight:bold;color:white;font-size:0.9em}
        .btn-green{background:#2e7d32}.btn-blue{background:#1565c0}.btn-red{background:#c62828}.btn-gray{background:#607d8b}
        .btn:hover{opacity:0.9}
        
        /* C√ÅC N√öT THAO T√ÅC */
        .btn-edit{background:#ff9800;color:white;margin-right:5px}
        .btn-qr{background:#3f51b5;color:white;margin-right:5px}
        .btn-del{background:#d32f2f;color:white;} 

        input,select{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box}
        .config-box{background:#e3f2fd;padding:15px;border-radius:8px;margin-bottom:20px}
        .row{display:flex;gap:15px;margin-bottom:10px}.col{flex:1}
        label{font-weight:600;display:block;margin-bottom:3px}
        #login-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:#263238;z-index:9999;display:flex;justify-content:center;align-items:center}
        .login-box{background:white;padding:40px;border-radius:10px;width:350px;text-align:center}
        #main-app{display:none;max-width:1200px;margin:0 auto;background:white;padding:25px;border-radius:10px}
        
        /* TABS */
        .tab-bar{display:flex;gap:10px;margin-bottom:20px;border-bottom:2px solid #eee;padding-bottom:10px;overflow-x:auto}
        .tab-btn{padding:10px 20px;background:#f5f5f5;border:none;border-radius:6px;cursor:pointer;color:#666;font-weight:bold;white-space:nowrap}
        .tab-btn.active{background:#00796b;color:white}
        .section{display:none}.section.active{display:block}
        
        #loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;display:none;flex-direction:column;justify-content:center;align-items:center;color:white}
        .modal{display:none;position:fixed;z-index:10000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);align-items:center;justify-content:center}
        .modal-content{background-color:white;padding:20px;border-radius:10px;text-align:center}
        #qrcode{margin:20px auto;display:flex;justify-content:center}
        .file-item{display:flex;justify-content:space-between;padding:12px;background:#fafafa;border:1px solid #ddd;border-radius:6px;margin-bottom:8px;align-items:center}
        .ai-box{background:#f3e5f5;padding:15px;border-radius:8px;border:1px dashed #ab47bc;text-align:center;margin-bottom:20px}
        
        /* FILE MANAGER STYLES (NEW) */
        .fm-breadcrumb {padding:10px; background:#eee; margin-bottom:15px; border-radius:4px; font-weight:bold; display:flex; align-items:center;}
        .fm-item {display:flex; align-items:center; padding:10px; border-bottom:1px solid #eee; cursor:pointer;}
        .fm-item:hover {background:#f0f0f0;}
        .fm-icon {width:30px; text-align:center; margin-right:10px; font-size:1.2em;}
        .fm-name {flex:1; font-weight:500;}
        .fm-folder {color:#fbc02d;}
        .fm-file {color:#546e7a;}
        
        /* EDITOR STYLES */
        .q-item{border:1px solid #ddd; padding:15px; margin-bottom:15px; border-radius:8px; background:#fff;}
        .smart-textarea{width:100%; height:80px; border:1px solid #ccc; padding:5px; margin-top:5px;}
    </style>
</head>
<body>

<div id="loading-overlay"><div style="font-size:50px">üöÄ</div><h2 id="loading-title">ƒêANG X·ª¨ L√ù...</h2></div>

<div id="qr-modal" class="modal">
    <div class="modal-content">
        <h3 style="color:#3f51b5">M√É QR ƒê·ªÄ THI</h3>
        <p id="qr-link-text" style="font-size:0.8em;color:#666"></p>
        <div id="qrcode"></div>
        <button class="btn btn-red" onclick="document.getElementById('qr-modal').style.display='none'">ƒê√≥ng</button>
    </div>
</div>

<div id="login-screen">
    <div class="login-box">
        <h2 style="color:#00695c">ADMIN LOGIN</h2>
        <input type="password" id="admin-pass-input" onkeyup="if(event.key==='Enter')checkAdmin()">
        <button class="btn btn-green" onclick="checkAdmin()">ƒêƒÇNG NH·∫¨P</button>
        <p id="login-msg" style="color:red;display:none;margin-top:10px">Sai m·∫≠t kh·∫©u!</p>
    </div>
</div>

<div id="main-app">
    <h1>QU·∫¢N TR·ªä v19.0</h1>
    <div class="config-box">
        <div class="row">
            <div class="col"><label>User</label><input type="text" id="gh-user"></div>
            <div class="col"><label>Repo</label><input type="text" id="gh-repo"></div>
            <div class="col"><label>Token</label><input type="password" id="gh-token"></div>
        </div>
        <div class="row" style="margin-top:10px;border-top:1px dashed #999;padding-top:10px">
            <div class="col"><label>Ng√¢n h√†ng</label><input type="text" id="bank-id" placeholder="MB"></div>
            <div class="col"><label>S·ªë T√†i Kho·∫£n</label><input type="text" id="bank-acc"></div>
            <div class="col"><label>Gemini Key</label><input type="password" id="gemini-key"></div>
        </div>
        <div class="row" style="margin-top:10px"><button class="btn btn-gray" onclick="saveConfig()">üíæ L∆∞u C·∫•u H√¨nh</button></div>
    </div>

    <div class="tab-bar">
        <button id="tab-data" class="tab-btn active" onclick="switchTab('data')">üìÇ QU·∫¢N L√ù ƒê·ªÄ</button>
        <button id="tab-files" class="tab-btn" onclick="switchTab('files')">üóÇÔ∏è QU·∫¢N L√ù FILE (FULL)</button>
        <button id="tab-create" class="tab-btn" onclick="switchTab('create')">üìù SO·∫†N ƒê·ªÄ</button>
        <button id="tab-images" class="tab-btn" onclick="switchTab('images')">üì∑ KHO ·∫¢NH</button>
    </div>

    <div id="sec-data" class="section active">
        <div style="display:flex;justify-content:space-between;margin-bottom:20px"><h3>DANH S√ÅCH ƒê·ªÄ THI</h3><button class="btn btn-green" onclick="loadDataFiles()">üîÑ T·∫£i L·∫°i</button></div>
        <div id="data-list" class="file-list"></div>
    </div>

    <div id="sec-files" class="section">
        <div class="fm-breadcrumb">
            <button class="btn btn-gray" style="margin-right:10px" onclick="loadFileManager('')"><i class="fas fa-home"></i> G·ªëc</button>
            <span id="fm-current-path">/</span>
        </div>
        <div id="fm-list" style="background:white;border:1px solid #ddd;border-radius:6px"></div>
    </div>

    <div id="sec-create" class="section">
        <div class="ai-box">
            <h3 style="margin:0;color:#7b1fa2">‚ú® AI QU√âT ƒê·ªÄ</h3>
            <input type="file" id="ai-img-input" style="display:none" accept="image/*" onchange="processImageWithGemini(this)">
            <button class="btn" style="background:#9c27b0;color:white;margin-top:10px" onclick="document.getElementById('ai-img-input').click()">üì∏ Ch·ªçn ·∫£nh ƒë·ªÅ thi</button>
        </div>

        <div class="config-box" style="background:#fff3e0;border-color:#ffe0b2">
            <div class="row">
                <div class="col"><label>M√£ ƒê·ªÅ (ID)</label><input type="text" id="exam-id" placeholder="de-toan-hk1" style="font-weight:bold;color:#c62828"></div>
                <div class="col" style="flex:2"><label>Ti√™u ƒê·ªÅ</label><input type="text" id="exam-title"></div>
            </div>
            <div class="row">
                <div class="col"><label>Th·ªùi gian (ph√∫t)</label><input type="number" id="exam-time" value="45"></div>
                <div class="col"><label style="color:#d32f2f">üí∞ Gi√° b√°n (VNƒê)</label><input type="number" id="exam-price" placeholder="VD: 5000"></div>
                <div class="col"><label>M·∫≠t kh·∫©u</label><input type="text" id="exam-pass" oninput="hashPass()"><input type="hidden" id="exam-pass-hash"></div>
            </div>
            <div class="row">
                <div class="col"><label>M·ªü l√∫c</label><input type="datetime-local" id="exam-start"></div>
                <div class="col"><label>ƒê√≥ng l√∫c</label><input type="datetime-local" id="exam-end"></div>
            </div>
            <div class="row" style="margin-top:10px"><input type="checkbox" id="secure-mode" checked><label for="secure-mode" style="display:inline">M√£ h√≥a ƒë√°p √°n</label></div>
        </div>

        <textarea id="json-input" style="width:100%;height:80px;border:2px dashed #009688;padding:10px" placeholder="JSON..."></textarea>
        <button class="btn btn-blue" style="width:100%;margin-top:10px" onclick="parseData()">PH√ÇN T√çCH</button>
        <div id="editor-area" style="display:none;margin-top:20px"><div id="questions-list"></div><button class="btn btn-red" style="width:100%;margin-top:20px;padding:15px" onclick="publishExam()">üöÄ XU·∫§T B·∫¢N</button></div>
    </div>

    <div id="sec-images" class="section"><button class="btn btn-green" onclick="loadImagesFromGitHub()">T·∫£i ·∫£nh</button><div id="image-gallery" style="display:flex;flex-wrap:wrap;gap:10px;margin-top:15px"></div></div>
</div>

<script>
    const ADMIN_HASH = "55ab43ebd8eb2635766c3944cb192e72"; 
    function checkAdmin(){if(CryptoJS.MD5(document.getElementById('admin-pass-input').value).toString()===ADMIN_HASH){document.getElementById('login-screen').style.display='none';document.getElementById('main-app').style.display='block';sessionStorage.setItem('admin_ok','1');}else document.getElementById('login-msg').style.display='block';}
    if(sessionStorage.getItem('admin_ok')) checkAdmin();

    function switchTab(t){
        document.querySelectorAll('.section').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
        document.getElementById('sec-'+t).classList.add('active');
        const btn = document.getElementById('tab-'+t); if(btn) btn.classList.add('active');
        
        // Auto load tab File Manager
        if(t === 'files') loadFileManager('');
    }
    
    window.onload=()=>{ ['gh-user','gh-repo','gh-token','gemini-key','bank-id','bank-acc'].forEach(id=>{if(localStorage.getItem(id))document.getElementById(id).value=localStorage.getItem(id)}); }
    function saveConfig(){ ['gh-user','gh-repo','gh-token','gemini-key','bank-id','bank-acc'].forEach(id=>localStorage.setItem(id,document.getElementById(id).value.trim())); alert("ƒê√£ l∆∞u!"); }
    function hashPass(){let p=document.getElementById('exam-pass').value.trim();document.getElementById('exam-pass-hash').value=p?CryptoJS.MD5(p).toString():"";}

    // ==========================================
    // T√çNH NƒÇNG QU·∫¢N L√ù FILE (M·ªöI v19.0)
    // ==========================================
    let currentPath = "";

    async function loadFileManager(path) {
        currentPath = path;
        document.getElementById('fm-current-path').innerText = path || " (Th∆∞ m·ª•c g·ªëc)";
        const u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value,t=document.getElementById('gh-token').value;
        const ov=document.getElementById('loading-overlay'); ov.style.display='flex';

        try {
            const res = await fetch(`https://api.github.com/repos/${u}/${r}/contents/${path}`, {headers: {Authorization: `token ${t}`}});
            if(!res.ok) throw new Error("L·ªói t·∫£i th∆∞ m·ª•c!");
            const items = await res.json();
            
            // S·∫Øp x·∫øp: Folder tr∆∞·ªõc, File sau
            items.sort((a, b) => (a.type === b.type ? 0 : a.type === 'dir' ? -1 : 1));

            let html = '';
            if(path !== "") { // N√∫t quay l·∫°i
                let parent = path.split('/').slice(0,-1).join('/');
                html += `<div class="fm-item" onclick="loadFileManager('${parent}')"><div class="fm-icon fm-folder"><i class="fas fa-level-up-alt"></i></div><div class="fm-name">.. (Quay l·∫°i)</div></div>`;
            }

            items.forEach(item => {
                let icon = item.type === 'dir' ? '<i class="fas fa-folder"></i>' : '<i class="fas fa-file-alt"></i>';
                let cls = item.type === 'dir' ? 'fm-folder' : 'fm-file';
                let action = item.type === 'dir' ? `onclick="loadFileManager('${item.path}')"` : '';
                let delBtn = `<button class="btn btn-del" style="padding:2px 8px;font-size:0.8em" onclick="event.stopPropagation();deleteFileGeneric('${item.path}', '${item.name}', true)">X√≥a</button>`;
                
                html += `<div class="fm-item" ${action}>
                            <div class="fm-icon ${cls}">${icon}</div>
                            <div class="fm-name">${item.name}</div>
                            <div>${delBtn}</div>
                         </div>`;
            });
            document.getElementById('fm-list').innerHTML = html;
        } catch(e) { alert("L·ªói: " + e.message); } finally { ov.style.display='none'; }
    }

    // H√ÄM X√ìA CHUNG (D√πng cho c·∫£ 2 tab)
    async function deleteFileGeneric(path, name, isFileManager) {
        if(!confirm(`‚ö†Ô∏è C·∫¢NH B√ÅO:\nX√≥a vƒ©nh vi·ªÖn "${name}"?\nKh√¥ng th·ªÉ ph·ª•c h·ªìi!`)) return;
        const u=document.getElementById('gh-user').value, r=document.getElementById('gh-repo').value, t=document.getElementById('gh-token').value;
        const ov=document.getElementById('loading-overlay'); ov.style.display='flex';

        try {
            const res = await fetch(`https://api.github.com/repos/${u}/${r}/contents/${path}`, {headers: {Authorization: `token ${t}`}});
            if(!res.ok) throw new Error("Kh√¥ng t√¨m th·∫•y file!");
            const data = await res.json();
            
            const del = await fetch(`https://api.github.com/repos/${u}/${r}/contents/${path}`, {
                method: 'DELETE',
                headers: { Authorization: `token ${t}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: `Delete ${name}`, sha: data.sha })
            });

            if(del.ok) { 
                alert("ƒê√£ x√≥a!"); 
                if(isFileManager) loadFileManager(currentPath); // Reload tab File
                else loadDataFiles(); // Reload tab Data
            } else throw new Error("L·ªói x√≥a file!");
        } catch(e) { alert("L·ªói: " + e.message); } finally { ov.style.display='none'; }
    }

    // ==========================================
    // C√ÅC T√çNH NƒÇNG C≈® (GI·ªÆ NGUY√äN)
    // ==========================================
    async function loadDataFiles(){
        const u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value,t=document.getElementById('gh-token').value;
        if(!u)return alert("Thi·∫øu Config!");
        try{
            const res=await fetch(`https://api.github.com/repos/${u}/${r}/contents/data`,{headers:{Authorization:`token ${t}`}});
            const f=await res.json();
            let h='';
            f.forEach(x=>{
                if(x.name.endsWith('.js')&&x.name!=='list.js') {
                    h+=`<div class="file-item">
                            <span style="font-weight:500">${x.name}</span>
                            <div>
                                <button class="btn btn-qr" onclick="showExamQR('${x.name}')"><i class="fas fa-qrcode"></i> QR</button>
                                <button class="btn btn-edit" onclick="loadExamToEdit('${x.path}','${x.name}')">S·ª≠a</button>
                                <button class="btn btn-del" onclick="deleteFileGeneric('${x.path}','${x.name}', false)">X√≥a</button>
                            </div>
                        </div>`;
                }
            });
            document.getElementById('data-list').innerHTML=h;
        }catch(e){alert(e.message);}
    }

    async function processImageWithGemini(input) {
        const file=input.files[0], key=document.getElementById('gemini-key').value;
        if(!file||!key)return alert("Thi·∫øu Key ho·∫∑c File!");
        const ov=document.getElementById('loading-overlay'); ov.style.display='flex';
        try {
            const base64 = await new Promise(r => { let fr=new FileReader(); fr.onload=()=>r(fr.result.split(',')[1]); fr.readAsDataURL(file); });
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({contents:[{parts:[{text:"Tr√≠ch xu·∫•t ƒë·ªÅ thi t·ª´ ·∫£nh th√†nh JSON (type: mcq, tf, match, short). Ch·ªâ tr·∫£ v·ªÅ JSON thu·∫ßn."}, {inline_data:{mime_type:file.type, data:base64}}]}]})
            });
            const d=await res.json();
            document.getElementById('json-input').value = d.candidates[0].content.parts[0].text.replace(/```json/g,'').replace(/```/g,'').trim();
            parseData();
        } catch(e){alert("L·ªói AI: "+e.message);} finally{ov.style.display='none'; input.value='';}
    }

    async function loadExamToEdit(path, name) {
        const u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value,t=document.getElementById('gh-token').value;
        const ov=document.getElementById('loading-overlay'); ov.style.display='flex';
        try{
            const res=await fetch(`https://api.github.com/repos/${u}/${r}/contents/${path}`,{headers:{Authorization:`token ${t}`}});
            if(!res.ok) throw new Error("Kh√¥ng t√¨m th·∫•y file!");
            const json=await res.json(), content=decodeURIComponent(escape(atob(json.content)));
            let dataStr = content.substring(content.indexOf('{'), content.lastIndexOf('}')+1);
            let data=JSON.parse(dataStr);
            
            document.getElementById('exam-id').value=name.replace('.js','');
            document.getElementById('exam-title').value=data.title||"";
            document.getElementById('exam-time').value=data.time||45;
            document.getElementById('exam-price').value=data.price||0;
            document.getElementById('exam-pass-hash').value=data.password||"";
            document.getElementById('secure-mode').checked=data.encrypted;
            if(data.start)document.getElementById('exam-start').value=data.start;
            if(data.end)document.getElementById('exam-end').value=data.end;
            questions=data.questions||[]; renderEditor(); 
            ov.style.display='none'; switchTab('create');
        }catch(e){ alert("L·ªói t·∫£i ƒë·ªÅ: "+e.message); ov.style.display='none'; }
    }

    let questions = [];
    function parseData(){
        try { let t = document.getElementById('json-input').value; let d = new Function("return " + t)(); questions = Array.isArray(d) ? d : (d.questions || []); renderEditor(); } catch(e) { alert("L·ªói JSON!"); }
    }

    function renderEditor(){
        let c=document.getElementById('questions-list');c.innerHTML="";
        questions.forEach((q,i)=>{
            let ansUI = "";
            if(q.type === 'mcq') ansUI = `<div><b>ƒê√°p √°n (0-3):</b> <input type="number" value="${q.ans}" onchange="questions[${i}].ans=this.value" style="width:50px"></div>`;
            else if (q.type === 'match') ansUI = `<div><b>Gh√©p c·ªôt:</b><br>${q.items.map((it,idx)=>`√ù ${idx+1}: <input value="${q.ans[idx]}" onchange="questions[${i}].ans[${idx}]=this.value" style="width:40px">`).join(' | ')}</div>`;
            else if (q.type === 'tf') ansUI = `<div><b>ƒê√∫ng(T)/Sai(F):</b><br>${q.items.map((it,idx)=>`√ù ${idx+1}: <input value="${it.ans}" onchange="questions[${i}].items[${idx}].ans=this.value" style="width:40px">`).join(' | ')}</div>`;
            else ansUI = `<div><b>ƒê√°p √°n:</b> <input type="text" value="${q.ans}" onchange="questions[${i}].ans=this.value"></div>`;

            c.insertAdjacentHTML('beforeend',`<div class="q-item">
                <div style="font-weight:bold;color:#009688">C√ÇU ${i+1} (${q.type}) <button onclick="questions.splice(${i},1);renderEditor()" style="float:right;background:red;color:white;border:none">X√≥a</button></div>
                <textarea class="smart-textarea" onchange="questions[${i}].q=this.value">${q.q}</textarea>
                ${ansUI}
                <textarea class="smart-textarea" placeholder="L·ªùi gi·∫£i..." onchange="questions[${i}].explain=this.value">${q.explain||''}</textarea>
            </div>`);
        });
        document.getElementById('editor-area').style.display='block';
    }

    async function publishExam(){
        const u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value,t=document.getElementById('gh-token').value,id=document.getElementById('exam-id').value;
        if(!u||!r||!t||!id)return alert("Thi·∫øu info!");
        const bankInfo = {id: document.getElementById('bank-id').value, acc: document.getElementById('bank-acc').value};
        const price = parseInt(document.getElementById('exam-price').value) || 0;
        const ov=document.getElementById('loading-overlay');ov.style.display='flex';
        try{
            let fQ=JSON.parse(JSON.stringify(questions));
            let sec=document.getElementById('secure-mode').checked;
            if(sec){
                fQ.forEach(q=>{
                    if(q.type==='mcq') q.ans=CryptoJS.MD5(String(q.ans)).toString();
                    else if(q.type==='tf') q.items.forEach(x=>x.ans=CryptoJS.MD5(String(x.ans).trim()).toString());
                    else if(q.type==='short') q.ans=CryptoJS.MD5(String(q.ans).trim().toLowerCase().replace(',','.')).toString();
                    else if(q.type==='match') q.ans=q.ans.map(v=>CryptoJS.MD5(String(v).trim()).toString());
                });
            }
            let dt={
                title:document.getElementById('exam-title').value,
                time:parseInt(document.getElementById('exam-time').value),
                password:document.getElementById('exam-pass-hash').value,
                encrypted:sec,
                start:document.getElementById('exam-start').value,
                end:document.getElementById('exam-end').value,
                price: price, bank: bankInfo,
                scores:{mcq:0.25,tf:1.0,short:0.5,match:1.0},
                questions:fQ
            };
            let c=btoa(unescape(encodeURIComponent(`window.EXAM_DATA = ${JSON.stringify(dt,null,4)};`)));
            await upF(u,r,t,`data/${id}.js`,c,false);
            await updateList(u,r,t,id,dt);
            alert("ƒê√£ c·∫≠p nh·∫≠t ƒë·ªÅ thi th√†nh c√¥ng!"); ov.style.display='none'; loadDataFiles();
        }catch(e){alert(e.message); ov.style.display='none';}
    }

    async function upF(u,r,t,p,c,isF){let s=null;try{let k=await fetch(`https://api.github.com/repos/${u}/${r}/contents/${p}`,{headers:{Authorization:`token ${t}`}});if(k.ok)s=(await k.json()).sha;}catch(e){}let b={message:"Up",content:isF?await toB64(c):c};if(s)b.sha=s;let rs=await fetch(`https://api.github.com/repos/${u}/${r}/contents/${p}`,{method:'PUT',headers:{Authorization:`token ${t}`,'Content-Type':'application/json'},body:JSON.stringify(b)});if(!rs.ok){let j=await rs.json();throw new Error(j.message);}}
    function toB64(f){return new Promise(r=>{let fr=new FileReader();fr.onload=()=>r(fr.result.split(',')[1]);fr.readAsDataURL(f);});}
    async function updateList(u,r,t,id,d){let url=`https://api.github.com/repos/${u}/${r}/contents/data/list.js`,l=[],s=null;try{let k=await fetch(url,{headers:{Authorization:`token ${t}`}});if(k.ok){let j=await k.json();s=j.sha;l=new Function("return "+decodeURIComponent(escape(atob(j.content))).replace(/window\.EXAM_LIST\s*=\s*/,'').replace(/;$/,''))();}}catch(e){}l=l.filter(x=>x.id!==id);l.unshift({id:id,title:d.title,subject:d.subject,grade:d.grade,time:d.time});let c=btoa(unescape(encodeURIComponent(`window.EXAM_LIST = ${JSON.stringify(l,null,4)};`)));await upF(u,r,t,`data/list.js`,c,false);}
    
    function showExamQR(n){let u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value;let url=`https://${u}.github.io/${r}/thi.html?id=${n.replace('.js','')}`;document.getElementById('qr-modal').style.display='flex';document.getElementById('qr-link-text').innerText=url;document.getElementById('qrcode').innerHTML="";new QRCode(document.getElementById("qrcode"),{text:url,width:200,height:200});}
    async function loadImagesFromGitHub(){const u=document.getElementById('gh-user').value,r=document.getElementById('gh-repo').value,t=document.getElementById('gh-token').value;if(!u)return;try{const res=await fetch(`https://api.github.com/repos/${u}/${r}/contents/images`,{headers:{Authorization:`token ${t}`}});const f=await res.json();let h='';f.forEach(x=>{if(x.name.match(/\.(png|jpg)$/i))h+=`<div style="border:1px solid #ddd;padding:5px"><img src="${x.download_url}" style="height:100px"><br><small>${x.name}</small></div>`});document.getElementById('image-gallery').innerHTML=h;}catch(e){}}
</script>
</body>
</html>
