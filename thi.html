<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L√†m B√†i Thi</title>
    <script>
        window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }, svg: { fontCache: 'global' } };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 0; }
        .loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 10000; display: flex; justify-content: center; align-items: center; font-size: 18px; color: #009688; }
        
        /* M√ÄN H√åNH CH·ªú */
        .welcome-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #009688 0%, #004d40 100%); z-index: 9999; display: flex; justify-content: center; align-items: center; padding: 20px; display: none; }
        .welcome-card { background: white; width: 100%; max-width: 500px; padding: 40px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .welcome-card h1 { color: #00796b; margin: 0 0 10px 0; }
        .input-group { margin: 20px 0; text-align: left; }
        .input-group label { display: block; font-weight: bold; margin-bottom: 5px; }
        .input-group input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-start { background: #d81b60; color: white; border: none; padding: 15px 40px; border-radius: 50px; font-weight: bold; cursor: pointer; width: 100%; font-size: 18px; transition: 0.3s; }
        
        /* GIAO DI·ªÜN CH√çNH */
        #main-interface { display: none; padding: 20px; max-width: 800px; margin: 0 auto; padding-bottom: 60px; }
        .header-bar { background: white; padding: 15px 20px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 10px; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-left: 5px solid #009688; margin-bottom: 20px; }
        .timer { font-size: 24px; color: #c62828; font-weight: bold; font-family: monospace; }
        
        /* TI√äU ƒê·ªÄ PH·∫¶N */
        .part-header { background: #e0f2f1; color: #00695c; padding: 10px 20px; margin: 30px 0 20px 0; font-weight: bold; border-radius: 5px; border: 1px solid #004d40; text-transform: uppercase; }

        .question-block { background: white; padding: 25px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .question-title { font-weight: bold; color: #333; margin-bottom: 15px; font-size: 1.1em; }
        .question-image img { max-width: 100%; border: 1px solid #ddd; border-radius: 5px; margin: 10px 0; }
        
        .options label { display: block; padding: 10px; cursor: pointer; border-radius: 5px; transition: 0.2s; border: 1px solid transparent; }
        .options label:hover { background: #e0f2f1; border-color: #80cbc4; }
        
        .tf-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .tf-table th, .tf-table td { border: 1px solid #eee; padding: 10px; text-align: center; }
        .tf-table th { background: #fafafa; text-align: left; }
        
        .short-input { padding: 10px; border: 2px solid #b0bec5; border-radius: 5px; width: 200px; font-weight: bold; }

        .btn-submit { background: #1976d2; color: white; padding: 15px; width: 100%; border: none; border-radius: 10px; font-size: 20px; font-weight: bold; cursor: pointer; margin-top: 20px; box-shadow: 0 5px 15px rgba(25, 118, 210, 0.3); }
        
        /* K·∫æT QU·∫¢ */
        .result-box { display: none; background: #e8f5e9; padding: 30px; text-align: center; border-radius: 15px; margin-top: 20px; border: 3px solid #4caf50; }
        .correct-ans { color: #2e7d32; font-weight: bold; background: #c8e6c9; padding: 5px 10px; display: inline-block; margin-top: 8px; border-radius: 5px; }
        .wrong-ans { color: #c62828; text-decoration: line-through; opacity: 0.7; }
        .feedback { background: #fff8e1; padding: 15px; margin-top: 15px; border-radius: 5px; border-left: 5px solid #ffca28; display: none; text-align: left; }
        .show-feedback .feedback { display: block; }
    </style>
</head>
<body>

<div class="loading" id="loading">ƒêang t·∫£i d·ªØ li·ªáu ƒë·ªÅ thi...</div>

<div class="welcome-overlay" id="welcome-screen">
    <div class="welcome-card">
        <h1 id="exam-title">B√ÄI KI·ªÇM TRA</h1>
        <p id="exam-desc">ƒêang t·∫£i...</p>
        <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">
        <div class="input-group"><label>H·ªç v√† T√™n (*)</label><input type="text" id="s-name" placeholder="Nh·∫≠p t√™n..."></div>
        <div class="input-group"><label>L·ªõp (*)</label><input type="text" id="s-class" placeholder="Nh·∫≠p l·ªõp..."></div>
        <button class="btn-start" onclick="startQuiz()">B·∫ÆT ƒê·∫¶U L√ÄM B√ÄI</button>
    </div>
</div>

<div id="main-interface">
    <div class="header-bar">
        <div><strong id="d-name">...</strong> | <span id="d-class">...</span></div>
        <div class="timer" id="timer">00:00</div>
    </div>
    
    <div id="result-area" class="result-box">
        <h2 style="color:#2e7d32; margin:0">K·∫æT QU·∫¢: <span id="final-score"></span></h2>
        <div id="status-msg" style="margin-top:10px; font-weight:bold; color:#555"></div>
        <p>K√©o xu·ªëng d∆∞·ªõi ƒë·ªÉ xem chi ti·∫øt.</p>
    </div>

    <div id="quiz-body"></div>
    <button class="btn-submit" onclick="preSubmit()" id="btn-submit">N·ªòP B√ÄI</button>
</div>

<script>
    // ============================================================
    // üëáüëáüëá D√ÅN LINK GOOGLE SCRIPT C·ª¶A B·∫†N V√ÄO ƒê√ÇY üëáüëáüëá
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw9AvPfuJ53SMG-AIdP9SBL6LThFM-r8DRphGwSqRutArucIK5jxf4BxzTHY2SIBJE/exec'; 
    // ============================================================

    let rawQuestions = [];      // D·ªØ li·ªáu g·ªëc t·ª´ file JS
    let currentQuestions = [];  // D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c ph√¢n lo·∫°i v√† x√°o tr·ªôn
    let timerDuration = 0;
    let timerInterval;

    // --- 1. T·∫¢I D·ªÆ LI·ªÜU ---
    const urlParams = new URLSearchParams(window.location.search);
    const examId = urlParams.get('id');

    if(examId) {
        const script = document.createElement('script');
        script.src = `data/${examId}.js`;
        script.onload = () => {
            if(window.EXAM_DATA) {
                rawQuestions = window.EXAM_DATA.questions;
                timerDuration = window.EXAM_DATA.time * 60;
                document.getElementById('exam-title').innerText = window.EXAM_DATA.title;
                document.getElementById('exam-desc').innerText = window.EXAM_DATA.description;
                
                // G·ªåI H√ÄM TR·ªòN ƒê·ªÄ TH√îNG MINH
                prepareQuestions();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('welcome-screen').style.display = 'flex';
            }
        };
        script.onerror = () => { document.getElementById('loading').innerText = "Kh√¥ng t√¨m th·∫•y ƒë·ªÅ thi!"; };
        document.head.appendChild(script);
    } else {
        document.getElementById('loading').innerText = "Ch∆∞a ch·ªçn m√£ ƒë·ªÅ thi.";
    }

    // --- 2. THU·∫¨T TO√ÅN TR·ªòN (FISHER-YATES SHUFFLE) ---
    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // --- 3. X·ª¨ L√ù TR·ªòN THEO PH·∫¶N ---
    function prepareQuestions() {
        // Sao ch√©p s√¢u ƒë·ªÉ kh√¥ng ·∫£nh h∆∞·ªüng d·ªØ li·ªáu g·ªëc
        let allQ = JSON.parse(JSON.stringify(rawQuestions));

        // B∆Ø·ªöC 1: T√ÅCH RI√äNG 3 PH·∫¶N
        let part1 = allQ.filter(q => q.type === 'mcq');
        let part2 = allQ.filter(q => q.type === 'tf');
        let part3 = allQ.filter(q => q.type === 'short');

        // B∆Ø·ªöC 2: TR·ªòN C√ÇU H·ªéI TRONG T·ª™NG PH·∫¶N
        shuffle(part1);
        shuffle(part2);
        shuffle(part3);

        // B∆Ø·ªöC 3: TR·ªòN ƒê√ÅP √ÅN B√äN TRONG (CHI TI·∫æT)
        
        // >> TR·ªòN PART 1 (MCQ): Tr·ªôn A,B,C,D
        part1.forEach(q => {
            // T·∫°o m·∫£ng ch·ªâ s·ªë [0, 1, 2, 3] t∆∞∆°ng ·ª©ng v·ªõi c√°c ƒë√°p √°n g·ªëc
            let indices = q.options.map((_, i) => i);
            shuffle(indices); // Tr·ªôn ch·ªâ s·ªë, VD th√†nh [2, 0, 3, 1]
            q.shuffledIndices = indices; // L∆∞u l·∫°i th·ª© t·ª± n√†y ƒë·ªÉ hi·ªÉn th·ªã v√† ch·∫•m ƒëi·ªÉm
        });

        // >> TR·ªòN PART 2 (TF): Tr·ªôn c√°c √Ω a,b,c,d
        part2.forEach(q => {
            shuffle(q.items); // Tr·ªôn tr·ª±c ti·∫øp m·∫£ng items
        });

        // >> PART 3 (SHORT): Kh√¥ng c·∫ßn tr·ªôn ƒë√°p √°n, ch·ªâ tr·ªôn c√¢u h·ªèi ·ªü b∆∞·ªõc 2 l√† ƒë·ªß.

        // B∆Ø·ªöC 4: G·ªòP L·∫†I TH√ÄNH M·∫¢NG CHUNG ƒê·ªÇ HI·ªÇN TH·ªä
        // Ta g√°n nh√£n 'partName' ƒë·ªÉ bi·∫øt khi n√†o c·∫ßn hi·ªán ti√™u ƒë·ªÅ ph·∫ßn
        if(part1.length > 0) part1[0].isPartHeader = "PH·∫¶N 1. Tr·∫Øc nghi·ªám 4 ph∆∞∆°ng √°n";
        if(part2.length > 0) part2[0].isPartHeader = "PH·∫¶N 2. Tr·∫Øc nghi·ªám ƒê√∫ng/Sai";
        if(part3.length > 0) part3[0].isPartHeader = "PH·∫¶N 3. Tr·∫£ l·ªùi ng·∫Øn";

        currentQuestions = [...part1, ...part2, ...part3];
        
        renderQuestions();
    }

    // --- 4. HI·ªÇN TH·ªä C√ÇU H·ªéI ---
    function renderQuestions() {
        let html = '';
        currentQuestions.forEach((q, idx) => {
            // Hi·ªÉn th·ªã ti√™u ƒë·ªÅ ph·∫ßn (n·∫øu c√≥)
            if(q.isPartHeader) {
                html += `<div class="part-header">${q.isPartHeader}</div>`;
            }

            html += `<div class="question-block" id="q-${idx}">`;
            
            // X·ª≠ l√Ω ti√™u ƒë·ªÅ c√¢u h·ªèi (c·∫Øt b·ªè ph·∫ßn "C√¢u 1:" c≈© n·∫øu c√≥ ƒë·ªÉ t·ª± ƒë√°nh s·ªë m·ªõi)
            let content = q.q.includes(':') ? q.q.substring(q.q.indexOf(':') + 1) : q.q;
            html += `<div class="question-title">C√¢u ${idx+1}: ${content}</div>`;
            
            if(q.img) html += `<div class="question-image"><img src="${q.img}"></div>`;

            // D·∫†NG 1: MCQ (ƒê√£ tr·ªôn th·ª© t·ª± A,B,C,D)
            if(q.type === 'mcq') {
                html += `<div class="options">`;
                // Duy·ªát theo th·ª© t·ª± ƒë√£ tr·ªôn (shuffledIndices)
                q.shuffledIndices.forEach(originalIndex => {
                    // originalIndex l√† ch·ªâ s·ªë g·ªëc trong file data
                    // value c·ªßa input v·∫´n l√† originalIndex ƒë·ªÉ d·ªÖ ch·∫•m ƒëi·ªÉm
                    html += `<label><input type="radio" name="q${idx}" value="${originalIndex}"> ${q.options[originalIndex]}</label>`;
                });
                html += `</div>`;
                html += `<div class="feedback">ƒê√°p √°n: ${q.options[q.ans]}<br><i>${q.explain}</i></div>`;
            } 
            // D·∫†NG 2: TF (ƒê√£ tr·ªôn th·ª© t·ª± √Ω a,b,c,d)
            else if(q.type === 'tf') {
                html += `<table class="tf-table"><tr><th>M·ªánh ƒë·ªÅ</th><th>ƒê</th><th>S</th></tr>`;
                // q.items ƒë√£ ƒë∆∞·ª£c tr·ªôn ·ªü b∆∞·ªõc prepareQuestions
                q.items.forEach((it, sIdx) => {
                    html += `<tr><td>${it.sub}</td>
                    <td><input type="radio" name="q${idx}_${sIdx}" value="T"></td>
                    <td><input type="radio" name="q${idx}_${sIdx}" value="F"></td></tr>`;
                });
                html += `</table><div class="feedback">Gi·∫£i th√≠ch: ${q.explain}</div>`;
            }
            // D·∫†NG 3: SHORT
            else if(q.type === 'short') {
                html += `<input type="text" class="short-input" id="in-${idx}" placeholder="Nh·∫≠p ƒë√°p √°n..."><div class="feedback">ƒê√°p √°n: ${q.ans}<br><i>${q.explain}</i></div>`;
            }
            html += `</div>`;
        });
        document.getElementById('quiz-body').innerHTML = html;
        if(window.MathJax) MathJax.typesetPromise();
    }

    // --- 5. C√ÅC H√ÄM TI·ªÜN √çCH KH√ÅC ---
    function startQuiz() {
        const name = document.getElementById('s-name').value;
        const cls = document.getElementById('s-class').value;
        if(!name || !cls) { alert("Vui l√≤ng nh·∫≠p t√™n v√† l·ªõp!"); return; }
        
        document.getElementById('d-name').innerText = name;
        document.getElementById('d-class').innerText = cls;
        document.getElementById('welcome-screen').style.display = 'none';
        document.getElementById('main-interface').style.display = 'block';

        const timerDisplay = document.getElementById('timer');
        timerInterval = setInterval(() => {
            let m = Math.floor(timerDuration/60), s = timerDuration%60;
            timerDisplay.innerText = `${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
            if(--timerDuration < 0) { clearInterval(timerInterval); submitQuiz(); }
        }, 1000);
    }

    function preSubmit() {
        if(confirm("Em c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i kh√¥ng?")) submitQuiz();
    }

    function submitQuiz() {
        clearInterval(timerInterval);
        document.getElementById('btn-submit').style.display = 'none';
        
        let score = 0, total = 0;
        
        // Duy·ªát qua m·∫£ng c√¢u h·ªèi hi·ªán t·∫°i (ƒë√£ tr·ªôn) ƒë·ªÉ ch·∫•m
        currentQuestions.forEach((q, idx) => {
            const block = document.getElementById(`q-${idx}`);
            block.classList.add('show-feedback');
            
            if(q.type === 'mcq') {
                total++;
                const sel = document.querySelector(`input[name="q${idx}"]:checked`);
                // So s√°nh gi√° tr·ªã (ch·ªâ s·ªë g·ªëc) v·ªõi ƒë√°p √°n g·ªëc
                if(sel && parseInt(sel.value) === q.ans) {
                    score++; block.innerHTML += `<div class="correct-ans">ƒê√∫ng (+1ƒë)</div>`;
                } else {
                    block.innerHTML += `<div class="wrong-ans">Sai</div>`;
                }
            } 
            else if(q.type === 'tf') {
                // V·ªõi d·∫°ng TF, items ƒë√£ b·ªã tr·ªôn, nh∆∞ng logic ch·∫•m v·∫´n duy·ªát qua t·ª´ng item ƒëang hi·ªÉn th·ªã
                q.items.forEach((it, sIdx) => {
                    total += 0.25;
                    const sel = document.querySelector(`input[name="q${idx}_${sIdx}"]:checked`);
                    // So s√°nh value ƒë√£ ch·ªçn v·ªõi it.ans (ƒë√°p √°n c·ªßa item ƒë√≥)
                    if(sel && sel.value === it.ans) score += 0.25;
                });
            }
            else if(q.type === 'short') {
                total++;
                const val = document.getElementById(`in-${idx}`).value.trim().replace(',', '.');
                if(val == q.ans.replace(',', '.')) {
                    score++; block.innerHTML += `<div class="correct-ans">ƒê√∫ng (+1ƒë)</div>`;
                } else {
                    block.innerHTML += `<div class="wrong-ans">Sai</div>`;
                }
            }
        });

        document.getElementById('result-area').style.display = 'block';
        document.getElementById('final-score').innerText = `${score} / ${total}`;
        window.scrollTo(0,0);

        // G·ª≠i ƒëi·ªÉm
        if(GOOGLE_SCRIPT_URL) {
            const sName = document.getElementById('s-name').value;
            const sClass = document.getElementById('s-class').value;
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST', mode: 'no-cors',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name: sName, class: sClass, score: score + "/" + total, exam: window.EXAM_DATA.title })
            }).then(() => {
                document.getElementById('status-msg').innerText = "ƒê√£ l∆∞u k·∫øt qu·∫£ v√†o h·ªá th·ªëng.";
                document.getElementById('status-msg').style.color = "green";
            }).catch(() => {
                document.getElementById('status-msg').innerText = "L·ªói g·ª≠i ƒëi·ªÉm. H√£y ch·ª•p m√†n h√¨nh!";
            });
        }
    }
</script>
</body>
</html>
