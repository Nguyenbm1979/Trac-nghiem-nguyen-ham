<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hệ Thống Thi Trực Tuyến</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }, svg: { fontCache: 'global' } };</script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* CSS CHUNG */
        body{font-family:'Roboto',sans-serif;background:#f4f7f6;margin:0;color:#333;padding-bottom:100px;user-select:none}
        
        /* GIAO DIỆN THI (MẶC ĐỊNH) */
        .status-bar{background:white;padding:10px 20px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1000;box-shadow:0 2px 5px rgba(0,0,0,0.05);border-bottom:1px solid #eee}
        .timer-box{background:#ffebee;color:#c62828;padding:5px 12px;border-radius:20px;font-weight:700;font-family:monospace;font-size:1.2em}
        .student-box{font-weight:600;color:#1565c0}
        .container{max-width:900px;margin:0 auto;padding:15px}
        .question-block{background:white;padding:25px;border-radius:12px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.03);border-left:5px solid #1a237e}
        .option-item{display:flex;align-items:center;background:#fafafa;border:1px solid #eee;padding:12px 15px;border-radius:8px;cursor:pointer;margin-bottom:8px;transition:0.2s}
        .option-item:hover{background:#e8eaf6;border-color:#c5cae9}
        .option-item:has(input:checked){background:#e3f2fd;border-color:#2196f3;color:#0d47a1;font-weight:500}
        input[type="radio"]{accent-color:#1a237e;transform:scale(1.2);margin-right:10px}
        
        .submit-floating {position: fixed; bottom: 30px; right: 30px; z-index: 1500; background: linear-gradient(45deg, #d32f2f, #c62828); color: white; padding: 15px 30px; border-radius: 50px; font-weight: bold; box-shadow: 0 5px 20px rgba(198,40,40,0.5); border: 2px solid white; cursor: pointer; transition: transform 0.2s; display: flex; align-items: center; gap: 10px; font-size: 1.1em;}
        .palette-item{width:35px;height:35px;display:flex;align-items:center;justify-content:center;border:1px solid #ddd;border-radius:6px;cursor:pointer;background:white;font-weight:bold;color:#555}
        .palette-item.answered{background:#1a237e;color:white;border-color:#1a237e}
        .palette-grid{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
        
        /* MÀN HÌNH CHÀO */
        .welcome-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(13,71,161,0.95);z-index:2000;display:flex;align-items:center;justify-content:center}
        .welcome-card{background:white;width:90%;max-width:400px;padding:30px;border-radius:20px;text-align:center}
        .btn-start{background:linear-gradient(45deg,#1565c0,#0d47a1);color:white;width:100%;padding:15px;border:none;border-radius:50px;font-weight:bold;font-size:1.1em;cursor:pointer;margin-top:15px}

        /* HIỆU ỨNG NHẠC */
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- CSS CHO CHẾ ĐỘ IN (PRINT MODE) --- */
        #print-area { display: none; background: white; color: black; padding: 20px; font-family: "Times New Roman", serif; }
        .print-header { display: flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
        .print-header div { text-align: center; }
        .print-q { margin-bottom: 15px; page-break-inside: avoid; }
        .print-q b { font-weight: bold; }
        .print-opts { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 5px; }
        .print-opt { min-width: 20%; }

        /* KHI IN THÌ ẨN GIAO DIỆN WEB, HIỆN GIAO DIỆN IN */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { display: block; position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
            @page { size: A4; margin: 2cm; }
        }
    </style>
</head>
<body>

<div id="loading" style="position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:3000;display:flex;justify-content:center;align-items:center;font-size:20px;color:#1a237e;font-weight:bold">⏳ Đang tải dữ liệu...</div>

<div id="print-area"></div>

<audio id="bg-music" loop>
    <source src="https://docs.google.com/uc?export=download&id=1jC5-lJk-uM_YqFjVpQ5UjQjX8qQjX8qQ" type="audio/mp3">
    <source src="https://github.com/Nguyenbm1979/Trac-nghiem-nguyen-ham/blob/3c9ee2c76b73e1120a063e6f76d5121a786461da/Softness%20And%20Light.mp3" type="audio/mp3">
</audio>
<div id="music-control" onclick="toggleMusic()" style="display:none; position:fixed; bottom:100px; right:30px; z-index:1500; width:50px; height:50px; background:#e91e63; color:white; border-radius:50%; align-items:center; justify-content:center; box-shadow:0 5px 15px rgba(233,30,99,0.4); cursor:pointer; font-size:1.2em; transition:0.3s">
    <i class="fas fa-music"></i>
</div>

<div class="welcome-overlay" id="welcome-screen" style="display:none">
    <div class="welcome-card">
        <h2 id="exam-title" style="color:#1a237e;margin:0">BÀI KIỂM TRA</h2>
        <p id="exam-info" style="color:#666;font-size:0.9em;margin-bottom:20px"></p>
        <input type="text" id="s-name" placeholder="Họ và Tên" style="width:100%;padding:12px;margin-bottom:10px;border:1px solid #ccc;border-radius:8px">
        <input type="text" id="s-class" placeholder="Lớp" style="width:100%;padding:12px;margin-bottom:10px;border:1px solid #ccc;border-radius:8px">
        <div id="pass-area" style="display:none"><input type="password" id="s-pass" placeholder="Mật khẩu" style="width:100%;padding:12px;border:1px solid #ccc;border-radius:8px"></div>
        <button class="btn-start" onclick="checkLogin()">VÀO THI NGAY</button>
    </div>
</div>

<div class="container" id="main-interface" style="display:none">
    <div class="status-bar">
        <div class="student-box"><i class="fas fa-user-graduate"></i> <span id="d-name">HS</span> <span id="d-class"></span></div>
        <div class="timer-box"><i class="far fa-clock"></i> <span id="timer">00:00</span></div>
    </div>
    <div style="background:white;padding:15px;margin:15px 0;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1)">
        <div class="palette-grid" id="palette-grid"></div>
    </div>
    <div id="result-area" style="display:none;background:white;padding:30px;text-align:center;border-radius:12px;margin-bottom:20px;border-top:5px solid #2e7d32">
        <h1 style="color:#2e7d32;font-size:4em;margin:5px 0"><span id="final-score"></span></h1>
        <div style="color:#1565c0;font-weight:bold;margin-top:15px">▼ Xem lời giải chi tiết bên dưới ▼</div>
    </div>
    <div id="quiz-body"></div>
    <button class="submit-floating" onclick="confirmSubmit()" id="btn-submit"><i class="fas fa-paper-plane"></i> NỘP BÀI</button>
</div>

<script>
    let rawQ=[], curQ=[], timerDur=0, timerInt;
    let scoresConfig={mcq:0.25, tf:1.0, short:0.5, match:1.0};
    let isEnc=false, userAns={}, stId="", exId="";

    // --- PHẦN 1: XỬ LÝ NHẠC ---
    function toggleMusic() {
        const audio = document.getElementById('bg-music');
        const btn = document.getElementById('music-control');
        
        // Buộc trình duyệt nhận tương tác người dùng
        if (audio.paused) {
            audio.volume = 0.5; // Âm lượng vừa phải
            var playPromise = audio.play();
            
            if (playPromise !== undefined) {
                playPromise.then(_ => {
                    btn.innerHTML = '<i class="fas fa-pause"></i>';
                    btn.style.animation = "spin 2s linear infinite";
                }).catch(error => {
                    alert("⚠️ Trình duyệt chặn phát nhạc tự động.\nHãy bấm OK rồi bấm lại nút nhạc lần nữa!");
                });
            }
        } else {
            audio.pause();
            btn.innerHTML = '<i class="fas fa-music"></i>';
            btn.style.animation = "none";
        }
    }

    // --- PHẦN 2: LOAD ĐỀ & KIỂM TRA CHẾ ĐỘ ---
    const urlParams=new URLSearchParams(window.location.search);
    const pId=urlParams.get('id'); exId=pId||"demo";
    const isPrintMode = urlParams.get('print') === '1'; // Kiểm tra có phải chế độ in không

    if(pId){
        const s=document.createElement('script');
        s.src=`data/${pId}.js?v=`+Date.now();
        s.onload=()=>{
            if(window.EXAM_DATA) {
                if(isPrintMode) {
                    renderPrintMode(window.EXAM_DATA); // Chuyển sang chế độ in ngay
                } else {
                    initExam(window.EXAM_DATA); // Chế độ thi bình thường
                }
            }
        };
        s.onerror=()=>document.getElementById('loading').innerText="Lỗi tải đề!";
        document.head.appendChild(s);
    }else document.getElementById('loading').innerText="Thiếu ID đề.";

    // --- PHẦN 3: HÀM DÀNH RIÊNG CHO CHẾ ĐỘ IN (PRINT MODE) ---
    function renderPrintMode(d) {
        document.getElementById('loading').style.display='none';
        document.body.style.background = "white"; // Nền trắng để in
        
        // Header tờ giấy thi
        let h = `<div class="print-header">
            <div><b>SỞ GIÁO DỤC VÀ ĐÀO TẠO</b><br>TRƯỜNG THPT BÌNH MINH</div>
            <div><b>ĐỀ KIỂM TRA: ${d.title}</b><br>Thời gian: ${d.time} phút</div>
        </div>
        <div style="margin-bottom:20px;border:1px solid #000;padding:10px">
            <b>Họ và tên thí sinh:</b> ............................................................................ <b>Lớp:</b> ...................
            <br><b>Số báo danh:</b> ..............................................................................................................
        </div>`;

        // Render toàn bộ câu hỏi
        d.questions.forEach((q, i) => {
            let imgHtml = q.img ? `<img src="${q.img}" style="max-height:150px;display:block;margin:5px 0">` : '';
            let contentHtml = q.q.replace('[IMG]', imgHtml);
            
            // Xử lý hiển thị các loại câu hỏi cho bản in
            h += `<div class="print-q">
                <b>Câu ${i+1}:</b> ${contentHtml} ${imgHtml}
                <div class="print-opts">`;
            
            if(q.type === 'mcq') {
                q.options.forEach((opt, idx) => {
                    h += `<div class="print-opt"><b>${String.fromCharCode(65+idx)}.</b> ${opt}</div>`;
                });
            } else if (q.type === 'tf') {
                h += `<table border="1" style="width:100%;border-collapse:collapse;margin-top:5px"><tr><th>Ý</th><th>Nội dung</th><th>Đúng/Sai</th></tr>`;
                q.items.forEach(it => h += `<tr><td>${it.sub}</td><td></td><td> □ Đ  □ S </td></tr>`);
                h += `</table>`;
            } else if (q.type === 'match') {
                h += `<i>(Ghép cột tương ứng)</i><br>`;
                q.items.forEach((it, idx) => h += `<div><b>${idx+1})</b> ${it} --- <b>${String.fromCharCode(65+idx)})</b> ${q.options[idx]}</div>`);
            }
            
            h += `</div></div>`;
        });

        // Đưa nội dung vào vùng in
        document.getElementById('print-area').innerHTML = h;
        document.getElementById('print-area').style.display = 'block';
        
        // Đợi MathJax xử lý công thức xong thì tự động mở hộp thoại in
        setTimeout(() => {
            if(window.MathJax) {
                MathJax.typesetPromise().then(() => {
                    setTimeout(() => window.print(), 1000);
                });
            } else {
                window.print();
            }
        }, 1000);
    }

    // --- PHẦN 4: HÀM CHO CHẾ ĐỘ THI (NORMAL MODE) ---
    function initExam(d){
        rawQ=d.questions; timerDur=(d.time||45)*60;
        if(d.scores) scoresConfig={...scoresConfig, ...d.scores}; 
        isEnc=d.encrypted===true;
        document.getElementById('exam-title').innerText=d.title||"BÀI KIỂM TRA";
        document.getElementById('exam-info').innerText=`${rawQ.length} Câu | ${d.time} Phút`;
        if(d.password)document.getElementById('pass-area').style.display='block';
        document.getElementById('loading').style.display='none'; 
        document.getElementById('welcome-screen').style.display='flex';

        // Hiện nút nhạc nếu Admin cho phép
        if (d.music === true) {
            document.getElementById('music-control').style.display = 'flex';
        }
    }
function checkLogin(){
        // 1. Lấy dữ liệu
        const n = document.getElementById('s-name').value.trim();
        const c = document.getElementById('s-class').value.trim();
        const p = document.getElementById('s-pass').value.trim();

        // 2. Kiểm tra tên lớp
        if(!n || !c) return alert("Vui lòng nhập Họ tên và Lớp!");

        // 3. (Tùy chọn) Mã vạn năng cho Admin
        if (p === "admin9999") {
            stId = n + c;
            document.getElementById('d-name').innerText = n;
            document.getElementById('d-class').innerText = c;
            startLogic(n); // Vào ngay
            return;
        }

        // 4. KIỂM TRA MẬT KHẨU CỦA ĐỀ
        if(window.EXAM_DATA.password && window.EXAM_DATA.password !== "") {
            // So sánh mật khẩu người dùng nhập (đã mã hóa MD5) với mật khẩu trong file đề
            if(CryptoJS.MD5(p).toString() !== window.EXAM_DATA.password) {
                return alert("Sai mật khẩu! Vui lòng thử lại.");
            }
        }

        // 5. NẾU ĐÚNG HẾT -> VÀO THI
        stId = n + c;
        document.getElementById('d-name').innerText = n;
        document.getElementById('d-class').innerText = c;
        
        // Lệnh quan trọng nhất để chuyển cảnh:
        startLogic(n);
    }
    // --- [CODE BỔ SUNG] HÀM BẮT ĐẦU THI (Bị thiếu) ---
    function startLogic(name){
        // 1. Xử lý trộn đề (Shuffle)
        let aq = JSON.parse(JSON.stringify(rawQ));
        let doShuffle = (window.EXAM_DATA.shuffle !== false);

        if(doShuffle) {
            // Tạo bộ sinh số ngẫu nhiên theo tên (để cùng tên thì đề giống nhau, tránh F5 đổi đề)
            let seed = 0;
            for(let i=0; i<name.length; i++) seed += name.charCodeAt(i);
            const random = () => {
                var x = Math.sin(seed++) * 10000;
                return x - Math.floor(x);
            };

            // Trộn thứ tự câu hỏi
            aq.sort(() => random() - 0.5);
            
            // Trộn thứ tự đáp án (chỉ cho câu trắc nghiệm MCQ)
            aq.forEach(q => { 
                if(q.type === 'mcq') {
                    q.idx = q.options.map((_,i)=>i).sort(() => random() - 0.5);
                } else {
                    q.idx = q.options ? q.options.map((_,i)=>i) : [];
                }
            });
        } else {
            // Không trộn
            aq.forEach(q => { 
                if(q.type === 'mcq') q.idx = q.options.map((_,i)=>i); 
            });
        }
        curQ = aq;

        // 2. Chuyển đổi giao diện
        renderUI(); // Vẽ câu hỏi
        document.getElementById('welcome-screen').style.display = 'none'; // Ẩn màn hình chào
        document.getElementById('main-interface').style.display = 'block'; // Hiện đề thi

        // 3. Bắt đầu tính giờ
        clearInterval(timerInt);
        timerInt = setInterval(() => {
            let m = Math.floor(timerDur / 60);
            let s = timerDur % 60;
            document.getElementById('timer').innerText = `${m}:${s<10?'0'+s:s}`;
            
            // Hết giờ
            if (--timerDur < 0) {
                clearInterval(timerInt);
                submitQuiz();
                alert("Hết giờ làm bài!");
            }
        }, 1000);
    }

    function renderUI(){
        let bh='', ph='';
        curQ.forEach((q,i)=>{
            ph+=`<div class="palette-item" id="pb-${i}" onclick="document.getElementById('q-${i}').scrollIntoView({behavior:'smooth',block:'center'})">${i+1}</div>`;
            bh+=`<div class="question-block" id="q-${i}"><div style="margin-bottom:15px"><span style="color:#1a237e;font-weight:bold">Câu ${i+1}:</span> <span style="font-weight:500">${q.q}</span></div>`;
            if(q.img)bh+=`<div style="text-align:center"><img src="${q.img}" style="max-width:100%;border-radius:8px;margin:10px auto;border:1px solid #eee"></div>`;
            
            if(q.type==='mcq') bh+=`<div style="display:grid;grid-template-columns:1fr;gap:5px">`+q.idx.map((o,d)=>`<label class="option-item"><input type="radio" name="q${i}" value="${o}" onchange="sv(${i},${o})"><span><b>${['A','B','C','D'][d]}.</b> ${q.options[o]}</span></label>`).join('')+`</div>`;
            else if(q.type==='tf') bh+=`<table style="width:100%;border-collapse:collapse"><tr><th>Ý</th><th>Đ</th><th>S</th></tr>`+q.items.map((it,s)=>`<tr><td style="border-bottom:1px solid #eee;padding:8px">${it.sub}</td><td align="center"><input type="radio" name="q${i}_${s}" value="T" onchange="sv(${i},'T',${s})"></td><td align="center"><input type="radio" name="q${i}_${s}" value="F" onchange="sv(${i},'F',${s})"></td></tr>`).join('')+`</table>`;
            else if(q.type==='match') {
                bh += `<div style="display:flex;flex-direction:column;gap:10px;margin-top:10px">`;
                q.items.forEach((it, idx) => {
                    let optsHTML = `<option value="">--</option>` + q.options.map((opt, oIdx) => `<option value="${String.fromCharCode(65 + oIdx)}">${String.fromCharCode(65 + oIdx)}</option>`).join('');
                    bh += `<div style="display:flex;justify-content:space-between;background:#f9f9f9;padding:8px"><div><b>${idx+1})</b> ${it}</div><select onchange="sv(${i},this.value,${idx})">${optsHTML}</select></div>`;
                });
                bh += `<div style="margin-top:10px;background:#e3f2fd;padding:10px">` + q.options.map((opt, oIdx) => `<div><b>${String.fromCharCode(65 + oIdx)}.</b> ${opt}</div>`).join('') + `</div></div>`;
            }
            else bh+=`<input type="text" placeholder="Nhập đáp án..." oninput="sv(${i},this.value)" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px">`;
            
            bh+=`<div id="sol-${i}" style="display:none;margin-top:15px;padding:15px;background:#e8f5e9;border:1px dashed #a5d6a7"><b>LỜI GIẢI:</b><br>${q.explain||'Không có.'}</div></div>`;
        });
        document.getElementById('palette-grid').innerHTML=ph; document.getElementById('quiz-body').innerHTML=bh;
        if(window.MathJax)MathJax.typesetPromise();
    }

    function sv(i,v,s=null){
        if(!userAns[i]) userAns[i]={};
        if(curQ[i].type === 'match' || curQ[i].type === 'tf') userAns[i][s] = v;
        else userAns[i] = v;
        let isDone = false;
        if(curQ[i].type === 'mcq' || curQ[i].type === 'short') { if(userAns[i] !== undefined && userAns[i] !== null && userAns[i].toString().trim() !== "") isDone = true; } 
        else { if(userAns[i] && Object.keys(userAns[i]).length === curQ[i].items.length) isDone = true; }
        if(isDone) document.getElementById(`pb-${i}`).classList.add('answered');
        else document.getElementById(`pb-${i}`).classList.remove('answered');
    }

    function confirmSubmit(){
        let un=[];
        curQ.forEach((q,i)=>{
            if(q.type==='match' || q.type==='tf'){ let count = userAns[i] ? Object.keys(userAns[i]).length : 0; if(count < q.items.length) un.push(i+1); }
            else { if(userAns[i] === undefined || userAns[i] === null || userAns[i] === "") un.push(i+1); }
        });
        if(un.length>0){ if(!confirm(`⚠️ CÒN CÂU CHƯA LÀM: ${un.join(", ")}\n\nBạn có chắc muốn nộp bài không?`)) return; }
        else { if(!confirm("Xác nhận nộp bài thi?")) return; }
        submitQuiz();
    }

    function chk(u, c) {
        if (u === undefined || u === null || u === "") return false;
        let uStr = String(u).trim(); let cStr = String(c).trim();
        let uClean = uStr.replace(',', '.'); let cClean = cStr.replace(',', '.');
        if (uClean === cClean) return true;
        if (uStr.toLowerCase() === cStr.toLowerCase()) return true;
        if (isEnc) { if (CryptoJS.MD5(uStr).toString() === cStr) return true; if (CryptoJS.MD5(uClean).toString() === cStr) return true; }
        return false;
    }

    function submitQuiz(){
        clearInterval(timerInt);
        document.getElementById('btn-submit').style.display='none';
        // Tắt nhạc khi nộp bài
        const audio = document.getElementById('bg-music');
        if(!audio.paused) audio.pause();
        document.getElementById('music-control').style.display='none';

        let score=0, max=0;
        curQ.forEach((q,i)=>{
            const bl=document.getElementById(`q-${i}`); document.getElementById(`sol-${i}`).style.display='block';
            let qPoint = (q.point && parseFloat(q.point) > 0) ? parseFloat(q.point) : scoresConfig[q.type];
            if(q.type==='mcq' || q.type==='short'){
                max += qPoint;
                if(chk(userAns[i], q.ans)) { score += qPoint; bg(bl, true, 'Đúng'); } else bg(bl, false, `Sai. ĐS: ${q.ans}`);
            }
            else if(q.type==='tf'){
                max += qPoint; let c=0;
                q.items.forEach((it, idx) => { if(chk(userAns[i]?userAns[i][idx]:null, it.ans)) c++; });
                let earned = 0;
                if(c==1) earned = qPoint * 0.1; else if(c==2) earned = qPoint * 0.25; else if(c==3) earned = qPoint * 0.5; else if(c==4) earned = qPoint * 1.0;
                score += earned; bg(bl, earned>0, `Đúng ${c}/${q.items.length} ý (+${earned}đ)`);
            }
            else if(q.type==='match'){
                max += qPoint; let c=0; let uObj = userAns[i] || {};
                q.items.forEach((_, idx) => { if(chk(uObj[idx], q.ans[idx])) c++; });
                let s = (c/q.items.length) * qPoint; score += s; bg(bl, s>0, `Đúng ${c}/${q.items.length} cặp (+${s.toFixed(2)}đ)`);
            }
        });
        let finalS = Math.round(score*100)/100;
        document.getElementById('result-area').style.display='block';
        document.getElementById('final-score').innerText = `${finalS} / ${max}`;
        window.scrollTo({top:0,behavior:'smooth'});
    }
    function bg(el,isT,txt){ el.insertAdjacentHTML('beforeend',`<div class="res-badge ${isT?'res-correct':'res-wrong'}">${txt}</div>`); }
</script>
</body>
</html>
