<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>L√†m B√†i Thi (v3.7 Debug)</title>
    
    <script>
    window.MathJax = {
        loader: { load: ['[tex]/noerrors'] },
        tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], packages: {'[+]': ['noerrors']} },
        svg: { fontCache: 'global' },
        startup: { typeset: false }
    };
    </script>
    <script id="MathJax-script" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-svg.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: #f0f2f5; margin: 0; color: #212529; line-height: 1.5; font-size: 16px; }
        .container { max-width: 800px; margin: 0 auto; padding: 10px; padding-bottom: 80px; }
        
        /* HEADER MOBILE */
        .header-bar { background: white; padding: 10px 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-top: 4px solid #009688; }
        .timer { font-size: 20px; color: #d32f2f; font-weight: 700; font-family: monospace; background: #ffebee; padding: 4px 10px; border-radius: 6px; }
        .student-info { font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 60%; }

        /* C√ÇU H·ªéI */
        .question-block { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .q-label { color: #d81b60; font-weight: 800; font-size: 1.1em; margin-right: 5px; }
        .q-content { font-weight: 600; color: #333; word-wrap: break-word; }
        .question-image img { max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px; border: 1px solid #eee; }
        mjx-container { overflow-x: auto; overflow-y: hidden; max-width: 100%; } 

        /* ƒê√ÅP √ÅN */
        .options-grid { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .option-item { display: flex; align-items: flex-start; background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px; cursor: pointer; transition: background 0.2s; min-height: 44px; }
        .option-item:active { background: #e2e6ea; } 
        .option-item input[type="radio"] { margin-top: 4px; margin-right: 10px; transform: scale(1.3); flex-shrink: 0; }
        .opt-letter { font-weight: 800; color: #00796b; margin-right: 8px; flex-shrink: 0; }
        .opt-text { word-break: break-word; }
        .option-item:has(input:checked) { border-color: #009688; background: #e0f2f1; box-shadow: inset 0 0 0 1px #009688; }

        /* B·∫¢NG ƒê√öNG SAI */
        .tf-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 15px; }
        .tf-table th { background: #eee; padding: 8px; text-align: center; }
        .tf-table td { padding: 10px 5px; border-bottom: 1px solid #eee; }
        .tf-table input[type="radio"] { transform: scale(1.3); }

        .short-input { width: 100%; padding: 12px; border: 2px solid #ced4da; border-radius: 8px; font-size: 16px; margin-top: 10px; }
        .part-header { background: #e0f7fa; color: #006064; padding: 10px 15px; margin: 25px 0 15px 0; font-weight: 700; border-radius: 8px; text-transform: uppercase; font-size: 0.95em; border-left: 5px solid #0097a7; }
        .solution-box { display: none; margin-top: 15px; padding: 12px; background-color: #e8f5e9; border-left: 4px solid #43a047; border-radius: 6px; font-size: 0.95em; color: #1b5e20; }
        .solution-title { font-weight: bold; text-decoration: underline; display: block; margin-bottom: 5px; }
        .btn-submit { background: #007bff; color: white; padding: 16px; width: 100%; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; box-shadow: 0 4px 12px rgba(0,123,255,0.3); }

        /* M√ÄN H√åNH CH·ªú & LOADING */
        .loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .error-log { margin-top: 20px; color: red; font-family: monospace; text-align: left; background: #fff0f0; padding: 15px; border-radius: 8px; max-width: 90%; border: 1px solid red; display:none;}
        
        .welcome-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #004d40; z-index: 1500; display: flex; align-items: center; justify-content: center; padding: 15px; display: none; }
        .welcome-card { background: white; width: 100%; max-width: 100%; padding: 25px; border-radius: 15px; text-align: center; }
        .welcome-card input { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; display: block; }
        .welcome-card label { display: block; text-align: left; margin-bottom: 5px; font-weight: bold; color: #555; }
        .btn-start { background: #d81b60; color: white; border: none; padding: 16px; width: 100%; border-radius: 50px; font-size: 18px; font-weight: bold; margin-top: 10px; }

        .result-box { display: none; background: white; padding: 30px 20px; text-align: center; border-radius: 15px; margin-top: 20px; border-top: 5px solid #28a745; }
        .correct-ans { color: #155724; background: #d4edda; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.9em; display: inline-block; margin-top: 6px; }
        .wrong-ans { color: #721c24; background: #f8d7da; padding: 4px 8px; border-radius: 4px; font-size: 0.9em; display: inline-block; margin-top: 6px; }
        
        @media (min-width: 768px) { .options-grid { display: grid; grid-template-columns: 1fr 1fr; } .container { padding: 30px; } .btn-submit { width: 300px; display: block; margin: 30px auto; } }
    </style>
</head>
<body>

<div class="loading" id="loading">
    <div style="font-size:40px; margin-bottom:10px">‚è≥</div>
    <div id="loading-text" style="color:#009688; font-weight:bold">ƒêang t·∫£i ƒë·ªÅ thi...</div>
    <div id="error-debug" class="error-log"></div>
</div>

<div class="welcome-overlay" id="welcome-screen">
    <div class="welcome-card">
        <h2 id="exam-title" style="color:#00796b; margin-top:0">B√ÄI KI·ªÇM TRA</h2>
        <p id="exam-desc" style="color:#666; font-size:0.9em">...</p>
        <hr style="border:0; border-top:1px solid #eee; margin: 15px 0;">
        <p style="color:#e65100; font-style:italic; font-weight:bold; font-size:0.95em">"Ch√∫c c√°c em l√†m b√†i t·ªët!"</p>
        <label>H·ªç v√† T√™n (*)</label><input type="text" id="s-name" placeholder="Nguy·ªÖn VƒÉn A">
        <label>L·ªõp (*)</label><input type="text" id="s-class" placeholder="12A1">
        <div id="pass-area" style="display:none"><label style="color:#c62828">M·∫≠t kh·∫©u ƒë·ªÅ thi (*)</label><input type="password" id="s-pass" placeholder="Nh·∫≠p m·∫≠t kh·∫©u..."></div>
        <button class="btn-start" onclick="startQuiz()">V√ÄO L√ÄM B√ÄI</button>
    </div>
</div>

<div class="container" id="main-interface">
    <div class="header-bar">
        <div class="student-info"><strong id="d-name">...</strong><br><span id="d-class" style="font-size:0.9em; color:#666">...</span></div>
        <div class="timer" id="timer">00:00</div>
    </div>
    <div id="result-area" class="result-box">
        <h1 style="color:#28a745; margin:0; font-size:2.5em"><span id="final-score"></span></h1>
        <p style="color:#666; margin-top:5px">ƒêi·ªÉm s·ªë c·ªßa b·∫°n</p>
        <div id="status-msg" style="margin-top:15px; font-weight:bold; color:#0056b3">‚ñº K√©o xu·ªëng xem l·ªùi gi·∫£i ‚ñº</div>
    </div>
    <div id="quiz-body"></div>
    <button class="btn-submit" onclick="if(confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i ch·ª©?')) submitQuiz()" id="btn-submit">N·ªòP B√ÄI THI</button>
</div>

<script>
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwlsAhI7NdHZhaOulVx0otepQkj8VijTm_g1lQjZaUBvffzC5uLb2IRyjhgnJdm4Wvg/exec'; 

    let rawQuestions=[], currentQuestions=[], timerDuration=0, timerInterval;
    function hash(input) { return CryptoJS.MD5(String(input).trim().toLowerCase()).toString(); }
    const urlParams = new URLSearchParams(window.location.search);
    const examId = urlParams.get('id');

    // --- B·ªò B·∫ÆT L·ªñI C√ö PH√ÅP (QUAN TR·ªåNG) ---
    window.onerror = function(msg, url, lineNo, columnNo, error) {
        if (url && (url.includes(examId) || url.includes('data/'))) {
            const errDiv = document.getElementById('error-debug');
            errDiv.style.display = 'block';
            errDiv.innerHTML = `‚ùå <b>PH√ÅT HI·ªÜN L·ªñI C√ö PH√ÅP!</b><br>File: data/${examId}.js<br>L·ªói: ${msg}<br>D√≤ng s·ªë: <b>${lineNo}</b><br><br>üëâ Th·∫ßy h√£y v√†o GitHub s·ª≠a l·∫°i d√≤ng ${lineNo} nh√©!`;
            document.getElementById('loading-text').innerText = "D·ª´ng t·∫£i do l·ªói d·ªØ li·ªáu.";
            return true;
        }
    };

    setTimeout(function() {
        const loadingDiv = document.getElementById('loading');
        if (loadingDiv && loadingDiv.style.opacity !== '0' && document.getElementById('error-debug').style.display === 'none') {
             document.getElementById('loading-text').innerHTML = `<span style="color:red">‚ö†Ô∏è Qu√° th·ªùi gian t·∫£i!</span><br>Ki·ªÉm tra l·∫°i t√™n file <b>data/${examId}.js</b> tr√™n GitHub xem c√≥ ƒë√∫ng ch·ªØ hoa/th∆∞·ªùng kh√¥ng?`;
        }
    }, 10000);

    if(examId) {
        const script = document.createElement('script'); 
        // TH√äM TIMESTAMP ƒê·ªÇ √âP T·∫¢I FILE M·ªöI NH·∫§T (FIX CACHE)
        script.src = `data/${examId}.js?v=` + new Date().getTime();
        
        script.onload = () => {
            if(window.EXAM_DATA) {
                rawQuestions = window.EXAM_DATA.questions;
                timerDuration = window.EXAM_DATA.time * 60;
                document.getElementById('exam-title').innerText = window.EXAM_DATA.title;
                document.getElementById('exam-desc').innerText = window.EXAM_DATA.description;
                if(window.EXAM_DATA.password) document.getElementById('pass-area').style.display = 'block';
                prepareQuestions();
                const ld = document.getElementById('loading'); ld.style.opacity = '0'; setTimeout(() => { ld.style.display='none'; }, 500);
                document.getElementById('welcome-screen').style.display='flex';
            }
        };
        script.onerror = () => { document.getElementById('loading-text').innerHTML = "‚ùå Kh√¥ng t√¨m th·∫•y file ƒë·ªÅ (404)!"; }; 
        document.head.appendChild(script);
    } else { document.getElementById('loading-text').innerText = "Ch∆∞a ch·ªçn ƒë·ªÅ thi."; }

    function shuffle(array) { for (let i=array.length-1; i>0; i--) { const j=Math.floor(Math.random()*(i+1)); [array[i], array[j]]=[array[j], array[i]]; } return array; }
    function prepareQuestions() {
        let allQ = JSON.parse(JSON.stringify(rawQuestions));
        let part1 = allQ.filter(q => q.type === 'mcq');
        let part2 = allQ.filter(q => q.type === 'tf');
        let part3 = allQ.filter(q => q.type === 'short');
        shuffle(part1); shuffle(part2); shuffle(part3);
        part1.forEach(q => { let indices = q.options.map((_, i) => i); shuffle(indices); q.shuffledIndices = indices; });
        part2.forEach(q => shuffle(q.items));
        if(part1.length > 0) part1[0].isPartHeader = "PH·∫¶N 1. Tr·∫Øc nghi·ªám";
        if(part2.length > 0) part2[0].isPartHeader = "PH·∫¶N 2. ƒê√∫ng/Sai";
        if(part3.length > 0) part3[0].isPartHeader = "PH·∫¶N 3. Tr·∫£ l·ªùi ng·∫Øn";
        currentQuestions = [...part1, ...part2, ...part3];
        renderQuestions();
    }
    function renderQuestions() {
        const LABELS = ['A', 'B', 'C', 'D'];
        let html = '';
        currentQuestions.forEach((q, idx) => {
            if(q.isPartHeader) html += `<div class="part-header">${q.isPartHeader}</div>`;
            html += `<div class="question-block" id="q-${idx}">`;
            let qText = q.q.includes(':') ? q.q.substring(q.q.indexOf(':') + 1) : q.q;
            html += `<div style="margin-bottom:10px"><span class="q-label">C√¢u ${idx+1}:</span> <span class="q-content">${qText}</span></div>`;
            if(q.img) html += `<div class="question-image"><img src="${q.img}"></div>`;
            if(q.type === 'mcq') {
                html += `<div class="options-grid">`;
                q.shuffledIndices.forEach((originalIndex, displayIndex) => {
                    html += `<label class="option-item"><input type="radio" name="q${idx}" value="${originalIndex}"><span class="opt-letter">${LABELS[displayIndex]}.</span><span class="opt-text">${q.options[originalIndex]}</span></label>`;
                });
                html += `</div>`;
            } else if(q.type === 'tf') {
                html += `<table class="tf-table"><tr><th>M·ªánh ƒë·ªÅ</th><th style="width:40px">ƒê</th><th style="width:40px">S</th></tr>`;
                q.items.forEach((it, sIdx) => { html += `<tr><td>${it.sub}</td><td align="center"><input type="radio" name="q${idx}_${sIdx}" value="T"></td><td align="center"><input type="radio" name="q${idx}_${sIdx}" value="F"></td></tr>`; });
                html += `</table>`;
            } else if(q.type === 'short') { html += `<input type="text" class="short-input" id="in-${idx}" placeholder="Nh·∫≠p ƒë√°p √°n...">`; }
            html += `<div class="solution-box" id="sol-${idx}"><span class="solution-title">L·ªúI GI·∫¢I:</span>${q.explain ? q.explain : "Kh√¥ng c√≥ l·ªùi gi·∫£i chi ti·∫øt."}</div>`;
            html += `</div>`;
        });
        document.getElementById('quiz-body').innerHTML = html;
        if(window.MathJax) MathJax.typesetPromise().catch((err) => console.log(err));
    }
    function startQuiz() {
        const name = document.getElementById('s-name').value.trim();
        const cls = document.getElementById('s-class').value.trim();
        if(!name || !cls) return alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß T√™n v√† L·ªõp!");
        if(window.EXAM_DATA.password) {
            const inputPass = document.getElementById('s-pass').value.trim();
            const configPass = window.EXAM_DATA.password;
            let isMatch = false;
            if(hash(inputPass) === configPass) isMatch = true;
            if(inputPass === configPass) isMatch = true;
            if(!isMatch) return alert("Sai m·∫≠t kh·∫©u ƒë·ªÅ thi!");
        }
        document.getElementById('d-name').innerText = name;
        document.getElementById('d-class').innerText = cls;
        document.getElementById('welcome-screen').style.display = 'none';
        document.getElementById('main-interface').style.display = 'block';
        timerInterval = setInterval(() => {
            let m=Math.floor(timerDuration/60), s=timerDuration%60;
            document.getElementById('timer').innerText = `${m}:${s<10?'0'+s:s}`;
            if(--timerDuration < 0) { clearInterval(timerInterval); submitQuiz(); }
        }, 1000);
    }
    function submitQuiz() {
        clearInterval(timerInterval);
        document.getElementById('btn-submit').style.display = 'none';
        let totalScore=0, maxScore=0;
        currentQuestions.forEach((q, idx) => {
            const block = document.getElementById(`q-${idx}`);
            const solBox = document.getElementById(`sol-${idx}`);
            if(solBox) solBox.style.display = 'block';
            if(q.type === 'mcq') {
                maxScore += 0.25;
                const sel = document.querySelector(`input[name="q${idx}"]:checked`);
                let isCorrect = false;
                if(sel) { let val = sel.value; let ans = q.ans; if(String(val) === String(ans) || hash(val) === String(ans)) isCorrect = true; }
                if(isCorrect) { totalScore += 0.25; block.insertAdjacentHTML('beforeend', `<div class="correct-ans">ƒê√∫ng (+0.25ƒë)</div>`); }
                else block.insertAdjacentHTML('beforeend', `<div class="wrong-ans">Sai</div>`);
            } else if(q.type === 'tf') {
                maxScore += 1.0; let correctCount = 0;
                q.items.forEach((it, sIdx) => { const sel = document.querySelector(`input[name="q${idx}_${sIdx}"]:checked`); if(sel) { let val = sel.value; let ans = it.ans; if(String(val) === String(ans) || hash(val) === String(ans)) correctCount++; } });
                let p=0; if(correctCount===1) p=0.1; else if(correctCount===2) p=0.25; else if(correctCount===3) p=0.5; else if(correctCount===4) p=1.0;
                totalScore += p;
                if(p>0) block.insertAdjacentHTML('beforeend', `<div class="partial-score">ƒê√∫ng ${correctCount}/4 √Ω (+${p}ƒë)</div>`); else block.insertAdjacentHTML('beforeend', `<div class="wrong-ans">Sai h·∫øt</div>`);
            } else if(q.type === 'short') {
                maxScore += 0.5; const val = document.getElementById(`in-${idx}`).value.replace(',', '.'); let isCorrect = false;
                if(String(val).trim().toLowerCase() === String(q.ans).trim().toLowerCase()) isCorrect = true;
                if(hash(val) === String(q.ans)) isCorrect = true;
                if(isCorrect) { totalScore += 0.5; block.insertAdjacentHTML('beforeend', `<div class="correct-ans">ƒê√∫ng (+0.5ƒë)</div>`); }
                else block.insertAdjacentHTML('beforeend', `<div class="wrong-ans">Sai. ƒê.√Ån: ${q.ans}</div>`);
            }
        });
        totalScore = Math.round(totalScore*100)/100; maxScore = Math.round(maxScore*100)/100;
        document.getElementById('result-area').style.display = 'block'; document.getElementById('final-score').innerText = `${totalScore} / ${maxScore}`; window.scrollTo(0,0);
        if(window.MathJax) MathJax.typesetPromise();
        if(GOOGLE_SCRIPT_URL) { fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name: document.getElementById('s-name').value, class: document.getElementById('s-class').value, score: totalScore + "/" + maxScore, exam: window.EXAM_DATA.title }) }); }
    }
</script>
</body>
</html>
