<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H·ªá Th·ªëng Thi Tr·ª±c Tuy·∫øn</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }, svg: { fontCache: 'global' } };</script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
    /* --- 1. CSS CHUNG & GIAO DI·ªÜN THI ONLINE --- */
    body{font-family:'Roboto',sans-serif;background:#f4f7f6;margin:0;color:#333;padding-bottom:100px;user-select:none}
    
    .status-bar{background:white;padding:10px 20px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1000;box-shadow:0 2px 5px rgba(0,0,0,0.05);border-bottom:1px solid #eee}
    .timer-box{background:#ffebee;color:#c62828;padding:5px 12px;border-radius:20px;font-weight:700;font-family:monospace;font-size:1.2em}
    .student-box{font-weight:600;color:#1565c0}
    .container{max-width:900px;margin:0 auto;padding:15px}
    .question-block{background:white;padding:25px;border-radius:12px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.03);border-left:5px solid #1a237e}
    .option-item{display:flex;align-items:center;background:#fafafa;border:1px solid #eee;padding:12px 15px;border-radius:8px;cursor:pointer;margin-bottom:8px;transition:0.2s}
    .option-item:hover{background:#e8eaf6;border-color:#c5cae9}
    .option-item:has(input:checked){background:#e3f2fd;border-color:#2196f3;color:#0d47a1;font-weight:500}
    input[type="radio"]{accent-color:#1a237e;transform:scale(1.2);margin-right:10px}
    
    .submit-floating {position: fixed; bottom: 30px; right: 30px; z-index: 1500; background: linear-gradient(45deg, #d32f2f, #c62828); color: white; padding: 15px 30px; border-radius: 50px; font-weight: bold; box-shadow: 0 5px 20px rgba(198,40,40,0.5); border: 2px solid white; cursor: pointer; transition: transform 0.2s; display: flex; align-items: center; gap: 10px; font-size: 1.1em;}
    .palette-item{width:35px;height:35px;display:flex;align-items:center;justify-content:center;border:1px solid #ddd;border-radius:6px;cursor:pointer;background:white;font-weight:bold;color:#555}
    .palette-item.answered{background:#1a237e;color:white;border-color:#1a237e}
    .palette-grid{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
    
    /* M√ÄN H√åNH CH√ÄO */
    .welcome-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(13,71,161,0.95);z-index:2000;display:flex;align-items:center;justify-content:center}
    .welcome-card{background:white;width:90%;max-width:400px;padding:30px;border-radius:20px;text-align:center}
    .btn-start{background:linear-gradient(45deg,#1565c0,#0d47a1);color:white;width:100%;padding:15px;border:none;border-radius:50px;font-weight:bold;font-size:1.1em;cursor:pointer;margin-top:15px}

    /* HI·ªÜU ·ª®NG NH·∫†C */
    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* --- 2. CSS M·ªöI: CHUY√äN D·ª§NG CHO IN ·∫§N (Print Mode) --- */
    #print-area { display: none; font-family: "Times New Roman", serif; line-height: 1.3; color: #000; }
    
    /* Header ƒë·ªÅ thi chu·∫©n */
    .print-header-table { width: 100%; margin-bottom: 15px; border-bottom: 1px solid #000; padding-bottom: 5px; }
    .print-header-table td { vertical-align: top; }
    .ph-left { text-align: center; width: 40%; font-weight: normal; }
    .ph-right { text-align: center; width: 60%; font-weight: bold; }
    .ph-school { font-weight: bold; text-transform: uppercase; }
    
    /* Khung th√¥ng tin th√≠ sinh */
    .student-info-box { margin-bottom: 15px; border: 1px solid #000; padding: 10px; font-size: 14px; }
    
    /* C√¢u h·ªèi */
    .print-q { margin-bottom: 12px; text-align: justify; page-break-inside: avoid; } /* Tr√°nh b·ªã ng·∫Øt ƒë√¥i c√¢u khi sang trang */
    .print-q b { font-weight: bold; }
    .print-img-box { text-align: center; margin: 5px 0; }
    
    /* L∆∞·ªõi ƒë√°p √°n tr·∫Øc nghi·ªám th√¥ng minh */
    .opts-grid { display: grid; gap: 5px; margin-top: 5px; margin-left: 20px; }
    .cols-4 { grid-template-columns: repeat(4, 1fr); } /* 4 ƒë√°p √°n 1 d√≤ng */
    .cols-2 { grid-template-columns: repeat(2, 1fr); } /* 2 ƒë√°p √°n 1 d√≤ng */
    .cols-1 { grid-template-columns: 1fr; }            /* 1 ƒë√°p √°n 1 d√≤ng */
    
    /* B·∫£ng ƒê√∫ng/Sai */
    .tf-table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 14px; }
    .tf-table th, .tf-table td { border: 1px solid #333; padding: 4px 8px; }
    .tf-table th { background: #f0f0f0; text-align: center; }

    /* C·∫§U H√åNH TRANG IN (Khi b·∫•m Ctrl+P) */
    @media print {
        @page { size: A4; margin: 1.5cm 1.5cm 1.5cm 1.5cm; } /* CƒÉn l·ªÅ chu·∫©n A4 */
        body * { visibility: hidden; } /* ·∫®n to√†n b·ªô web */
        #print-area, #print-area * { visibility: visible; } /* Ch·ªâ hi·ªán v√πng in */
        #print-area { display: block; position: absolute; left: 0; top: 0; width: 100%; }
        
        /* ·∫®n c√°c n√∫t r√°c */
        .submit-floating, .status-bar, #music-control, #theme-toggle { display: none !important; }
    }

    /* --- 3. CSS GIAO DI·ªÜN DARK MODE --- */
    body.dark-mode { background: #121212; color: #e0e0e0; }
    body.dark-mode .status-bar, 
    body.dark-mode .question-block, 
    body.dark-mode .palette-item { background: #1e1e1e; border-color: #333; color: #e0e0e0; }
    body.dark-mode .option-item { background: #2c2c2c; border-color: #444; color: #ccc; }
    body.dark-mode .option-item:hover { background: #3c3c3c; }
    body.dark-mode .option-item:has(input:checked) { background: #0d47a1; color: white; border-color: #1976d2; }
    body.dark-mode .student-box { color: #90caf9; }
    body.dark-mode input[type="text"], 
    body.dark-mode input[type="password"] { background: #333; color: white; border-color: #555; }
    body.dark-mode #result-area { background: #1e1e1e; border-top-color: #4caf50; }
    body.dark-mode select { background: #333; color: white; border-color: #555; }
</style>
</head>
<body>

<div id="loading" style="position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:3000;display:flex;justify-content:center;align-items:center;font-size:20px;color:#1a237e;font-weight:bold">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</div>

<div id="print-area"></div>

<audio id="bg-music" loop>
    <source src="./MaiHoaLe.mp3" type="audio/mp3">
    <source src="https://nguyenbm1979.github.io/Trac-nghiem-nguyen-ham/MaiHoaLe.mp3" type="audio/mp3">
</audio>
<div id="music-control" onclick="toggleMusic()" style="display:none; position:fixed; bottom:100px; right:30px; z-index:1500; width:50px; height:50px; background:#e91e63; color:white; border-radius:50%; align-items:center; justify-content:center; box-shadow:0 5px 15px rgba(233,30,99,0.4); cursor:pointer; font-size:1.2em; transition:0.3s">
    <i class="fas fa-music"></i>
</div>

<div class="welcome-overlay" id="welcome-screen" style="display:none">
    <div class="welcome-card">
        <h2 id="exam-title" style="color:#1a237e;margin:0">B√ÄI KI·ªÇM TRA</h2>
        <p id="exam-info" style="color:#666;font-size:0.9em;margin-bottom:20px"></p>
        <input type="text" id="s-name" placeholder="H·ªç v√† T√™n" style="width:100%;padding:12px;margin-bottom:10px;border:1px solid #ccc;border-radius:8px">
        <input type="text" id="s-class" placeholder="L·ªõp" style="width:100%;padding:12px;margin-bottom:10px;border:1px solid #ccc;border-radius:8px">
        <div id="pass-area" style="display:none"><input type="password" id="s-pass" placeholder="M·∫≠t kh·∫©u" style="width:100%;padding:12px;border:1px solid #ccc;border-radius:8px"></div>
        <button class="btn-start" onclick="checkLogin()">V√ÄO THI NGAY</button>
    </div>
</div>

<div class="container" id="main-interface" style="display:none">
   <div class="status-bar">
        <div class="student-box"><i class="fas fa-user-graduate"></i> <span id="d-name">HS</span> <span id="d-class"></span></div>
        <div id="theme-toggle" onclick="toggleTheme()" style="cursor:pointer;font-size:1.3em;margin-right:15px;color:#1a237e" title="Ch·∫ø ƒë·ªô S√°ng/T·ªëi">
            <i class="fas fa-moon"></i>
        </div>
        <div class="timer-box"><i class="far fa-clock"></i> <span id="timer">00:00</span></div>
    </div>
    <div style="background:white;padding:15px;margin:15px 0;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1)">
        <div class="palette-grid" id="palette-grid"></div>
    </div>
    <div id="result-area" style="display:none;background:white;padding:30px;text-align:center;border-radius:12px;margin-bottom:20px;border-top:5px solid #2e7d32">
        <h1 style="color:#2e7d32;font-size:4em;margin:5px 0"><span id="final-score"></span></h1>
        <div style="color:#1565c0;font-weight:bold;margin-top:15px">‚ñº Xem l·ªùi gi·∫£i chi ti·∫øt b√™n d∆∞·ªõi ‚ñº</div>
    </div>
    <div id="quiz-body"></div>
    <button class="submit-floating" onclick="confirmSubmit()" id="btn-submit"><i class="fas fa-paper-plane"></i> N·ªòP B√ÄI</button>
</div>

<script>
    // --- KHAI B√ÅO BI·∫æN TO√ÄN C·ª§C ---
    let rawQ = [], curQ = [], timerDur = 0, timerInt;
    // C·∫§U H√åNH LI√äN K·∫æT GOOGLE SHEET
    const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbyvrYa-XEHWk_Pcn2_9x4ZOLpdqfi_1KFPn1Y6I6QeaHihDVBNwu2lLfE43D1z96f9_zQ/exec";
    
    // Kh·ªüi t·∫°o th·ªùi gian v√† bi·∫øn ƒë·∫øm vi ph·∫°m
    let startTime = new Date().toLocaleString('vi-VN'); 
    let warnCount = 0; 
    let scoresConfig = {mcq: 0.25, tf: 1.0, short: 0.5, match: 1.0};
    let isEnc = false, userAns = {}, stId = "", exId = "";

    // --- PH·∫¶N 1: X·ª¨ L√ù NH·∫†C ---
    function toggleMusic() {
        const audio = document.getElementById('bg-music');
        const btn = document.getElementById('music-control');
        
        if (audio.paused) {
            audio.volume = 0.5;
            var playPromise = audio.play();
            if (playPromise !== undefined) {
                playPromise.then(_ => {
                    btn.innerHTML = '<i class="fas fa-pause"></i>';
                    btn.style.animation = "spin 2s linear infinite";
                }).catch(error => {
                    alert("‚ö†Ô∏è Tr√¨nh duy·ªát ch·∫∑n ph√°t nh·∫°c t·ª± ƒë·ªông.\nH√£y b·∫•m OK r·ªìi b·∫•m l·∫°i n√∫t nh·∫°c l·∫ßn n·ªØa!");
                });
            }
        } else {
            audio.pause();
            btn.innerHTML = '<i class="fas fa-music"></i>';
            btn.style.animation = "none";
        }
    }

    // --- H√ÄM CHUY·ªÇN ƒê·ªîI S√ÅNG/T·ªêI ---
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        const btn = document.getElementById('theme-toggle');
        
        if (isDark) {
            btn.innerHTML = '<i class="fas fa-sun"></i>';
            btn.style.color = "#fdd835"; 
        } else {
            btn.innerHTML = '<i class="fas fa-moon"></i>';
            btn.style.color = "#1a237e"; 
        }
    }

    // --- PH·∫¶N 2: LOAD ƒê·ªÄ & KI·ªÇM TRA CH·∫æ ƒê·ªò ---
    const urlParams = new URLSearchParams(window.location.search);
    const pId = urlParams.get('id'); exId = pId || "demo";
    const isPrintMode = urlParams.get('print') === '1'; 

    if(pId){
        const s = document.createElement('script');
        s.src = `data/${pId}.js?v=` + Date.now();
        s.onload = () => {
            if(window.EXAM_DATA) {
                // KI·ªÇM TRA QUY·ªÄN IN
                if(isPrintMode && window.EXAM_DATA.allowPrint !== true) {
                    alert("‚õî ƒê·ªÅ thi n√†y KH√îNG CHO PH√âP IN!");
                    window.location.href = window.location.pathname + "?id=" + pId; 
                    return;
                }
                
                if(isPrintMode) {
                    renderPrintMode(window.EXAM_DATA); 
                } else {
                    initExam(window.EXAM_DATA); 
                }
            }
        };
        s.onerror = () => document.getElementById('loading').innerText = "L·ªói t·∫£i ƒë·ªÅ!";
        document.head.appendChild(s);
    } else document.getElementById('loading').innerText = "Thi·∫øu ID ƒë·ªÅ.";

    // --- PH·∫¶N 3: H√ÄM D√ÄNH RI√äNG CHO CH·∫æ ƒê·ªò IN (PRINT MODE) ---
    function renderPrintMode(d) {
        document.getElementById('loading').style.display='none';
        document.body.style.background = "white"; 
        
        let h = `<div class="print-header">
            <div><b>S·ªû GI√ÅO D·ª§C V√Ä ƒê√ÄO T·∫†O Vƒ®NH LONG</b><br>TR∆Ø·ªúNG THPT B√åNH MINH</div>
            <div><b>ƒê·ªÄ KI·ªÇM TRA: ${d.title}</b><br>Th·ªùi gian: ${d.time} ph√∫t</div>
        </div>
        <div style="margin-bottom:20px;border:1px solid #000;padding:10px">
            <b>H·ªç v√† t√™n th√≠ sinh:</b> ............................................................................ <b>L·ªõp:</b> ...................
            <br><b>S·ªë b√°o danh:</b> ..............................................................................................................
        </div>`;

        d.questions.forEach((q, i) => {
            let imgHtml = q.img ? `<img src="${q.img}" style="max-height:150px;display:block;margin:5px 0">` : '';
            let contentHtml = q.q.replace('[IMG]', imgHtml);
            
            h += `<div class="print-q">
                <b>C√¢u ${i+1}:</b> ${contentHtml} ${imgHtml}
                <div class="print-opts">`;
            
            if(q.type === 'mcq') {
                q.options.forEach((opt, idx) => {
                    h += `<div class="print-opt"><b>${String.fromCharCode(65+idx)}.</b> ${opt}</div>`;
                });
            } else if (q.type === 'tf') {
                h += `<table border="1" style="width:100%;border-collapse:collapse;margin-top:5px"><tr><th>√ù</th><th>N·ªôi dung</th><th>ƒê√∫ng/Sai</th></tr>`;
                q.items.forEach(it => h += `<tr><td>${it.sub}</td><td></td><td> ‚ñ° ƒê  ‚ñ° S </td></tr>`);
                h += `</table>`;
            } else if (q.type === 'match') {
                h += `<i>(Gh√©p c·ªôt t∆∞∆°ng ·ª©ng)</i><br>`;
                q.items.forEach((it, idx) => h += `<div><b>${idx+1})</b> ${it} --- <b>${String.fromCharCode(65+idx)})</b> ${q.options[idx]}</div>`);
            }
            
            h += `</div></div>`;
        });

        document.getElementById('print-area').innerHTML = h;
        document.getElementById('print-area').style.display = 'block';
        
        setTimeout(() => {
            if(window.MathJax) {
                MathJax.typesetPromise().then(() => {
                    setTimeout(() => window.print(), 1000);
                });
            } else {
                window.print();
            }
        }, 1000);
    }

    // --- PH·∫¶N 4: H√ÄM CHO CH·∫æ ƒê·ªò THI (NORMAL MODE) ---
    function initExam(d){
        rawQ = d.questions; timerDur = (d.time||45)*60;
        if(d.scores) scoresConfig = {...scoresConfig, ...d.scores}; 
        // --- ƒêO·∫†N CODE TH√äM V√ÄO THI.HTML ƒê·ªÇ CH·∫∂N GI·ªú ---
let now = new Date();
if (d.start && now < new Date(d.start)) {
    alert("‚õî CH∆ØA ƒê·∫æN GI·ªú M·ªû ƒê·ªÄ!\nTh·ªùi gian m·ªü: " + new Date(d.start).toLocaleString('vi-VN'));
    window.location.href = "index.html"; // Quay v·ªÅ trang ch·ªß
    return;
}
if (d.end && now > new Date(d.end)) {
    alert("‚õî ƒê·ªÄ THI ƒê√É ƒê√ìNG!\nTh·ªùi gian ƒë√≥ng: " + new Date(d.end).toLocaleString('vi-VN'));
    window.location.href = "index.html"; // Quay v·ªÅ trang ch·ªß
    return;
}
// -----------------------------------------------
        isEnc = d.encrypted===true;
        document.getElementById('exam-title').innerText = d.title||"B√ÄI KI·ªÇM TRA";
        // --- S·ª¨A L·∫†I ƒêO·∫†N HI·ªÇN TH·ªä S·ªê C√ÇU ---
        // N·∫øu c√≥ thi·∫øt l·∫≠p l·∫•y √≠t h∆°n t·ªïng s·ªë, th√¨ hi·ªán s·ªë l∆∞·ª£ng l·∫•y
        let realCount = (d.take && d.take > 0 && d.take < rawQ.length) ? d.take : rawQ.length;
        document.getElementById('exam-info').innerText = `${realCount} C√¢u | ${d.time} Ph√∫t`;
        // ------------------------------------
        if(d.password) document.getElementById('pass-area').style.display='block';
        document.getElementById('loading').style.display='none'; 
        document.getElementById('welcome-screen').style.display='flex';

        if (d.music === true) {
            document.getElementById('music-control').style.display = 'flex';
        }
    }

    function checkLogin(){
        const n = document.getElementById('s-name').value.trim();
        const c = document.getElementById('s-class').value.trim();
        const p = document.getElementById('s-pass').value.trim();

        if(!n || !c) return alert("Vui l√≤ng nh·∫≠p H·ªç t√™n v√† L·ªõp!");

        if (p === "admin9999") {
            stId = n + c;
            document.getElementById('d-name').innerText = n;
            document.getElementById('d-class').innerText = c;
            startLogic(n);
            return;
        }

        if(window.EXAM_DATA.password && window.EXAM_DATA.password !== "") {
            if(CryptoJS.MD5(p).toString() !== window.EXAM_DATA.password) {
                return alert("Sai m·∫≠t kh·∫©u! Vui l√≤ng th·ª≠ l·∫°i.");
            }
        }
        stId = n + c;
        // --- TH√äM D√íNG N√ÄY: T·∫°o kh√≥a l∆∞u tr·ªØ ri√™ng cho h·ªçc sinh n√†y v·ªõi ƒë·ªÅ n√†y ---
        window.storageKey = "exam_save_" + exId + "_" + stId.replace(/\s/g,''); 
        // -----------------------------------------------------------------------
        document.getElementById('d-name').innerText = n;
        document.getElementById('d-class').innerText = c;
        startLogic(n);
    }

    // --- LOGIC TR·ªòN ƒê·ªÄ THEO MA TR·∫¨N (M·ªöI) ---
    function startLogic(name){
        startTime = new Date().toLocaleString('vi-VN');
        
        // 1. Ph√¢n lo·∫°i c√¢u h·ªèi t·ª´ kho d·ªØ li·ªáu g·ªëc
        let pool = { mcq: [], tf: [], short: [] };
        rawQ.forEach(q => { if(pool[q.type]) pool[q.type].push(JSON.parse(JSON.stringify(q))); });

        // 2. L·∫•y c·∫•u h√¨nh ma tr·∫≠n (N·∫øu kh√¥ng c√≥ th√¨ m·∫∑c ƒë·ªãnh l·∫•y h·∫øt)
        let m = window.EXAM_DATA.matrix || { 
            mcq: {take: 999}, tf: {take: 999}, short: {take: 999} 
        };

        // H√†m t·∫°o b·ªô s·ªë ng·∫´u nhi√™n theo t√™n h·ªçc sinh
        let seed = 0;
        for(let i=0; i<name.length; i++) seed += name.charCodeAt(i);
        const random = () => { var x = Math.sin(seed++) * 10000; return x - Math.floor(x); };

        // 3. H√†m r√∫t c√¢u h·ªèi: Ghim tr∆∞·ªõc -> Random sau
        const pickQs = (sourceArr, count, sectionScore) => {
            if(!sourceArr) return [];
            // N·∫øu count = 0 ho·∫∑c kh√¥ng nh·∫≠p th√¨ l·∫•y h·∫øt
            let takeCount = (count > 0) ? count : sourceArr.length;
            
            // T√°ch c√¢u ghim v√† c√¢u th∆∞·ªùng
            let pinned = sourceArr.filter(q => q.mustTake === true);
            let others = sourceArr.filter(q => !q.mustTake);
            
            // Tr·ªôn ng·∫´u nhi√™n c√¢u th∆∞·ªùng
            if(window.EXAM_DATA.shuffle !== false) others.sort(() => random() - 0.5);
            
            // L·∫•y cho ƒë·ªß s·ªë l∆∞·ª£ng (∆∞u ti√™n ghim tr∆∞·ªõc)
            let needed = takeCount - pinned.length;
            let pickedOthers = others.slice(0, Math.max(0, needed));
            
            // G·ªôp l·∫°i & Tr·ªôn th·ª© t·ª± hi·ªÉn th·ªã TRONG NH√ìM (n·∫øu mu·ªën)
            let final = pinned.concat(pickedOthers);
            if(window.EXAM_DATA.shuffle !== false) final.sort(() => random() - 0.5);
            
            // T√çNH L·∫†I ƒêI·ªÇM CHO T·ª™NG C√ÇU (T·ª± ƒë·ªông chia ƒëi·ªÉm)
            if(final.length > 0 && sectionScore > 0) {
                let pPerQ = sectionScore / final.length;
                final.forEach(q => q.point = pPerQ);
            }
            
            return final;
        };

        // 4. Th·ª±c hi·ªán r√∫t c√¢u h·ªèi cho 3 ph·∫ßn
        let part1 = pickQs(pool.mcq, m.mcq.take, m.mcq.score);
        let part2 = pickQs(pool.tf, m.tf.take, m.tf.score);
        let part3 = pickQs(pool.short, m.short.take, m.short.score);

        // 5. G√°n nh√£n ti√™u ƒë·ªÅ ph·∫ßn (ƒë·ªÉ hi·ªÉn th·ªã l√∫c render)
        if(part1.length) part1[0].sectionTitle = "PH·∫¶N I. C√¢u tr·∫Øc nghi·ªám nhi·ªÅu ph∆∞∆°ng √°n l·ª±a ch·ªçn";
        if(part2.length) part2[0].sectionTitle = "PH·∫¶N II. C√¢u tr·∫Øc nghi·ªám ƒë√∫ng sai";
        if(part3.length) part3[0].sectionTitle = "PH·∫¶N III. C√¢u tr·∫Øc nghi·ªám tr·∫£ l·ªùi ng·∫Øn";

        // 6. G·ªôp l·∫°i th√†nh ƒë·ªÅ thi ho√†n ch·ªânh (Theo th·ª© t·ª± I -> II -> III)
        curQ = [...part1, ...part2, ...part3];

        // 7. Tr·ªôn ƒë√°p √°n ABCD (ch·ªâ cho ph·∫ßn tr·∫Øc nghi·ªám)
        curQ.forEach(q => {
            if(q.type === 'mcq' && window.EXAM_DATA.shuffle !== false) {
                q.idx = q.options.map((_,i)=>i).sort(() => random() - 0.5);
            } else if (q.type === 'mcq') {
                q.idx = q.options.map((_,i)=>i);
            }
        });

        renderUI();
        // Gi·ªØ nguy√™n ph·∫ßn kh√¥i ph·ª•c b√†i l√†m c≈©
        let savedData = localStorage.getItem(window.storageKey);
        if(savedData){
            let d = JSON.parse(savedData);
            userAns = d.ans;
            timeLeft = d.time;
            renderUI(); // Render l·∫°i ƒë·ªÉ ƒëi·ªÅn ƒë√°p √°n c≈©
        }
    }

    function renderUI(){
        let bh='', ph='';
        curQ.forEach((q,i)=>{
            // --- TH√äM ƒêO·∫†N N√ÄY ƒê·ªÇ HI·ªÜN TI√äU ƒê·ªÄ PH·∫¶N ---
            if(q.sectionTitle) {
                bh += `<div style="background:#e3f2fd; color:#0d47a1; padding:10px 15px; margin:25px 0 15px 0; border-radius:5px; font-weight:bold; font-size:1.1em; border-left:5px solid #2196f3; text-transform:uppercase;">${q.sectionTitle}</div>`;
            }
            // ------------------------------------------
            ph+=`<div class="palette-item" id="pb-${i}" onclick="document.getElementById('q-${i}').scrollIntoView({behavior:'smooth',block:'center'})">${i+1}</div>`;
            bh+=`<div class="question-block" id="q-${i}"><div style="margin-bottom:15px"><span style="color:#1a237e;font-weight:bold">C√¢u ${i+1}:</span> <span style="font-weight:500">${q.q}</span></div>`;
            if(q.img)bh+=`<div style="text-align:center"><img src="${q.img}" style="max-width:100%;border-radius:8px;margin:10px auto;border:1px solid #eee"></div>`;
            
            if(q.type==='mcq') bh+=`<div style="display:grid;grid-template-columns:1fr;gap:5px">`+q.idx.map((o,d)=>`<label class="option-item"><input type="radio" name="q${i}" value="${o}" onchange="sv(${i},${o})"><span><b>${['A','B','C','D'][d]}.</b> ${q.options[o]}</span></label>`).join('')+`</div>`;
            else if(q.type==='tf') bh+=`<table style="width:100%;border-collapse:collapse"><tr><th>√ù</th><th>ƒê</th><th>S</th></tr>`+q.items.map((it,s)=>`<tr><td style="border-bottom:1px solid #eee;padding:8px">${it.sub}</td><td align="center"><input type="radio" name="q${i}_${s}" value="T" onchange="sv(${i},'T',${s})"></td><td align="center"><input type="radio" name="q${i}_${s}" value="F" onchange="sv(${i},'F',${s})"></td></tr>`).join('')+`</table>`;
            else if(q.type==='match') {
                bh += `<div style="display:flex;flex-direction:column;gap:10px;margin-top:10px">`;
                q.items.forEach((it, idx) => {
                    let optsHTML = `<option value="">--</option>` + q.options.map((opt, oIdx) => `<option value="${String.fromCharCode(65 + oIdx)}">${String.fromCharCode(65 + oIdx)}</option>`).join('');
                    bh += `<div style="display:flex;justify-content:space-between;background:#f9f9f9;padding:8px"><div><b>${idx+1})</b> ${it}</div><select onchange="sv(${i},this.value,${idx})">${optsHTML}</select></div>`;
                });
                bh += `<div style="margin-top:10px;background:#e3f2fd;padding:10px">` + q.options.map((opt, oIdx) => `<div><b>${String.fromCharCode(65 + oIdx)}.</b> ${opt}</div>`).join('') + `</div></div>`;
            }
            else bh+=`<input type="text" placeholder="Nh·∫≠p ƒë√°p √°n..." oninput="sv(${i},this.value)" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px">`;
            
            bh+=`<div id="sol-${i}" style="display:none;margin-top:15px;padding:15px;background:#e8f5e9;border:1px dashed #a5d6a7"><b>L·ªúI GI·∫¢I:</b><br>${q.explain||'Kh√¥ng c√≥.'}</div></div>`;
        });
        document.getElementById('palette-grid').innerHTML=ph; document.getElementById('quiz-body').innerHTML=bh;
        if(window.MathJax)MathJax.typesetPromise();
    }

    function sv(i,v,s=null){
        if(!userAns[i]) userAns[i]={};
        if(curQ[i].type === 'match' || curQ[i].type === 'tf') userAns[i][s] = v;
        else userAns[i] = v;
        localStorage.setItem(window.storageKey, JSON.stringify({ans: userAns, time: timerDur}));
        let isDone = false;
        if(curQ[i].type === 'mcq' || curQ[i].type === 'short') { if(userAns[i] !== undefined && userAns[i] !== null && userAns[i].toString().trim() !== "") isDone = true; } 
        else { if(userAns[i] && Object.keys(userAns[i]).length === curQ[i].items.length) isDone = true; }
        if(isDone) document.getElementById(`pb-${i}`).classList.add('answered');
        else document.getElementById(`pb-${i}`).classList.remove('answered');
    }

    function confirmSubmit(){
        let un=[];
        curQ.forEach((q,i)=>{
            if(q.type==='match' || q.type==='tf'){ let count = userAns[i] ? Object.keys(userAns[i]).length : 0; if(count < q.items.length) un.push(i+1); }
            else { if(userAns[i] === undefined || userAns[i] === null || userAns[i] === "") un.push(i+1); }
        });
        if(un.length>0){ if(!confirm(`‚ö†Ô∏è C√íN C√ÇU CH∆ØA L√ÄM: ${un.join(", ")}\n\nB·∫°n c√≥ ch·∫Øc mu·ªën n·ªôp b√†i kh√¥ng?`)) return; }
        else { if(!confirm("X√°c nh·∫≠n n·ªôp b√†i thi?")) return; }
        submitQuiz();
    }

    function chk(u, c) {
        if (u === undefined || u === null || u === "") return false;
        let uStr = String(u).trim(); let cStr = String(c).trim();
        let uClean = uStr.replace(',', '.'); let cClean = cStr.replace(',', '.');
        if (uClean === cClean) return true;
        if (uStr.toLowerCase() === cStr.toLowerCase()) return true;
        if (isEnc) { if (CryptoJS.MD5(uStr).toString() === cStr) return true; if (CryptoJS.MD5(uClean).toString() === cStr) return true; }
        return false;
    }

    function submitQuiz(){
        // 1. KI·ªÇM TRA % L√ÄM B√ÄI (Gi·ªØ nguy√™n logic c·ªßa th·∫ßy)
        let minPercent = window.EXAM_DATA.minTime || 0; 
        let count = 0;
        Object.keys(userAns).forEach(k => { if(userAns[k]) count++; });
        let total = curQ.length;
        let currentPercent = (count / total) * 100;
        if(currentPercent < minPercent){
            alert(`‚ö†Ô∏è C·∫¢NH B√ÅO:\nTh·∫ßy y√™u c·∫ßu l√†m t·ªëi thi·ªÉu ${minPercent}% m·ªõi ƒë∆∞·ª£c n·ªôp b√†i.\n\nHi·ªán t·∫°i b·∫°n m·ªõi l√†m ƒë∆∞·ª£c: ${currentPercent.toFixed(1)}% (${count}/${total} c√¢u).\nVui l√≤ng l√†m ti·∫øp!`);
            return; 
        }

        if(!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i? Th·ªùi gian c√≤n l·∫°i s·∫Ω b·ªã h·ªßy.')) return;
        
        // D·ªçn d·∫πp h·ªá th·ªëng (Gi·ªØ nguy√™n)
        if(window.storageKey) localStorage.removeItem(window.storageKey);
        clearInterval(timerInt);
        document.removeEventListener("visibilitychange", handleVisibilityChange);
        document.getElementById('btn-submit').style.display='none';
        const audio = document.getElementById('bg-music');
        if(!audio.paused) audio.pause();
        document.getElementById('music-control').style.display='none';
        
        // --- 2. T√çNH ƒêI·ªÇM & X·ª¨ L√ù HI·ªÇN TH·ªä (LOGIC B·∫¢O M·∫¨T) ---
        let score=0, max=0;
        
        // L·∫•y quy·ªÅn xem gi·∫£i t·ª´ d·ªØ li·ªáu Admin
        // N·∫øu admin kh√¥ng t√≠ch -> bi·∫øn n√†y s·∫Ω l√† FALSE -> H·ªá th·ªëng s·∫Ω ch·∫∑n h·∫øt
        let allowView = (window.EXAM_DATA.viewDetail === true); 

        curQ.forEach((q,i)=>{
            const bl=document.getElementById(`q-${i}`); 
            
            // CH·ªà HI·ªÜN L·ªúI GI·∫¢I N·∫æU CHO PH√âP (N·∫øu c·∫•m th√¨ ·∫©n lu√¥n)
            if(allowView) {
                document.getElementById(`sol-${i}`).style.display='block';
            }

            let qPoint = (q.point && parseFloat(q.point) > 0) ? parseFloat(q.point) : scoresConfig[q.type];
            
            // --- T√çNH ƒêI·ªÇM NG·∫¶M (V·∫´n t√≠nh ƒëi·ªÉm nh∆∞ng ch·ªâ hi·ªán m√†u n·∫øu ƒë∆∞·ª£c ph√©p) ---
            if(q.type==='mcq' || q.type==='short'){
                max += qPoint;
                if(chk(userAns[i], q.ans)) { 
                    score += qPoint; 
                    if(allowView) bg(bl, true, 'ƒê√∫ng'); // Ch·ªâ t√¥ m√†u Xanh n·∫øu ƒë∆∞·ª£c ph√©p
                } else {
                    if(allowView) bg(bl, false, `Sai. ƒêS: ${q.ans}`); // Ch·ªâ t√¥ m√†u ƒê·ªè & hi·ªán ƒêS n·∫øu ƒë∆∞·ª£c ph√©p
                }
            }
            else if(q.type==='tf'){
                max += q.point; // C·ªông ƒëi·ªÉm t·ªëi ƒëa c·ªßa c√¢u n√†y
                
                let correctCount = 0;
                // ƒê·∫øm s·ªë √Ω ƒë√∫ng
                q.items.forEach((it, idx) => { 
                    // So s√°nh ƒë√°p √°n h·ªçc sinh ch·ªçn (userAns[i][idx]) v·ªõi ƒë√°p √°n ƒë√∫ng (it.ans)
                    if(chk(userAns[i]?userAns[i][idx]:null, it.ans)) correctCount++; 
                });
                
                let earned = 0;
                // --- C√îNG TH·ª®C T√çNH ƒêI·ªÇM B·∫¨C THANG (M·ªöI) ---
                // q.point l√† ƒëi·ªÉm tr·ªçn v·∫πn c·ªßa c√¢u (VD: 1 ƒëi·ªÉm)
                if(correctCount == 1) earned = q.point * 0.1;       // ƒê√∫ng 1 √Ω: 10% ƒëi·ªÉm
                else if(correctCount == 2) earned = q.point * 0.25; // ƒê√∫ng 2 √Ω: 25% ƒëi·ªÉm
                else if(correctCount == 3) earned = q.point * 0.5;  // ƒê√∫ng 3 √Ω: 50% ƒëi·ªÉm
                else if(correctCount == 4) earned = q.point * 1.0;  // ƒê√∫ng 4 √Ω: 100% ƒëi·ªÉm
                
                score += earned;
                
                // Hi·ªÉn th·ªã k·∫øt qu·∫£ chi ti·∫øt
                if(allowView) bg(bl, earned>0, `ƒê√∫ng ${correctCount}/4 √Ω (+${earned.toFixed(2)}ƒë)`);
            }
            else if(q.type==='match'){
                max += qPoint; let c=0; let uObj = userAns[i] || {};
                q.items.forEach((_, idx) => { if(chk(uObj[idx], q.ans[idx])) c++; });
                let s = (c/q.items.length) * qPoint; score += s; 
                
                if(allowView) bg(bl, s>0, `ƒê√∫ng ${c}/${q.items.length} c·∫∑p (+${s.toFixed(2)}ƒë)`);
            }
        });
        
        let finalS = Math.round(score*100)/100;
        sendToGoogleSheet(finalS, max); // V·∫´n g·ª≠i ƒëi·ªÉm v·ªÅ Sheet b√¨nh th∆∞·ªùng
        
        // --- 3. HI·ªÇN TH·ªä K·∫æT QU·∫¢ CU·ªêI C√ôNG ---
        let msg = finalS >= max/2 ? "Ch√∫c m·ª´ng b·∫°n ƒë√£ ho√†n th√†nh!" : "C·ªë g·∫Øng h∆°n l·∫ßn sau nh√©!";
        let color = finalS >= max/2 ? "#2e7d32" : "#d32f2f";
        let icon = finalS >= max/2 ? "üéâ" : "üí™";

        // T·∫°o n√∫t b·∫•m t√πy theo quy·ªÅn h·∫°n
        let viewBtn = '';
        if (allowView) {
            viewBtn = `<button class="btn btn-green" onclick="reviewExam()">Xem chi ti·∫øt & L·ªùi gi·∫£i</button>`;
        } else {
            viewBtn = `<p style="color:#d32f2f; font-weight:bold; margin-top:10px; background:#ffebee; padding:10px; border-radius:5px">‚õî ƒê·ªÅ thi n√†y kh√¥ng cho xem l·ªùi gi·∫£i chi ti·∫øt.</p>`;
        }

        // T·∫°o m√†n h√¨nh k·∫øt qu·∫£ (Overlay)
        let overlayHtml = `
            <div id="result-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; overflow-y:auto; display:flex; flex-direction:column; align-items:center; justify-content:center">
                <div style="text-align:center; padding:20px; max-width:600px; width:90%">
                    <div style="font-size:60px; margin-bottom:20px">${icon}</div>
                    <h2 style="color:#333; margin-bottom:10px">${msg}</h2>
                    <p style="color:#666; font-size:1.1em">B·∫°n ƒë√£ ho√†n th√†nh b√†i thi v·ªõi s·ªë ƒëi·ªÉm:</p>
                    <h1 style="font-size:4em; color:${color}; margin:15px 0; font-weight:bold">${finalS} / ${max}</h1>
                    
                    <div style="margin-top:40px; display:flex; justify-content:center; gap:15px; flex-wrap:wrap; flex-direction:column">
                        <button class="btn btn-blue" onclick="location.reload()" style="padding:12px 30px; font-size:1.1em">üîÑ L√†m l·∫°i ƒë·ªÅ n√†y</button>
                        <div style="margin-top:15px">
                            ${viewBtn}
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', overlayHtml);
        window.scrollTo({top:0, behavior:'smooth'});
    }
    
    function bg(el,isT,txt){ el.insertAdjacentHTML('beforeend',`<div class="res-badge ${isT?'res-correct':'res-wrong'}">${txt}</div>`); }
    
    // --- CH·ª®C NƒÇNG CH·ªêNG GIAN L·∫¨N ---
    function handleVisibilityChange() {
        if (document.hidden) {
            warnCount++;
            if (warnCount >= 3) {
                alert("‚õî VI PH·∫†M NGHI√äM TR·ªåNG!\n\nB·∫°n ƒë√£ r·ªùi kh·ªèi m√†n h√¨nh l√†m b√†i qu√° 3 l·∫ßn.\nH·ªá th·ªëng bu·ªôc ph·∫£i thu b√†i ngay l·∫≠p t·ª©c.");
                submitQuiz();
            } else {
                alert(`‚ö†Ô∏è C·∫¢NH B√ÅO (${warnCount}/3)!\n\nVui l√≤ng t·∫≠p trung l√†m b√†i. N·∫øu vi ph·∫°m 3 l·∫ßn, b√†i thi s·∫Ω t·ª± ƒë·ªông n·ªôp!`);
            }
        }
    }

    // --- H√ÄM G·ª¨I D·ªÆ LI·ªÜU V·ªÄ GOOGLE SHEET (ƒê√É C·∫¨P NH·∫¨T) ---
    function sendToGoogleSheet(score, maxScore) {
        if (!GOOGLE_SHEET_URL || GOOGLE_SHEET_URL.includes("D√ÅN_LINK")) {
            console.log("Ch∆∞a c·∫•u h√¨nh Link Google Sheet!");
            return;
        }

        const formData = new FormData();
        // 1. L·∫•y th√¥ng tin h·ªçc sinh
        formData.append("name", document.getElementById('s-name').value);
        formData.append("class", document.getElementById('s-class').value);
        
        // 2. L·∫•y th√¥ng tin b√†i thi (M·ªöI)
        formData.append("examTitle", document.getElementById('exam-title').innerText);
        formData.append("score", `${score}/${maxScore}`);
        
        // 3. Th√¥ng tin th·ªùi gian & gi√°m s√°t
        formData.append("startTime", startTime); 
        formData.append("violations", warnCount);

        // 4. Chi ti·∫øt ƒë√°p √°n
        let details = curQ.map((q, i) => {
            let u = userAns[i];
            let val = "";
            if(typeof u === 'object' && u !== null) val = JSON.stringify(u);
            else if(q.type === 'mcq' && u !== undefined) {
                // Chuy·ªÉn s·ªë 0,1,2 th√†nh A,B,C
                val = String.fromCharCode(65 + parseInt(u));
            }
            else val = u || "_";
            return `C${i+1}:${val}`;
        }).join(" | ");
        
        formData.append("detail", details);

        // 5. G·ª≠i ƒëi
        fetch(GOOGLE_SHEET_URL, {
            method: "POST",
            body: formData,
            mode: "no-cors"
        }).then(() => {
            console.log("‚úÖ ƒê√£ g·ª≠i ƒëi·ªÉm th√†nh c√¥ng!");
        }).catch(err => {
            console.error("‚ùå L·ªói g·ª≠i ƒëi·ªÉm:", err);
        });
    }
    // --- H√ÄM M·ªöI: ƒêI·ªÄN L·∫†I ƒê√ÅP √ÅN ƒê√É L∆ØU L√äN M√ÄN H√åNH ---
    function restoreUI(){
        Object.keys(userAns).forEach(i => {
            let u = userAns[i];
            let type = curQ[i].type;
            
            // ƒê√°nh d·∫•u tr√™n thanh palette
            document.getElementById(`pb-${i}`).classList.add('answered');

            if(type === 'mcq') {
                // Ch·ªçn l·∫°i Radio tr·∫Øc nghi·ªám
                let rad = document.querySelector(`input[name="q${i}"][value="${u}"]`);
                if(rad) rad.checked = true;
            } 
            else if(type === 'short') {
                // ƒêi·ªÅn l·∫°i text ƒëi·ªÅn khuy·∫øt
                let inp = document.querySelector(`#q-${i} input[type="text"]`);
                if(inp) inp.value = u;
            }
            else if(type === 'tf') {
                // Ch·ªçn l·∫°i ƒë√∫ng sai
                Object.keys(u).forEach(idx => {
                    let rad = document.querySelector(`input[name="q${i}_${idx}"][value="${u[idx]}"]`);
                    if(rad) rad.checked = true;
                });
            }
            else if(type === 'match') {
                // Ch·ªçn l·∫°i select box gh√©p ƒë√¥i
                Object.keys(u).forEach(idx => {
                    let sel = document.querySelector(`#q-${i} select`); 
                    // L∆∞u √Ω: Logic t√¨m th·∫ª select c·ªßa gh√©p ƒë√¥i h∆°i ph·ª©c t·∫°p, c·∫ßn d√πng selector ch√≠nh x√°c
                    // C√°ch ƒë∆°n gi·∫£n nh·∫•t cho gh√©p ƒë√¥i l√† th·∫ßy t√¨m th·∫ª select th·ª© `idx` trong c√¢u ƒë√≥
                    let selects = document.querySelectorAll(`#q-${i} select`);
                    if(selects[idx]) selects[idx].value = u[idx];
                });
            }
        });
    }
    // --- H√ÄM M·ªû KH√ìA ƒê·ªÇ XEM L·∫†I B√ÄI (Quan tr·ªçng) ---
    function reviewExam() {
        console.log("ƒêang m·ªü ch·∫ø ƒë·ªô xem l·∫°i...");
        
        // 1. T√¨m v√† x√≥a l·ªõp ph·ªß k·∫øt qu·∫£ (c√°i m√†n h√¨nh tr·∫Øng hi·ªán ƒëi·ªÉm)
        let overlay = document.getElementById('result-overlay');
        if(overlay) {
            overlay.remove(); 
        } else {
            alert("Kh√¥ng t√¨m th·∫•y l·ªõp ph·ªß k·∫øt qu·∫£!");
            return;
        }

        // 2. Hi·ªán l·∫°i thanh ƒëi·ªÅu h∆∞·ªõng c√¢u h·ªèi b√™n ph·∫£i (n·∫øu n√≥ b·ªã ·∫©n)
        let palette = document.getElementById('palette-area');
        if(palette) palette.style.display = 'block';

        // 3. Cu·ªôn trang l√™n ƒë·∫ßu ƒë·ªÉ xem t·ª´ c√¢u 1
        window.scrollTo({top:0, behavior:'smooth'});
        
        // 4. Th√¥ng b√°o nh·ªè
        alert("‚úÖ ƒê√£ m·ªü l·ªùi gi·∫£i chi ti·∫øt!\n- M√†u xanh: ƒê√∫ng\n- M√†u ƒë·ªè: Sai\n(Th·∫ßy k√©o xu·ªëng ƒë·ªÉ xem chi ti·∫øt t·ª´ng c√¢u)");
    }
</script>
</body>
</html>
