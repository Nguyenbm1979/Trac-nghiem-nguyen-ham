<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H·ªá Th·ªëng Thi Tr·ª±c Tuy·∫øn v18.1 (Fix Logic)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }, svg: { fontCache: 'global' } };</script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body{font-family:'Roboto',sans-serif;background:#f4f7f6;margin:0;color:#333;padding-bottom:100px;user-select:none}
        .status-bar{background:white;padding:10px 20px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1000;box-shadow:0 2px 5px rgba(0,0,0,0.05);border-bottom:1px solid #eee}
        .timer-box{background:#ffebee;color:#c62828;padding:5px 12px;border-radius:20px;font-weight:700;font-family:monospace;font-size:1.2em}
        .student-box{font-weight:600;color:#1565c0}
        .container{max-width:900px;margin:0 auto;padding:15px}
        .question-block{background:white;padding:25px;border-radius:12px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.03);border-left:5px solid #1a237e}
        .q-label{color:#1a237e;font-weight:700;font-size:1.1em;margin-bottom:5px;display:block}
        .option-item{display:flex;align-items:center;background:#fafafa;border:1px solid #eee;padding:12px 15px;border-radius:8px;cursor:pointer;margin-bottom:8px;transition:0.2s}
        .option-item:hover{background:#e8eaf6;border-color:#c5cae9}
        .option-item:has(input:checked){background:#e3f2fd;border-color:#2196f3;color:#0d47a1;font-weight:500}
        input[type="radio"]{accent-color:#1a237e;transform:scale(1.2);margin-right:10px}
        
        .alert-rule {background: #fff3e0; border: 1px solid #ffe0b2; color: #e65100; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; display: flex; align-items: center; gap: 10px; font-size: 0.95em;}
        
        /* N√öT N·ªòP B√ÄI N·ªîI (STICKY) */
        .submit-floating {
            position: fixed; bottom: 30px; right: 30px; z-index: 1500;
            background: linear-gradient(45deg, #d32f2f, #c62828);
            color: white; padding: 15px 30px; border-radius: 50px;
            font-weight: bold; box-shadow: 0 5px 20px rgba(198,40,40,0.5);
            border: 2px solid white; cursor: pointer; transition: transform 0.2s;
            display: flex; align-items: center; gap: 10px; font-size: 1.1em;
        }
        .submit-floating:hover { transform: scale(1.05); }
        .submit-floating:active { transform: scale(0.95); }

        .welcome-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(13,71,161,0.95);z-index:2000;display:flex;align-items:center;justify-content:center}
        .welcome-card{background:white;width:90%;max-width:400px;padding:30px;border-radius:20px;text-align:center;box-shadow:0 20px 50px rgba(0,0,0,0.3)}
        .btn-start{background:linear-gradient(45deg,#1565c0,#0d47a1);color:white;width:100%;padding:15px;border:none;border-radius:50px;font-weight:bold;font-size:1.1em;cursor:pointer;margin-top:15px}
        .pay-box{border:2px dashed #e91e63;background:#fce4ec;padding:15px;margin:15px 0;border-radius:12px}
        
        .palette-item{width:35px;height:35px;display:flex;align-items:center;justify-content:center;border:1px solid #ddd;border-radius:6px;cursor:pointer;background:white;font-weight:bold;color:#555}
        .palette-item.answered{background:#1a237e;color:white;border-color:#1a237e}
        .palette-grid{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
        .res-badge{display:inline-block;padding:5px 10px;border-radius:6px;font-weight:bold;margin-top:10px;font-size:0.9em}
        .res-correct{background:#c8e6c9;color:#1b5e20;border:1px solid #a5d6a7}
        .res-wrong{background:#ffcdd2;color:#b71c1c;border:1px solid #ef9a9a}
    </style>
</head>
<body>

<div id="loading" style="position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:3000;display:flex;justify-content:center;align-items:center;font-size:20px;color:#1a237e;font-weight:bold">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</div>

<div class="welcome-overlay" id="welcome-screen" style="display:none">
    <div class="welcome-card">
        <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" style="width:60px;height:60px;border-radius:50%;margin-bottom:10px">
        <h2 id="exam-title" style="color:#1a237e;margin:0">B√ÄI KI·ªÇM TRA</h2>
        <p id="exam-info" style="color:#666;font-size:0.9em;margin-bottom:20px"></p>
        
        <div id="payment-area" class="pay-box" style="display:none">
            <h3 style="margin:0;color:#c2185b;font-size:1em">‚òï ·ª¶NG H·ªò T√ÅC GI·∫¢</h3>
            <p style="font-size:0.85em;color:#880e4f;margin:5px 0">Qu√©t m√£ ƒë·ªÉ v√†o thi:</p>
            <img id="vietqr-img" style="width:100%;max-width:200px;border-radius:8px" src="">
            <p id="pay-amount" style="font-weight:bold;font-size:1.4em;color:#d81b60;margin:10px 0"></p>
        </div>

        <input type="text" id="s-name" placeholder="H·ªç v√† T√™n" style="width:100%;padding:12px;margin-bottom:10px;border:1px solid #ccc;border-radius:8px">
        <input type="text" id="s-class" placeholder="L·ªõp" style="width:100%;padding:12px;margin-bottom:10px;border:1px solid #ccc;border-radius:8px">
        <div id="pass-area" style="display:none"><input type="password" id="s-pass" placeholder="M·∫≠t kh·∫©u" style="width:100%;padding:12px;border:1px solid #ccc;border-radius:8px"></div>
        <button class="btn-start" onclick="checkLogin()">V√ÄO THI NGAY</button>
    </div>
</div>

<div class="container" id="main-interface" style="display:none">
    <div class="status-bar">
        <div class="student-box"><i class="fas fa-user-graduate"></i> <span id="d-name">HS</span> <span id="d-class"></span></div>
        <div class="timer-box"><i class="far fa-clock"></i> <span id="timer">00:00</span></div>
    </div>
    
    <div style="background:white;padding:15px;margin:15px 0;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1)">
        <div class="palette-grid" id="palette-grid"></div>
    </div>

    <div class="alert-rule">
        <i class="fas fa-info-circle fa-2x"></i>
        <div>
            <b>L∆ØU √ù:</b> M√°y t√≠nh ch·∫•p nh·∫≠n c·∫£ d·∫•u ph·∫©y (,) v√† d·∫•u ch·∫•m (.)<br>
            V√≠ d·ª•: Nh·∫≠p <b>16,98</b> ho·∫∑c <b>16.98</b> ƒë·ªÅu ƒë∆∞·ª£c t√≠nh ƒëi·ªÉm.
        </div>
    </div>

    <div id="result-area" style="display:none;background:white;padding:30px;text-align:center;border-radius:12px;margin-bottom:20px;border-top:5px solid #2e7d32">
        <div style="color:#666">K·∫æT QU·∫¢</div>
        <h1 style="color:#2e7d32;font-size:4em;margin:5px 0"><span id="final-score"></span></h1>
        <div id="review-timer" style="color:#c62828;font-weight:bold;margin-top:10px;padding:10px;background:#ffebee;border-radius:4px;border:1px solid #ffcdd2">
            ‚è≥ Th·ªùi gian xem l·∫°i b√†i: <span id="r-time">120</span> gi√¢y
        </div>
        <div style="color:#1565c0;font-weight:bold;margin-top:15px">‚ñº K√©o xu·ªëng ƒë·ªÉ xem l·ªùi gi·∫£i chi ti·∫øt ‚ñº</div>
    </div>

    <div id="quiz-body"></div>
    
    <button class="submit-floating" onclick="confirmSubmit()" id="btn-submit">
        <i class="fas fa-paper-plane"></i> N·ªòP B√ÄI THI
    </button>
</div>

<script>
    // üëáüëáüëá TH·∫¶Y D√ÅN LINK GOOGLE SCRIPT V√ÄO GI·ªÆA 2 D·∫§U NH√ÅY D∆Ø·ªöI ƒê√ÇY üëáüëáüëá
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwkdoesopItYMdgey0Zh7Rlru3ILoUbUaJw_b1EmmTtMiHSVYniswKOp1ZIP6gCIqSh/exec'; 
    // üëÜüëÜüëÜ (N·∫øu ƒë·ªÉ tr·ªëng th√¨ kh√¥ng g·ª≠i ƒëi·ªÉm v·ªÅ Sheet)

    const REVIEW_TIME = 120;
    let rawQ=[], curQ=[], timerDur=0, timerInt;
    let scoresConfig={mcq:0.25, tf:1.0, short:0.5, match:1.0};
    let isEnc=false, userAns={}, stId="", exId="";

    // LOAD ƒê·ªÄ
    const urlParams=new URLSearchParams(window.location.search);
    const pId=urlParams.get('id'); exId=pId||"demo";
    if(pId){
        const s=document.createElement('script');
        s.src=`data/${pId}.js?v=`+Date.now();
        s.onload=()=>{if(window.EXAM_DATA)initExam(window.EXAM_DATA)};
        s.onerror=()=>document.getElementById('loading').innerText="L·ªói t·∫£i ƒë·ªÅ!";
        document.head.appendChild(s);
    }else document.getElementById('loading').innerText="Thi·∫øu ID ƒë·ªÅ.";

    function initExam(d){
        rawQ=d.questions; timerDur=(d.time||45)*60;
        if(d.scores) scoresConfig={...scoresConfig, ...d.scores}; 
        isEnc=d.encrypted===true;
        
        document.getElementById('exam-title').innerText=d.title||"B√ÄI KI·ªÇM TRA";
        document.getElementById('exam-info').innerText=`${rawQ.length} C√¢u | ${d.time} Ph√∫t`;
        if(d.password)document.getElementById('pass-area').style.display='block';

        if(d.price > 0 && d.bank) {
             document.getElementById('payment-area').style.display = 'block';
             document.getElementById('pay-amount').innerText = d.price.toLocaleString('vi-VN') + "ƒë";
             const qrUrl = `https://img.vietqr.io/image/${d.bank.id}-${d.bank.acc}-compact.png?amount=${d.price}&addInfo=HOCPHI ${exId}`;
             document.getElementById('vietqr-img').src = qrUrl;
        }
        document.getElementById('loading').style.display='none'; 
        document.getElementById('welcome-screen').style.display='flex';
    }

    function checkLogin(){
        const n=document.getElementById('s-name').value.trim(), c=document.getElementById('s-class').value.trim();
        if(!n||!c)return alert("Nh·∫≠p ƒë·ªß th√¥ng tin!");
        if(window.EXAM_DATA.password && CryptoJS.MD5(document.getElementById('s-pass').value.trim()).toString()!==window.EXAM_DATA.password) return alert("Sai m·∫≠t kh·∫©u!");
        stId=n+c; document.getElementById('d-name').innerText=n; document.getElementById('d-class').innerText=c;
        startLogic(n);
    }

    function startLogic(name){
        let doShuffle = (window.EXAM_DATA.shuffle !== false); 

        function mul32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^(t>>>15),t|1);t^=t+Math.imul(t^(t>>>7),t|61);return((t^(t>>>14))>>>0)/4294967296}}
        function cyrb128(s){let h1=1779033703,h2=3144134277,h3=1013904242,h4=2773480762;for(let i=0,k;i<s.length;i++){k=s.charCodeAt(i);h1=h2^Math.imul(h1^k,597399067);h2=h3^Math.imul(h2^k,2869860281);h3=h4^Math.imul(h3^k,951274213);h4=h1^Math.imul(h4^k,2716044179);}return(h1^h2^h3^h4)>>>0}
        function seedShuf(arr,rng){for(let i=arr.length-1;i>0;i--){const j=Math.floor(rng()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]}}
        
        let aq=JSON.parse(JSON.stringify(rawQ));
        
        if(doShuffle) {
            const rng=mul32(cyrb128(name+exId));
            let p1=aq.filter(q=>q.type==='mcq'), p2=aq.filter(q=>q.type==='tf'), p3=aq.filter(q=>q.type==='short'), p4=aq.filter(q=>q.type==='match');
            seedShuf(p1,rng); seedShuf(p2,rng); seedShuf(p3,rng); seedShuf(p4,rng);
            p1.forEach(q=>{q.idx=q.options.map((_,i)=>i);seedShuf(q.idx,rng)}); 
            p2.forEach(q=>seedShuf(q.items,rng)); 
            curQ=[...p1,...p2,...p3,...p4]; 
        } else {
            aq.forEach(q => { if(q.type==='mcq') q.idx = q.options.map((_,i)=>i); });
            curQ = aq;
        }

        renderUI();
        document.getElementById('welcome-screen').style.display='none';
        document.getElementById('main-interface').style.display='block';
        timerInt=setInterval(()=>{
            let m=Math.floor(timerDur/60),s=timerDur%60;
            document.getElementById('timer').innerText=`${m}:${s<10?'0'+s:s}`;
            if(--timerDur<0){clearInterval(timerInt);submitQuiz();alert("H·∫øt gi·ªù!");}
        },1000);
    }

    function renderUI(){
        let bh='', ph='';
        curQ.forEach((q,i)=>{
            ph+=`<div class="palette-item" id="pb-${i}" onclick="document.getElementById('q-${i}').scrollIntoView({behavior:'smooth',block:'center'})">${i+1}</div>`;
            bh+=`<div class="question-block" id="q-${i}"><div style="margin-bottom:15px"><span class="q-label">C√¢u ${i+1}:</span> <span style="font-weight:500">${q.q.replace(/^C√¢u \d+[:.]\s*/i,'')}</span></div>`;
            if(q.img)bh+=`<div style="text-align:center"><img src="${q.img}" style="max-width:100%;border-radius:8px;margin:10px auto;border:1px solid #eee"></div>`;
            
            if(q.type==='mcq') bh+=`<div style="display:grid;grid-template-columns:1fr;gap:5px">`+q.idx.map((o,d)=>`<label class="option-item"><input type="radio" name="q${i}" value="${o}" onchange="sv(${i},${o})"><span><b>${['A','B','C','D'][d]}.</b> ${q.options[o]}</span></label>`).join('')+`</div>`;
            else if(q.type==='tf') bh+=`<table style="width:100%;border-collapse:collapse;margin-top:5px"><tr><th>√ù</th><th>ƒê</th><th>S</th></tr>`+q.items.map((it,s)=>`<tr><td style="border-bottom:1px solid #eee;padding:8px">${it.sub}</td><td align="center" style="border-bottom:1px solid #eee"><input type="radio" name="q${i}_${s}" value="T" onchange="sv(${i},'T',${s})"></td><td align="center" style="border-bottom:1px solid #eee"><input type="radio" name="q${i}_${s}" value="F" onchange="sv(${i},'F',${s})"></td></tr>`).join('')+`</table>`;
            else if(q.type==='match') {
                bh += `<div style="display:flex;flex-direction:column;gap:10px;margin-top:10px">`;
                q.items.forEach((it, idx) => {
                    let optsHTML = `<option value="">--</option>` + q.options.map((opt, oIdx) => `<option value="${String.fromCharCode(65 + oIdx)}">${String.fromCharCode(65 + oIdx)}</option>`).join('');
                    bh += `<div style="display:flex;align-items:center;justify-content:space-between;background:#f9f9f9;padding:8px;border-radius:4px"><div style="flex:1;font-size:0.9em"><b>${idx+1})</b> ${it}</div><select style="padding:5px;border:1px solid #ccc;border-radius:4px;color:#1565c0;font-weight:bold" onchange="sv(${i},this.value,${idx})">${optsHTML}</select></div>`;
                });
                bh += `<div style="margin-top:10px;background:#e3f2fd;padding:10px;border-radius:8px;font-size:0.9em">` + q.options.map((opt, oIdx) => `<div style="margin-bottom:4px"><b>${String.fromCharCode(65 + oIdx)}.</b> ${opt}</div>`).join('') + `</div></div>`;
            }
            else bh+=`<input type="text" placeholder="Nh·∫≠p ƒë√°p √°n (VD: 16,98)" oninput="sv(${i},this.value)" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:8px;outline:none;font-weight:bold;color:#1a237e">`;
            bh+=`<div id="sol-${i}" style="display:none;margin-top:15px;padding:15px;background:#e8f5e9;border-radius:6px;color:#2e7d32;border:1px dashed #a5d6a7"><b>L·ªúI GI·∫¢I:</b><br>${q.explain||'Kh√¥ng c√≥.'}</div></div>`;
        });
        document.getElementById('palette-grid').innerHTML=ph; document.getElementById('quiz-body').innerHTML=bh;
        if(window.MathJax)MathJax.typesetPromise();
    }

    function sv(i,v,s=null){
        if(!userAns[i]) userAns[i]={};
        if(curQ[i].type === 'match' || curQ[i].type === 'tf') userAns[i][s] = v;
        else userAns[i] = v;
        
        // ƒê·ªïi m√†u: Ki·ªÉm tra xem ƒë√£ l√†m ƒë·ªß √Ω ch∆∞a
        let isDone = false;
        if(curQ[i].type === 'mcq' || curQ[i].type === 'short') {
            if(userAns[i] !== undefined && userAns[i] !== null && userAns[i].toString().trim() !== "") isDone = true;
        } else {
            if(userAns[i] && Object.keys(userAns[i]).length === curQ[i].items.length) isDone = true;
        }
        if(isDone) document.getElementById(`pb-${i}`).classList.add('answered');
    }

    // --- S·ª¨A L·ªñI CONFIRM SUBMIT (Cho ph√©p s·ªë 0 - ƒë√°p √°n A) ---
    function confirmSubmit(){
        let un=[];
        curQ.forEach((q,i)=>{
            if(q.type==='match' || q.type==='tf'){ 
                let count = userAns[i] ? Object.keys(userAns[i]).length : 0;
                if(count < q.items.length) un.push(i+1); 
            }
            else {
                // S·ª¨A L·ªñI T·∫†I ƒê√ÇY: Ki·ªÉm tra k·ªπ h∆°n v·ªõi undefined, null v√† chu·ªói r·ªóng
                if(userAns[i] === undefined || userAns[i] === null || userAns[i] === "") un.push(i+1);
            }
        });

        if(un.length>0){ 
            if(!confirm(`‚ö†Ô∏è C√ÅC C√ÇU CH∆ØA L√ÄM XONG: ${un.join(", ")}\n\nB·∫°n c√≥ ch·∫Øc mu·ªën n·ªôp b√†i kh√¥ng?`)) return;
        }
        else { 
            if(!confirm("X√°c nh·∫≠n n·ªôp b√†i thi?")) return;
        }
        submitQuiz();
    }

    function chk(u, c) {
        if (u === undefined || u === null || u === "") return false;
        let uStr = String(u).trim();
        let cStr = String(c).trim();
        let uClean = uStr.replace(',', '.');
        let cClean = cStr.replace(',', '.');
        
        if (uClean === cClean) return true;
        if (uStr.toLowerCase() === cStr.toLowerCase()) return true;
        
        if (uStr === 'T' && ['true', '1', 'ƒë√∫ng', 'yes'].includes(cStr.toLowerCase())) return true;
        if (uStr === 'F' && ['false', '0', 'sai', 'no'].includes(cStr.toLowerCase())) return true;

        if (isEnc) {
            if (CryptoJS.MD5(uStr).toString() === cStr) return true;
            if (CryptoJS.MD5(uClean).toString() === cStr) return true; 
            if (uStr === 'T') { 
                let trues = ["True", "true", "TRUE", "ƒê√∫ng", "Dung", "Yes", "1", "T"];
                for(let t of trues) if(CryptoJS.MD5(t).toString() === cStr) return true;
            }
            if (uStr === 'F') {
                let falses = ["False", "false", "FALSE", "Sai", "No", "0", "F"];
                for(let f of falses) if(CryptoJS.MD5(f).toString() === cStr) return true;
            }
        }
        return false;
    }

    function submitQuiz(){
        clearInterval(timerInt);
        document.getElementById('btn-submit').style.display='none';
        
        let score=0, max=0;
        curQ.forEach((q,i)=>{
            const bl=document.getElementById(`q-${i}`); document.getElementById(`sol-${i}`).style.display='block';
            
            // L·∫§Y ƒêI·ªÇM RI√äNG T·ª™NG C√ÇU
            let qPoint = (q.point && parseFloat(q.point) > 0) ? parseFloat(q.point) : scoresConfig[q.type];

            if(q.type==='mcq' || q.type==='short'){
                max += qPoint;
                if(chk(userAns[i], q.ans)) { score += qPoint; bg(bl, true, 'ƒê√∫ng'); } 
                else bg(bl, false, `Sai. ƒêS: ${q.ans}`);
            }
            else if(q.type==='tf'){
                max += qPoint; let c=0;
                q.items.forEach((it, idx) => { if(chk(userAns[i]?userAns[i][idx]:null, it.ans)) c++; });
                
                let earned = 0;
                if(c==1) earned = qPoint * 0.1;
                else if(c==2) earned = qPoint * 0.25;
                else if(c==3) earned = qPoint * 0.5;
                else if(c==4) earned = qPoint * 1.0;
                
                score += earned; 
                bg(bl, earned>0, `ƒê√∫ng ${c}/${q.items.length} √Ω (+${earned}ƒë)`);
            }
            else if(q.type==='match'){
                max += qPoint; let c=0; let uObj = userAns[i] || {};
                q.items.forEach((_, idx) => { if(chk(uObj[idx], q.ans[idx])) c++; });
                let s = (c/q.items.length) * qPoint; 
                score += s; 
                bg(bl, s>0, `ƒê√∫ng ${c}/${q.items.length} c·∫∑p (+${s.toFixed(2)}ƒë)`);
            }
        });

        let finalS = Math.round(score*100)/100;
        document.getElementById('result-area').style.display='block';
        document.getElementById('final-score').innerText = `${finalS} / ${max}`;
        window.scrollTo({top:0,behavior:'smooth'});
        if(GOOGLE_SCRIPT_URL.length > 10) sendToSheet(finalS);

        let reviewSec = REVIEW_TIME;
        const rInt = setInterval(() => {
            reviewSec--;
            document.getElementById('r-time').innerText = reviewSec;
            if(reviewSec <= 0) {
                clearInterval(rInt);
                document.body.innerHTML = "<div style='height:100vh;display:flex;justify-content:center;align-items:center;background:#263238;color:white;flex-direction:column'><h1>H·∫æT GI·ªú XEM B√ÄI</h1><button onclick='location.reload()' style='padding:10px'>Quay l·∫°i</button></div>";
            }
        }, 1000);
    }

    function bg(el,isT,txt){ el.insertAdjacentHTML('beforeend',`<div class="res-badge ${isT?'res-correct':'res-wrong'}">${txt}</div>`); }
    function sendToSheet(score) {
        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: document.getElementById('s-name').value, class: document.getElementById('s-class').value, exam: window.EXAM_DATA.title, score: score })
        });
    }
</script>
</body>
</html>
