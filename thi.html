<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H·ªá Th·ªëng Thi Tr·ª±c Tuy·∫øn Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }, svg: { fontCache: 'global' } };</script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        /* CSS CHU·∫®N (GI·ªÆ NGUY√äN T·ª™ B·∫¢N TR∆Ø·ªöC) */
        *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;scroll-behavior:smooth}body{font-family:'Segoe UI',Arial,sans-serif;background:#f0f2f5;margin:0;color:#333;padding-bottom:80px;user-select:none}.container{max-width:900px;margin:0 auto;padding:15px}.header-bar{background:white;padding:10px 20px;box-shadow:0 2px 10px rgba(0,0,0,0.1);position:sticky;top:0;z-index:1000;display:flex;justify-content:space-between;align-items:center;border-bottom:3px solid #009688}.timer{font-size:1.3em;color:#d32f2f;font-weight:800;font-family:monospace;background:#ffebee;padding:5px 15px;border-radius:20px}.violation-box{background:#ffebee;color:#c62828;padding:10px;margin-bottom:15px;border-radius:6px;border:1px solid #ffcdd2;display:none;font-weight:bold;text-align:center}.palette-container{background:white;padding:15px;margin:15px auto;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}.palette-grid{display:flex;flex-wrap:wrap;gap:8px}.palette-item{width:35px;height:35px;display:flex;align-items:center;justify-content:center;border:1px solid #ddd;border-radius:4px;font-size:0.9em;cursor:pointer;background:#f9f9f9}.palette-item.answered{background:#009688;color:white;border-color:#009688;font-weight:bold}.question-block{background:white;padding:20px;border-radius:12px;margin-bottom:20px;box-shadow:0 1px 3px rgba(0,0,0,0.05);border:1px solid #e0e0e0;scroll-margin-top:80px}.q-label{color:#0277bd;font-weight:800;font-size:1.1em}.q-content{font-weight:500;display:block;margin-bottom:15px}.q-image{max-width:100%;border-radius:8px;margin:10px auto;border:1px solid #eee;display:block}.option-item{display:flex;align-items:flex-start;background:#f8f9fa;border:1px solid #eee;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:8px;transition:0.2s}.option-item:hover{background:#e0f2f1}.option-item:has(input:checked){border-color:#009688;background:#e0f2f1;font-weight:600;color:#004d40}.option-item input{margin-right:12px;margin-top:5px;transform:scale(1.3);accent-color:#009688}.tf-table{width:100%;border-collapse:collapse;margin-top:5px}.tf-table td,.tf-table th{padding:10px;border-bottom:1px solid #eee;text-align:center}.tf-table td:first-child{text-align:left}.short-input{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;outline:none}.part-header{background:#e3f2fd;color:#1565c0;padding:12px;margin:30px 0 15px 0;font-weight:800;border-radius:6px;border-left:5px solid #1565c0}.welcome-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#009688,#004d40);z-index:2000;display:flex;align-items:center;justify-content:center;padding:20px}.welcome-card{background:white;width:100%;max-width:420px;padding:35px;border-radius:16px;text-align:center;box-shadow:0 15px 40px rgba(0,0,0,0.3)}.welcome-card input{width:100%;padding:14px;margin-bottom:15px;border:1px solid #ccc;border-radius:8px;font-size:16px}.btn-start{background:#ff9800;color:white;width:100%;padding:15px;border:none;border-radius:50px;font-weight:bold;font-size:1.2em;cursor:pointer;transition:0.3s}.btn-start:hover{transform:scale(1.05)}.loading{position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:3000;display:flex;flex-direction:column;justify-content:center;align-items:center}.result-box{display:none;background:white;padding:40px;text-align:center;border-radius:12px;margin-bottom:20px;border-top:6px solid #2e7d32}.solution-box{display:none;margin-top:15px;padding:15px;background:#e8f5e9;border-radius:6px;color:#2e7d32;border:1px dashed #a5d6a7}.ans-badge{display:inline-block;padding:5px 10px;border-radius:6px;font-weight:bold;margin-top:10px}.correct{background:#c8e6c9;color:#1b5e20}.wrong{background:#ffcdd2;color:#b71c1c}.btn-submit{background:#d32f2f;color:white;padding:15px;width:100%;border:none;border-radius:8px;font-size:18px;font-weight:bold;cursor:pointer;margin-top:20px}
        /* TH√îNG B√ÅO L·ªñI */
        .error-overlay{background:rgba(255,255,255,0.9);position:fixed;top:0;left:0;width:100%;height:100%;z-index:4000;display:flex;justify-content:center;align-items:center;flex-direction:column;text-align:center}
    </style>
</head>
<body>

<div class="loading" id="loading"><div style="font-size:50px; animation: bounce 1s infinite">‚è≥</div><div style="margin-top:15px; color:#009688; font-weight:bold">ƒêang t·∫£i ƒë·ªÅ thi...</div></div>

<div class="welcome-overlay" id="welcome-screen" style="display:none">
    <div class="welcome-card">
        <h2 id="exam-title" style="color:#00796b; margin:0">B√ÄI KI·ªÇM TRA</h2>
        <p id="exam-info" style="color:#666; margin-bottom:25px"></p>
        <p style="font-size:0.9em;color:#d32f2f;background:#ffebee;padding:5px;border-radius:4px">‚ö†Ô∏è L∆∞u √Ω: H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông n·ªôp b√†i n·∫øu b·∫°n r·ªùi kh·ªèi m√†n h√¨nh qu√° 3 l·∫ßn!</p>
        <input type="text" id="s-name" placeholder="H·ªç v√† T√™n (Kh√¥ng d·∫•u c√†ng t·ªët)">
        <input type="text" id="s-class" placeholder="L·ªõp">
        <div id="pass-area" style="display:none"><input type="password" id="s-pass" placeholder="M·∫≠t kh·∫©u ƒë·ªÅ thi"></div>
        <button class="btn-start" onclick="checkLogin()">B·∫ÆT ƒê·∫¶U L√ÄM B√ÄI</button>
    </div>
</div>

<div class="container" id="main-interface" style="display:none">
    <div class="header-bar"><div class="student-info">üë§ <span id="d-name"></span> | <span id="d-class"></span></div><div class="timer" id="timer">00:00</div></div>
    <div id="violation-msg" class="violation-box"></div>
    <div class="palette-container"><div class="palette-grid" id="palette-grid"></div></div>
    <div id="result-area" class="result-box">
        <div style="color:#666;font-size:1.2em">K·∫æT QU·∫¢</div><h1 style="color:#2e7d32;font-size:4em;margin:10px 0"><span id="final-score"></span></h1>
        <div id="violation-final" style="color:red;font-weight:bold;margin-bottom:10px;display:none">‚ö†Ô∏è B√ÄI THI B·ªä ƒê√ÅNH D·∫§U VI PH·∫†M</div>
        <div id="save-status" style="margin-bottom:10px;font-style:italic;color:#555"></div>
        <div style="color:#1565c0;font-weight:bold">‚ñº Xem chi ti·∫øt ƒë√°p √°n b√™n d∆∞·ªõi ‚ñº</div>
    </div>
    <div id="quiz-body"></div>
    <button class="btn-submit" onclick="confirmSubmit()" id="btn-submit">N·ªòP B√ÄI THI</button>
</div>

<script>
    // --- C·∫§U H√åNH ---
    // ‚ö†Ô∏è QUAN TR·ªåNG: D√ÅN LINK GOOGLE SCRIPT C·ª¶A TH·∫¶Y V√ÄO ƒê√ÇY
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbypgz3zUkMH6qGEahUz3v5wq_D3nqAJ3Iogm0ox96mZN21L7NtiYi4Xf1zx2NdW4D4C/exec'; 

    let rawQ=[], curQ=[], timerDur=0, timerInt;
    let scoresConfig={mcq:0.25,tf:1.0,short:0.5};
    let isEnc=false, userAns={}, stId="", exId="";
    let vCount=0, isVio=false; const MAX_V=3;
    let startTime=0; // Th·ªùi gian b·∫Øt ƒë·∫ßu l√†m b√†i

    // --- 1. T·∫¢I ƒê·ªÄ ---
    const urlParams=new URLSearchParams(window.location.search);
    const pId=urlParams.get('id'); exId=pId||"demo";
    if(pId){const s=document.createElement('script');s.src=`data/${pId}.js?v=`+Date.now();s.onload=()=>{if(window.EXAM_DATA)initExam(window.EXAM_DATA)};s.onerror=()=>document.getElementById('loading').innerHTML="<h3 style='color:red'>Kh√¥ng t√¨m th·∫•y ƒë·ªÅ!</h3>";document.head.appendChild(s);}else document.getElementById('loading').innerText="Ch∆∞a c√≥ m√£ ƒë·ªÅ.";

    function initExam(d){
        // KI·ªÇM TRA TH·ªúI GIAN M·ªû/ƒê√ìNG ƒê·ªÄ
        let now = new Date();
        if(d.start && now < new Date(d.start)) return showErr(`‚õî CH∆ØA ƒê·∫æN GI·ªú THI!<br>ƒê·ªÅ s·∫Ω m·ªü l√∫c: ${formatDate(d.start)}`);
        if(d.end && now > new Date(d.end)) return showErr(`‚õî ƒê√É H·∫æT GI·ªú THI!<br>ƒê·ªÅ ƒë√£ ƒë√≥ng l√∫c: ${formatDate(d.end)}`);

        rawQ=d.questions; timerDur=(d.time||45)*60;
        if(d.scores)scoresConfig=d.scores; isEnc=d.encrypted===true;
        document.getElementById('exam-title').innerText=d.title||"B√ÄI KI·ªÇM TRA";
        document.getElementById('exam-info').innerText=`${rawQ.length} C√¢u | ${d.time} Ph√∫t | M√¥n: ${d.subject||'Kh√°c'}`;
        if(d.password)document.getElementById('pass-area').style.display='block';
        document.getElementById('loading').style.display='none'; 
        document.getElementById('welcome-screen').style.display='flex';
    }

    function showErr(msg){
        document.body.innerHTML += `<div class="error-overlay"><h1>${msg}</h1></div>`;
        document.getElementById('loading').style.display='none';
    }
    function formatDate(s){ return new Date(s).toLocaleString('vi-VN'); }

    // --- 2. SEEDED SHUFFLE ---
    function mul32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^(t>>>15),t|1);t^=t+Math.imul(t^(t>>>7),t|61);return((t^(t>>>14))>>>0)/4294967296}}
    function cyrb128(s){let h1=1779033703,h2=3144134277,h3=1013904242,h4=2773480762;for(let i=0,k;i<s.length;i++){k=s.charCodeAt(i);h1=h2^Math.imul(h1^k,597399067);h2=h3^Math.imul(h2^k,2869860281);h3=h4^Math.imul(h3^k,951274213);h4=h1^Math.imul(h4^k,2716044179);}return(h1^h2^h3^h4)>>>0}
    function seedShuf(arr,rng){for(let i=arr.length-1;i>0;i--){const j=Math.floor(rng()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]}}

    // --- 3. START ---
    function checkLogin(){
        const n=document.getElementById('s-name').value.trim(), c=document.getElementById('s-class').value.trim();
        if(!n||!c)return alert("Nh·∫≠p t√™n v√† l·ªõp!");
        if(window.EXAM_DATA.password&&CryptoJS.MD5(document.getElementById('s-pass').value.trim()).toString()!==window.EXAM_DATA.password)return alert("Sai m·∫≠t kh·∫©u!");
        stId=n+c; document.getElementById('d-name').innerText=n; document.getElementById('d-class').innerText=c;
        startLogic(n);
    }
    function startLogic(name){
        const rng=mul32(cyrb128(name+exId));
        prepQ(rng);
        document.getElementById('welcome-screen').style.display='none';
        document.getElementById('main-interface').style.display='block';
        startTime = new Date(); // Ghi nh·∫≠n gi·ªù b·∫Øt ƒë·∫ßu
        resProg(); actAntiCheat();
        timerInt=setInterval(()=>{let m=Math.floor(timerDur/60),s=timerDur%60;document.getElementById('timer').innerText=`${m}:${s<10?'0'+s:s}`;if(--timerDur<0){clearInterval(timerInt);submitQuiz();alert("H·∫øt gi·ªù!");}},1000);
    }
    function prepQ(rng){
        let aq=JSON.parse(JSON.stringify(rawQ)), p1=aq.filter(q=>q.type==='mcq'), p2=aq.filter(q=>q.type==='tf'), p3=aq.filter(q=>q.type==='short');
        seedShuf(p1,rng);seedShuf(p2,rng);seedShuf(p3,rng);
        p1.forEach(q=>{q.idx=q.options.map((_,i)=>i);seedShuf(q.idx,rng)}); p2.forEach(q=>seedShuf(q.items,rng));
        if(p1.length)p1[0].hd=`PH·∫¶N 1: TR·∫ÆC NGHI·ªÜM`; if(p2.length)p2[0].hd=`PH·∫¶N 2: ƒê√öNG SAI`; if(p3.length)p3[0].hd=`PH·∫¶N 3: TR·∫¢ L·ªúI NG·∫ÆN`;
        curQ=[...p1,...p2,...p3]; renderUI();
    }

    // --- 4. RENDER ---
    function renderUI(){
        let ph='', bh='';
        curQ.forEach((q,i)=>{
            ph+=`<div class="palette-item" id="pb-${i}" onclick="scQ(${i})">${i+1}</div>`;
            if(q.hd)bh+=`<div class="part-header">${q.hd}</div>`;
            bh+=`<div class="question-block" id="q-${i}"><div style="margin-bottom:15px"><span class="q-label">C√¢u ${i+1}:</span> <span class="q-content">${q.q.replace(/^C√¢u \d+[:.]\s*/i,'')}</span></div>`;
            if(q.img)bh+=`<div style="text-align:center"><img src="${q.img}" class="q-image"></div>`;
            if(q.type==='mcq')bh+=`<div class="options-grid">`+q.idx.map((o,d)=>`<label class="option-item"><input type="radio" name="q${i}" value="${o}" onchange="sv(${i},${o})"><span><b>${['A','B','C','D'][d]}.</b> ${q.options[o]}</span></label>`).join('')+`</div>`;
            else if(q.type==='tf')bh+=`<table class="tf-table"><tr><th>√ù</th><th>ƒê</th><th>S</th></tr>`+q.items.map((it,s)=>`<tr><td>${it.sub}</td><td align="center"><input type="radio" name="q${i}_${s}" value="T" onchange="sv(${i},'T',${s})"></td><td align="center"><input type="radio" name="q${i}_${s}" value="F" onchange="sv(${i},'F',${s})"></td></tr>`).join('')+`</table>`;
            else bh+=`<input type="text" class="short-input" id="in-${i}" placeholder="ƒê√°p √°n..." onchange="sv(${i},this.value)">`;
            bh+=`<div class="solution-box" id="sol-${i}"><b>L·ªúI GI·∫¢I:</b><br>${q.explain||'Kh√¥ng.'}</div></div>`;
        });
        document.getElementById('palette-grid').innerHTML=ph; document.getElementById('quiz-body').innerHTML=bh;
        if(window.MathJax)MathJax.typesetPromise();
    }

    // --- 5. LOGIC ---
    function sv(i,v,s=null){if(!userAns[i])userAns[i]={};if(s!==null)userAns[i][s]=v;else userAns[i]=v;document.getElementById(`pb-${i}`).classList.add('answered');localStorage.setItem(`ex_${exId}_${stId}`,JSON.stringify({a:userAns,t:timerDur}));}
    function resProg(){let d=localStorage.getItem(`ex_${exId}_${stId}`);if(d){try{let j=JSON.parse(d);userAns=j.a||{};timerDur=j.t>0?j.t:timerDur;for(let[i,v]of Object.entries(userAns)){const q=curQ[i];if(q.type==='mcq'){let r=document.querySelector(`input[name="q${i}"][value="${v}"]`);if(r)r.checked=true}else if(q.type==='short'){document.getElementById(`in-${i}`).value=v}else if(q.type==='tf'){for(let[s,tv]of Object.entries(v)){let r=document.querySelector(`input[name="q${i}_${s}"][value="${tv}"]`);if(r)r.checked=true}}document.getElementById(`pb-${i}`).classList.add('answered');}}catch(e){}}}
    function scQ(i){document.getElementById(`q-${i}`).scrollIntoView({behavior:"smooth",block:"center"});}
    function actAntiCheat(){window.addEventListener('blur',()=>{if(document.getElementById('result-area').style.display==='block')return;vCount++;document.getElementById('violation-msg').style.display='block';document.getElementById('violation-msg').innerText=`‚ö†Ô∏è C·∫¢NH B√ÅO: R·ªùi m√†n h√¨nh! (${vCount}/${MAX_V})`;if(vCount>MAX_V){isVio=true;alert("VI PH·∫†M QUY CH·∫æ. H·ªÜ TH·ªêNG T·ª∞ N·ªòP B√ÄI!");submitQuiz();}});}

    // --- 6. SUBMIT & SEND TO SHEET ---
    function confirmSubmit(){
        let un=[];curQ.forEach((q,i)=>{if((q.type!=='tf'&&!userAns[i])||(q.type==='tf'&&(!userAns[i]||Object.keys(userAns[i]).length<q.items.length)))un.push(i+1)});
        if(un.length>0){if(!confirm(`Ch∆∞a l√†m c√¢u: ${un.join(", ")}. N·ªôp lu√¥n?`))return;}else{if(!confirm("X√°c nh·∫≠n n·ªôp b√†i?"))return;}
        submitQuiz();
    }

    function submitQuiz(){
        clearInterval(timerInt);
        document.getElementById('btn-submit').style.display='none';
        localStorage.removeItem(`ex_${exId}_${stId}`);
        
        let score=0, max=0;
        curQ.forEach((q,i)=>{
            const bl=document.getElementById(`q-${i}`); document.getElementById(`sol-${i}`).style.display='block';
            if(q.type==='mcq'){max+=scoresConfig.mcq;if(chk(userAns[i],q.ans)){score+=scoresConfig.mcq;bg(bl,'correct','ƒê√∫ng');}else bg(bl,'wrong',isEnc?'Sai':'ƒê√∫ng: '+q.options[q.ans]);}
            else if(q.type==='tf'){
                max+=scoresConfig.tf;let c=0;q.items.forEach((it,s)=>{if(chk(userAns[i]?userAns[i][s]:'X',it.ans))c++});
                let s=[0,0.1,0.25,0.5,1.0][c]*scoresConfig.tf; score+=s;
                bg(bl,s>0?'correct':'wrong',`ƒê√∫ng ${c}/4 √Ω`);
            }
            else{max+=scoresConfig.short;if(chk(userAns[i],q.ans)) {score+=scoresConfig.short;bg(bl,'correct','ƒê√∫ng');} else bg(bl,'wrong','Sai');}
        });

        let finalS = Math.round(score*100)/100;
        document.getElementById('result-area').style.display='block';
        document.getElementById('final-score').innerText = `${finalS} / ${max}`;
        if(isVio){document.getElementById('violation-final').style.display='block';document.getElementById('final-score').style.color='red';}
        window.scrollTo({top:0,behavior:'smooth'});

        // G·ª¨I ƒêI·ªÇM L√äN GOOGLE SHEET
        sendToSheet(finalS);
    }

    function bg(el,cls,txt){el.insertAdjacentHTML('beforeend',`<div class="ans-badge ${cls}">${txt}</div>`);}
    function chk(u,c){if(!u)return false;return isEnc?CryptoJS.MD5(String(u).trim().toLowerCase()).toString()===c:String(u).trim().toLowerCase()===String(c).trim().toLowerCase();}

    function sendToSheet(score) {
        if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL.length < 10) return;
        
        document.getElementById('save-status').innerText = "‚è≥ ƒêang l∆∞u ƒëi·ªÉm...";
        
        // T√≠nh th·ªùi gian l√†m b√†i (Ph√∫t)
        let duration = Math.round((new Date() - startTime) / 60000); 

        let data = {
            name: document.getElementById('s-name').value,
            class: document.getElementById('s-class').value,
            exam: window.EXAM_DATA.title || "B√†i thi",
            score: score,
            duration: duration + " ph√∫t",
            violation: vCount
        };

        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', // Quan tr·ªçng ƒë·ªÉ kh√¥ng b·ªã ch·∫∑n l·ªói CORS
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).then(() => {
            document.getElementById('save-status').innerText = "‚úÖ ƒê√£ l∆∞u ƒëi·ªÉm th√†nh c√¥ng!";
            document.getElementById('save-status').style.color = "green";
        }).catch(err => {
            document.getElementById('save-status').innerText = "‚ùå L·ªói l∆∞u ƒëi·ªÉm. H√£y ch·ª•p ·∫£nh m√†n h√¨nh!";
            document.getElementById('save-status').style.color = "red";
        });
    }
</script>
</body>
</html>
